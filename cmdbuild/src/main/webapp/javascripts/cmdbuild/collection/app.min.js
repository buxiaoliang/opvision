Ext.define("CMDBuild.core.constants.Global",{singleton:!0,config:{errorMsgCss:"cmdb-error-msg",mandatoryLabelFlag:"* ",rootNameClasses:"Class",rootNameWorkflows:"Activity",tableTypeClass:"class",tableTypeSimpleTable:"simpletable",tableTypeStandardTable:"standard",tableTypeWorkflow:"processclass",titleSeparator:" - "},constructor:function(e){this.initConfig(e)}}),Ext.define("CMDBuild.core.CookiesManager",{uses:["CMDBuild.core.constants.Proxy"],singleton:!0,authorizationClear:function(){Ext.util.Cookies.set(CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY,null,null,Ext.Array.slice(window.location.pathname.split("/"),0,-1).join("/")+"/"),Ext.util.Cookies.clear(CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY)},authorizationExpirationUpdate:function(){if(!CMDBuild.core.CookiesManager.authorizationIsEmpty()){var e=null;Ext.isEmpty(CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.SESSION_TIMEOUT))||(e=new Date).setSeconds(e.getSeconds()+CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.SESSION_TIMEOUT)),Ext.util.Cookies.set(CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY,CMDBuild.core.CookiesManager.authorizationGet(),e,Ext.Array.slice(window.location.pathname.split("/"),0,-1).join("/")+"/")}},authorizationGet:function(){return Ext.util.Cookies.get(CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY)},authorizationIsEmpty:function(){return Ext.isEmpty(CMDBuild.core.CookiesManager.authorizationGet())||"null"==CMDBuild.core.CookiesManager.authorizationGet()},authorizationSet:function(e){if("null"!==e)return Ext.isEmpty(e)&&"null"==e?void 0:Ext.util.Cookies.set(CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY,e,null,Ext.Array.slice(window.location.pathname.split("/"),0,-1).join("/")+"/");this.authorizationClear()}}),Ext.define("CMDBuild.core.interfaces.messages.Error",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.Message"],singleton:!0,display:function(e,t){Ext.isEmpty(e)||Ext.isEmpty(e[CMDBuild.core.constants.Proxy.ERRORS])||!Ext.isArray(e[CMDBuild.core.constants.Proxy.ERRORS])||Ext.Array.forEach(e[CMDBuild.core.constants.Proxy.ERRORS],function(e,i,r){Ext.Object.isEmpty(e)||CMDBuild.core.interfaces.messages.Error.showPopup(e,t)},this)},formatMessage:function(e,t){return Ext.isEmpty(CMDBuild.Translation.errors.reasons)||Ext.isEmpty(CMDBuild.Translation.errors.reasons[e])?(_error('"'+e+'" translation not found',"CMDBuild.core.interfaces.messages.Error"),""):Ext.String.format.apply(null,[].concat(CMDBuild.Translation.errors.reasons[e]).concat(t))},showPopup:function(e,t){var i=null,r={text:CMDBuild.Translation.errors.anErrorHasOccurred,detail:void 0};if(Ext.Object.isEmpty(e))Ext.isEmpty(response)||200==response.status||0==response.status?(i=CMDBuild.Translation.errors.error_message,r.text=CMDBuild.Translation.errors.anErrorHasOccurred):response.status&&(i=CMDBuild.Translation.errors.error_message,r.text=CMDBuild.Translation.errors.server_error_code+response.status);else{var s="",o=e.reason;if(!Ext.Object.isEmpty(t)&&!Ext.isEmpty(t.url)){s="Call: "+t.url+"\n";for(var a="",n=0;n<s.length;++n)a+="-";s+=a+"\n"}if(s+="Error: "+e.stacktrace,r.detail=s,!Ext.isEmpty(o)){if("AUTH_NOT_LOGGED_IN"==o||"AUTH_MULTIPLE_GROUPS"==o)return void Ext.create("CMDBuild.controller.common.sessionExpired.SessionExpired",{ajaxParameters:t,passwordFieldEnable:"AUTH_NOT_LOGGED_IN"==o});var l=CMDBuild.core.interfaces.messages.Error.formatMessage(o,e.reasonParameters);Ext.isEmpty(l)?_error('cannot format error message from "'+e+'"',"CMDBuild.core.interfaces.messages.Error"):r.text=l}}CMDBuild.core.Message.error(i,r,t.form)}}),Ext.define("CMDBuild.core.interfaces.messages.Warning",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.Message"],singleton:!0,display:function(e){Ext.isEmpty(e)||Ext.isEmpty(e[CMDBuild.core.constants.Proxy.WARNINGS])||!Ext.isArray(e[CMDBuild.core.constants.Proxy.WARNINGS])||Ext.Array.forEach(e[CMDBuild.core.constants.Proxy.WARNINGS],function(e,t,i){Ext.Object.isEmpty(e)||CMDBuild.core.interfaces.messages.Warning.showPopup(e)},this)},formatMessage:function(e,t){return Ext.isEmpty(CMDBuild.Translation.errors.reasons)||Ext.isEmpty(CMDBuild.Translation.errors.reasons[e])?(_error('"'+e+'" translation not found',"CMDBuild.core.interfaces.messages.Warning"),""):Ext.String.format.apply(null,[].concat(CMDBuild.Translation.errors.reasons[e]).concat(t))},showPopup:function(e){if(!Ext.Object.isEmpty(e)){var t=CMDBuild.core.interfaces.messages.Warning.formatMessage(e.reason,e.reasonParameters);Ext.isEmpty(t)?_error('cannot format warning message from "'+e+'"',"CMDBuild.core.interfaces.messages.Warning"):CMDBuild.core.Message.warning(null,t)}}}),Ext.define("CMDBuild.core.interfaces.service.LoadMask",{uses:["CMDBuild.core.LoadMask"],singleton:!0,manage:function(e,t){if(t=!!Ext.isBoolean(t)&&t,!Ext.isEmpty(e))switch(Ext.typeOf(e)){case"object":return CMDBuild.core.interfaces.service.LoadMask.manageObject(e,t);case"boolean":default:return CMDBuild.core.interfaces.service.LoadMask.manageBoolean(e,t)}},manageBoolean:function(e,t){t=!!Ext.isBoolean(t)&&t,e&&(t?CMDBuild.core.LoadMask.show():CMDBuild.core.LoadMask.hide())},manageObject:function(e,t){t=!!Ext.isBoolean(t)&&t,Ext.isFunction(e.setLoading)&&e.setLoading(t)}}),Ext.define("CMDBuild.proxy.Cache",{uses:["CMDBuild.cache.CMReferenceStoreModel","CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.model.cache.LookupFieldStore"],singleton:!0,getStoreForeignKey:function(e){return e=Ext.isObject(e)?e:{},e[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(["Description"]),CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.CARD,{autoLoad:!0,model:"CMDBuild.cache.CMReferenceStoreModel",baseParams:e,pageSize:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.REFERENCE_COMBO_STORE_LIMIT),proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.card.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.ROWS,totalProperty:CMDBuild.core.constants.Proxy.RESULTS},extraParams:e},sorters:[{property:"Description",direction:"ASC"}],listeners:{beforeload:function(e,t,i){var r=Ext.encode(e.getProxy().extraParams);return Ext.Array.every(["{client","{cql","{group","{js","{server","{user","{xa"],function(e,t,i){return r.indexOf(e)<0},this)}}})},getStoreLookup:function(e){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.LOOKUP,{autoLoad:!0,model:"CMDBuild.model.cache.LookupFieldStore",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.lookup.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.ROWS},extraParams:{type:e,active:!0,short:!0},actionMethods:"POST"},sorters:[{property:"Number",direction:"ASC"},{property:"Description",direction:"ASC"}]})},getStoreReference:function(e,t){(t=Ext.isObject(t)?t:{})[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(["Description"]);var i=CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.CARD,{autoLoad:!e,model:"CMDBuild.cache.CMReferenceStoreModel",isOneTime:e,baseParams:t,pageSize:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.REFERENCE_COMBO_STORE_LIMIT),proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.card.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.ROWS,totalProperty:CMDBuild.core.constants.Proxy.RESULTS},extraParams:t},sorters:[{property:"Description",direction:"ASC"}],listeners:{beforeload:function(e,t,i){var r=Ext.encode(e.getProxy().extraParams);return Ext.Array.every(["{client","{cql","{group","{js","{server","{user","{xa"],function(e,t,i){return r.indexOf(e)<0},this)}}});return t.NoFilter&&i.filters.clear(),i}}),Ext.define("CMDBuild.proxy.common.tabs.attribute.Attribute",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.model.common.tabs.attribute.Attribute","CMDBuild.model.common.tabs.attribute.Domain","CMDBuild.model.common.tabs.attribute.Type"],singleton:!0,create:function(e){},getStore:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.ATTRIBUTE,{autoLoad:!1,model:"CMDBuild.model.common.tabs.attribute.Attribute",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.attribute.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.ATTRIBUTES},extraParams:{limitParam:void 0,pageParam:void 0,startParam:void 0}},sorters:[{property:CMDBuild.core.constants.Proxy.INDEX,direction:"ASC"},{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},getStoreTypes:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.ATTRIBUTE,{autoLoad:!1,model:"CMDBuild.model.common.tabs.attribute.Type",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.attribute.readTypes,reader:{type:"json",root:CMDBuild.core.constants.Proxy.TYPES},extraParams:{limitParam:void 0,pageParam:void 0,startParam:void 0}},sorters:[{property:CMDBuild.core.constants.Proxy.VALUE,direction:"ASC"}]})},getStoreRenceableDomains:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.DOMAIN,{autoLoad:!1,model:"CMDBuild.model.common.tabs.attribute.Domain",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.attribute.readRenceableDomains,reader:{type:"json",root:CMDBuild.core.constants.Proxy.DOMAINS},extraParams:{limitParam:void 0,pageParam:void 0,startParam:void 0}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.attribute.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.ATTRIBUTE,e)},readClassByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.classes.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CLASS,e)},readWorkflowByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.attribute.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.ATTRIBUTE,e,!0)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.attribute.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.ATTRIBUTE,e,!0)}}),Ext.define("CMDBuild.proxy.gis.Layer",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.model.gis.Layer","CMDBuild.proxy.index.Json"],singleton:!0,getStore:function(e){CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT);return Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:[{text:CMDBuild.Translation.administration.modClass.tabs.geo_attributes,layerName:"cm_cmdbuild_layers_folder",checked:!0},{text:CMDBuild.Translation.administration.modcartography.external_services.title,layerName:"cm_external_layers_folder",checked:!0}]},rootVisible:!1,autoLoad:!0,model:"CMDBuild.model.gis.Layer"})},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.gis.layer.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.GIS,e)},setOrder:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.gis.layer.setOrder}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.GIS,e,!0)},setVisibility:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.gis.layer.setVisibility}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.GIS,e,!0)}}),Ext.define("CMDBuild.proxy.index.Json",{singleton:!0,attachment:{create:"services/json/attachments/create",read:"",update:"services/json/attachments/update",remove:"services/json/attachments/delete",readAll:"services/json/attachments/readall",download:"services/json/attachments/download",getContext:"services/json/attachments/readcontext",getVersions:"services/json/attachments/readallversions"},attribute:{create:"",read:"services/json/schema/modclass/getattributelist",update:"services/json/schema/modclass/saveattribute",remove:"services/json/schema/modclass/deleteattribute",readAll:"services/json/schema/modclass/getattributelist",readTypes:"services/json/schema/modclass/getattributetypes",readRenceableDomains:"services/json/schema/modclass/getreferenceabledomainlist",sorting:{reorder:"services/json/schema/modclass/reorderattribute",update:"services/json/schema/modclass/saveordercriteria"}},bim:{create:"services/json/bim/create",read:"services/json/bim/read",update:"services/json/bim/update",remove:"",activeForClassName:"services/json/bim/getactiveforclassname",disable:"services/json/bim/disableproject",enable:"services/json/bim/enableproject",fetchCardFromViewewId:"services/json/bim/fetchcardfromviewewid",fetchJsonForBimViewer:"services/json/bim/fetchjsonforbimviewer",roidForCardId:"services/json/bim/getroidforcardid",ifc:{download:"services/json/bim/download",imports:"services/json/bim/importifc"},layer:{create:"",read:"",update:"services/json/bim/savebimlayer",remove:"",readAll:"services/json/bim/readbimlayer",rootName:"services/json/bim/rootclassname"}},card:{create:"services/json/management/modcard/updatecard",read:"services/json/management/modcard/getcard",update:"services/json/management/modcard/updatecard",remove:"services/json/management/modcard/deletecard",readAll:"services/json/management/modcard/getcardlist",bulkUpdate:"services/json/management/modcard/bulkupdate",bulkUpdateFromFilter:"services/json/management/modcard/bulkupdatefromfilter",getPosition:"services/json/management/modcard/getcardposition",getSqlCardList:"services/json/management/modcard/getsqlcardlist",lock:"services/json/lock/lockcard",unlock:"services/json/lock/unlockcard",unlockAll:"services/json/lock/unlockall"},classes:{create:"services/json/schema/modclass/savetable",read:"",update:"services/json/schema/modclass/savetable",remove:"services/json/schema/modclass/deletetable",readAll:"services/json/schema/modclass/readall",readById:"services/json/schema/modclass/readbyid",readByName:"services/json/schema/modclass/readbyname",foreignKeyTargetClass:"services/json/schema/modclass/getfktargetingclass"},configuration:{create:"",read:"services/json/schema/setup/getconfiguration",update:"services/json/schema/setup/saveconfiguration",remove:"",apply:"services/json/configure/apply",connectionTest:"services/json/configure/testconnection",dms:{readAllPreset:"services/json/attachments/readpresets"},ui:{read:"services/json/schema/modsecurity/getuiconfiguration"}},csv:{readAll:"services/json/management/importcsv/getcsvrecords",exports:{create:"services/json/management/exportcsv/writecsv",read:"",update:"",remove:"",download:"services/json/management/exportcsv/export"},imports:{create:"services/json/management/importcsv/uploadcsv",read:"services/json/management/importcsv/readcsv",update:"services/json/management/importcsv/storecsvrecords",remove:"",clearSession:"services/json/management/importcsv/clearsession",updateRecords:"services/json/management/importcsv/updatecsvrecords"}},customPage:{readForCurrentUser:"services/json/custompages/readforcurrentuser"},dashboard:{create:"services/json/dashboard/add",read:"",update:"services/json/dashboard/modifybaseproperties",remove:"services/json/dashboard/remove",readAll:"services/json/dashboard/fulllist",readAllVisible:"services/json/dashboard/list",chart:{create:"services/json/dashboard/addchart",read:"services/json/dashboard/getchartdata",update:"services/json/dashboard/modifychart",remove:"services/json/dashboard/removechart",readForPreview:"services/json/dashboard/getchartdataforpreview"},columns:{create:"",read:"",update:"services/json/dashboard/modifycolumns",remove:""}},dataView:{readAll:"services/json/viewmanagement/read",filter:{create:"services/json/viewmanagement/createfilterview",read:"services/json/viewmanagement/readfilterview",update:"services/json/viewmanagement/updatefilterview",remove:"services/json/viewmanagement/deletefilterview",readAll:"services/json/viewmanagement/readfilterview"},sql:{create:"services/json/viewmanagement/createsqlview",read:"services/json/viewmanagement/readsqlview",update:"services/json/viewmanagement/updatesqlview",remove:"services/json/viewmanagement/deletesqlview",readAll:"services/json/viewmanagement/readsqlview"}},domain:{create:"services/json/schema/modclass/savedomain",read:"services/json/schema/modclass/getalldomains",update:"services/json/schema/modclass/savedomain",remove:"services/json/schema/modclass/deletedomain",getDomains:"services/json/schema/modclass/getdomains",readAll:"services/json/schema/modclass/getalldomains",readAllByClass:"services/json/schema/modclass/getdomainlist"},email:{create:"services/json/email/email/create",read:"services/json/email/email/read",update:"services/json/email/email/update",remove:"services/json/email/email/delete",readAll:"services/json/email/email/readall",enabled:"services/json/email/email/enabled",account:{create:"services/json/schema/emailaccount/post",read:"services/json/schema/emailaccount/get",update:"services/json/schema/emailaccount/put",remove:"services/json/schema/emailaccount/delete",readAll:"services/json/schema/emailaccount/getall",setDefault:"services/json/schema/emailaccount/setdefault"},attachment:{create:"services/json/email/attachment/upload",read:"",update:"",remove:"services/json/email/attachment/delete",readAll:"services/json/email/attachment/readall",copy:"services/json/email/attachment/copy",download:"services/json/email/attachment/download"},queue:{read:"services/json/email/queue/configuration",save:"services/json/email/queue/configure",isRunning:"services/json/email/queue/running",start:"services/json/email/queue/start",stop:"services/json/email/queue/stop"},template:{create:"services/json/email/template/create",read:"services/json/email/template/read",update:"services/json/email/template/update",remove:"services/json/email/template/delete",readAll:"services/json/email/template/readall"}},entryType:{readAll:"services/json/schema/modclass/getallclasses",item:{create:"",read:"services/json/management/modcard/getcard",update:"",remove:""}},filter:{defaults:{create:"",read:"services/json/filter/getdefault",update:"services/json/filter/setdefaultsforgroup",remove:""},group:{create:"services/json/filter/create",read:"services/json/filter/readallgroupfilters",update:"services/json/filter/update",remove:"services/json/filter/delete",readAll:"services/json/filter/readallgroupfilters",defaults:{create:"",read:"services/json/filter/getgroups",update:"services/json/filter/setdefaultgroups",remove:""}},user:{create:"",read:"services/json/filter/read",update:"",remove:"",readAll:"services/json/filter/readforuser"}},functions:{readAll:"services/json/schema/modclass/getfunctions",readCards:"services/json/management/modcard/getsqlcardlist"},gis:{expandDomainTree:"services/json/gis/expanddomaintree",getFeatures:"services/json/gis/getfeature",getGeoCardList:"services/json/gis/getgeocardlist",getGISTreeNavigation:"services/json/gis/getgistreenavigation",geoAttribute:{create:"services/json/gis/addgeoattribute",read:"",update:"services/json/gis/modifygeoattribute",remove:"services/json/gis/deletegeoattribute"},geoServer:{layer:{create:"services/json/gis/addgeoserverlayer",read:"",update:"services/json/gis/modifygeoserverlayer",remove:"services/json/gis/deletegeoserverlayer",readAll:"services/json/gis/getgeoserverlayers"}},icons:{create:"services/json/icon/upload",read:"",update:"services/json/icon/update",remove:"services/json/icon/remove",readAll:"services/json/icon/list"},layer:{create:"",read:"services/json/gis/getalllayers",update:"",remove:"",readAll:"services/json/gis/getalllayers",setOrder:"services/json/gis/setlayersorder",setVisibility:"services/json/gis/setlayervisibility"},treeNavigation:{create:"",read:"services/json/gis/getgistreenavigation",update:"services/json/gis/savegistreenavigation",remove:"services/json/gis/removegistreenavigation"}},group:{create:"services/json/schema/modsecurity/savegroup",read:"services/json/schema/modsecurity/getgrouplist",update:"services/json/schema/modsecurity/savegroup",remove:"",readAll:"services/json/schema/modsecurity/getgrouplist",enableDisableGroup:"services/json/schema/modsecurity/enabledisablegroup",user:{readAll:"services/json/schema/modsecurity/getgroupuserlist",save:"services/json/schema/modsecurity/savegroupuserlist"},userInterface:{read:"services/json/schema/modsecurity/getgroupuiconfiguration",save:"services/json/schema/modsecurity/savegroupuiconfiguration"}},history:{classes:{card:{create:"",read:"services/json/management/modcard/getcardhistory",update:"",remove:"",readRelations:"services/json/management/modcard/getrelationshistory",readHistoric:"services/json/management/modcard/gethistoriccard",readHistoricRelation:"services/json/management/modcard/gethistoricrelation"}},workflow:{activity:{create:"",read:"services/json/management/modcard/getprocesshistory",update:"",remove:"",readRelations:"services/json/management/modcard/getrelationshistory",readHistoric:"services/json/management/modcard/gethistoriccard",readHistoricRelation:"services/json/management/modcard/gethistoricrelation"}}},localization:{translation:{create:"",read:"services/json/schema/translation/read",update:"services/json/schema/translation/update",remove:"",readAll:"services/json/schema/translation/readall"},utility:{csv:{exports:"services/json/schema/translation/exportcsv",imports:"services/json/schema/translation/importcsv"}}},lookup:{create:"services/json/schema/modlookup/savelookup",read:"services/json/schema/modlookup/getlookuplist",update:"services/json/schema/modlookup/savelookup",remove:"",readAll:"services/json/schema/modlookup/getlookuplist",readAllParents:"services/json/schema/modlookup/getparentlist",disable:"services/json/schema/modlookup/disablelookup",enable:"services/json/schema/modlookup/enablelookup",setOrder:"services/json/schema/modlookup/reorderlookup",type:{create:"services/json/schema/modlookup/savelookuptype",read:"services/json/schema/modlookup/tree",update:"services/json/schema/modlookup/savelookuptype",remove:"",readAll:"services/json/schema/modlookup/tree"}},menu:{create:"",read:"services/json/schema/modmenu/getassignedmenu",update:"services/json/schema/modmenu/savemenu",remove:"services/json/schema/modmenu/deletemenu",readAvailableItems:"services/json/schema/modmenu/getavailablemenuitems",readConfiguration:"services/json/schema/modmenu/getmenuconfiguration"},navigationTree:{create:"services/json/navigationtree/create",read:"services/json/navigationtree/read",update:"services/json/navigationtree/save",remove:"services/json/navigationtree/remove",readAll:"services/json/navigationtree/get"},patchManager:{update:"services/json/configure/applypatches",readAll:"services/json/configure/getpatches"},privilege:{classes:{update:"services/json/schema/modsecurity/saveclassprivilege",readAll:"services/json/schema/modsecurity/getclassprivilegelist",setRowAndColumnPrivileges:"services/json/schema/modsecurity/setrowandcolumnprivileges",uiConfiguration:{read:"services/json/schema/modsecurity/loadclassuiconfiguration",update:"services/json/schema/modsecurity/saveclassuiconfiguration"}},customPage:{update:"services/json/schema/modsecurity/savecustompageprivilege",readAll:"services/json/schema/modsecurity/getcustompageprivilegelist"},dataView:{update:"services/json/schema/modsecurity/saveviewprivilege",readAll:"services/json/schema/modsecurity/getviewprivilegelist"},filter:{update:"services/json/schema/modsecurity/savefilterprivilege",readAll:"services/json/schema/modsecurity/getfilterprivilegelist"},workflow:{update:"services/json/schema/modsecurity/saveprocessprivilege",readAll:"services/json/schema/modsecurity/getprocessprivilegelist",setRowAndColumnPrivileges:"services/json/schema/modsecurity/setrowandcolumnprivileges"}},relation:{create:"services/json/management/modcard/createrelations",read:"",update:"services/json/management/modcard/modifyrelation",remove:"services/json/management/modcard/deleterelation",readAll:"services/json/management/modcard/getrelationlist",readAlreadyRelatedCards:"services/json/management/modcard/getalreadyrelatedcards",removeDetail:"services/json/management/modcard/deletedetail"},report:{readByType:"services/json/management/modreport/getreportsbytype",readTypesTree:"services/json/management/modreport/getreporttypestree",menuTree:"services/json/schema/modreport/menutree",factory:{create:"services/json/management/modreport/createreportfactory",createByTypeCode:"services/json/management/modreport/createreportfactorybytypecode",print:"services/json/management/modreport/printreportfactory",updateParams:"services/json/management/modreport/updatereportfactoryparams"},jasper:{create:"services/json/management/modreport/createreportfactory",read:"",update:"",remove:"services/json/schema/modreport/deletereport",save:"services/json/schema/modreport/savejasperreport",analyze:"services/json/schema/modreport/analyzejasperreport",imports:"services/json/schema/modreport/importjasperreport",resetSession:"services/json/schema/modreport/resetsession"},print:{cardDetails:"services/json/management/modreport/printcarddetails",classSchema:"services/json/schema/modreport/printclassschema",currentView:"services/json/management/modreport/printcurrentview",schema:"services/json/schema/modreport/printschema",sqlView:"services/json/management/modreport/printsqlview"}},session:{create:"services/json/session/create",update:"services/json/session/update",remove:"services/json/session/delete"},taskManager:{readAll:"services/json/schema/taskmanager/readall",cyclicExecution:"services/json/schema/taskmanager/start",singleExecution:"services/json/schema/taskmanager/execute",stop:"services/json/schema/taskmanager/stop",connector:{create:"services/json/schema/taskmanager/connector/create",read:"services/json/schema/taskmanager/connector/read",update:"services/json/schema/taskmanager/connector/update",remove:"services/json/schema/taskmanager/connector/delete",readAll:"services/json/schema/taskmanager/connector/readall",readSqlSources:"services/json/schema/taskmanager/connector/availablesqlsources"},email:{create:"services/json/schema/taskmanager/reademail/create",read:"services/json/schema/taskmanager/reademail/read",update:"services/json/schema/taskmanager/reademail/update",remove:"services/json/schema/taskmanager/reademail/delete",readAll:"services/json/schema/taskmanager/reademail/readall"},event:{readAll:"services/json/schema/taskmanager/event/readall",asynchronous:{create:"services/json/schema/taskmanager/event/asynchronous/create",read:"services/json/schema/taskmanager/event/asynchronous/read",update:"services/json/schema/taskmanager/event/asynchronous/update",remove:"services/json/schema/taskmanager/event/asynchronous/delete",readAll:"services/json/schema/taskmanager/event/asynchronous/readall"},synchronous:{create:"services/json/schema/taskmanager/event/synchronous/create",read:"services/json/schema/taskmanager/event/synchronous/read",update:"services/json/schema/taskmanager/event/synchronous/update",remove:"services/json/schema/taskmanager/event/synchronous/delete",readAll:"services/json/schema/taskmanager/event/synchronous/readall"}},generic:{create:"services/json/schema/taskmanager/generic/create",read:"services/json/schema/taskmanager/generic/read",update:"services/json/schema/taskmanager/generic/update",remove:"services/json/schema/taskmanager/generic/delete",readAll:"services/json/schema/taskmanager/generic/readall"},workflow:{create:"services/json/schema/taskmanager/startworkflow/create",read:"services/json/schema/taskmanager/startworkflow/read",update:"services/json/schema/taskmanager/startworkflow/update",remove:"services/json/schema/taskmanager/startworkflow/delete",readAll:"services/json/schema/taskmanager/startworkflow/readall",readAllByWorkflow:"services/json/schema/taskmanager/startworkflow/readallbyworkflow"}},user:{create:"services/json/schema/modsecurity/saveuser",read:"services/json/schema/modsecurity/readuser",update:"services/json/schema/modsecurity/saveuser",remove:"",readAll:"services/json/schema/modsecurity/getuserlist",readAllGroups:"services/json/schema/modsecurity/getusergrouplist",disable:"services/json/schema/modsecurity/disableuser",getPosition:"services/json/schema/modsecurity/getuserposition"},utility:{changePassword:"services/json/schema/modsecurity/changepassword"},utils:{clearCache:"services/json/utils/clearcache",generateId:"services/json/utils/generateid",readAllAvailableTranslations:"services/json/utils/listavailabletranslations",readDefaultLanguage:"services/json/utils/getdefaultlanguage"},widget:{create:"services/json/widget/create",read:"services/json/widget/read",update:"services/json/widget/update",remove:"services/json/widget/delete",readAll:"services/json/widget/readall",readAllForClass:"services/json/widget/readallforclass",ping:"services/json/widget/callwidget",webService:"services/json/widget/callwidget"},workflow:{create:"services/json/schema/modclass/savetable",read:"",update:"services/json/schema/modclass/savetable",remove:"services/json/schema/modclass/deletetable",readAll:"services/json/workflow/readall",readById:"services/json/workflow/readbyid",readByName:"services/json/workflow/readbyname",getPosition:"services/json/workflow/getposition",isProcessUpdated:"services/json/workflow/isprocessupdated",synchronize:"services/json/workflow/sync",activity:{create:"services/json/workflow/saveactivity",read:"services/json/workflow/getactivityinstance",update:"services/json/workflow/saveactivity",remove:"",readStart:"services/json/workflow/getstartactivity",abort:"services/json/workflow/abortprocess",lock:"services/json/lock/lockactivity",unlock:"services/json/lock/unlockactivity"},instance:{create:"",read:"services/json/workflow/getinstance",update:"",remove:"",readAll:"services/json/workflow/getinstances"},xpdl:{download:"services/json/workflow/downloadxpdl",downloadTemplate:"services/json/workflow/downloadxpdltemplate",upload:"services/json/workflow/uploadxpdl",versions:"services/json/workflow/xpdlversions"}}}),Ext.define("CMDBuild.proxy.TemplateResolver",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllCard:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)}}),Ext.define("CMDBuild.proxy.Card",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,lock:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.lock}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e,!0)},unlock:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.unlock}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e,!0)},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)},readPosition:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.getPosition}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},remove:function(e){(e=Ext.isEmpty(e)?{}:e).important=!0,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e,!0)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e,!0)}}),Ext.define("CMDBuild.core.constants.FieldWidths",{singleton:!0,LABEL:150,LABEL_LOGIN:100,LABEL_CONFIGURE:250,LABEL_CONFIGURATION:300,STANDARD_BIG_FIELD_ONLY:475,STANDARD_MEDIUM_FIELD_ONLY:150,STANDARD_SMALL_FIELD_ONLY:100,EDITOR_HTML:750,MENU_DROPDOWN:600,ADMINISTRATION_BIG:400,ADMINISTRATION_MEDIUM:300,ADMINISTRATION_SMALL:230,CONFIGURATION_BIG:750,CONFIGURATION_MEDIUM:450,CONFIGURATION_SMALL:400,CONFIGURE_BIG:700,CONFIGURE_MEDIUM:400,CONFIGURE_SMALL:350,STANDARD_BIG:625,STANDARD_MEDIUM:300,STANDARD_SMALL:250}),Ext.define("CMDBuild.view.common.field.CMBaseCombo",{extend:"Ext.form.field.ComboBox",alias:"cmbasecombo",uses:["CMDBuild.core.constants.FieldWidths"],cmGreatestItem:"",initComponent:function(){Ext.applyIf(this,{maxWidth:CMDBuild.core.constants.FieldWidths.STANDARD_BIG}),this.callParent(arguments),this.mon(this.store,"load",function(e,t,i,r){r&&r.add?this._growSizeFix(t||[]):this._growSizeFix()},this),this.mon(this.store,"add",function(e,t){this._growSizeFix(t||[])},this),this.mon(this,"render",function(){this._growSizeFix()},this),this.mon(this,"focus",function(){this._growSizeFixFail&&this._growSizeFix()},this),this.on("blur",function(){this.clearStoreFilteringInSafeMode()},this)},_growSizeFix:function(e){if(this.isVisible(deep=!0)){for(var t,i=e||this.store.getRange(),r=0,s=i.length;r<s;++r)t=i[r].get(this.displayField),this.setGreatestItem(t);this.setSizeLookingTheGreatestItem(),this._growSizeFixFail=!1}else this._growSizeFixFail=!0},setGreatestItem:function(e){this.cmGreatestItem.length<e.length&&(this.cmGreatestItem=e)},getReadableValue:function(){return this.getRawValue()},setSizeLookingTheGreatestItem:function(){if(this.cmGreatestItem&&this.bodyEl){var e=new Ext.util.TextMetrics,t=e.getWidth(this.cmGreatestItem)+"px";this.bodyEl.dom.firstChild.style.width=t,this.bodyEl.dom.style.width=t;var i=e.getWidth(this.cmGreatestItem);this.labelEl&&(i+=this.labelEl.dom.clientWidth);var r=i+this.getTriggersLength()+20;this.setWidth(r),e.destroy()}},getTriggersLength:function(){try{return 20*this.triggerEl.elements.length}catch(e){return 0}},setValue:function(e){this.callParent([this.extractIdIfValueIsObject(e)])},extractIdIfValueIsObject:function(e){return null==e||"object"!=typeof e||Ext.isArray(e)||(e=e[CMDBuild.core.constants.Proxy.ID]),"string"!=typeof e||isNaN(parseInt(e))||(e=parseInt(e)),e},onKeyUp:function(e,t){if(e.isNavKeyPress())return this.callParent(arguments);return""==this.getRawValue()?this.clearStoreFilteringInSafeMode():this.callParent(arguments)},clearStoreFilteringInSafeMode:function(){var e=this.getStore();this.queryFilter.setValue(""),e.filter()}}),Ext.define("CMDBuild.proxy.common.field.multiselect.Group",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.model.common.field.multiselect.Group"],singleton:!0,getStore:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.GROUP,{autoLoad:!0,model:"CMDBuild.model.common.field.multiselect.Group",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.group.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.GROUPS},extraParams:{limitParam:void 0,pageParam:void 0,startParam:void 0}},filters:[function(e){return e.get(CMDBuild.core.constants.Proxy.IS_ACTIVE)}],sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})}}),Ext.define("Ext.ux.form.field.TinyMCE",{extend:"Ext.form.field.TextArea",alias:"widget.tinymcefield",uses:["Ext.ux.form.field.TinyMCEWindowManager"],mixins:{observable:"Ext.util.Observable"},config:{height:170},border:!0,inProgress:!1,lastWidth:0,lastHeight:0,statics:{tinyMCEInitialized:!1,globalSettings:{accessibility_focus:!1,language:"en",mode:"exact",skin:"extjs",theme:"advanced",plugins:"autolink,lists,spellchecker,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",theme_advanced_buttons1:"newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,fontselect,fontsizeselect",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute,|,styleprops,spellchecker,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,blockquote,pagebreak",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resize_horizontal:!1,theme_advanced_resizing:!1,width:"100%"},setGlobalSettings:function(e){Ext.apply(this.globalSettings,e)}},constructor:function(e){this.mixins.observable.constructor.call(this,arguments),e.height=e.height&&e.height>=this.config.height?e.height:this.config.height,Ext.applyIf(e.tinyMCEConfig,this.statics().globalSettings),this.addEvents({editorcreated:!0}),this.callParent([e])},initComponent:function(){var e=this;e.callParent(arguments),e.on("resize",function(t,i,r){i&&r&&(e.lastWidth=i,e.lastHeight=e.editor?r:e.inputEl.getHeight(),e.editor?e.setEditorSize(e.lastWidth,e.lastHeight):e.initEditor())},e)},initEditor:function(){var e=this;e.inProgress||(e.inProgress=!0,e.tinyMCEConfig.elements=e.getInputId(),e.tinyMCEConfig.mode="exact",e.tinyMCEConfig.height=e.lastHeight-5,e.tinyMCEConfig.setup=function(t){t.onInit.add(function(t){e.inProgress=!1,tinymce.dom.Event.add(t.getBody(),"focus",function(t){e.fireEvent("focus",e)}),tinymce.dom.Event.add(t.getBody(),"blur",function(t){e.fireEvent("blur",e),e.fireEvent("change",e)})}),t.onKeyPress.add(Ext.Function.createBuffered(e.validate,250,e)),t.onPostRender.add(function(t){e.editor=t,window.b=e.editor,t.windowManager=new Ext.ux.form.field.TinyMCEWindowManager({editor:e.editor}),e.tableEl=Ext.get(e.editor.id+"_tbl"),e.iframeEl=Ext.get(e.editor.id+"_ifr"),e.edToolbar=e.tableEl.down(".mceToolbar"),e.edStatusbar=e.tableEl.down(".mceStatusbar"),e.border||e.tableEl.setStyle("border","0px"),Ext.Function.defer(function(){e.tableEl.getHeight()!=e.lastHeight-5&&e.setEditorSize(e.lastWidth,e.lastHeight)},10,e),e.fireEvent("editorcreated",e.editor,e)})},Ext.isEmpty(tinymce)||tinymce.init(e.tinyMCEConfig))},setEditorSize:function(e,t){var i=t-2;this.editor&&this.rendered&&(this.edToolbar&&(i-=this.edToolbar.getHeight()),this.edStatusbar&&(i-=this.edStatusbar.getHeight()),this.iframeEl.setHeight(i),this.tableEl.setHeight(t),this.inputEl.setHeight(t))},isDirty:function(){return!(this.disabled||!this.rendered)&&(this.editor&&this.editor.initialized&&this.editor.isDirty())},getValue:function(){return this.editor?this.editor.getContent():this.value},setValue:function(e){var t=this;t.value=e,t.rendered&&t.withEd(function(){t.editor.undoManager.clear(),t.editor.setContent(null===e||void 0===e?"":e),t.editor.startContent=t.editor.getContent({format:"raw"}),t.validate()})},getSubmitData:function(){var e={};return e[this.getName()]=this.getValue(),e},insertValueAtCursor:function(e){this.editor&&this.editor.initialized&&this.editor.execCommand("mceInsertContent",!1,e)},onDestroy:function(){this.editor&&this.editor.destroy(),this.callParent(arguments)},getEditor:function(){return this.editor},getRawValue:function(){return this.editor&&this.editor.initialized?this.editor.getContent():Ext.valueFrom(this.value,"")},disable:function(){var e=this;return e.withEd(function(){var t=e.editor;tinymce.each(t.controlManager.controls,function(e){e.setDisabled(!0)}),tinymce.dom.Event.clear(t.getBody()),tinymce.dom.Event.clear(t.getWin()),tinymce.dom.Event.clear(t.getDoc()),tinymce.dom.Event.clear(t.formElement),t.onExecCommand.listeners=[],e.iframeEl.addCls("x-form-field x-form-text")}),e.callParent(arguments)},enable:function(){var e=this;return e.withEd(function(){var t=e.editor;t.bindNativeEvents(),tinymce.each(t.controlManager.controls,function(e){e.setDisabled(!1)}),t.nodeChanged(),e.iframeEl.removeCls("x-form-field x-form-text")}),e.callParent(arguments)},withEd:function(e){var t=this;t.editor?t.editor.initialized?e.call(t):t.editor.onInit.add(Ext.Function.bind(function(){Ext.Function.defer(e,10,t)},t)):t.on("editorcreated",function(){t.withEd(e)},t)},validateValue:function(e){if(Ext.isFunction(this.validator)){var t=this.validator(e);if(!0!==t)return this.markInvalid(t),!1}if(e.length<1||e===this.emptyText)return this.allowBlank?(this.clearInvalid(),!0):(this.markInvalid(this.blankText),!1);if(e.length<this.minLength)return this.markInvalid(Ext.String.format(this.minLengthText,this.minLength)),!1;if(this.clearInvalid(),e.length>this.maxLength)return this.markInvalid(Ext.String.format(this.maxLengthText,this.maxLength)),!1;if(this.clearInvalid(),this.vtype){var i=Ext.form.field.VTypes;if(!i[this.vtype](e,this))return this.markInvalid(this.vtypeText||i[this.vtype+"Text"]),!1}return!(this.regex&&!this.regex.test(e))||(this.markInvalid(this.regexText),!1)}}),Ext.define("CMDBuild.view.common.field.CMErasableCombo",{extend:"CMDBuild.view.common.field.CMBaseCombo",alias:"cmerasablecombo",trigger1cls:Ext.form.field.ComboBox.triggerCls,trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",hideTrigger1:!1,hideTrigger2:!1,onTrigger1Click:Ext.form.field.ComboBox.prototype.onTriggerClick,onTrigger2Click:function(){this.disabled||this.setValue([""])}}),function(){function e(){this.setValue([""])}Ext.define("CMDBuild.view.common.field.SearchableCombo",{extend:"CMDBuild.view.common.field.CMBaseCombo",uses:["CMDBuild.proxy.Card"],trigger1Cls:Ext.baseCSSPrefix+"form-arrow-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",trigger3Cls:Ext.baseCSSPrefix+"form-search-trigger",hideTrigger1:!1,hideTrigger2:!1,hideTrigger3:!1,gridExtraConfig:{},searchWindowReadOnly:!1,initComponent:function(){this.labelAlign="right",this.callParent(arguments)},searchWindow:null,onTrigger1Click:function(){function e(){this.storeIsLargerThenLimit()?this.onTrigger3Click():this.onTriggerClick()}this.store.isLoading()?this.store.on("load",e,this,{single:!0}):e.call(this)},onTrigger2Click:function(){this.disabled||(e.call(this),this.focus(),this.blur())},onTrigger3Click:function(e){"string"!=typeof e&&(e=""),this.createSearchWindow(e)},storeIsLargerThenLimit:function(){return null!==this.store&&this.store.getTotalCount()>CMDBuild.configuration.instance.get("referenceComboStoreLimit")},createSearchWindow:function(e){if(!this.disabled&&!this.searchWindow){var t=Ext.Function.bind(this.buildSearchWindow,this,[this.store.baseParams,e],!0),i=this.store.baseParams.IdClass;if(!i){var r=this.store.baseParams.className;if(r){var s=_CMCache.getEntryTypeByName(r);s&&(i=s.get("id"))}}i&&CMDBuild.Management.FieldManager.loadAttributes(i,t)}},buildSearchWindow:function(e,t,i){var r=Ext.apply({},t);delete r.NoFilter,this.searchWindow=new CMDBuild.Management.ReferenceSearchWindow({ClassName:this.store.baseParams.className,selModel:new CMDBuild.selection.CMMultiPageSelectionModel({mode:"SINGLE",idProperty:"Id"}),extraParams:r,gridConfig:this.gridExtraConfig||{},readOnly:this.searchWindowReadOnly,searchFieldValue:i}),this.searchWindow.on("cmdbuild-referencewindow-selected",function(e){this.addToStoreIfNotInIt(e),this.focus(),this.setValue(e.get("Id")),this.fireEvent("cmdbuild-reference-selected",e,this)},this),this.searchWindow.on("close",function(){this.searchWindow&&(this.searchWindow.destroy(),delete this.searchWindow)},this),this.searchWindow.on("destroy",function(){this.searchWindow&&delete this.searchWindow},this),this.searchWindow.show()},addToStoreIfNotInIt:function(e){var t=e.get("Id");if(this.getStore()&&-1==this.getStore().find("Id",t)){var i=Ext.apply({cardId:t},this.getStore().baseParams);CMDBuild.proxy.Card.read({params:i,loadMask:!1,scope:this,success:function(e,i,r){-1==this.getStore().find("Id",t)&&this.getStore().add({Id:t,Description:r.card.Description}),this.setValue(t),this.validate()}})}},recordDescriptionFixedForCarriageReturnBugOnComboBoxes:function(e){try{return e.get("Description").replace(/\n/g," ")}catch(e){_error("CMDBuild.view.common.field.SearchableCombo recordDescriptionFixedForCarriageReturnBugOnComboBoxes error",e)}},onKeyUp:function(){this.storeIsLargerThenLimit()?this.onTrigger3Click(this.getRawValue()):this.callParent(arguments)},reset:e})}(),Ext.define("CMDBuild.core.window.AbstractModal",{extend:"Ext.window.Window",autoHeight:!1,autoWidth:!1,defaultSize:.8,buttonAlign:"center",constrain:!0,layout:"fit",modal:!0,resizable:!0,initComponent:function(){if(!this.autoHeight){var e,t=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.POPUP_HEIGHT_PERCENTAGE);e=t?t/100:this.defaultSize,this.height=Ext.getBody().getHeight()*e}if(this.autoWidth)this.width=660;else{var i,r=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.POPUP_WIDTH_PERCENTAGE);i=r?r/100:this.defaultSize,this.width=Ext.getBody().getWidth()*i}this.callParent(arguments)}}),function(){Ext.define("CMDBuild.view.management.common.CMCardListWindow",{extend:"CMDBuild.core.window.AbstractModal",ClassName:void 0,idClass:void 0,filterType:void 0,readOnly:void 0,selModel:void 0,selType:"rowmodel",multiSelect:!1,extraParams:{},gridConfig:{},initComponent:function(){if(void 0===this.idClass&&void 0===this.ClassName)throw"There are no Class Id or Class Name to load";this.title=CMDBuild.Translation.management.modcard.title+function(e){var t=_CMCache.getEntryTypeById(e.getIdClass()),i="";return t&&(i=t.getDescription()),i}(this),this.grid=new CMDBuild.view.management.common.CMCardGrid(this.buildGrdiConfiguration()),this.setItems(),this.callParent(arguments),this.mon(this.grid.getSelectionModel(),"selectionchange",this.onSelectionChange,this),this.mon(this.grid,"itemdblclick",this.onGridDoubleClick,this)},show:function(){this.callParent(arguments);var e=this.getIdClass();return this.grid.updateStoreForClassId(e),this},setItems:function(){this.items=[this.grid],this.readOnly||"class"!=_CMCache.getEntryTypeById(this.getIdClass()).get("type")||(this.tbar=[this.addCardButton=this.buildAddButton()])},buildAddButton:function(){var e=Ext.create("CMDBuild.core.buttons.iconized.split.add.Card"),t=_CMCache.getEntryTypeById(this.getIdClass());return e.updateForEntry(t),this.mon(e,"cmClick",function(e){var t=new CMDBuild.view.management.common.CMCardWindow({withButtons:!0,title:e.className});new CMDBuild.controller.management.common.CMCardWindowController(t,{cmEditMode:!0,card:null,entryType:e.classId}),t.show(),this.mon(t,"destroy",function(){this.grid.reload()},this)},this),e},getIdClass:function(){if(this.idClass)return this.idClass;var e=_CMCache.getEntryTypeByName(this.ClassName);if(e)return e.getId();throw"No class info for "+Ext.getClassName(this)},buildGrdiConfiguration:function(){var e=Ext.apply(this.gridConfig,{cmAdvancedFilter:!1,columns:[],CQL:this.extraParams,frame:!1,border:!1,selType:this.selType,multiSelect:this.multiSelect});return void 0===this.selModel?e.selType=this.selType:e.selModel=this.selModel,e},onSelectionChange:Ext.emptyFn,onGridDoubleClick:Ext.emptyFn})}(),Ext.define("CMDBuild.core.templateResolver.Utils",{uses:["CMDBuild.core.constants.TemplateResolver"],singleton:!0,hasTemplatesForStrings:function(e){return!Ext.Array.every(CMDBuild.core.constants.TemplateResolver.getTemplateList(),function(t,i,r){return e.indexOf(t)<0},this)},hasTemplates:function(e){switch(Ext.typeOf(e)){case"array":case"object":return CMDBuild.core.templateResolver.Utils.hasTemplatesForStrings(Ext.encode(e));case"string":return CMDBuild.core.templateResolver.Utils.hasTemplatesForStrings(e);default:return _error("hasTemplates(): unmanaged target type",this,e)}}}),Ext.define("CMDBuild.proxy.Filter",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,create:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.group.create}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.group.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.groupStore}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.group.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.group.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)},newGroupStore:function(e){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!0,model:"CMDBuild.model.CMFilterModel",pageSize:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),proxy:{url:CMDBuild.proxy.index.Json.filter.group.readAll,type:"ajax",reader:{root:"filters",type:"json",totalProperty:"count"},extraParams:{className:e}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},newUserStore:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!1,model:"CMDBuild.model.CMFilterModel",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.filter.user.readAll,reader:{type:"json",idProperty:CMDBuild.core.constants.Proxy.ID,root:CMDBuild.core.constants.Proxy.FILTERS}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},newSystemStore:function(e){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!0,model:"CMDBuild.model.CMFilterModel",pageSize:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),proxy:{url:CMDBuild.proxy.index.Json.filter.group.read,type:"ajax",reader:{type:"json",root:CMDBuild.core.constants.Proxy.FILTERS,totalProperty:CMDBuild.core.constants.Proxy.COUNT},extraParams:{className:e}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})}}),Ext.define("CMDBuild.proxy.dashboard.Chart",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,create:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.chart.create}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.chart.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e)},readForPreview:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.chart.readForPreview}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.chart.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.chart.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)}}),Ext.define("CMDBuild.view.management.common.widgets.CMWidgetsWindow",{extend:"CMDBuild.core.window.AbstractModal",delegate:void 0,initComponent:function(){this.widgetsToAdd={},this.widgetsContainer=new Ext.panel.Panel({layout:"card",activeItem:0,hideMode:"offsets",border:!1,frame:!1,items:[{}]});var e=this;Ext.apply(this,{items:[this.widgetsContainer],buttonAlign:"center",buttons:[{text:CMDBuild.Translation.close,_cmNotRemoveMe:!0,handler:function(){e.onWidgetsWindowHide(),e.hide()}}]}),this.callParent(arguments)},listeners:{close:function(e,t){Ext.isFunction(e.onWidgetsWindowHide)&&e.onWidgetsWindowHide()},hide:function(e,t){Ext.isFunction(e.onWidgetsWindowHide)&&e.onWidgetsWindowHide()}},onWidgetsWindowHide:function(){Ext.isEmpty(this.delegate)||Ext.isEmpty(this.currentWidget.delegate)||this.delegate.beforeHideView(this.currentWidget.delegate)},showWidget:function(e,t){if(this.currentWidget=e,this.setTitle(t),this.show(),this.widgetsToAdd[e.id]&&(this.widgetsContainer.add(e),delete this.widgetsToAdd[e.id]),this.widgetsContainer.layout.setActiveItem(e.id),this.removeExtraButtons(),e.getExtraButtons){var i=e.getExtraButtons();this.addExtraButtons(i)}e.buttonLabel&&this.setTitle(e.buttonLabel)},addWidgt:function(e){this.widgetsToAdd[e.id]=e},destroy:function(){CMDBuild.clearComponent(this.widgetsContainer),delete this.widgetsToAdd,this.callParent(arguments)},addExtraButtons:function(e){var t=this.getButtonBar();t&&t.insert(0,e)},removeExtraButtons:function(){var e=this.getButtonBar();e&&e.items.each(function(t){t._cmNotRemoveMe||e.remove(t)})},getButtonBar:function(){for(var e=this.getDockedItems(),t=0,i=e.length;t<i;++t){var r=e[t];if("bottom"==r.dock)return r}return null},close:function(){this.hide()}}),Ext.define("CMDBuild.view.management.common.widgets.CMWidgetsWindowPopup",{extend:"CMDBuild.view.management.common.widgets.CMWidgetsWindow",defaultSizeW:.9,defaultSizeH:.8,initComponent:function(){this.callParent(arguments),this.height=this.height*this.defaultSizeH,this.width=this.width*this.defaultSizeW}}),function(){function e(e,t,i,r,s,o){this.callDelegates("onCMCardGridIconRowClick",[e,s.target.className,t])}Ext.define("CMDBuild.view.management.common.CMCardGridDelegate",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],onCMCardGridSelect:function(e,t){},onCMCardGridDeselect:function(e,t){},onCMCardGridBeforeLoad:function(e){},onCMCardGridLoad:function(e){},onCMCardGridColumnsReconfigured:function(e){},onCMCardGridIconRowClick:function(e,t,i){}}),Ext.define("CMDBuild.view.management.common.CMCardGridPagingBar",{extend:"Ext.toolbar.Paging",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],grid:void 0,doRefresh:function(e){if(this.grid){var t=this.grid.getSelectionModel();t&&t.deselectAll()}return this.callOverridden(arguments)}}),Ext.define("CMDBuild.view.management.common.CMCardGrid",{extend:"Ext.grid.Panel",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.core.constants.Global"],mixins:{delegable:"CMDBuild.core.CMDelegable"},delegate:void 0,controllerAdvancedFilterButtons:void 0,CLASS_COLUMN_DATA_INDEX:"IdClass_value",columns:[],extraParams:void 0,forceSelectionOfFirst:!1,skipSelectFirst:!1,cmPaginate:!0,cmBasicFilter:!0,cmAdvancedFilter:!0,cmAddGraphColumn:!0,cmAddPrintButton:!0,constructor:function(e){this.mixins.delegable.constructor.call(this,"CMDBuild.view.management.common.CMCardGridDelegate"),this.callParent(arguments)},initComponent:function(){this.loadMask=!1,this.store=this.getStoreForFields([]),this.cmPaginate&&function(e){var t=[];e.cmBasicFilter&&(e.gridSearchField=new CMDBuild.field.GridSearchField({grid:e}),t.push(e.gridSearchField)),e.cmAdvancedFilter&&(e.controllerAdvancedFilterButtons=Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.filter.advanced.Advanced",{masterGrid:e}),_CMUtils.forwardMethods(e,e.controllerAdvancedFilterButtons.getView(),["enableClearFilterButton","disableClearFilterButton","setFilterButtonLabel"]),t.push(e.controllerAdvancedFilterButtons.getView())),e.cmAddPrintButton&&(e.printGridMenu=Ext.create("CMDBuild.core.buttons.iconized.split.Print",{formatList:[CMDBuild.core.constants.Proxy.PDF,CMDBuild.core.constants.Proxy.CSV],mode:"legacy",disabled:!0}),t.push(e.printGridMenu)),e.pagingBar=new CMDBuild.view.management.common.CMCardGridPagingBar({grid:e,store:e.store,displayInfo:!0,displayMsg:"{0} - {1} "+CMDBuild.Translation.of+" {2}",emptyMsg:CMDBuild.Translation.noTopicsToDisplay,items:t}),e.bbar=e.pagingBar}(this),this.viewConfig={stripeRows:!0,autoScroll:!1,overflowX:"hidden",overflowY:"auto"},this.layout={type:"fit",reserveScrollbar:!0},this.callParent(arguments),this.mon(this,"beforeitemclick",e,this),this.mon(this,"select",function(e,t){this.callDelegates("onCMCardGridSelect",[e,t])},this),this.mon(this,"deselect",function(e,t){this.callDelegates("onCMCardGridDeselect",[e,t])},this),this.on("columnhide",function(e,t,i){this.getStore().reload()},this),this.on("columnshow",function(e,t,i){this.getStore().reload()},this)},shouldSelectFirst:function(){var e=this.forceSelectionOfFirst&&!this.skipSelectFirst;return this.skipSelectFirst=!1,e},skipNextSelectFirst:function(){this.skipSelectFirst=!0},updateStoreForClassId:function(e,t){var i=this;this.loadAttributes(e,function(r){function s(e){t&&t.cb?t.cb.call(t.scope||e):e.store.loadPage(1)}i.currentClassId==e?s(i):(i.currentClassId=e,i.gridSearchField&&i.gridSearchField.setValue(""),i.cmAdvancedFilter&&i.controllerAdvancedFilterButtons.cmfg("entryTypeSet",{value:_CMCache.getEntryTypeById(e).getData()}),i.printGridMenu&&i.printGridMenu.setDisabled(!e),i.setColumnsForClass(r),i.setGridSorting(r),s(i))})},loadAttributes:function(e,t){_CMCache.getAttributeList(e,t)},loadPage:function(e,t){t=t||{},scope=t.scope||this,cb=t.cb||function(e){e[2]||CMDBuild.core.Message.error(null,{text:CMDBuild.Translation.errors.anErrorHasOccurred})},this.mon(this,"load",cb,scope,{single:!0}),this.getStore().loadPage(Math.floor(e))},reload:function(e){e=Ext.isBoolean(e)&&e,this.getStore().load({scope:this,callback:function(t,i,r){if(r&&(i.start>0&&Ext.isEmpty(t)&&this.loadPage(1),e))if(this.getSelectionModel().hasSelection()){var s=this.getStore().findRecord("Id",this.getSelectionModel().getSelection()[0].get("Id"));Ext.isEmpty(s)||this.getSelectionModel().select(s)}else this.getSelectionModel().select(0)}})},getVisibleColumns:function(){for(var e=this.columns,t=[],i=0,r=e.length;i<r;i++){var s=e[i];if(!s.hidden&&s.dataIndex&&"Id"!=s.dataIndex){var o=s.dataIndex;if(o){var a=o.lastIndexOf("_value");a>=0&&(o=o.slice(0,a)),t.push(o)}}}return t},setColumnsForClass:function(e){var t=this.buildColumnsForAttributes(e),i=this.getStoreForFields(t.fields);this.suspendLayouts(),this.reconfigure(i,t.headers),this.resumeLayouts(!0),this.pagingBar&&this.pagingBar.bindStore(i),this.callDelegates("onCMCardGridColumnsReconfigured",this)},buildColumnsForAttributes:function(e){this.classAttributes=e;var t=[],i=[];_CMUtils.isSuperclass(this.currentClassId)&&t.push(this.buildClassColumn());for(var r=0;r<e.length;r++){var s=e[r],o=CMDBuild.Management.FieldManager.getHeaderForAttr(s);o&&o.dataIndex!=this.CLASS_COLUMN_DATA_INDEX?(this.addRendererToHeader(o),t.push(o),i.push(o.dataIndex)):"Description"==s.name&&i.push("Description")}return t=t.concat(this.buildExtraColumns()),this.cmAddGraphColumn&&CMDBuild.configuration.graph.get(CMDBuild.core.constants.Proxy.ENABLED)&&function(e){var t=_CMCache.getClassById(this.currentClassId);!Ext.isEmpty(t)&&t.get("tableType")!=CMDBuild.core.constants.Global.getTableTypeSimpleTable()&&Ext.isArray(e)&&e.push(Ext.create("Ext.grid.column.Action",{align:"center",width:30,sortable:!1,hideable:!1,menuDisabled:!0,fixed:!0,items:[Ext.create("CMDBuild.core.buttons.iconized.Graph",{withSpacer:!0,tooltip:CMDBuild.Translation.openRelationGraph,scope:this,handler:function(e,t,i,r,s,o,a){Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.graph.Window",{parentDelegate:this,classId:o.get("IdClass"),cardId:o.get("id")})}})]}))}.call(this,t),{headers:t,fields:i}},setGridSorting:function(e){if(this.store.sorters){this.store.sorters.clear();for(var t=[],i=0,r=e.length;i<r;++i){var s=e[i],o={},a=s.classOrderSign*s.absoluteClassOrder;0!=a&&(o.property=s.name,a>0?o.direction="ASC":(o.direction="DESC",a=-a),t[a]=o)}for(i=0,r=t.length;i<r;++i){(o=t[i])&&this.store.sorters.add(o)}}},addRendererToHeader:function(e){e.renderer=function(t,i,r,s,o,a,n){return void 0===(t=t||r.get(e.dataIndex))||null==t?"":("object"==typeof t?t=t.description:"boolean"==typeof t?t=t?Ext.MessageBox.buttonText.yes:Ext.MessageBox.buttonText.no:"string"==typeof t&&(t=Ext.util.Format.stripTags(t)),t)}},getStoreForFields:function(e){var t=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),i=this.buildStore(e,t);return this.mon(i,"beforeload",function(e,t){this.callDelegates("onCMCardGridBeforeLoad",this),this.fireEvent("beforeload",arguments);var i=this.getStore().getProxy().extraParams;return!(!Ext.isObject(i)||Ext.Object.isEmpty(i)||!Ext.isString(i[CMDBuild.core.constants.Proxy.CLASS_NAME])||Ext.isEmpty(i[CMDBuild.core.constants.Proxy.CLASS_NAME]))&&(i[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(this.getVisibleColumns()),!0)},this),this.mon(i,"load",function(e,t){if(this.callDelegates("onCMCardGridLoad",this),this.fireEvent("load",arguments),this.shouldSelectFirst()&&!this.getSelectionModel().hasSelection()&&t&&t.length>0)try{this.getSelectionModel().select(0)}catch(e){this.fireEvent("cmWrongSelection"),CMDBuild.log.info("Not selected the first record"),_trace()}},this),i},buildStore:function(e,t){return e.push({name:"Id",type:"int"}),e.push({name:"IdClass",type:"int"}),e.push(this.CLASS_COLUMN_DATA_INDEX),CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!1,fields:e,pageSize:t,remoteSort:!0,proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.card.readAll,reader:{type:"json",root:"rows",totalProperty:"results",idProperty:"Id"},extraParams:this.getStoreExtraParams()}})},getStoreExtraParams:function(){var e={className:""};return this.currentClassId&&(e.className=_CMCache.getEntryTypeNameById(this.currentClassId)),this.CQL&&((e=Ext.apply(e,this.CQL)).filter=Ext.encode(this.CQL)),e},buildExtraColumns:function(){return[]},buildClassColumn:function(){return{header:CMDBuild.Translation.subClass,width:100,sortable:!1,dataIndex:this.CLASS_COLUMN_DATA_INDEX}},disableFilterMenuButton:function(){this.cmAdvancedFilter&&this.controllerAdvancedFilterButtons.getView().disable()},enableFilterMenuButton:function(){this.cmAdvancedFilter&&this.controllerAdvancedFilterButtons.getView().enable()},applyFilterToStore:function(e){try{var t=e;"string"!=typeof t&&(t=Ext.encode(e)),this.getStore().proxy.extraParams.filter=t}catch(t){_debug("I'm not able to set the filter to the store",this,e)}}})}(),Ext.define("CMDBuild.proxy.management.classes.tabs.MasterDetail",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllClasses:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.classes.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CLASS,e)},readForeignKeyTargetingClass:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.classes.foreignKeyTargetClass}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CLASS,e)}}),Ext.define("CMDBuild.proxy.gis.Gis",{uses:["CMDBuild.core.configurations.Timeout","CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,configurationRead:function(e){(e=Ext.isEmpty(e)?{}:e).params=Ext.isObject(e.params)?e.params:{},e.params[CMDBuild.core.constants.Proxy.NAME]="gis",Ext.apply(e,{url:CMDBuild.proxy.index.Json.configuration.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CONFIGURATION,e)},configurationUpdate:function(e){(e=Ext.isEmpty(e)?{}:e).params=Ext.isObject(e.params)?e.params:{},e.params[CMDBuild.core.constants.Proxy.NAME]="gis",Ext.apply(e,{url:CMDBuild.proxy.index.Json.configuration.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CONFIGURATION,e,!0)},expandDomainTree:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{timeout:CMDBuild.core.configurations.Timeout.getGisTreeExpand(),url:CMDBuild.proxy.index.Json.gis.expandDomainTree}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.GIS,e)},getFeature:function(e){null!=(e=Ext.isEmpty(e)?{}:e).params.cardId&&null!=e.params.className&&(Ext.apply(e,{url:CMDBuild.proxy.index.Json.gis.getFeatures}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.GIS,e))}}),Ext.define("CMDBuild.proxy.Relation",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,create:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.create}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e,!0)},getAlreadyRelatedCards:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.readAlreadyRelatedCards}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e)},getCards:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e,!0)},removeDetail:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.removeDetail}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e,!0)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e,!0)}}),Ext.define("CMDBuild.proxy.management.classes.tabs.Note",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e,!0)}}),Ext.define("CMDBuild.controller.management.classes.map.CardGrid",{extend:"CMDBuild.controller.common.abstract.Base",uses:["CMDBuild.view.management.classes.map.CardGrid"],parentDelegate:void 0,cmfgCatchedFunctions:["onCardNavigation","onCardZoom"],view:void 0,constructor:function(e){this.callParent(arguments),this.view=Ext.create("CMDBuild.view.management.classes.map.CardGrid",{delegate:this,title:e.title,interactionDocument:this.interactionDocument,mainGrid:this.mainGrid})},onCardNavigation:function(e){e.id||(e.id=e.Id),CMDBuild.global.controller.MainViewport.cmfg("mainViewportCardSelect",e)},onCardZoom:function(e){this.interactionDocument.centerOnCard(e,function(){},this)}}),Ext.define("CMDBuild.controller.management.classes.map.LayerTree",{extend:"CMDBuild.controller.common.abstract.Base",uses:["CMDBuild.view.management.classes.map.LayerTree"],parentDelegate:void 0,cmfgCatchedFunctions:["onVisibilityChange"],view:void 0,map:void 0,constructor:function(e){this.callParent(arguments),this.view=Ext.create("CMDBuild.view.management.classes.map.LayerTree",{delegate:this,title:e.title,interactionDocument:this.interactionDocument})},onVisibilityChange:function(e){this.interactionDocument.setLayerVisibility(e.layer,e.checked),this.interactionDocument.changed()}}),function(){function e(e,t){t.parentNode&&t.parentNode.childNodes.length>CMDBuild.gis.constants.navigation.LIMIT_SELECTION&&(t=parentNode);var i=Ext.Function.createDelayed(function(){!function(e){try{var t=e.getSelectionModel();if(t){t.deselectAll(!0)}}catch(e){_debug("ERROR deselecting the CardBrowserTree",e)}}(e);var i=Ext.get(e.view.getNode(t));i&&i.scrollIntoView(e.view.el,!1,!1),function(e,t){if(!t)return;try{var i=e.getSelectionModel();i&&(i.suspendEvents(),i.select(t),i.resumeEvents())}catch(e){_debug("ERROR selecting the CardBrowserTree",e)}}(e,t)},500),r=t.getPath();e.selectPath(r,void 0,void 0,i)}function t(e,t){if(!e||!t)return Number.MAX_SAFE_INTEGER;var i=new ol.geom.LineString([e,t]);return Math.round(100*i.getLength())/100}Ext.define("CMDBuild.view.management.classes.map.navigationTree.ViewTree",{extend:"Ext.tree.Panel",oldCard:void 0,initialized:!1,active:void 0,delegate:void 0,abstractTree:void 0,cache:{},blockedExpanding:void 0,constructor:function(){this.callParent(arguments)},initComponent:function(){this.activationCount=0;var e=this;this.columns=[{xtype:"treecolumn",flex:2,sortable:!1,dataIndex:"text",menuDisabled:!0},{width:40,menuDisabled:!0,xtype:"actioncolumn",tooltip:CMDBuild.Translation.management.modcard.open_relation,align:"center",sortable:!1,icon:"images/icons/bullet_go.png",handler:function(t,i,r,s,o,a,n){""!==a.get("className")&&e.navigateOnCard(a)},isDisabled:function(e,t,i,r,s){return!1}}],this.abstractTree=Ext.create("CMDBuild.view.management.classes.map.navigationTree.AbstractTree"),this.abstractTree.setInteractionDocument(this.interactionDocument),this.concreteTree=Ext.create("CMDBuild.view.management.classes.map.navigationTree.ConcreteTree"),this.concreteTree.setInteractionDocument(this.interactionDocument),this.concreteTree.setAbstractTree(this.abstractTree),this.interactionDocument.observe(this),this.interactionDocument.observeCard(this),this.mon(this,"deactivate",function(e){this.active=!1},this),this.mon(this,"activate",function(t,i,r){if(this.active=!0,!0!==this.initialized)this.initialized=!0,this.setRootNode({loading:!0,text:CMDBuild.Translation.common.loading}),this.abstractTree.load(function(){var t=this.concreteTree.getRootNode();e.setRootNode(t);this.setSubjects(function(){this.cacheNodes(e.getRootNode().childNodes),e.loaded()},this)},this);else{var s=this.interactionDocument.getCurrentCard();s&&this.showCard(s,!0)}},this),this.mon(this,"beforeitemexpand",function(t,i){t.get("className");return this.blockedExpanding||(this.unloadExcess(),e.populateNode(t,function(){this.cacheNodes(t.childNodes)},e)),!0},this),this.mon(this,"checkchange",function(e,t){this.concreteTree.check(e,t),this.interactionDocument.changedNavigables(),this.interactionDocument.changed(),this.resetChecksBlocking(this.getRootNode())},this),this.callParent(arguments)},addDelegate:function(e){this.delegate=e},refresh:function(){setTimeout(this._refresh(),10)},cacheNodes:function(e){for(var t=0;t<e.length;t++){var i=e[t],r=i.get("className"),s=i.get("cardId");this.cache[r]||(this.cache[r]={}),this.cache[r][s]=i}},refreshCard:function(){this.oldCard=null;var e=this.interactionDocument.getCurrentCard();this.deleteFromCache(e.className,e.cardId)},_refresh:function(){var e=this.interactionDocument.getCurrentCard();if(e&&-1!==e.cardId&&(!this.oldCard||this.oldCard.className!==e.className||this.oldCard.cardId!=e.cardId)){var t=!this.oldCard;this.oldCard=e,this.showCard(e,t)}},showCard:function(t,i){var r={properties:{master_className:t.className,master_card:t.cardId}};this.concreteTree.changeCard(t,function(){this.concreteTree.loadFeatures([r],function(){if(this.concreteTree.getRootClass()===t.className){var r=this.concreteTree.getBaseNodes(),s=this.getRootNode();return this.removeAllChildren(s),void this.appendChildren(s,r)}var o=this.concreteTree.getCardPath(t);this.blockedExpanding=!0,this.unloadExcess(),this.populatePath(o,function(){var r=this.getFromCache(t.className,t.cardId);r&&(this.concreteTree.check(r,!0),this.resetChecksBlocking(this.getRootNode()),this.active&&e(this,r)),i&&this.interactionDocument.changedNavigables(),this.blockedExpanding=!1},this)},this)},this)},isANavigableCard:function(e){return this.concreteTree.isANavigableCard(e)},isANavigableClass:function(e){return this.abstractTree.classControlledByNavigation(e)},checkCard:function(e){this.showCard(e,!0)},unloadExcess:function(){if(this.countLeafsOnTree()>CMDBuild.gis.constants.navigation.MAX_VIEW_TREE_NODES){var e=this.interactionDocument.getMapCenter(),i=this.concreteTree.getBaseNodes(),r=[e[0]+(e[2]-e[0])/2,e[1]+(e[3]-e[1])/2],s=[];this.getPositionedSubjects(i,0,s,function(){!function(e,i){for(var r=0;r<i.length;r++){var s=i[r].position;i[r].distance=t(s,e)}}(r,s),function(e){for(var t=!0,i=0;!0===t;){t=!1,i++;for(var r=0;r<e.length-i;r++){var s=e[r],o=e[r+1];s.distance>o.distance&&(e[r]=o,e[r+1]=s,t=!0)}}}(s),this.deleteFarSubjects(s)},this)}},getPositionedSubjects:function(e,t,i,r,s){if(t>=e.length)r.apply(s,[]);else{var o=e[t];t++;var a={cardId:o.get("cardId"),className:o.get("className"),description:o.get("text")};this.interactionDocument.getPosition(a,function(o){i.push({position:o,card:a}),this.getPositionedSubjects(e,t,i,r,s)},this)}},setSubjects:function(e,t){this.concreteTree.expandRoot(function(){var i=this.concreteTree.getBaseNodes(),r=this.getRootNode();this.appendChildren(r,i),e.apply(t,[])},this)},loaded:function(){this.interactionDocument.setStarted(!0)},appendChildren:function(e,t){t=this.orderChildren(t);Ext.suspendLayouts(),this.removeAllChildren(e);for(var i=0;i<t.length;i++){var r=t[i];newNode=e.appendChild(r);newNode.get("leaf")||newNode.appendChild(this.concreteTree.getEmptyNode())}Ext.resumeLayouts()},orderChildren:function(e){function t(e,t){var i=e.get("leaf"),r=t.get("leaf");if(i&&!r)return!0;if(i===r){return e.get("text")>t.get("text")}return!1}for(var i=!0,r=1;i;){i=!1;for(var s=0;s<e.length-r;s++)if(t(e[s],e[s+1])){var o=e[s];e[s]=e[s+1],e[s+1]=o,i=!0}r+=1}return e},removeAllChildren:function(e){for(;e.hasChildNodes();)e.removeChild(e.childNodes[0])},removeEmptyNode:function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(i.get("className")===CMDBuild.gis.constants.navigation.THE_EMPTY_NODE){e.removeChild(i);break}}},resetChecksBlocking:function(e){Ext.suspendLayouts(),this.resetChecks(e),Ext.resumeLayouts()},resetChecks:function(e){var t=e.get("className");if(t!==CMDBuild.gis.constants.navigation.THE_EMPTY_NODE){for(var i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];this.resetChecks(r)}var s={cardId:e.get("cardId"),className:t};e.set("checked",this.concreteTree.isANavigableCard(s))}},navigateOnCard:function(e){var t=e.get("className");e.get("cardId");this.concreteTree.check(e,!0),this.resetChecksBlocking(this.getRootNode());var i=this.interactionDocument.getEntryTypeByName(t);if(i){var r=i.get("id");this.delegate.onCardNavigation({Id:e.get("cardId"),IdClass:r})}},populatePath:function(e,t,i){if(0!==e.length){var r=e.pop(),s=this.getFromCache(r.className,r.cardId);s?this.populateNode(s,function(){this.populatePath(e,t,i)},this):t.apply(i,[])}else t.apply(i,[])},getFromCache:function(e,t){if(!this.cache[e]){for(var i in this.cache)if(this.interactionDocument.sameClass(i,e)&&this.cache[i][t])return this.cache[i][t];return null}return this.cache[e][t]},deleteFromCache:function(e,t){if(this.cache[e])delete this.cache[e][t];else for(var i in this.cache)if(this.interactionDocument.sameClass(i,e)&&this.cache[i][t])return void delete this.cache[i][t]},populateNode:function(e,t,i){this.concreteTree.expand(e,function(){this.removeEmptyNode(e);var r=this.concreteTree.getChildren(e);this.appendChildren(e,r),this.cacheNodes(e.childNodes),t.apply(i,[])},this)},loadFeatures:function(e,t,i,r,s){this.concreteTree.loadFeatures(i,function(){r.apply(s,[])},this)},deleteFarSubjects:function(e){for(var t=e.length-1;t>1;t--){if(this.countLeafsOnTree()<CMDBuild.gis.constants.navigation.MAX_VIEW_TREE_NODES)break;this.unloadSubject(e[t].card)}},unloadSubject:function(e){for(var t=this.cache[e.className][e.cardId];t.hasChildNodes();)this.unload(t.childNodes[0]);t.set("expanded",!1),t.appendChild(this.concreteTree.getEmptyNode())},unload:function(e){for(;e.hasChildNodes();)this.unload(e.childNodes[0]);var t=e.get("className"),i=e.get("cardId");this.deleteFromCache(t,i),e.parentNode.removeChild(e)},countLeafsOnTree:function(){var e=0;return this.getRootNode().cascadeBy(function(t){e++}),e},changeTransparency:function(e){}})}(),Ext.define("CMDBuild.controller.management.classes.map.thematism.ThematismMainWindow",{extend:"CMDBuild.controller.common.abstract.Base",uses:["CMDBuild.view.management.classes.map.thematism.ThematismMainWindow"],parentDelegate:void 0,cmfgCatchedFunctions:["onShowThematism"],view:void 0,interactionDocument:void 0,constructor:function(e){this.callParent(arguments),this.view=Ext.create("CMDBuild.view.management.classes.map.thematism.ThematismMainWindow",{delegate:this,title:CMDBuild.Translation.thematismTitle,interactionDocument:this.interactionDocument})},show:function(e){var t=this.interactionDocument.getThematicDocument(),i=t.getLayerByName(e);if(i&&i.get("adapter")){var r=i.get("adapter").getConfiguration();this.view.configure(r)}else if(!i){r=t.getDefaultThematismConfiguration();this.view.configure(r.configuration)}this.view.show(e)},onShowThematism:function(e){var t=this.interactionDocument.getThematicDocument();null!==t.getLayerByName(e.name)?t.modifyThematism(e):t.addThematism(e);var i=e.configuration.originalLayer.className;this.interactionDocument.setCurrentThematicLayer(i,e.name),this.interactionDocument.changedThematicDocument()}}),function(){function e(e,n,l,c,d){var u=function(e){return-1!=a.indexOf(e)}(e.type);return n.type===CMDBuild.gis.constants.layers.RANGES_ANALYSIS&&u?function(e,r,o,a,n){for(var l=[],c=Number.MIN_VALUE,d=Number.MAX_VALUE,u=0;u<a.length;u++){var m=a[u];s(e,r.strategy,o,m,n),c=t(c,0+m.value),d=i(d,0+m.value)}l=function(e,t,i){for(var r=[],s=(t-e)/i,o=0;o<i;o++)r.push({range:e+o*s,count:0,cards:[]});return r}(d,c,r.layoutConfiguration.segmentsConfiguration);for(var C=(c-d)/r.layoutConfiguration.segmentsConfiguration,u=0;u<a.length;u++){var m=a[u];!function(e,t,i){for(var r=0;r<e.length;r++){var s=0+t.value;if(r===e.length-1&&e[r].range<=s)e[r].count++,e[r].cards.push(t);else if(e[r].range<=s&&s<e[r].range+i){e[r].count++,e[r].cards.push(t);break}}}(l,m,C)}for(var g={},u=0;u<l.length;u++){var h=u<l.length-1?" "+CMDBuild.Translation.rangeTo+" "+parseInt(l[u+1].range):"";g[u+1+") "+parseInt(l[u].range)+h]={count:l[u].count,cards:l[u].cards}}return g}(e,n,l,c,d):n.type===CMDBuild.gis.constants.layers.GRADUATE_ANALYSIS?function(e,a,n,l,c){for(var d=[],u=0;u<l.length;u++){var m=l[u];s(e,a.strategy,n,m,c),m.value=parseInt(m.value)}for(var C=function(e){for(var r=Number.MIN_VALUE,s=Number.MAX_VALUE,o=0;o<e.length;o++){var a=e[o];r=t(r,0+a.value),s=i(s,0+a.value)}return{min:s,max:r}}(l),g={min:a.layoutConfiguration.minRadius,max:a.layoutConfiguration.maxRadius},u=0;u<l.length;u++){var m=l[u];m.grade=r(m,C,g),o(d,m,m.grade)}return d}(e,n,l,c,d):function(e,t,i,r,a){for(var n={},l=0;l<r.length;l++){var c=r[l];s(e,t.strategy,i,c,a),o(n,c,c.value)}return n}(e,n,l,c,d)}function t(e,t){return e?isNaN(t)?e:e>t?e:t:t}function i(e,t){return e?isNaN(t)?e:e<t?e:t:t}function r(e,t,i){var r=(i.max-i.min)/(t.max-t.min);return(parseFloat(e.value)-t.min)*r+parseFloat(i.min)}function s(e,t,i,r,s){var o={card:r,strategy:t,attributeName:s||e.value};value=t.value(o),i===CMDBuild.gis.constants.layers.FUNCTION_SOURCE&&(value=value[e.value]),r.value=value}function o(e,t,i){e[i]?(e[i].count++,e[i].cards.push(t)):e[i]={count:1,cards:[t]}}var a=["INTEGER","integer","DECIMAL","decimal","double","DOUBLE","numeric","NUMERIC"];Ext.define("CMDBuild.view.management.classes.map.thematism.ThematicDocument",{observers:[],thematisms4Classes:[],thematisms:[],strategiesManager:void 0,interactionDocument:void 0,thematicColors:void 0,currentClassName:void 0,currentLayers:{},addThematism:function(e,t){var i=Ext.create("CMDBuild.view.management.classes.map.thematism.ThematicLayer",e,this.interactionDocument,this.thematicColors);e.thematicLayer=i,this.thematisms.push(e),this.interactionDocument.changed()},configureStrategiesManager:function(e){this.strategiesManager=e},getStrategiesManager:function(){return this.strategiesManager},forceRefreshThematism:function(){for(var e=0;e<this.thematisms.length;e++){this.thematisms[e].thematicLayer.setDirty()}},getAllLayers:function(){var e=[];return this.interactionDocument.getMap().getLayers().forEach(function(t){t.get("geoAttribute");t.masterTableName===CMDBuild.gis.constants.layers.THEMATISM_LAYER&&e.push(t)}),e},changed:function(){for(var e=0;e<this.observers.length;e++)this.observers[e].refresh();var t=this.interactionDocument.getCurrentCard();this.refreshLayerButton(t.className)},observe:function(e){-1===this.observers.indexOf(e)&&this.observers.push(e)},setCurrentThematicLayer:function(e,t){this.currentLayers[e]=t},getCurrentThematicLayer:function(e){return this.currentLayers[e]},getColor:function(e,t,i,r){return this.thematicColors.getColor(e,t,i,r)},getDefaultThematismConfiguration:function(){return function(e){return JSON.parse(JSON.stringify(e))}(n)},getFieldStrategies:function(e,t){this.strategiesManager.getFieldStrategies(function(i){e.apply(t,[i])},this)},getFunctionStrategies:function(e,t){this.strategiesManager.getFunctionStrategies(function(i){e.apply(t,[i])},this)},getLayerByName:function(e){for(var t=0;t<this.thematisms.length;t++){var i=this.thematisms[t];if(e===i.thematicLayer.layer.name)return i.thematicLayer.layer}return null},getLayers:function(){for(var e=[],t=0;t<this.thematisms.length;t++){var i=this.thematisms[t];e.push(i.thematicLayer.layer)}return e},getStrategyByDescription:function(e){return this.strategiesManager.getStrategyByDescription(e)},getThematicLayersBySourceName:function(e){for(var t=[],i=0;i<this.thematisms.length;i++){var r=this.thematisms[i];r.layer&&e===r.layer.get("name")&&t.push(r.thematicLayer)}return t},groupData:function(t,i,r,s,o){return e(t,i,r,s,o)},init:function(e,t){this.interactionDocument=e,this.thematicColors=t},modifyThematism:function(e){this.removeThematism(e),this.addThematism(e,!0)},refreshFeatures:function(e,t){for(var i=this.getThematicLayersBySourceName(e),r=0;r<i.length;r++)i[r].refreshFeatures(t)},removeAllThematicLayers:function(){var e=this.interactionDocument.getMap();e.getLayers().forEach(function(t){var i=t.get("geoAttribute");if(t.masterTable===CMDBuild.gis.constants.layers.THEMATISM_LAYER||i&&i.masterTableName===CMDBuild.gis.constants.layers.THEMATISM_LAYER)e.removeLayer(t)})},removeThematism:function(e){for(var t=-1,i=0;i<this.thematisms.length;i++)if(e.name===this.thematisms[i].name){t=i;break}this.interactionDocument.getMap().removeLayer(this.thematisms[i].thematicLayer.layer),-1!==t&&this.thematisms.splice(t,1)},recover:function(e){for(var t=0;t<e.length;t++)this.addThematism(e[t],!0)},setCurrentCard:function(e){this.currentClassName&&e.className!==this.currentClassName&&(this.removeAllThematicLayers(),this.thematisms4Classes[this.currentClassName]=this.thematisms,this.thematisms=[],this.thematisms4Classes[e.className]&&this.recover(this.thematisms4Classes[e.className])),this.refreshLayerButton(e.className),this.currentClassName=e.className},refreshLayerButton:function(e){this.thematismButton.removeAll();for(var t=[],i=0;i<this.thematisms.length;i++){var r=this.thematisms[i];t.push(r.name)}var s=this.getCurrentThematicLayer(e);this.thematismButton.add(t,s),this.thematismButton.enableEntries(0===t.length)},setThematismButton:function(e){this.thematismButton=e}});var n={name:"",layer:"",strategy:"",configuration:{thematismConfiguration:{},functionConfiguration:{},layoutConfiguration:{}}}}(),Ext.define("CMDBuild.view.management.classes.map.thematism.ThematicStrategiesManager",{uses:["CMDBuild.view.management.classes.map.proxy.Functions"],functionStrategies:void 0,strategies:{valueData:{description:CMDBuild.Translation.value,value:function(e,t,i){var r=e.card[e.attributeName];return"object"==typeof r&&(r=r.description),r}}},getFieldStrategies:function(e,t){e.apply(t,[this.strategies])},getFunctionStrategies:function(e,t){CMDBuild.view.management.classes.map.proxy.Functions.readAllFunctions({scope:this,params:{detailed:!0},success:function(i,r,s){this.functionStrategies=s[CMDBuild.core.constants.Proxy.DATA],this.completeStrategyByStrategy(this.functionStrategies,0,function(){e.apply(t,[this.functionStrategies])},this)}})},getStrategyByDescription:function(e){for(var t in this.strategies)if(this.strategies[t].description===e)return this.strategies[t];for(var i=0;this.functionStrategies&&i<this.functionStrategies.length;i++)if(this.functionStrategies[i].description===e)return this.functionStrategies[i];return null},value4Function:function(e){return e.card},functionValue:function(e,t,i){var r={parameters:Ext.encode({ClassName:e.className})};CMDBuild.view.management.classes.map.proxy.Functions.readOutput({scope:this,_id:e.strategy._id,params:r,success:function(e,r,s){t.apply(i,[s.data])}})},completeStrategyByStrategy:function(e,t,i,r){if(t>=e.length)i.apply(r,[]);else{var s=e[t];CMDBuild.view.management.classes.map.proxy.Functions.readAttributes({scope:this,_id:s._id,success:function(o,a,n){var l=n[CMDBuild.core.constants.Proxy.DATA];s.attributes=l,this.completeOneStrategy(s,function(){this.completeStrategyByStrategy(e,t+1,function(){i.apply(r,[])},this)},this)}})}},completeOneStrategy:function(e,t,i){e.value=this.value4Function,CMDBuild.view.management.classes.map.proxy.Functions.readParameters({scope:this,_id:e._id,success:function(r,s,o){var a=o[CMDBuild.core.constants.Proxy.DATA];e.parameters=a,t.apply(i,[])}})}}),function(){function e(e){return function(e){"string"==typeof e&&(e=r(e));return t(e[0],e[1],e[2])}(e&&e.getColor()?e.getColor():[0,0,0,0])}function t(e,t,r){e=Number(e),t=Number(t),r=Number(r),(isNaN(e)||e<0||e>255||isNaN(t)||t<0||t>255||isNaN(r)||r<0||r>255)&&(e=t=r=0);return"#"+i(e.toString(16))+i(t.toString(16))+i(r.toString(16))}function i(e){return 1===e.length?"0"+e:e}function r(e){var t={red:null,green:null,blue:null,alpha:null};if("string"==typeof e)if(0===e.indexOf("#"))t=3==(e=e.substr(1)).length?[parseInt(e[0]+e[0],16),parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),1]:[parseInt(e.substr(0,2),16),parseInt(e.substr(2,2),16),parseInt(e.substr(4,2),16),1];else if(0===e.indexOf("rgb(")){var i=e.indexOf(",");t=[parseInt(e.substr(4,i)),parseInt(e.substr(i+1,e.indexOf(",",i))),parseInt(e.substr(e.indexOf(",",i+1)+1,e.indexOf(")"))),1]}else if(0===e.indexOf("rgba(")){i=e.indexOf(",");var s=e.indexOf(",",i+1);t=[parseInt(e.substr(5,i)),parseInt(e.substr(i+1,s)),parseInt(e.substr(e.indexOf(",",i+1)+1,e.indexOf(",",s))),parseFloat(e.substr(e.indexOf(",",s+1)+1,e.indexOf(")")))]}else{var o={acqua:"#0ff",teal:"#008080",blue:"#00f",navy:"#000080",yellow:"#ff0",olive:"#808000",lime:"#0f0",green:"#008000",fuchsia:"#f0f",purple:"#800080",red:"#f00",maroon:"#800000",white:"#fff",gray:"#808080",silver:"#c0c0c0",black:"#000"};void 0!=o[e]&&(t=r(o[e]))}return t}Ext.define("CMDBuild.view.management.classes.map.geoextension.CMDBuildGeoExt",{extend:"CMDBuild.controller.common.abstract.Base",interactionDocument:void 0,baseLayer:void 0,scalesTable:void 0,constructor:function(){CMDBuild.gis.values.browserEnabled&&this.initBaseLayer(),this.callParent(arguments)},setMap:function(e){this.mapPanel=e},getBaseLayer:function(){return this.baseLayer},initBaseLayer:function(){var e=void 0;if(CMDBuild.configuration.gis.get([CMDBuild.gis.constants.MAP_OSM,CMDBuild.gis.constants.ENABLED])){var t=new ol.source.OSM;e=new ol.layer.Tile({source:t})}else if(CMDBuild.configuration.gis.get([CMDBuild.gis.constants.MAP_GOOGLE,CMDBuild.gis.constants.ENABLED])){t=new ol.source.OSM;e=new ol.layer.Tile({source:t})}else if(CMDBuild.configuration.gis.get([CMDBuild.gis.constants.MAP_YAHOO,CMDBuild.gis.constants.ENABLED])){t=new ol.source.OSM;e=new ol.layer.Tile({source:t})}this.baseLayer=e},search:function(){Ext.create("CMDBuild.view.management.classes.map.geoextension.SearchPlaceWindow",{frame:!1,border:!1,region:"center",interactionDocument:this.interactionDocument}).show()},print:function(){this.loadPrintCapabilities(function(e){this.loadStores(e);Ext.create("CMDBuild.view.management.classes.map.geoextension.PrintMapWindow",{frame:!1,border:!1,region:"center",layouts:this.layouts,printExecutor:this}).show()},this)},printExecute:function(e){this.getGeoLayers2Print(function(t){this.getGisLayers2Print(function(i){this.printMap(e,t,i)},this)},this)},getGeoLayers2Print:function(e,t){var i=[],r=this.interactionDocument.getCurrentCard();this.interactionDocument.getAllLayers(function(s){for(var o=0;o<s.length;o++){var a=s[o],n=this.interactionDocument.isVisible(a,r.className,r.cardId),l=!this.interactionDocument.getLayerVisibility(a),c=this.interactionDocument.isANavigableLayer(a);this.interactionDocument.isGeoServerLayer(a)&&!l&&n&&c&&i.push(a.name)}e.apply(t,[i])},this)},getGisLayers2Print:function(e,t){var i=this.interactionDocument.getCurrentCard(),r=this.interactionDocument.getMapPanel(),s=[];this.interactionDocument.getAllLayers(function(o){for(var a=0;a<o.length;a++){var n=o[a],l=this.interactionDocument.isVisible(n,i.className,i.cardId),c=!this.interactionDocument.getLayerVisibility(n),d=this.interactionDocument.isANavigableLayer(n);if(!this.interactionDocument.isGeoServerLayer(n)&&!c&&l&&d){var u=r.getLayerByClassAndName(n.masterTableName,n.name);u&&s.push(u)}}e.apply(t,[s])},this)},getThematicLayer:function(){var e=this.interactionDocument.getCurrentCard().className,t=this.interactionDocument.getCurrentThematicLayer(e);return this.interactionDocument.getMapPanel().getLayerByClassAndName(CMDBuild.gis.constants.layers.THEMATISM_LAYER,t)},scaleFromZoom:function(){for(var e=function(e){return e*(25.4/.28*39.37)}(this.interactionDocument.getMap().getView().getResolution()),t=1;t<this.scalesTable.length;t++)if(this.scalesTable[t].value>e)return this.scalesTable[t-1].value;return 1e3},serialize:function(e,t,i){if(!e)return null;var r=e.getSource(),s=r&&r.getFeatures?r.getFeatures():new ol.Collection,o=e.getStyle?e.getStyle():null;this.loadLayerFeatures(s,o,function(e,r){var s=void 0;if(e.length>0){s={geoJson:{type:"FeatureCollection",features:e,opacity:1,styleProperty:"_gx_style"},type:"Vector",opacity:1,styleProperty:"_gx_style",name:"vector",styles:r}}else s=this.FALLBACK_SERIALIZATION;t.apply(i,[s])},this)},getCacheLayerIcon:function(e,t){return this.interactionDocument.getLayerByName(e).externalGraphic},loadLayerFeatures:function(t,i,r,s){var o=[],a={},n=1;Ext.each(t,function(t){var r=t.getGeometry(),s=(new ol.format.GeoJSON,function(t,i){var r=t.getStyle();r||(r=i(t)),"function"==typeof r&&(r=r(t));var s=window.location.toString().split("/");s=Ext.Array.slice(s,0,s.length-1).join("/");var o=e(r.getFill()),a=e(r.getStroke()),n=12,l=r.getImage(),c=l&&l.getSrc?s+"/"+l.getSrc():"";return""===c&&l&&(o=e(l.getFill()),a=e(l.getStroke()),n=l.getRadius()),{externalGraphic:c,fillColor:o,strokeColor:a,pointRadius:n,strokeWidth:1}}(t,i));a[n]=s;r.getType();var l={type:"Feature",properties:{_gx_style:n},geometry:{type:r.getType(),coordinates:r.getCoordinates()}};n++,o.push(l)}),r.apply(s,[o,a])},loadGisLayers:function(e,t){for(var i=0;i<t.length;i++)this.serialize(t[i],function(t){null!==t&&e.push(t)},this)},loadThematicLayer:function(e,t){this.serialize(e,function(e){null!==e&&t.push(e)},this)},printMap:function(e,t,i,r){r=this.scaleFromZoom();var s=this.interactionDocument.getMap(),o=this.getThematicLayer(),a=CMDBuild.configuration.gis.get([CMDBuild.core.constants.Proxy.GEO_SERVER,"url"]),n=a+"/"+CMDBuild.gis.constants.print.GEOSERVER_JSON_SERVICE,l=s.getView().getCenter(),c=(s.getView().calculateExtent(s.getSize()),[{baseURL:CMDBuild.gis.constants.print.OSM_SOURCE,singleTile:!1,type:"OSM",maxExtent:[-20037508.3392,-20037508.3392,20037508.3392,20037508.3392],tileSize:[256,256],extension:"png",opacity:1,resolutions:[156543.0339,78271.51695,39135.758475,19567.8792375,9783.93961875,4891.969809375,2445.9849046875,1222.99245234375,611.496226171875,305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887,1.1943285667419434,.5971642833709717]},function(e){for(var t=CMDBuild.configuration.gis.get([CMDBuild.core.constants.Proxy.GEO_SERVER,"workspace"]),i=CMDBuild.configuration.gis.get([CMDBuild.core.constants.Proxy.GEO_SERVER,"url"]),r=[],s=0;s<e.length;s++)r.push(t+":"+e[s]);return{baseURL:i+"/"+CMDBuild.gis.constants.print.GEOSERVER_WORKSPACE_WMS,customParams:{TRANSPARENT:!0},format:"image/png",layers:r,opacity:1,serverType:"geoserver",type:"WMS",styles:[""]}}(t)]);this.loadGisLayers(c,i),this.loadThematicLayer(o,c);var d=this.loadThematicLegend(),u=window.location.toString().split("/"),m=(u=Ext.Array.slice(u,0,u.length-1).join("/"))+"/images/logo.png",C=[-1050091.8944356,4675576.582525099,-990623.88643799,4733515.8499572],g={units:"m",srs:"EPSG:3857",layout:e.layout,outputFormat:"pdf",dpi:"300",mapTitle:e.pageTitle,comment:e.comment,data:d,layers:c,pages:[{bbox:C,center:l,scale:r,mapPage:1,logo:m,data:!1},{data:d,thematismName:o?o.name:"",bbox:C,logo:m}]},h=this;Ext.Ajax.request({url:n,method:"POST",jsonData:g,success:function(e){var t=e.responseText;h.temporaryPdfUrl=Ext.decode(t).getURL;var i=h.temporaryPdfUrl.split("/");h.temporaryPdfUrl=a+"/pdf/"+i[i.length-1],window.open(h.temporaryPdfUrl)}})},loadPrintCapabilities:function(e,t){var i=CMDBuild.configuration.gis.get([CMDBuild.core.constants.Proxy.GEO_SERVER,"url"]),r=i+"/"+CMDBuild.gis.constants.print.GEOSERVER_JSON_INFO;CMDBuild.gis.constants.print.GEOSERVER_PRINT_SERVICE,CMDBuild.gis.constants.print.GEOSERVER_JSON_SERVICE;Ext.Ajax.request({url:r,params:{url:i+"/"+CMDBuild.gis.constants.print.GEOSERVER_PDF+"iga"},method:"GET",disableCaching:!1,success:function(i){var r=Ext.decode(i.responseText);e.apply(t,[r])},scope:this})},loadStores:function(e){this.scalesTable=e.scales,this.layouts=[];for(var t=0;t<e.layouts.length;t++)this.layouts.push(e.layouts[t].name)},loadThematicLegend:function(){var e={data:[],columns:["value","cardinality","color"]},i=this.interactionDocument.getCurrentCard(),s=this.interactionDocument.getCurrentThematicLayer(i.className);if(!s)return!1;for(var o=this.interactionDocument.getMapPanel().getLayerByClassAndName(CMDBuild.gis.constants.layers.THEMATISM_LAYER,s).get("adapter"),a=o.getThematismAnalysisType(),n=o.getColorsTable(),l=0;l<n.length;l++){var c=n[l],d=a!==CMDBuild.gis.constants.layers.GRADUATE_ANALYSIS?r(c.color):[255,255,255],u=t(d[0],d[1],d[2]);e.data.push({value:c.value,cardinality:c.cardinality,color:u})}return e}})}(),function(){function e(e){return"#"===e.substr(0,1)?t(e.substr(1)):e}function t(e){return"rgba("+parseInt(e.substr(0,2),16)+", "+parseInt(e.substr(2,2),16)+","+parseInt(e.substr(4,2),16)+",0.7)"}Ext.define("CMDBuild.view.management.classes.map.thematism.ThematicColors",{getColor:function(s,o,a,n){var l=function(e,t){for(var i=0;t&&i<t.length;i++)if(t[i].value===e||parseInt(t[i].value)===parseInt(e))return t[i].color;return null}(s,o);if(l)return e(l);return t(a===CMDBuild.gis.constants.layers.PUNTUAL_ANALYSIS?i[n%i.length]:r[n%r.length])},tableToExa:function(t){for(var i=0;i<t.length;i++)for(var r=0;r<t[i].cards.length;r++)t[i].color=e(t[i].color);return t}});var i=["FFFF00","00FF00","00FFFF","0000FF","FF0000","FF00FF","FF6666","6666FF","FF6600","66FF66","D0E0E3","CFE2F3","D9D2E9","EAD1DC","EA9999","F9CB9C","FFE599","B6D7A8","FCE5CD","9FC5E8","B4A7D6","D5A6BD","E06666","F6B26B","FFD966","93C47D","76A5AF","6FA8DC","8E7CC3","FFF2CC","CC0000","E69138","F1C232","6AA84F","45818E","3D85C6","674EA7","A64D79","990000","B45F06","BF9000","38761D","134F5C","0B5394","351C75","741B47","660000","783F04","7F6000","000000","444444","666666","999999","CCCCCC","EEEEEE","F3F3F3","FFFFFF","33FF33","FF9900","274E13","0C343D","073763","20124D","4C1130"],r=["9999FF","0000FF","0000AA","00AA00","00FF00","99FF99","FF9999","FF9900","AA0000","FF0000"]}(),Ext.define("CMDBuild.proxy.management.widget.Calendar",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)}}),Ext.define("CMDBuild.proxy.widget.WebService",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,callWidget:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.widget.webService}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.UNCACHED,e)}}),function(){function e(e){if(e.widgetReader){e.view.setLoading(!0);var t=e.widgetReader.getCode(e.typedWidgetConf),i=_CMCache.getEntryTypeByName(t);CMDBuild.proxy.management.widget.Workflow.readStartActivity({params:{classId:i.data.id},scope:e,success:function(t,r,s){this.attributes=CMDBuild.controller.management.common.widgets.workflow.StaticsController.filterAttributesInStep(this.cardAttributes,s.response.variables),this.view.configureForm(this.attributes),this.templateResolver=new CMDBuild.Management.TemplateResolver({clientForm:this.clientForm,xaVars:this.presets,serverVars:this.getTemplateResolverServerVars()}),function(e){e.templateResolver.resolveTemplates({attributes:Ext.Object.getKeys(e.presets),callback:function(t){e.view.fillFormValues(t)}})}(e),this.widgetControllerManager.buildControllers(s.response.widgets,i),this.view.getWidgetButtonsPanel().editMode(),this.view.setLoading(!1),this.configured=!0,Ext.isArray(this.view.formFields)&&!Ext.isEmpty(this.view.formFields)&&Ext.Array.forEach(this.view.formFields,function(e,t,i){Ext.isObject(e)&&!Ext.Object.isEmpty(e)&&Ext.isFunction(e.resolveTemplate)&&e.resolveTemplate()},this)}})}}function t(){r(this,!0)}function i(){r(this,!1)}function r(e,t){var i=e.view.formPanel.getForm();if(!t||function(e){var t=function(e){var t=e.view.formPanel.getForm(),i=CMDBuild.controller.management.classes.StaticsController.getInvalidAttributeAsHTML(t);{if(null!=i){var r=Ext.String.format('<p class="{0}">{1}</p>',CMDBuild.core.constants.Global.getErrorMsgCss(),CMDBuild.Translation.errors.invalid_attributes);return CMDBuild.core.Message.error(null,r+i,!1),!1}return!0}}(e);if(wrongWidgets=e.widgetControllerManager.getWrongWFAsHTML(),null!=wrongWidgets){t=!1;var i=Ext.String.format(s,CMDBuild.core.constants.Global.getErrorMsgCss(),CMDBuild.Translation.errors.invalid_extended_attributes);CMDBuild.core.Message.error(null,i+wrongWidgets,popup=!1)}return t}(e)){CMDBuild.core.LoadMask.show();var r={},o=e.widgetReader.getCode(e.typedWidgetConf),a=_CMCache.getEntryTypeByName(o);r.classId=a.data.id,r.attributes=Ext.JSON.encode(i.getValues()),r.advance=t,r.activityInstanceId=void 0,r.ww=Ext.JSON.encode(e.widgetControllerManager.getData(t)),CMDBuild.proxy.management.widget.Workflow.updateActivity({params:r,scope:e,clientValidation:!0,loadMask:!1,callback:function(e,t,i){CMDBuild.core.LoadMask.hide()},success:function(t,i,r){e.processId=r.response.Id;var s=r.response.IdClass,o=_CMCache.getEntryTypeById(s);e.processClassName=o.get("name")}}),e.ownerController.hideWidgetsContainer()}else _debug("There are no processInstance to save")}var s='<p class="{0}">{1}</p>',o="_SystemFieldFilter";Ext.define("CMDBuild.controller.management.common.widgets.workflow.CMWorkflowController",{uses:["CMDBuild.controller.management.common.widgets.workflow.StaticsController","CMDBuild.core.constants.Global","CMDBuild.core.Message","CMDBuild.proxy.management.widget.Workflow"],mixins:{observable:"Ext.util.Observable",widgetcontroller:"CMDBuild.controller.management.common.widgets.CMWidgetController"},statics:{WIDGET_NAME:".Workflow"},processId:null,processClassName:null,constructor:function(e,r,s,o,a){this.ownerController=r,this.mixins.observable.constructor.call(this),this.mixins.widgetcontroller.constructor.apply(this,arguments),this.widgetReader=Ext.create("CMDBuild.controller.management.common.widgets.workflow.CMWorkflowControllerWidgetReader");var n=new CMDBuild.view.management.common.widgets.CMWidgetManagerPopup(this.view);this.widgetControllerManager=new CMDBuild.controller.management.common.CMWidgetManagerControllerPopup(n),e.setDelegate(this),this.widgetControllerManager.setDelegate(this),this.mon(this.view,this.view.CMEVENTS.saveButtonClick,i,this),this.mon(this.view,this.view.CMEVENTS.advanceButtonClick,t,this);var l=this,c=this.widgetReader.getCode(this.widgetConf);if(c){this.typedWidgetConf=this.widgetConf,this.view.hideComboPanel(),this.widgetType="name";(a=_CMCache.getEntryTypeByName(c))&&a.data&&_CMCache.getAttributeList(a.data.id,function(e){l.cardAttributes=e}),this.presets=this.widgetReader.getPreset(this.typedWidgetConf)}else this.view.showComboPanel(),this.widgetType="cql"},chargeComboFiels:function(){var e=this;this.filter=this.widgetReader.getFilter(this.widgetConf);var t=new CMDBuild.Management.TemplateResolver({xaVars:{},clientForm:this.clientForm,serverVars:this.getTemplateResolverServerVars()});t.xaVars[o]=this.filter,t.resolveTemplates({attributes:[o],callback:function(i){var r=t.buildCQLQueryParameters(i[o]),s=Ext.encode({CQL:r.CQL});CMDBuild.proxy.management.widget.Workflow.readWorkflowByFilter({params:{className:CMDBuild.core.constants.Global.getRootNameWorkflows(),limit:1e3,start:0,filter:s,attributes:Ext.encode(["Description"])},loadMask:!1,scope:this,success:function(t,i,r){var s=r.rows;e.view.clearComboValues(s),e.view.loadComboValues(s)}})}})},getData:function(){var e=null;return this.readOnly||((e={}).output={id:this.processId,className:this.processClassName}),e},ensureEditPanel:function(){},onWidgetButtonClick:function(e){this.widgetControllerManager.onWidgetButtonClick(e)},beforeActiveView:function(){"cql"==this.widgetType&&(this.chargeComboFiels(),this.view.comboPanel.clearCombo()),this.view.clearWindow(),"name"==this.widgetType&&e(this)},changeWorkflow:function(t){var i=this;this.view.clearWindow(),this.typedWidgetConf={workflowName:t,presets:{}};var r=_CMCache.getEntryTypeByName(t);r&&r.data&&_CMCache.getAttributeList(r.data.id,function(e){i.cardAttributes=e}),this.presets=this.widgetReader.getPreset(this.typedWidgetConf),e(this)}})}(),Ext.define("CMDBuild.controller.management.widget.linkCards.LinkCardsController",{extend:"CMDBuild.controller.management.common.widgets.CMWidgetController",uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.Message","CMDBuild.core.Utils","CMDBuild.proxy.management.widget.LinkCards"],mixins:{observable:"Ext.util.Observable"},alertIfChangeDefaultSelection:!1,card:void 0,clientForm:void 0,firstWidgetVisualization:!0,gisMapEnabled:!1,grid:void 0,mapController:void 0,model:void 0,readOnly:void 0,singleSelect:void 0,outputName:void 0,ownerController:void 0,targetClass:void 0,templateResolver:void 0,templateResolverIsBusy:!1,view:void 0,widgetConf:void 0,constructor:function(e,t,i,r,s){var o=null;if(this.mixins.observable.constructor.call(this),this.callParent(arguments),!Ext.isEmpty(this.widgetConf[CMDBuild.core.constants.Proxy.CLASS_NAME])&&_CMCache.isEntryTypeByName(this.widgetConf[CMDBuild.core.constants.Proxy.CLASS_NAME]))o=this.widgetConf[CMDBuild.core.constants.Proxy.CLASS_NAME];else{if(Ext.isEmpty(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER])||!_CMCache.isEntryTypeByName(this.getClassNameFromFilterString(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER])))return CMDBuild.core.Message.error(CMDBuild.Translation.error,CMDBuild.Translation.errors.widgetLinkCardsNoClassNameError,!1);o=this.getClassNameFromFilterString(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER])}this.targetClass=_CMCache.getEntryTypeByName(o),_CMCardModuleState.setEntryType(this.targetClass,null,null,!1),this.singleSelect=this.widgetConf[CMDBuild.core.constants.Proxy.SINGLE_SELECT],this.readOnly=this.widgetConf[CMDBuild.core.constants.Proxy.READ_ONLY],this.view.delegate=this,this.grid=this.view.grid,this.grid.delegate=this,this.view.widgetConf=this.widgetConf,this.model=Ext.create("CMDBuild.model.management.widget.linkCards.Selection",{singleSelect:this.singleSelect}),this.templateResolver=new CMDBuild.Management.TemplateResolver({clientForm:this.clientForm,xaVars:this._extractVariablesForTemplateResolver(),serverVars:this.getTemplateResolverServerVars()}),this.gisMapEnabled&&!Ext.isEmpty(this.view.getMapPanel())&&(this.mapController=Ext.create("CMDBuild.controller.management.widget.linkCards.LinkCardsMapController",{view:this.view.getMapPanel(),model:this.model,parentDelegate:this,widgetConf:this.widgetConf})),this.resolveDefaultSelectionTemplate()},cmOn:function(e,t,i){switch(e){case"onDeselect":return this.onDeselect(t);case"onGridPageChange":return this.onGridPageChange();case"onGridShow":return this.onGridShow();case"onToggleGridFilterButtonClick":return this.onToggleGridFilterButtonClick(t);case"onToggleMapButtonClick":return this.onToggleMapButtonClick();case"onRowEditButtonClick":return this.onRowEditButtonClick(t);case"onRowViewButtonClick":return this.onRowViewButtonClick(t);case"onSelect":return this.onSelect(t.record);case"onLinkCardApplyDefaultSelectionButtonClick":return this.onLinkCardApplyDefaultSelectionButtonClick();default:if(!Ext.isEmpty(this.parentDelegate))return this.parentDelegate.cmOn(e,t,i)}},_extractVariablesForTemplateResolver:function(){var e={};return e[CMDBuild.core.constants.Proxy.DEFAULT_SELECTION]=this.widgetConf[CMDBuild.core.constants.Proxy.DEFAULT_SELECTION],e[CMDBuild.core.constants.Proxy.FILTER]=this.widgetConf[CMDBuild.core.constants.Proxy.FILTER],Ext.apply(e,this.widgetConf[CMDBuild.core.constants.Proxy.TEMPLATES]||{}),e},alertIfNeeded:function(){this.alertIfChangeDefaultSelection&&(CMDBuild.core.Message.warning(null,Ext.String.format(CMDBuild.Translation.warnings.link_cards_changed_values,this.widgetConf[CMDBuild.core.constants.Proxy.LABEL]||this.view.id),!1),this.alertIfChangeDefaultSelection=!1)},beforeActiveView:function(){Ext.isEmpty(this.targetClass)||(this.gisMapEnabled=this.widgetConf[CMDBuild.core.constants.Proxy.ENABLE_MAP]&&CMDBuild.configuration.gis.get(CMDBuild.core.constants.Proxy.ENABLED),this.toggleGridFilterButtonManageState(),this.grid.getSelectionModel().setLocked(this.widgetConf[CMDBuild.core.constants.Proxy.READ_ONLY]),new _CMUtils.PollingFunction({success:function(){Ext.isEmpty(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER])||this.view.toggleGridFilterButton.getActiveState()!=CMDBuild.core.constants.Proxy.ENABLE?this.updateViewGrid(this.targetClass.getId()):this.resolveFilterTemplate(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER],this.targetClass.getId()),this.model.hasSelection()||this.resolveDefaultSelectionTemplate(),this.onGridShow()},failure:function(){CMDBuild.core.Message.error(null,CMDBuild.Translation.errors.busyVisualControls,!1)},checkFn:function(){return!this.isBusy()},cbScope:this,checkFnScope:this}).run())},toggleGridFilterButtonManageState:function(e){e=Ext.isBoolean(e)?e:null,Ext.isEmpty(e)?this.view.toggleGridFilterButton.setDisabled(this.widgetConf.hasOwnProperty(CMDBuild.core.constants.Proxy.DISABLE_GRID_FILTER_TOGGLER)&&this.widgetConf[CMDBuild.core.constants.Proxy.DISABLE_GRID_FILTER_TOGGLER]||Ext.isEmpty(this.widgetConf[CMDBuild.core.constants.Proxy.FILTER])):this.view.toggleGridFilterButton.setDisabled(e)},getCardWindow:function(e,t){var i=Ext.create("CMDBuild.view.management.widget.linkCards.cardWindow.CMCardWindow",{cmEditMode:t,withButtons:t,title:e.get("IdClass_value")});return Ext.create("CMDBuild.controller.management.widget.linkCards.cardWindow.CMCardWindowController",{view:i,configuration:{entryType:e.get("IdClass"),card:e.get("Id"),cmEditMode:t}}),i},getClassNameFromFilterString:function(e){var t=e.trim().split("from");return(t=t[1].trim()).split(" ")[0]},getData:function(){var e=null;if(!this.readOnly){var t=this.model.getSelections(),i=this.widgetConf[CMDBuild.core.constants.Proxy.METADATA];if(this.singleSelect&&!Ext.Object.isEmpty(i))for(var r in i)switch(i[r]){case"POINT":var s=Ext.Object.getKeys(t)[0];if(!Ext.Object.isEmpty(t[s])){var o=t[s].lat,a=t[s].lon;t[s]={},t[s][r]=new OpenLayers.Geometry.Point(a,o).toString()}break;default:throw"ERROR: LinkCardsController getData wrong widget metadata configuration ("+i[r]+")"}(e={})[CMDBuild.core.constants.Proxy.OUTPUT]=t,e[CMDBuild.core.constants.Proxy.METADATA_OUTPUT]=this.widgetConf[CMDBuild.core.constants.Proxy.METADATA_OUTPUT]}return e},getTargetClass:function(){return this.targetClass},isBusy:function(){return this.templateResolverIsBusy},isValid:function(){return!(!this.readOnly&&this.widgetConf[CMDBuild.core.constants.Proxy.REQUIRED])||this.model.hasSelection()},onDeselect:function(e){this.model.deselect(e.record.get("Id"))},onGridPageChange:function(){var e=this.model.getSelections();this.grid.getSelectionModel().deselectAll();for(var t in e)this.grid.getSelectionModel().select(this.grid.getStore().find(CMDBuild.core.constants.Proxy.ID,t))},onGridShow:function(){var e=this.model.getLastSelection();if(!Ext.isEmpty(e)){var t={};t[CMDBuild.core.constants.Proxy.CARD_ID]=e,t[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.widgetConf[CMDBuild.core.constants.Proxy.CLASS_NAME],t[CMDBuild.core.constants.Proxy.SORT]=Ext.encode(this.grid.getStore().sorters.getRange()),this.view.toggleGridFilterButton.getActiveState()==CMDBuild.core.constants.Proxy.ENABLE&&(t[CMDBuild.core.constants.Proxy.FILTER]=this.grid.getStore().getProxy().extraParams[CMDBuild.core.constants.Proxy.FILTER]),this.model._silent=!0,CMDBuild.proxy.management.widget.LinkCards.readCardPosition({params:t,loadMask:!1,scope:this,success:function(t,i,r){var s=(r=r[CMDBuild.core.constants.Proxy.RESPONSE])[CMDBuild.core.constants.Proxy.POSITION];Ext.isBoolean(r[CMDBuild.core.constants.Proxy.HAS_POSITION])&&r[CMDBuild.core.constants.Proxy.HAS_POSITION]?this.grid.loadPage(CMDBuild.core.Utils.getPageNumber(s),{scope:this,cb:function(){this.grid.getSelectionModel().select(this.grid.getStore().find(CMDBuild.core.constants.Proxy.ID,e)),!this.grid.getSelectionModel().hasSelection()&&this.view.toggleGridFilterButton.getActiveState()&&this.onToggleGridFilterButtonClick(!1),this.model._silent=!1}}):this.view.toggleGridFilterButton.getActiveState()&&this.onToggleGridFilterButtonClick(!1),this.model._silent=!1}})}},onRowEditButtonClick:function(e){var t=this.getCardWindow(e,!0);t.on("destroy",function(){this.grid.reload()},this,{single:!0}),t.show()},onRowViewButtonClick:function(e){this.getCardWindow(e,!1).show()},onSelect:function(e){Ext.isEmpty(e)||Ext.isEmpty(e.get("Id"))?(this.grid.getSelectionModel().deselectAll(),this.model.reset()):(_CMCardModuleState.setCard(e,null,!1),this.model.select(e.get("Id")))},onToggleGridFilterButtonClick:function(e){var t=this.targetClass.getId(),i=this.widgetConf[CMDBuild.core.constants.Proxy.FILTER];Ext.isBoolean(e)&&this.view.toggleGridFilterButton.setActiveState(e?CMDBuild.core.constants.Proxy.ENABLE:CMDBuild.core.constants.Proxy.DISABLE),e==CMDBuild.core.constants.Proxy.ENABLE?this.resolveFilterTemplate(i,t):this.resolveFilterTemplate(null,t),this.onGridShow()},onToggleMapButtonClick:function(){this.gisMapEnabled&&!Ext.isEmpty(this.view.getMapPanel())&&(this.grid.isVisible()?(this.view.showMap(),this.toggleGridFilterButtonManageState(!0)):(this.view.showGrid(),this.toggleGridFilterButtonManageState()))},onLinkCardApplyDefaultSelectionButtonClick:function(){this.resolveDefaultSelectionTemplate()},resolveDefaultSelectionTemplate:function(){this.templateResolverIsBusy=!0,this.viewReset(),this.alertIfNeeded(),this.templateResolver.resolveTemplates({attributes:[CMDBuild.core.constants.Proxy.DEFAULT_SELECTION],scope:this,callback:function(e,t){var i=this.templateResolver.buildCQLQueryParameters(e[CMDBuild.core.constants.Proxy.DEFAULT_SELECTION],t);Ext.isObject(i)&&!Ext.Object.isEmpty(i)?(i[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(["Description"]),i[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.targetClass.get(CMDBuild.core.constants.Proxy.NAME),CMDBuild.proxy.management.widget.LinkCards.readAllCards({params:i,loadMask:!1,scope:this,success:function(e,t,i){i=i.rows;var r=void 0;Ext.isEmpty(i)||(Ext.Array.forEach(i,function(e,t,i){this.model.select(e.Id),r=e},this),_CMCardModuleState.setCard({Id:r.Id,IdClass:r.IdClass},null,!1)),this.templateResolverIsBusy=!1,this.onGridShow()}}),this.templateResolver.bindLocalDepsChange(function(){this.resolveDefaultSelectionTemplate()})):this.templateResolverIsBusy=!1}})},resolveFilterTemplate:function(e,t){var i=this;this.templateResolver.resolveTemplates({attributes:[CMDBuild.core.constants.Proxy.FILTER],callback:function(r,s){var o=i.templateResolver.buildCQLQueryParameters(e,s);i.updateViewGrid(t,o),i.templateResolver.bindLocalDepsChange(function(){i.viewReset()})}})},updateViewGrid:function(e,t){this.grid.CQL=t,this.grid.store.proxy.extraParams=this.grid.getStoreExtraParams(),this.grid.updateStoreForClassId(e)},viewReset:function(){this.grid.getSelectionModel().deselectAll(),this.model.reset()}}),function(){function e(e,t){var i=new CMDBuild.view.management.common.CMCardWindow({cmEditMode:t,withButtons:t,title:e.get("label")+" - "+e.get("dst_desc")});t&&i.on("destroy",function(){this.fireEvent(this.CMEVENTS.serverOperationSuccess),this.loadData()},this,{single:!0}),new CMDBuild.controller.management.common.CMCardWindowController(i,{entryType:e.get("dst_cid"),card:e.get("dst_id"),cmEditMode:t}),i.show()}function t(){function e(e,i){this.templateResolverIsBusy=!1,this.templateResolver.bindLocalDepsChange(t,this)}(function(){this.templateResolverIsBusy=!0,this.templateResolver.resolveTemplates({attributes:["objId"],callback:e,scope:this})}).call(this)}function i(e,t,i,r,s,o){var a=s.target.className;this.callBacks[a]&&this.callBacks[a].call(this,t)}function r(e){var t={};return"_1"==e?(t.slaveSide="_2",t.masterSide="_1"):(t.slaveSide="_1",t.masterSide="_2"),t}function s(e){if(e.get("relations_size")>CMDBuild.configuration.instance.get("relationLimit")){e.removeAll();var t={};t[CMDBuild.core.constants.Proxy.CARD_ID]=this.getCardId(),t[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(this.getClassId()),t[CMDBuild.core.constants.Proxy.DOMAIN_ID]=e.get("dom_id"),t[CMDBuild.core.constants.Proxy.SRC]=e.get("src"),CMDBuild.proxy.management.widget.ManageRelation.readAllRelations({params:t,scope:this,success:function(t,i,r){this.view.suspendLayouts();this.view.convertRelationInNodes(r.domains[0].relations,e.data.dom_id,e.data.src,e.data,e);this.view.resumeLayouts(!0)}})}}Ext.define("CMDBuild.controller.management.widget.manageRelation.CMManageRelationController",{uses:["CMDBuild.core.constants.Global","CMDBuild.core.constants.Proxy","CMDBuild.proxy.management.widget.ManageRelation"],mixins:{observable:"Ext.util.Observable",widgetcontroller:"CMDBuild.controller.management.common.widgets.CMWidgetController"},constructor:function(e,t,r,o,a){if(this.mixins.observable.constructor.call(this,arguments),void 0===e)throw"OOO snap, you have not passed a view to me";this.view=e,this.view.delegate=this,this.superController=t,this.card=null,this.entryType=null,this.buildCardModuleStateDelegate(),this.hasDomains=!1,this.callBacks={"action-relation-delete":this.onDeleteRelationClick,"action-relation-deletecard":this.onDeleteCard,"action-relation-edit":this.onEditRelationClick,"action-relation-editcard":this.onEditCardClick,"action-relation-viewcard":this.onViewCardClick},this.view.store.getRootNode().on("append",function(e,t){1==t.get("depth")&&t.on("expand",s,this,{single:!0})},this),this.mon(this.view,this.view.CMEVENTS.openGraphClick,this.onShowGraphClick,this),this.mon(this.view,this.view.CMEVENTS.addButtonClick,this.onAddRelationButtonClick,this),this.mon(this.view,"beforeitemclick",i,this),this.mon(this.view,"activate",this.loadData,this),this.CMEVENTS={serverOperationSuccess:"cm-server-success"},this.addEvents(this.CMEVENTS.serverOperationSuccess),this.mixins.widgetcontroller.constructor.apply(this,arguments),function(e){if(e.targetEntryType=_CMCache.getEntryTypeByName(e.widgetConf.className),null==e.targetEntryType)throw{error:"There is no entry type for this widget",widget:e.widgetConf}}(this),this.templateResolver=new CMDBuild.Management.TemplateResolver({clientForm:o,xaVars:this.widgetConf,serverVars:this.getTemplateResolverServerVars()}),this.templateResolverIsBusy=!1,this.readOnly=!(this.widgetConf.singleSelection||this.widgetConf.multiSelection),this.idClass=this.targetEntryType.getId(),this.domain=_CMCache.getDomainByName(this.widgetConf.domainName)},buildCardModuleStateDelegate:function(){var e=this;if(this.cardStateDelegate=new CMDBuild.state.CMCardModuleStateDelegate,this.cardStateDelegate.onEntryTypeDidChange=function(t,i){e.onEntryTypeSelected(i)},this.cardStateDelegate.onModifyCardClick=function(t){e.onModifyCardClick()},this.cardStateDelegate.onCardDidChange=function(t,i){Ext.suspendLayouts(),e.onCardSelected(i),Ext.resumeLayouts()},_CMCardModuleState.addDelegate(this.cardStateDelegate),this.view){e=this;this.mon(e.view,"destroy",function(t){_CMCardModuleState.removeDelegate(e.cardStateDelegate),delete e.cardStateDelegate})}},onAbortCardClick:function(){this.superController.onAbortCardClick()},onAddCardButtonClick:Ext.emptyFn,onAddRelationButtonClick:function(e){var t=_CMCache.getDomainById(e.dom_id),i=!1,s="_1"==e.src?"_2":"_1";t&&(i=t.isMany(s));var o=this,a=r(e.src),n=Ext.create("CMDBuild.view.management.widget.manageRelation.CMEditRelationWindow",{sourceCard:this.card,relation:{dst_cid:e.dst_cid,dom_id:e.dom_id,rel_id:-1,masterSide:a.masterSide,slaveSide:a.slaveSide},selModel:new CMDBuild.selection.CMMultiPageSelectionModel({mode:i?"MULTI":"SINGLE",avoidCheckerHeader:!0,idProperty:"Id"}),filterType:this.view.id,successCb:function(){o.onAddRelationSuccess()}});this.mon(n,"destroy",function(){this.loadData()},this,{single:!0}),n.show()},onAddRelationSuccess:function(){this.defaultOperationSuccess()},onCardSelected:function(e){this.card=e,this.view.clearStore(),this.view.disable(),e&&(this.updateCurrentClass(e),this.hasDomains&&(this.view.enable(),this.loadData()))},onCloneCard:function(){this.view&&this.view.disable()},onDeleteCard:function(e){this.cardToDelete=e,this.onDeleteRelationClick(e)},onDeleteRelationClick:function(e){Ext.Msg.confirm(CMDBuild.Translation.attention,CMDBuild.Translation.management.modcard.delete_relation_confirm,function(r){if("yes"==r){var s=_CMCache.getDomainById(e.get("dom_id")),o={},a={};o[CMDBuild.core.constants.Proxy.DOMAIN_NAME]=s.getName(),o[CMDBuild.core.constants.Proxy.RELATION_ID]=e.get("rel_id"),o.master=t.masterSide;var n={};n[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(i.card.get("IdClass")),n[CMDBuild.core.constants.Proxy.CARD_ID]=i.card.get("Id"),a[t.masterSide]=[n];var l={};l[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(e.get("dst_cid")),l[CMDBuild.core.constants.Proxy.CARD_ID]=e.get("dst_id"),a[t.slaveSide]=[l],o[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(a),CMDBuild.proxy.management.widget.ManageRelation.removeRelation({params:o,scope:this,success:this.onDeleteRelationSuccess,callback:function(){this.loadData()}})}},this);var t=r(e.get("src")),i=this},onEditCardClick:function(t){e.call(this,t,!0)},onEditMode:function(){t.call(this)},onEditRelationClick:function(e){var t=this,i=e.raw||e.data,s=r(e.get("src")),o=Ext.create("CMDBuild.view.management.widget.manageRelation.CMEditRelationWindow",{sourceCard:this.card,relation:{rel_attr:i.attr_as_obj,dst_cid:e.get("dst_cid"),dst_id:e.get("dst_id"),dom_id:e.get("dom_id"),rel_id:e.get("rel_id"),masterSide:s.masterSide,slaveSide:s.slaveSide},filterType:this.view.id,successCb:function(){t.onEditRelationSuccess()},selModel:new CMDBuild.selection.CMMultiPageSelectionModel({mode:"SINGLE",idProperty:"Id"})});this.mon(o,"destroy",function(){this.loadData()},this,{single:!0}),o.show()},onEditRelationSuccess:function(){this.defaultOperationSuccess()},onEntryTypeSelected:function(e){this.entryType=e,this.card=null,this.entryType&&this.entryType.get("tableType")!=CMDBuild.core.constants.Global.getTableTypeSimpleTable()||(this.entryType=null),this.view.disable(),this.view.clearStore()},onDeleteRelationSuccess:function(){this.cardToDelete?function(){this.cardToDelete&&CMDBuild.proxy.management.widget.ManageRelation.removeCard({params:{IdClass:this.cardToDelete.get("dst_cid"),Id:this.cardToDelete.get("dst_id")},scope:this,callback:function(e,t,i){delete this.cardToDelete,this.loadData()}})}.call(this):this.defaultOperationSuccess()},onModifyCardClick:function(){this.superController.onModifyCardClick()},onShowGraphClick:function(){Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.graph.Window",{parentDelegate:this,classId:parseInt(this.idClass),cardId:parseInt(this.cardId)})},onViewCardClick:function(t){e.call(this,t,!1)},defaultOperationSuccess:function(){this.loadData()},getCardId:function(e){var t=this.getVariable("xa:id");return t?("string"==typeof t&&(t=parseInt(t),isNaN(t)&&(t=-1)),t):-1},beforeActiveView:function(){this.view.addRelationButton.setDomainsForEntryType(this.targetEntryType,this.domain.getId());var e=this;this.templateResolver.resolveTemplates({attributes:["objId"],callback:function(t){e.cardId=t.objId,e.card=function(e){var t={IdClass:e.idClass,Id:e.cardId};return{get:function(e){return t[e]}}}(e),e.cardId>0?(e.loadData(),e.view.addRelationButton.enable()):(e.view.fillWithData(),e.view.addRelationButton.disable())},scope:this})},getData:function(){var e=null;e={};for(var t=[],i=Ext.query("input[name="+this.view.CHECK_NAME+"]"),r=0,s=i.length,o=null;r<s;++r)(o=i[r])&&o.checked&&t.push(o.value);return e.output=t,e},isValid:function(){if(!this.widgetConf.required||this.readOnly)return!0;try{return this.getData().output.length>0}catch(e){return!1}},loadData:function(){var e=this.domain;if(null!=e){(function(){var e={Id:this.cardId,IdClass:this.idClass};this.currentCard={get:function(t){return e[t]}}}).call(this);var t={};t[CMDBuild.core.constants.Proxy.CARD_ID]=this.cardId,t[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(this.idClass),t[CMDBuild.core.constants.Proxy.DOMAIN_ID]=e.getId(),t[CMDBuild.core.constants.Proxy.SRC]=function(e){var t=e.widgetConf.source;if(null==t){var i=_CMCache.getEntryTypeById(e.targetEntryType.getId()),r=[];if(i)for(r.push(i.get("id"));""!=i.get("parent");)i=_CMCache.getEntryTypeById(i.get("parent")),r.push(i.get("id"));t=Ext.Array.contains(r,e.domain.get("idClass1"))?"_1":"_2"}return t}(this),CMDBuild.proxy.management.widget.ManageRelation.readAllRelations({params:t,scope:this,success:function(e,t,i){this.view.fillWithData(i.domains)}})}else _debug("It is not possible to lad data for null domain")},getClassId:function(){return this.card.get("IdClass")},getLabel:function(){var e="";return this.widgetConf&&(e=this.widgetConf.label),e},updateCurrentClass:function(e){var t=e.get("IdClass"),i=_CMCache.getEntryTypeById(t);this.currentClass!=i&&(i&&i.get("tableType")!=CMDBuild.core.constants.Global.getTableTypeSimpleTable()||(i=null),this.currentClass=i,this.hasDomains=this.view.addRelationButton.setDomainsForEntryType(i))}})}(),Ext.define("CMDBuild.core.configurations.Timeout",{singleton:!0,config:{base:90,cache:3e5,cacheEntity:1e3,configurationSetup:12e6,csvUtility:6e5,gisTreeExpand:3e5,patchManager:6e5,report:72e5,taskSingleExecution:72e5,workflowWidgetsExecutionTimeout:3e4},constructor:function(e){this.initConfig(e)}}),Ext.define("CMDBuild.proxy.administration.userAndGroup.group.tabs.DefaultFilters",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.model.administration.userAndGroup.group.defaultFilters.Filter"],singleton:!0,getStoreClassFilters:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.FILTER,{autoLoad:!1,model:"CMDBuild.model.administration.userAndGroup.group.defaultFilters.Filter",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.filter.group.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.FILTERS}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.defaults.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DEFAULT_FILTER,e)},readAllEntryTypes:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.entryType.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.ENTRY_TYPE,e)},readAllGroupFilters:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.group.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.FILTER,e)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.filter.defaults.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DEFAULT_FILTER,e,!0)}}),function(){function e(e){this.widgetControllerManager&&this.widgetControllerManager.buildControllers(e)}Ext.define("CMDBuild.controller.management.classes.CMBaseCardPanelController",{extend:"CMDBuild.controller.management.classes.CMModCardSubController",mixins:{observable:"Ext.util.Observable"},uses:["CMDBuild.core.constants.Global","CMDBuild.core.Message","CMDBuild.controller.management.classes.StaticsController","CMDBuild.core.constants.Proxy","CMDBuild.proxy.Card"],cardDataProviders:[],constructor:function(e,t,i){this.callParent(arguments),this.mixins.observable.constructor.call(this,arguments);var r=this.view.CMEVENTS;if(i)this.widgetControllerManager=i;else{var s=new CMDBuild.view.management.common.widgets.CMWidgetManager(this.view);this.widgetControllerManager=new CMDBuild.controller.management.common.CMWidgetManagerController(s)}this.widgetControllerManager.setDelegate(this),this.CMEVENTS={cardSaved:"cm-card-saved",abortedModify:"cm-card-modify-abort",editModeDidAcitvate:r.editModeDidAcitvate,displayModeDidActivate:r.displayModeDidActivate},this.addEvents(this.CMEVENTS.cardSaved,this.CMEVENTS.abortedModify,r.editModeDidAcitvate,r.displayModeDidActivate),this.relayEvents(this.view,[r.editModeDidAcitvate,r.displayModeDidActivate]),this.mon(this.view,r.modifyCardButtonClick,function(){this.onModifyCardClick.apply(this,arguments)},this),this.mon(this.view,r.saveCardButtonClick,function(){this.onSaveCardClick.apply(this,arguments)},this),this.mon(this.view,r.abortButtonClick,function(){this.onAbortCardClick.apply(this,arguments)},this),this.mon(this.view,r.widgetButtonClick,this.onWidgetButtonClick,this),this.mon(this.view,r.editModeDidAcitvate,this.onCardGoesInEdit,this)},onEntryTypeSelected:function(){this.unlockCard(),this.view.isInEditing()&&this.view.displayMode(),this.callParent(arguments),this.loadFields(this.entryType.get("id")),this.widgetControllerManager&&this.widgetControllerManager.removeAll()},onCardSelected:function(t){var i=this;if(this.unlockCard(),this.callParent(arguments),this.view.isInEditing()&&this.view.displayMode(),this.view.reset(),this.entryType&&this.card){Ext.defer(e,1,this,[t]),this.loadFields(this.card.get("IdClass"),function(){i.loadCard(!0)}),Ext.isEmpty(_CMCardModuleState.entryType)||Ext.isEmpty(t)||CMDBuild.global.navigation.Chronology.cmfg("navigationChronologyRecordSave",{moduleId:"class",entryType:{description:_CMCardModuleState.entryType.get(CMDBuild.core.constants.Proxy.TEXT),id:_CMCardModuleState.entryType.get(CMDBuild.core.constants.Proxy.ID),object:_CMCardModuleState.entryType},item:{description:t.get("Description")||t.raw.Description||t.get("Code")||t.raw.Code,id:t.get("Id"),object:t}})}},onModifyCardClick:function(){if(this.isEditable(this.card)){var e=this;this.lockCard(function(){e.loadCard(!0,null,function(){e.view.editMode()})})}this.callParent(arguments)},onSaveCardClick:function(){var e={};e[CMDBuild.core.constants.Proxy.CARD_ID]=this.cloneCard?-1:this.card.get("Id"),e[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(this.card.get("IdClass")),function(e,t){for(var i in e.cardDataProviders)if("function"==typeof(i=e.cardDataProviders[i]).getCardData){var r=i.getCardData(t);r&&(t[i.getCardDataName()]=r)}}(this,e),function(e){var t=e.view.getForm(),i=CMDBuild.controller.management.classes.StaticsController.getInvalidAttributeAsHTML(t);if(null!=i){var r=Ext.String.format('<p class="{0}">{1}</p>',CMDBuild.core.constants.Global.getErrorMsgCss(),CMDBuild.Translation.errors.invalid_attributes);return CMDBuild.core.Message.error(null,r+i,!1),!1}return!0}(this)&&this.doFormSubmit(e)},doFormSubmit:function(e){CMDBuild.proxy.Card.update({params:Ext.Object.merge(e,this.view.getForm().getValues()),scope:this,success:function(e,t,i){var r={};r.result=i,r.params=t.params,this.onSaveSuccess(this.view.getForm(),r)}})},onSaveSuccess:function(e,t){this.view.displayMode();var i={Id:t.result[CMDBuild.core.constants.Proxy.ID]||this.card.get("Id"),IdClass:this.entryType.get(CMDBuild.core.constants.Proxy.ID)};this.fireEvent(this.CMEVENTS.cardSaved,i)},onAbortCardClick:function(){this.card&&-1==this.card.get("Id")?_CMCardModuleState.setCard(_CMCardModuleState.getPreviousCard()):this.onCardSelected(this.card),this.callParent(arguments),this.fireEvent(this.CMEVENTS.abortedModify)},onAddCardButtonClick:function(e){e&&(_CMCardModuleState.setPreviousCard(_CMCardModuleState.card),this.onCardSelected(new CMDBuild.DummyModel({IdClass:e,Id:-1})),this.view.editMode())},addCardDataProviders:function(e){this.cardDataProviders.push(e)},loadFields:function(e,t){var i=this;_CMCache.getAttributeList(e,function(e){i.view.fillForm(e,editMode=!1),t&&t()})},loadCard:function(e,t,i){var r,s=this;if((r=t?t.Id||t.cardId:s.card.get("Id"))&&"-1"!=r&&(e||s.view.hasDomainAttributes())){if(!t){(t={})[CMDBuild.core.constants.Proxy.CARD_ID]=s.card.get("Id"),t[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(s.card.get("IdClass"))}CMDBuild.proxy.Card.read({params:t,loadMask:!1,success:function(e,t,r){var o=r.card;s.card&&(o=Ext.Object.merge(s.card.raw||s.card.data,o)),function(e,t){var i=e;if(i)for(var r in i){var s=i[r];for(var o in s)t["_"+r+"_"+o]=s[o]}}(r.referenceAttributes,o);var a=Ext.create("CMDBuild.DummyModel",o);"function"==typeof i?i(a):s.loadCardStandardCallBack(a)}})}else s.loadCardStandardCallBack(s.card)},loadCardStandardCallBack:function(e){this.view.loadCard(e),e&&(this.isEditable(e)?-1==e.get("Id")||this.cmForceEditing?(this.view.editMode(),this.cmForceEditing=!1):this.view.displayMode(enableTBar=!0):this.view.displayModeForNotEditableCard())},isEditable:function(e){return _CMUtils.getEntryTypePrivilegesByCard(e).create},setWidgetManager:function(e){this.widgetManager=e},onWidgetButtonClick:function(e){this.widgetControllerManager&&this.widgetControllerManager.onWidgetButtonClick(e)},onCardGoesInEdit:function(){this.widgetControllerManager&&this.widgetControllerManager.onCardGoesInEdit()},lockCard:function(e){CMDBuild.configuration.instance.get("enableCardLock")?this.card&&this.card.get("Id")>=0&&CMDBuild.proxy.Card.lock({params:{id:this.card.get("Id")},loadMask:!1,success:e}):e()},unlockCard:function(){CMDBuild.configuration.instance.get("enableCardLock")&&this.card&&this.view.isInEditing()&&this.card.get("Id")>=0&&CMDBuild.proxy.Card.unlock({params:{id:this.card.get("Id")},loadMask:!1})},onCloneCard:Ext.emptyFn,ensureEditPanel:function(){this.view.ensureEditPanel()}}),Ext.define("CMDBuild.controller.management.classes.CMCardDataProvider",{cardDataName:null,getCardDataName:function(){return this.cardDataName},getCardData:function(){throw"You have to implement the getCardData method in "+this.$className}})}(),Ext.define("CMDBuild.controller.management.common.CMCardWindowController",{extend:"CMDBuild.controller.management.classes.CMBaseCardPanelController",uses:["CMDBuild.core.constants.Global","CMDBuild.core.Message","CMDBuild.proxy.Card","CMDBuild.controller.management.classes.StaticsController"],mixins:{observable:"Ext.util.Observable"},constructor:function(e,t){if(this.configuration=t,!Ext.isEmpty(this.configuration.entryType)){var i=this;this.callParent(arguments),this.mixins.observable.constructor.call(this,arguments),this.onEntryTypeSelected(_CMCache.getEntryTypeById(this.configuration.entryType)),this.cmEditMode=this.configuration.cmEditMode,this.mon(this.view,"show",function(){this.loadFields(this.configuration.entryType,function(){if(i.configuration.card){var e={};e[CMDBuild.core.constants.Proxy.CARD_ID]=i.configuration.card,e[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(i.configuration.entryType),i.loadCard(!0,e,function(e){i.onCardLoaded(i,e)})}else i.editModeIfPossible()})},this),this.mon(this.view,"destroy",function(){this.unlockCard()},this)}},getForm:function(){return this.view.cardPanel.getForm()},onSaveCardClick:function(){var e=this.getForm(),t=this.buildSaveParams();this.beforeRequest(e),e.isValid()?this.doFormSubmit(t):CMDBuild.core.Message.error(null,Ext.String.format('<p class="{0}">{1}</p>',CMDBuild.core.constants.Global.getErrorMsgCss(),CMDBuild.Translation.errors.invalid_attributes)+CMDBuild.controller.management.classes.StaticsController.getInvalidAttributeAsHTML(e),!1)},doFormSubmit:function(e){CMDBuild.proxy.Card.update({params:Ext.Object.merge(e,this.view.getForm().getValues()),loadMask:this.view,scope:this,success:function(e,t,i){var r={};r.result=i,r.params=t.params,this.onSaveSuccess(this.view.getForm(),r)}})},onAbortCardClick:function(){this.view.destroy()},onEntryTypeSelected:function(e){this.callParent(arguments),this.view.setTitle(this.entryType.get(CMDBuild.core.constants.Proxy.TEXT))},buildSaveParams:function(){var e={};return e[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.entryType.getName(),e[CMDBuild.core.constants.Proxy.CARD_ID]=this.card?this.card.get("Id"):-1,e},onSaveSuccess:function(e,t){CMDBuild.core.LoadMask.hide(),_CMCache.onClassContentChanged(this.entryType.get(CMDBuild.core.constants.Proxy.ID)),this.view.destroy()},onCardLoaded:function(e,t){e.card=t,e.view.loadCard(t),e.widgetControllerManager&&e.widgetControllerManager.buildControllers(t),e.editModeIfPossible()},beforeRequest:Ext.emptyFn,editModeIfPossible:function(){var e=this;e.card?e.cmEditMode?e.lockCard(function(){e.view.editMode()}):e.view.displayMode():e.onAddCardButtonClick(this.configuration.entryType)}}),function(){Ext.define("CMDBuild.controller.management.common.CMDetailWindowController",{extend:"CMDBuild.controller.management.common.CMCardWindowController",constructor:function(){this.callParent(arguments)},getRelationsAttribute:function(){for(var e=this.getForm().getFields(),t=[],i=0,r=null;i<e.items.length;++i)(r=e.items[i]).CMAttribute&&r.CMAttribute.cmRelationAttribute&&(r.enable(),t.push(r));return t},buildSaveParams:function(){var e=this.callParent(arguments);if(this.referenceToMaster){var t=this.referenceToMaster;e[t.name]=t.value}return e},buildParamsToSaveRelation:function(e){var t=this.view.detail,i=function(e,t){var i={};return"_1"==_CMCache.getDirectedDomainForEntryType(e,t).src?(i.slaveSide="_2",i.masterSide="_1"):(i.slaveSide="_1",i.masterSide="_2"),i}(this.entryType,t.getName()),r={domainName:t.getName(),attributes:Ext.encode(this.fillRelationAttributesParams(e,{})),master:i.masterSide};return this.relation&&(r.relationId=this.relation.rel_id),r},fillRelationAttributesParams:function(e,t){for(var i=this.getRelationsAttribute(),r=0,s=null;r<i.length;++r)t[(s=i[r]).CMAttribute.attributeName]=s.getValue();var o=this.view.detail,a=this.view.masterData,n=function(e,t){var i=t.get("cardinality"),r=e.get("IdClass");if("1:1"==i)throw"Wrong cardinality for a MasterDetail domain";return Ext.Array.contains(_CMUtils.getAncestorsId(r),t.get("idClass1"))?"1:N"==i?"_1":"_2":"N:1"==i?"_2":"_1"}(a,o),l=function(e){return"_1"==e?"_2":"_1"}(n);return t[n]=[{cardId:a.get("Id"),className:_CMCache.getEntryTypeNameById(a.get("IdClass"))}],t[l]=[{cardId:e.cardId,className:e.className}],t},beforeRequest:function(e){if(!this.referenceToMaster)for(var t=e.getFields(),i=0,r=null;i<t.items.length;++i)(r=t.items[i]).setDisabled(r.CMAttribute&&r.CMAttribute.cmRelationAttribute)},onSaveSuccess:function(e,t){this.relation&&!this.referenceToMaster&&this.updateRelation(e,t),this.callParent(arguments)},updateRelation:function(e,t){var i=this.buildParamsToSaveRelation(t.params);CMDBuild.proxy.Relation.update({params:i,loadMask:!1})},loadFields:function(e,t){var i=this;_CMCache.getAttributeList(e,function(e){e=function(e,t){for(var i=[],r=0;r<t.length;r++){var s=t[r];s&&(function(e,t){return!(!t||!e.fkAttribute)&&t.name==e.fkAttribute.name}(e.view,s)||function(e,t){return!!e.detail&&t.idDomain==e.detail.get("id")}(e.view,s)?e.view.masterData&&(e.referenceToMaster={name:s.name,value:e.view.masterData.get("Id")}):i.push(s))}return i}(i,e),e=function(e,t,i){var r=Ext.isEmpty(t)||Ext.isEmpty(t.detail)?[]:t.detail.getAttributes()||[],s=[];if(r.length>0){t.hasRelationAttributes=!0;for(var o=!1,a=0,n=i.length;a<n;++a)if((l=i[a]).group&&""!=l.group){o=!0;break}if(o)s=[].concat(i);else{a=0;for(var l=null;a<i.length;++a)l=i[a],(c=Ext.apply({},l)).group=CMDBuild.Translation.management.modcard.detail_window.detail_attributes,s.push(c)}for(a=0,l=null;a<r.length;++a){l=r[a];var c;(c=Ext.apply({},l)).group=CMDBuild.Translation.management.modcard.detail_window.relation_attributes,c.attributeName=c.name,e.referenceToMaster&&(c.name="_"+e.referenceToMaster.name+"_"+c.name),c.cmRelationAttribute=!0,s.push(c)}}else s=[].concat(i);return s}(i,i.view,e),i.view.fillForm(e,editMode=!1),t&&t()})},onCardLoaded:function(e,t){this.callParent(arguments),e.view.hasRelationAttributes&&function(e){var t={};t[CMDBuild.core.constants.Proxy.CARD_ID]=e.card.get("Id"),t[CMDBuild.core.constants.Proxy.CLASS_NAME]=e.entryType.getName(),t[CMDBuild.core.constants.Proxy.DOMAIN_ID]=e.view.detail.get("id"),t[CMDBuild.core.constants.Proxy.SRC]=e.view.detail.getDetailSide(),CMDBuild.proxy.Relation.readAll({params:t,loadMask:!1,scope:this,success:function(t,i,r){var s=r.domains;try{s.length>1&&_debug("TODO ecco perch sbaglia il modify, il get relation torna due domini, che in realt  lo stesso nei due versi",s),e.relation=s[0].relations[0];for(var o=e.getRelationsAttribute(),a=e.relation.rel_attr,n=0,l=null;n<o.length;++n)if((l=o[n]).CMAttribute){var c=a[l.CMAttribute.name]||a[l.CMAttribute.attributeName];l.setValue(c)}}catch(t){e.relation=void 0,_debug("No relations",t)}}})}(e)}})}(),Ext.define("CMDBuild.bim.proxy.Bim",{uses:["CMDBuild.bim.data.CMBIMProjectModel","CMDBuild.core.constants.Proxy","CMDBuild.core.interfaces.FormSubmit","CMDBuild.proxy.index.Json"],singleton:!0,activeForClassName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.activeForClassName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e)},create:function(e,t,i,r){CMDBuild.core.interfaces.FormSubmit.submit({form:e,url:CMDBuild.proxy.index.Json.bim.create,params:t,fileUpload:!0,success:i,failure:r})},disable:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.disable}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e,!0)},enable:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.enable}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e,!0)},fetchCardFromViewewId:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.fetchCardFromViewewId}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e)},fetchJsonForBimViewer:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.fetchJsonForBimViewer}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e,!0)},getStore:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.BIM,{autoLoad:!1,model:"CMDBuild.bim.data.CMBIMProjectModel",defaultPageSize:0,pageSize:0,proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.bim.read,actionMethods:"GET",reader:{type:"json",root:"bimProjects"}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},roidForCardId:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.bim.roidForCardId}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.BIM,e)},update:function(e,t,i,r){CMDBuild.core.interfaces.FormSubmit.submit({form:e,url:CMDBuild.proxy.index.Json.bim.update,params:t,fileUpload:!0,success:i,failure:r})}}),Ext.define("CMDBuild.controller.management.routes.Card",{extend:"CMDBuild.controller.common.abstract.Routes",uses:["CMDBuild.core.configurations.Routes","CMDBuild.core.constants.Proxy","CMDBuild.core.Message","CMDBuild.proxy.management.routes.Card"],paramsModel:void 0,supportedPrintFormats:[CMDBuild.core.constants.Proxy.PDF,CMDBuild.core.constants.Proxy.CSV],detail:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER),CMDBuild.proxy.management.routes.Card.readClassByName({params:e,scope:this,success:function(e,t,i){if(i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i)){if(!Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER)))return this.manageIdentifierCard(i,this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER));if(!Ext.Object.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER)))return this.manageFilterSimple(i)}return CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1)}})}},manageFilterSimple:function(e,t){var i=this.paramsModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER),r={};r[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(["Description"]),r[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER),r[CMDBuild.core.constants.Proxy.FILTER]='{"attribute":{"simple":{"attribute":"'+i[CMDBuild.core.constants.Proxy.KEY]+'","operator":"equal","value":["'+i[CMDBuild.core.constants.Proxy.VALUE]+'"]}}}',CMDBuild.proxy.management.routes.Card.readAllCards({params:r,scope:this,success:function(i,r,s){1==s[CMDBuild.core.constants.Proxy.RESULTS]?(s=s[CMDBuild.core.constants.Proxy.ROWS],this.manageIdentifierCard(e,s[0].Id,t)):CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidSimpleFilter,!1)}})},manageIdentifierCard:function(e,t,i){if(!Ext.isNumber(t)||Ext.isEmpty(t))return _error("manageIdentifierCard(): invalid cardIdentifier parameter",this,t);Ext.Function.createDelayed(function(){CMDBuild.global.controller.MainViewport.cmfg("mainViewportCardSelect",{Id:t,IdClass:e[CMDBuild.core.constants.Proxy.ID]}),Ext.isFunction(i)&&Ext.callback(i,this)},500,this)()},paramsValidation:function(e){return this.paramsModel=Ext.create("CMDBuild.model.management.routes.Card",e),Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1),!1):Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER))&&Ext.Object.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidCardIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER)+")",!1),!1):!!Ext.Array.contains(this.supportedPrintFormats,this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT))||(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidPrintFormat+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT)+")",!1),!1)},print:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER),CMDBuild.proxy.management.routes.Card.readClassByName({params:e,scope:this,success:function(e,t,i){if(i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i)){if(!Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER)))return this.manageIdentifierCard(i,this.paramsModel.get(CMDBuild.core.constants.Proxy.CARD_IDENTIFIER),Ext.Function.createDelayed(function(){CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet","class").cardPanelController.onPrintCardMenuClick(this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT))},1500,this));if(!Ext.Object.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER)))return this.manageFilterSimple(i,Ext.Function.createDelayed(function(){CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet","class").cardPanelController.onPrintCardMenuClick(this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT))},1500,this))}return CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1)}})}}}),Ext.define("CMDBuild.controller.management.routes.Classes",{extend:"CMDBuild.controller.common.abstract.Routes",uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.Message","CMDBuild.proxy.management.routes.Classes"],paramsModel:void 0,supportedPrintFormats:[CMDBuild.core.constants.Proxy.PDF,CMDBuild.core.constants.Proxy.CSV],detail:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER),CMDBuild.proxy.management.routes.Classes.readClassByName({params:e,scope:this,success:function(e,t,i){return i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i)?this.manageIdentifierClass(i):CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1)}})}},manageFilterClient:function(e,t){Ext.isObject(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER))&&!Ext.Object.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER))&&Ext.Function.createDelayed(function(){var i=Ext.create("CMDBuild.cache.CMEntryTypeModel",e);i.set(CMDBuild.core.constants.Proxy.FILTER,Ext.encode(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER))),CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet","class").onViewOnFront(i),Ext.isFunction(t)&&Ext.Function.createDelayed(t,500,this)()},1500,this)(),Ext.isFunction(t)&&Ext.callback(t,this)},manageIdentifierClass:function(e,t){CMDBuild.configuration.runtime.set(CMDBuild.core.constants.Proxy.STARTING_CLASS_ID,e[CMDBuild.core.constants.Proxy.ID]),CMDBuild.global.controller.MainViewport.cmfg("mainViewportStartingEntitySelect"),this.manageFilterClient(e,t)},paramsValidation:function(e){return this.paramsModel=Ext.create("CMDBuild.model.management.routes.Classes",e),Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1),!1):(Ext.isEmpty(this.paramsModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER)),Ext.Array.contains(this.supportedPrintFormats,this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT))?this.callParent(arguments):(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidPrintFormat+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT)+")",!1),!1))},print:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER),CMDBuild.proxy.management.routes.Classes.readClassByName({params:e,scope:this,success:function(e,t,i){return i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i)?this.manageIdentifierClass(i,function(){var e=CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet","class").gridController;e.view.updateStoreForClassId(i.id,{cb:function(){e.onPrintGridMenuClick(this.paramsModel.get(CMDBuild.core.constants.Proxy.FORMAT))},scope:this})}):CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidClassIdentifier+" ("+this.paramsModel.get(CMDBuild.core.constants.Proxy.CLASS_IDENTIFIER)+")",!1)}})}}}),Ext.define("CMDBuild.controller.management.routes.Instance",{extend:"CMDBuild.controller.common.abstract.Routes",uses:["CMDBuild.controller.management.workflow.Utils","CMDBuild.core.configurations.Routes","CMDBuild.core.constants.Proxy","CMDBuild.core.constants.WorkflowStates","CMDBuild.core.Message","CMDBuild.proxy.management.routes.Instance"],parametersModel:void 0,detail:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER),CMDBuild.proxy.management.routes.Instance.readWorkflowByName({params:e,scope:this,success:function(e,t,i){return i=i[CMDBuild.core.constants.Proxy.RESPONSE],!Ext.isObject(i)||Ext.Object.isEmpty(i)?CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidProcessIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER)+")",!1):Ext.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.INSTANCE_IDENTIFIER))?Ext.Object.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER))?void 0:this.manageFilterSimple(i):this.readInstanceDetails(i)}})}},manageFilterSimple:function(e){var t=this.parametersModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER),i={};i[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(["Description"]),i[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER),i[CMDBuild.core.constants.Proxy.FILTER]='{"attribute":{"simple":{"attribute":"'+t[CMDBuild.core.constants.Proxy.KEY]+'","operator":"equal","value":["'+t[CMDBuild.core.constants.Proxy.VALUE]+'"]}}}',i[CMDBuild.core.constants.Proxy.STATE]=CMDBuild.core.constants.WorkflowStates.getAll(),CMDBuild.proxy.management.routes.Instance.readAll({params:i,scope:this,success:function(t,i,r){1==(r=r[CMDBuild.core.constants.Proxy.RESPONSE])[CMDBuild.core.constants.Proxy.RESULTS]?(r=r[CMDBuild.core.constants.Proxy.ROWS][0],this.manageIdentifierInstance(e,r[CMDBuild.core.constants.Proxy.ID],r[CMDBuild.core.constants.Proxy.FLOW_STATUS])):CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidSimpleFilter,!1)}})},manageIdentifierInstance:function(e,t){var i=CMDBuild.global.controller.MainViewport.cmfg("mainViewportAccordionControllerWithNodeWithIdGet",e[CMDBuild.core.constants.Proxy.ID]),r=CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet",CMDBuild.core.constants.ModuleIdentifiers.getWorkflow());return!Ext.isObject(e)||Ext.Object.isEmpty(e)?_error("manageIdentifierInstance(): unmanaged workflowObject parameter",this,e):!Ext.isNumber(t)||Ext.isEmpty(t)?_error("manageIdentifierInstance(): unmanaged instanceIdentifier parameter",this,t):Ext.isObject(i)&&!Ext.Object.isEmpty(i)&&Ext.isFunction(i.cmfg)?Ext.isObject(r)&&!Ext.Object.isEmpty(r)&&Ext.isFunction(r.cmfg)?(Ext.apply(i,{disableSelection:!0,scope:this,callback:function(){i.cmfg("accordionDeselect"),i.cmfg("accordionNodeByIdSelect",{id:e[CMDBuild.core.constants.Proxy.ID]}),r.cmfg("workflowTreeApplyStoreEvent",{eventName:"load",fn:function(){var e={};e.enableForceFlowStatus=!0,e[CMDBuild.core.constants.Proxy.INSTANCE_ID]=t,r.cmfg("workflowTreeActivitySelect",e)},scope:this,options:{single:!0}})}}),void i.cmfg("accordionExpand")):_error("manageIdentifierInstance(): moduleController not found",this,r):_error("manageIdentifierInstance(): accordionController not found",this,i)},paramsValidation:function(e){return this.parametersModel=Ext.create("CMDBuild.model.management.routes.Instance",e),Ext.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidProcessIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER)+")",!1),!1):Ext.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.INSTANCE_IDENTIFIER))&&Ext.Object.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.SIMPLE_FILTER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidInstanceIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.INSTANCE_IDENTIFIER)+")",!1),!1):this.callParent(arguments)},readInstanceDetails:function(e){var t={};t[CMDBuild.core.constants.Proxy.CARD_ID]=this.parametersModel.get(CMDBuild.core.constants.Proxy.INSTANCE_IDENTIFIER),t[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER),CMDBuild.proxy.management.routes.Instance.read({params:t,scope:this,success:function(t,i,r){r=r[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(r)&&!Ext.Object.isEmpty(r)?this.manageIdentifierInstance(e,r[CMDBuild.core.constants.Proxy.ID],r[CMDBuild.core.constants.Proxy.FLOW_STATUS]):CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidInstanceIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.INSTANCE_IDENTIFIER)+")",!1)}})}}),Ext.define("CMDBuild.controller.management.routes.Workflow",{extend:"CMDBuild.controller.common.abstract.Routes",uses:["CMDBuild.core.constants.ModuleIdentifiers","CMDBuild.core.constants.Proxy","CMDBuild.core.Message","CMDBuild.proxy.management.routes.Workflow"],parametersModel:void 0,supportedPrintFormats:[CMDBuild.core.constants.Proxy.PDF,CMDBuild.core.constants.Proxy.CSV],detail:function(e,t,i){if(this.paramsValidation(e)){(e={})[CMDBuild.core.constants.Proxy.NAME]=this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER),CMDBuild.proxy.management.routes.Workflow.readByName({params:e,scope:this,success:function(e,t,i){if(i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i))return this.manageIdentifierProcess(i,this.manageFilterClient);CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidProcessIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER)+")",!1)}})}},manageFilterClient:function(){if(Ext.isObject(this.parametersModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER))&&!Ext.Object.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER))){var e=CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet",CMDBuild.core.constants.ModuleIdentifiers.getWorkflow());e.cmfg("workflowTreeApplyStoreEvent",{eventName:"load",fn:function(){e.cmfg("workflowTreeFilterApply",{filter:Ext.create("CMDBuild.model.common.panel.gridAndForm.filter.advanced.Filter",{configuration:this.parametersModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER)}),type:"advanced"})},scope:this,options:{single:!0}})}},manageIdentifierProcess:function(e,t){var i=CMDBuild.global.controller.MainViewport.cmfg("mainViewportAccordionControllerWithNodeWithIdGet",e[CMDBuild.core.constants.Proxy.ID]);return!Ext.isObject(e)||Ext.Object.isEmpty(e)?_error("manageIdentifierProcess(): invalid workflowObject parameter",this,e):Ext.isObject(i)&&!Ext.Object.isEmpty(i)&&Ext.isFunction(i.cmfg)?(Ext.apply(i,{disableSelection:!0,scope:this,callback:function(){i.cmfg("accordionDeselect"),i.cmfg("accordionNodeByIdSelect",{id:e[CMDBuild.core.constants.Proxy.ID]}),Ext.isFunction(t)&&Ext.callback(t,this)}}),void i.cmfg("accordionExpand")):_error("manageIdentifierInstance(): accordionController not found",this,i)},paramsValidation:function(e){return this.parametersModel=Ext.create("CMDBuild.model.management.routes.Workflow",e),Ext.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER))?(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidProcessIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER)+")",!1),!1):(Ext.isEmpty(this.parametersModel.get(CMDBuild.core.constants.Proxy.CLIENT_FILTER)),Ext.Array.contains(this.supportedPrintFormats,this.parametersModel.get(CMDBuild.core.constants.Proxy.FORMAT))?this.callParent(arguments):(CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidPrintFormat+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.FORMAT)+")",!1),!1))},print:function(e,t,i){if(this.paramsValidation(e)){var r=CMDBuild.global.controller.MainViewport.cmfg("mainViewportModuleControllerGet",CMDBuild.core.constants.ModuleIdentifiers.getWorkflow());(e={})[CMDBuild.core.constants.Proxy.NAME]=this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER),CMDBuild.proxy.management.routes.Workflow.readByName({params:e,scope:this,success:function(e,t,i){if(i=i[CMDBuild.core.constants.Proxy.RESPONSE],Ext.isObject(i)&&!Ext.Object.isEmpty(i))return this.manageIdentifierProcess(i,function(){r.cmfg("workflowTreeApplyStoreEvent",{eventName:"load",fn:function(){r.cmfg("onWorkflowTreePrintButtonClick",this.parametersModel.get(CMDBuild.core.constants.Proxy.FORMAT))},scope:this,options:{single:!0}})});CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,CMDBuild.Translation.errors.routesInvalidProcessIdentifier+" ("+this.parametersModel.get(CMDBuild.core.constants.Proxy.PROCESS_IDENTIFIER)+")",!1)}})}},showAll:function(e,t,i){if(CMDBuild.global.controller.MainViewport.cmfg("mainViewportAccordionControllerExists",CMDBuild.core.constants.ModuleIdentifiers.getWorkflow())){CMDBuild.global.controller.MainViewport.cmfg("mainViewportAccordionControllerGet",CMDBuild.core.constants.ModuleIdentifiers.getWorkflow()).cmfg("accordionExpand")}}}),Ext.define("CMDBuild.core.Management",{uses:["CMDBuild.core.configurations.Timeout","CMDBuild.core.constants.ModuleIdentifiers","CMDBuild.core.constants.Proxy","CMDBuild.core.CookiesManager","CMDBuild.core.Splash","CMDBuild.proxy.core.Management","CMDBuild.proxy.dashboard.Dashboard","CMDBuild.proxy.lookup.Type","CMDBuild.proxy.Menu","CMDBuild.proxy.widget.Widget","CMDBuild.view.management.classes.CMModCard"],singleton:!0,init:function(){CMDBuild.core.Splash.show(),CMDBuild.core.Management.buildConfiguration()},buildCache:function(){var e={},t=Ext.create("CMDBuild.core.RequestBarrier",{id:"managementBuildCacheBarrier",callback:CMDBuild.core.Management.buildUserInterface});(e={})[CMDBuild.core.constants.Proxy.ACTIVE]=!0;var i=t.getCallback("managementBuildCacheBarrier");CMDBuild.proxy.core.Management.readAllEntryTypes({params:e,loadMask:!1,scope:this,success:function(e,t,r){r=r[CMDBuild.core.constants.Proxy.CLASSES],_CMCache.addClasses(r),CMDBuild.proxy.widget.Widget.readAll({loadMask:!1,scope:this,success:function(e,t,i){i=i[CMDBuild.core.constants.Proxy.RESPONSE],_CMCache.addWidgetToEntryTypes(i,!0)},callback:i})}}),CMDBuild.proxy.dashboard.Dashboard.readAllVisible({loadMask:!1,scope:this,success:function(e,t,i){i=i[CMDBuild.core.constants.Proxy.RESPONSE],_CMCache.addDashboards(i[CMDBuild.core.constants.Proxy.DASHBOARDS]),_CMCache.setAvailableDataSources(i[CMDBuild.core.constants.Proxy.DATA_SOURCES])},callback:t.getCallback("managementBuildCacheBarrier")}),(e={})[CMDBuild.core.constants.Proxy.ACTIVE]=!0,CMDBuild.proxy.core.Management.readAllDomains({params:e,loadMask:!1,scope:this,success:function(e,t,i){i=i[CMDBuild.core.constants.Proxy.DOMAINS],_CMCache.addDomains(i)},callback:t.getCallback("managementBuildCacheBarrier")}),CMDBuild.proxy.lookup.Type.readAll({loadMask:!1,scope:this,success:function(e,t,i){_CMCache.addLookupTypes(i)},callback:t.getCallback("managementBuildCacheBarrier")}),t.finalize("managementBuildCacheBarrier",!0)},buildConfiguration:function(){var e=Ext.create("CMDBuild.core.RequestBarrier",{id:"managementBuildConfigurationBarrier",callback:CMDBuild.core.Management.buildCache});Ext.create("CMDBuild.core.configurations.builder.Instance",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.Bim",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.Dms",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.Gis",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.Localization",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.RelationGraph",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.UserInterface",{callback:e.getCallback("managementBuildConfigurationBarrier")}),Ext.create("CMDBuild.core.configurations.builder.Workflow",{callback:e.getCallback("managementBuildConfigurationBarrier")}),e.finalize("managementBuildConfigurationBarrier",!0)},buildUserInterface:function(){if(!CMDBuild.core.CookiesManager.authorizationIsEmpty()){var e=[{className:"CMDBuild.controller.management.accordion.Menu",identifier:CMDBuild.core.constants.ModuleIdentifiers.getNavigation()}];CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.CLASS)||e.push({className:"CMDBuild.controller.management.accordion.Classes",identifier:"class"}),!CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.PROCESS)&&CMDBuild.configuration.workflow.get(CMDBuild.core.constants.Proxy.ENABLED)&&e.push({className:"CMDBuild.controller.management.accordion.Workflow",identifier:CMDBuild.core.constants.ModuleIdentifiers.getWorkflow()}),CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.DATA_VIEW)||e.push({className:"CMDBuild.controller.management.accordion.DataView",identifier:CMDBuild.core.constants.ModuleIdentifiers.getDataView()}),CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.DASHBOARD)||e.push({className:"CMDBuild.controller.management.accordion.Dashboard",identifier:"dashboard"}),CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.REPORT)||e.push({className:"CMDBuild.controller.management.accordion.Report",identifier:CMDBuild.core.constants.ModuleIdentifiers.getReport()}),CMDBuild.configuration.userInterface.isDisabledModule(CMDBuild.core.constants.Proxy.CUSTOM_PAGES)||e.push({className:"CMDBuild.controller.management.accordion.CustomPage",identifier:CMDBuild.core.constants.ModuleIdentifiers.getCustomPage()}),e.push({className:"CMDBuild.controller.management.accordion.Utility",identifier:CMDBuild.core.constants.ModuleIdentifiers.getUtility()}),Ext.ns("CMDBuild.global.controller"),CMDBuild.global.controller.MainViewport=Ext.create("CMDBuild.controller.common.MainViewport",{accordion:e,module:[{className:"CMDBuild.controller.management.customPage.SinglePage",identifier:CMDBuild.core.constants.ModuleIdentifiers.getCustomPage()},{className:"CMDBuild.controller.management.dataView.DataView",identifier:CMDBuild.core.constants.ModuleIdentifiers.getDataView()},{className:"CMDBuild.controller.management.report.Report",identifier:CMDBuild.core.constants.ModuleIdentifiers.getReport()},{className:"CMDBuild.controller.management.report.Single",identifier:CMDBuild.core.constants.ModuleIdentifiers.getReportSingle()},{className:"CMDBuild.controller.management.utility.Utility",identifier:CMDBuild.core.constants.ModuleIdentifiers.getUtility()},{className:"CMDBuild.controller.management.workflow.Workflow",identifier:CMDBuild.core.constants.ModuleIdentifiers.getWorkflow()},new CMDBuild.view.management.classes.CMModCard({cmControllerType:CMDBuild.controller.management.classes.CMModCardController,cmName:"class"}),new CMDBuild.view.management.dashboard.CMModDashboard({cmControllerType:CMDBuild.controller.management.dashboard.CMModDashboardController,cmName:"dashboard"})],scope:this,callback:function(){CMDBuild.core.Splash.hide(function(){CMDBuild.global.controller.MainViewport.cmfg("mainViewportInstanceNameSet",CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.INSTANCE_NAME)),CMDBuild.global.Routes.isRoutePathEmpty()?CMDBuild.global.controller.MainViewport.cmfg("mainViewportStartingEntitySelect"):CMDBuild.global.Routes.exec()},this)}})}}}),Ext.define("CMDBuild.core.LoadMask",{uses:["CMDBuild.core.Splash"],singleton:!0,instance:void 0,build:function(e){return e=Ext.isString(e)?e:CMDBuild.Translation.pleaseWait,Ext.isEmpty(CMDBuild.core.LoadMask.instance)&&(CMDBuild.core.LoadMask.instance=Ext.create("Ext.LoadMask",{msg:e,target:Ext.getBody()})),CMDBuild.core.LoadMask.instance},hide:function(){CMDBuild.core.LoadMask.build().hide()},show:function(e){(Ext.isEmpty(CMDBuild.core.Splash)||!Ext.isFunction(CMDBuild.core.Splash.build)||CMDBuild.core.Splash.build().isHidden())&&CMDBuild.core.LoadMask.build(e).show()}}),Ext.require("CMDBuild.core.constants.Proxy"),Ext.define("CMDBuild.model.common.field.multiselect.Group",{extend:"Ext.data.Model",fields:[{name:CMDBuild.core.constants.Proxy.DESCRIPTION,type:"string"},{name:CMDBuild.core.constants.Proxy.ID,type:"int",useNull:!0},{name:CMDBuild.core.constants.Proxy.IS_ACTIVE,type:"boolean"},{name:CMDBuild.core.constants.Proxy.NAME,type:"string"}]}),Ext.define("Ext.ux.form.field.TinyMCEWindowManager",{extend:"tinymce.WindowManager",constructor:function(e){tinymce.WindowManager.call(this,e.editor)},alert:function(e,t,i){Ext.MessageBox.alert("",e,function(){Ext.isEmpty(t)||t.call(this)},i)},confirm:function(e,t,i){Ext.MessageBox.confirm("",e,function(e){Ext.isEmpty(t)||t.call(this,"yes"==e)},i)},open:function(e,t){e=e||{},t=t||{},e.type||(this.bookmark=this.editor.selection.getBookmark("simple")),e.width=parseInt(e.width||320),e.height=parseInt(e.height||240)+(tinymce.isIE?8:0),e.min_width=parseInt(e.min_width||150),e.min_height=parseInt(e.min_height||100),e.max_width=parseInt(e.max_width||2e3),e.max_height=parseInt(e.max_height||2e3),e.movable=!0,e.resizable=!0,t.mce_width=e.width,t.mce_height=e.height,t.mce_inline=!0,this.features=e,this.params=t;var i=Ext.create("Ext.window.Window",{title:e.name,width:e.width,height:e.height,minWidth:e.min_width,minHeight:e.min_height,resizable:!0,maximizable:e.maximizable,minimizable:e.minimizable,modal:!0,stateful:!1,constrain:!0,layout:"fit",items:[Ext.create("Ext.Component",{autoEl:{tag:"iframe",border:"0",frameborder:"0",src:e.url||e.file},style:"border-width: 0px;"})]});return t.mce_window_id=i.getId(),i.show(null,function(){this.editor.fullscreen_is_enabled&&i.zIndexManager.setBase(2e5),e.left&&e.top&&i.setPagePosition(e.left,e.top);var r=i.getPosition();e.left=r[0],e.top=r[1],this.onOpen.dispatch(this,e,t)},this),i.toFront(!0),i},close:function(e){if(e.tinyMCEPopup&&e.tinyMCEPopup.id){var t=Ext.getCmp(e.tinyMCEPopup.id);t&&(this.onClose.dispatch(this),t.close())}else tinymce.WindowManager.prototype.close.call(this,e)},setTitle:function(e,t){if(e.tinyMCEPopup&&e.tinyMCEPopup.id){var i=Ext.getCmp(e.tinyMCEPopup.id);i&&i.setTitle(t)}else tinymce.WindowManager.prototype.setTitle.call(this,e,t)},resizeBy:function(e,t,i){var r=Ext.getCmp(i);if(r){var s=r.getSize();r.setSize(s.width+e,s.height+t)}}}),Ext.define("CMDBuild.core.constants.TemplateResolver",{singleton:!0,config:{templateList:["{client","{cql","{group","{js","{server","{user","{xa"]}}),Ext.define("CMDBuild.controller.common.abstract.Base",{uses:["CMDBuild.core.constants.Global","CMDBuild.core.Message"],parentDelegate:void 0,cmfgCatchedFunctions:[],identifier:void 0,stringToFunctionNameMap:{},view:void 0,constructor:function(e){this.stringToFunctionNameMap={},Ext.apply(this,e),Ext.isEmpty(this.identifier)||this.cmfgCatchedFunctions.push("identifierGet"),this.decodeCatchedFunctionsArray()},cmfg:function(e,t){if(!Ext.isString(e)||Ext.isEmpty(e))return _error("cmfg(): unmanaged name parameter",this,e);if(Ext.isArray(this.cmfgCatchedFunctions)&&!Ext.isEmpty(this.cmfgCatchedFunctions)&&!Ext.isEmpty(this.stringToFunctionNameMap[e])){if(Ext.isString(this.stringToFunctionNameMap[e])&&Ext.isFunction(this[this.stringToFunctionNameMap[e]]))return this[this.stringToFunctionNameMap[e]](t);if(Ext.isObject(this.stringToFunctionNameMap[e]))switch(this.stringToFunctionNameMap[e].action){case"forward":var i={};return Ext.isArray(this.stringToFunctionNameMap[e].target)&&Ext.Array.forEach(this.stringToFunctionNameMap[e].target,function(r,s,o){Ext.isEmpty(this[r])?_warning('undefined class property "this.'+r+'"',this):i[r]=this[r].cmfg(e,t)},this),1==Ext.Object.getSize(i)?Ext.Object.getValues(i)[0]:i}}return!Ext.isEmpty(this.parentDelegate)&&Ext.isFunction(this.parentDelegate.cmfg)?this.parentDelegate.cmfg(e,t):_warning('cmfg(): unmanaged function with name "'+e+'"',this)},decodeCatchedFunctionsArray:function(){Ext.Array.each(this.cmfgCatchedFunctions,function(e,t,i){if(Ext.isString(e)){if(e.indexOf("->")>=0){if(2==(s=e.split("->")).length&&Ext.String.trim(s[0]).indexOf(" ")<0){var r=Ext.String.trim(s[1]).split(",");Ext.Array.forEach(r,function(e,t,i){r[t]=Ext.String.trim(e)},this),this.stringToFunctionNameMap[Ext.String.trim(s[0])]={action:"forward",target:r}}}if(e.indexOf("=")>=0){var s=e.split("=");if(this.stringToFunctionNameMap[Ext.String.trim(s[0])]=Ext.String.trim(s[0]),2==s.length&&Ext.String.trim(s[0]).indexOf(" ")<0){var o=Ext.String.trim(s[1]).split(",");Ext.Array.each(o,function(e,t,i){this.stringToFunctionNameMap[Ext.String.trim(e)]=Ext.String.trim(s[0])},this)}}var a=Ext.String.trim(e);a.indexOf(" ")<0&&(this.stringToFunctionNameMap[a]=a)}},this)},getBaseTitle:function(){return Ext.isEmpty(this.view)||Ext.isEmpty(this.view.baseTitle)?"":this.view.baseTitle},getView:function(){return this.view},identifierGet:function(){return Ext.isString(this.identifier)&&!Ext.isEmpty(this.identifier)?this.identifier:null},onModuleInit:Ext.emptyFn,propertyManageGet:function(e){if(!Ext.isObject(e)||Ext.Object.isEmpty(e))return _error("propertyManageGet(): unmanaged parameters",this,e);if(!Ext.isString(e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME])||Ext.isEmpty(e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]))return _error("propertyManageGet(): unmanaged targetVariableName parameter",this,e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]);var t=void 0,i=this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]];return!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH])&&Ext.isArray(e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH])?t=e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH]:!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH])&&Ext.isString(e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH])&&(t=[e[CMDBuild.core.constants.Proxy.ATTRIBUTE_PATH]]),!Ext.isEmpty(t)&&Ext.isArray(t)&&Ext.Array.each(t,function(e,t,r){Ext.isString(e)&&!Ext.isEmpty(e)&&Ext.isObject(i)&&!Ext.Object.isEmpty(i)&&(i=Ext.isFunction(i.get)?i.get(e):Ext.isEmpty(i[e])?void 0:i[e])},this),i},propertyManageIsEmpty:function(e){var t=this.propertyManageGet(e);if(Ext.isObject(t)&&Ext.isFunction(t.getData)){var i=!0;return Ext.Object.each(t.getData(),function(e,t,r){return i=Ext.isEmpty(t)},this),i}return Ext.isObject(t)?Ext.Object.isEmpty(t):Ext.isEmpty(t)},propertyManageReset:function(e){!Ext.isEmpty(e)&&Ext.isString(e)&&(this[e]=null)},propertyManageSet:function(e){if(!Ext.Object.isEmpty(e)&&!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME])&&Ext.isString(e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME])&&!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.MODEL_NAME])){var t=e[CMDBuild.core.constants.Proxy.MODEL_NAME],i=Ext.isEmpty(e[CMDBuild.core.constants.Proxy.VALUE])?null:e[CMDBuild.core.constants.Proxy.VALUE];if(!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.PROPERTY_NAME])&&Ext.isString(e[CMDBuild.core.constants.Proxy.PROPERTY_NAME]))return(Ext.isEmpty(this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]])||Ext.getClassName(this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]])!=t)&&(this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]]=Ext.create(t)),this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]].set(e[CMDBuild.core.constants.Proxy.PROPERTY_NAME],i);Ext.isObject(i)&&!Ext.Object.isEmpty(i)&&(Ext.getClassName(i)==t?this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]]=i:this[e[CMDBuild.core.constants.Proxy.TARGET_VARIABLE_NAME]]=Ext.create(t,i))}},setViewTitle:function(e){e=Ext.isEmpty(e)?[]:e,e=Ext.isArray(e)?e:[e],Ext.isEmpty(this.view)||(Ext.isEmpty(e)?this.view.setTitle(this.getBaseTitle()):this.view.setTitle(this.getBaseTitle()+CMDBuild.core.constants.Global.getTitleSeparator()+e.join(CMDBuild.core.constants.Global.getTitleSeparator())))},validate:function(e,t){t=!Ext.isBoolean(t)||t;var i=e.getNonValidFields();if(!Ext.isEmpty(e)&&!Ext.isEmpty(i)&&Ext.isArray(i)&&t){var r="";return Ext.Array.each(i,function(e,t,i){!Ext.isEmpty(e)&&Ext.isFunction(e.getFieldLabel)&&(r+="<li>"+e.getFieldLabel()+"</li>")},this),CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,"<b>"+CMDBuild.Translation.errors.invalid_fields+'</b><ul style="text-align: left;">'+r+"</ul>",!1),!1}return!0}}),function(){Ext.define("CMDBuild.view.management.classes.map.CMCardGridPagingBar",{extend:"Ext.toolbar.Paging",grid:void 0}),Ext.define("CMDBuild.view.management.classes.map.CardGrid",{extend:"Ext.grid.Panel",delegate:void 0,border:!1,cls:"cmdb-border-bottom",frame:!1,map:void 0,noSelect:!1,oldCard:void 0,fromMe:void 0,initComponent:function(){var e=this.getStoreForFields([]);!function(e){var t=[];e.cmBasicFilter=!0,e.cmBasicFilter&&(e.gridSearchField=new CMDBuild.field.GridSearchField({grid:e}),t.push(e.gridSearchField)),e.pagingBar=new CMDBuild.view.management.common.CMCardGridPagingBar({grid:e,store:e.store,displayInfo:!0,displayMsg:"{0} - {1} "+CMDBuild.Translation.of+" {2}",emptyMsg:CMDBuild.Translation.noTopicsToDisplay,items:t}),e.bbar=e.pagingBar}(this),Ext.apply(this,{columns:[],store:e}),this.interactionDocument.observe(this),this.callParent(arguments)},listeners:{activate:function(){console.log("activate"),this.active=!0;this.interactionDocument.getCurrentCard()&&this.refresh()},deactivate:function(){this.active=!1},select:function(e,t,i){if(!this.noSelect){var r=t.get("IdClass"),s=this.interactionDocument.getEntryTypeById(r).get("name"),o={cardId:t.get("id"),className:s};this.interactionDocument.checkNavigationTree(o),this.interactionDocument.setNoZoom(!0),this.fromMe=!0,this.navigateOnCard(t)}}},navigateOnCard:function(e){this.delegate.cmfg("onCardNavigation",{Id:e.get("Id"),IdClass:e.get("IdClass")})},zoomOnCard:function(e){this.delegate.cmfg("onCardZoom",{Id:e.get("Id"),IdClass:e.get("IdClass")})},getStoreExtraParams:function(){return this.store.getProxy().extraParams},buildClassColumn:function(){return{header:CMDBuild.Translation.subClass,width:100,sortable:!1,dataIndex:this.CLASS_COLUMN_DATA_INDEX}},refresh:function(){if(!this.fromMe&&this.active){var e=this.interactionDocument.getCurrentCard();if(!function(e,t){return!(!t||!e)&&t.cardId==e.cardId&&t.className==e.className}(e,this.oldCard)){var t="";if(t=e?e.className:this.interactionDocument.getCurrentClassName()){if(this.store.proxy.setExtraParam("className",t),this.oldCard&&this.oldCard.className===t)this.jumpOnPosition(e);else{!function(e,t){var i=CMDBuild.Translation.management.modcard.title;t.setTitle(i+e)}(t,this);var i=this.interactionDocument.getEntryTypeByName(t),r=this;r.store.proxy.setExtraParam("className",t),i&&this.updateStoreForClassId(i.get("id"),function(){r.jumpOnPosition(e)},this)}this.oldCard=e}}}else this.fromMe=!1},jumpOnPosition:function(e){e&&this.getPosition(this.store,e,function(t){if(this.store.proxy.setExtraParam("className",e.className),t.found){var i=CMDBuild.core.Utils.getPageNumber(t.position),r=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),s=t.position%r,o=this;this.store.on("load",function(e,t,i,r){o.selectAt(s)}),this.store.loadPage(i)}else this.store.loadPage(1)},this)},selectAt:function(e){try{var t=this.getSelectionModel();t.deselectAll(),this.noSelect=!0,t.select(e),this.noSelect=!1}catch(e){this.noSelect=!1}},loadAttributes:function(e,t){this.interactionDocument.getAttributeListById(e,t,this)},addRendererToHeader:function(e){e.renderer=function(t,i,r,s,o,a,n){return void 0===(t=t||r.get(e.dataIndex))||null==t?"":("object"==typeof t?t=t.description:"boolean"==typeof t?t=t?Ext.MessageBox.buttonText.yes:Ext.MessageBox.buttonText.no:"string"==typeof t&&(t=Ext.util.Format.stripTags(t)),t)}},getPosition:function(e,t,i,r){if(t.className){var s=Ext.apply({},e.proxy.extraParams);s[CMDBuild.core.constants.Proxy.CARD_ID]=t.cardId,s[CMDBuild.core.constants.Proxy.CLASS_NAME]=t.className,s[CMDBuild.core.constants.Proxy.SORT]=Ext.encode(function(e){for(var t=e.getSorters(),i=[],r=0,s=t.length;r<s;++r){var o=t[r];i.push({property:o.property,direction:o.direction})}return i}(e)),CMDBuild.proxy.Card.readPosition({params:s,loadMask:!1,success:function(e,t,s){var o=(s=s[CMDBuild.core.constants.Proxy.RESPONSE])[CMDBuild.core.constants.Proxy.POSITION],a=s[CMDBuild.core.constants.Proxy.HAS_POSITION];i.apply(r,[{position:o,found:a}])}})}else i.apply(r,[{position:0,found:!1}])},updateStoreForClassId:function(e,t,i){var r=this;this.loadAttributes(e,function(s){r.currentClassId==e?t.apply(i,[]):(r.currentClassId=e,r.gridSearchField&&r.gridSearchField.setValue(""),r.cmAdvancedFilter&&r.controllerAdvancedFilterButtons.cmfg("entryTypeSet",{value:r.interactionDocument.getEntryTypeById(e).getData()}),r.printGridMenu&&r.printGridMenu.setDisabled(!e),r.setColumnsForClass(s),t.apply(i,[]))})},getStoreForFields:function(e){var t=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT);return this.buildStore(e,t)},buildStore:function(e,t){return e.push({name:"Id",type:"int"}),e.push({name:"IdClass",type:"int"}),e.push("IdClass_value"),CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.CARD,{autoLoad:!1,fields:e,pageSize:t,remoteSort:!0,proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.card.readAll,reader:{type:"json",root:"rows",totalProperty:"results",idProperty:"Id"},extraParams:null},listeners:{beforeload:function(e,t,i){}}})},setColumnsForClass:function(e){var t=this.buildColumnsForAttributes(e),i=this.getStoreForFields(t.fields);this.suspendLayouts(),this.reconfigure(i,t.headers),this.resumeLayouts(!0),this.pagingBar&&this.pagingBar.bindStore(i)},buildColumnsForAttributes:function(e){this.classAttributes=e;var t=[],i=[];_CMUtils.isSuperclass(this.currentClassId)&&t.push(this.buildClassColumn());for(var r=0;r<e.length;r++){var s=e[r],o=CMDBuild.Management.FieldManager.getHeaderForAttr(s);o&&"IdClass_value"!=o.dataIndex?(this.addRendererToHeader(o),t.push(o),i.push(o.dataIndex)):"Description"==s.name&&i.push("Description")}return{headers:t,fields:i}}})}(),function(){function e(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function t(e,t){return e.findChildBy(function(e){return e.raw.layerName===t},null,!0)}var i="cm_external_layers_folder",r="cm_cmdbuild_layers_folder",s="cm_geoserver_layers_folder";Ext.define("CMDBuild.view.management.classes.map.LayerTree",{extend:"Ext.tree.Panel",requires:["CMDBuild.proxy.gis.Layer"],delegate:void 0,border:!1,cls:"cmdb-border-bottom",frame:!1,map:void 0,oldClassName:void 0,constructor:function(){var e=CMDBuild.proxy.gis.Layer.getStore();this.store=e,this.callParent(arguments)},initComponent:function(){this.interactionDocument.observe(this),this.interactionDocument.observeLayers(this),this.callParent(arguments)},checkNode:function(e,t){if(e.raw.leaf)this.interactionDocument.getLayerByClassAndName(e.raw.className,e.raw.layerName,function(i){i||(i=this.interactionDocument.getThematicLayerByName(e.raw.layerName)),this.delegate.cmfg("onVisibilityChange",{checked:t,layer:i})},this);else for(var i=e.childNodes,r=0;r<i.length;r++)this.checkNode(i[r],t)},listeners:{checkchange:function(e,t,i){this.checkNode(e,t)}},navigateOnCard:function(e){this.delegate.cmfg("onCardNavigation",{Id:e.get("Id"),IdClass:e.get("IdClass")})},refreshLayers:function(e){var t=this.interactionDocument.getCurrentCard();if(t){var i=t.cardId,r=t.className,s=this;this.interactionDocument.getAllLayers(function(t){for(var o=s.getRootNode(),a=0;a<t.length;a++){var n=function(e,t){return e.findChildBy(function(e){return e.raw.layerName===t.name&&e.raw.className===t.masterTableName},null,!0)}(o,t[a]),l=s.interactionDocument.isVisible(t[a],r,i),c=s.inZoom(t[a]);if(l)if(l&&n&&c&&!0===e){var d=s.interactionDocument.getLayerVisibility(t[a]);n.set("checked",d)}else l&&n&&!c?n.remove():l&&c&&!n?s.addLayerItem(t[a]):!l&&n&&n.remove();else;}})}},inZoom:function(e){var t=this.interactionDocument.getZoom();return!(t<e.minZoom||t>e.maxZoom)},refresh:function(){var s=this.interactionDocument.getCurrentCard();s&&(this.oldClassName!==s.className&&function(s){var o=t(s,i),a=t(s,r);e(o),e(a)}(this.getRootNode()),this.oldClassName=s.className,this.refreshLayers(!0))},addLayerItem:function(e){var t=this.retrieveTargetFolder(e,this.getRootNode());if(e.masterTableName!==CMDBuild.gis.constants.layers.THEMATISM_LAYER){var i=Ext.isEmpty(_CMCardModuleState.entryType)?void 0:_CMCardModuleState.entryType.getName();Ext.isEmpty(_CMCardModuleState.card)||_CMCardModuleState.card.raw.Id;try{var r=function(e,t){return CMDBuild.gis.constants.layers.THEMATISM_LAYER===t?"":CMDBuild.gis.constants.layers.GEOSERVER_LAYER===t?"":e===t?"":" ("+t+")"}(i,e.masterTableName),s=t.appendChild({text:e.name+r,layerName:e.name,className:e.masterTableName,leaf:!0,checked:!0});s.layerId=e.id,s.layerIndex=e.cmdb_index}catch(t){console.log("Fail to add layer",e)}}},retrieveTargetFolder:function(e,o){var a=null;return e.isBaseLayer?a=t(o,i):e.masterTableName===CMDBuild.gis.constants.layers.GEOSERVER_LAYER?a=function(e){var r=t(e,i),o=t(r,s);return o||(o=r.appendChild({text:CMDBuild.Translation.administration.modcartography.geoserver.title,layerName:s,checked:!0})),o}(o):e.masterTableName===CMDBuild.gis.constants.layers.THEMATISM_LAYER||(a=t(o,r)),a}})}(),function(){function e(e){return JSON.parse(JSON.stringify(e))}Ext.define("CMDBuild.view.management.classes.map.thematism.ThematismMainWindow",{extend:"CMDBuild.core.window.AbstractCustomModal",delegate:void 0,baseTitle:CMDBuild.Translation.searchFilter,dimensionsMode:"percentage",wrapper:void 0,border:!0,closeAction:"hide",frame:!0,bodyCls:"cmdb-blue-panel",layout:"fit",thematismConfiguration:void 0,functionConfiguration:void 0,layoutConfiguration:void 0,initComponent:function(){this.configureThematism=Ext.create("CMDBuild.view.management.classes.map.thematism.configurationSteps.ConfigureThematism",{interactionDocument:this.interactionDocument,parentWindow:this}),this.configureSourceFunction=Ext.create("CMDBuild.view.management.classes.map.thematism.configurationSteps.ConfigureSourceFunction",{interactionDocument:this.interactionDocument,parentWindow:this}),this.configureFieldFunction=Ext.create("CMDBuild.view.management.classes.map.thematism.configurationSteps.ConfigureFieldFunction",{interactionDocument:this.interactionDocument,parentWindow:this}),this.configureLayout=Ext.create("CMDBuild.view.management.classes.map.thematism.configurationSteps.ConfigureLayout",{interactionDocument:this.interactionDocument,parentWindow:this}),this.wizard=this.getWizard(),Ext.apply(this,{items:[this.wizard]}),this.callParent(arguments)},listeners:{hide:function(e,t){},show:function(e,t){this.configureThematism.loadComponents(function(){this.wizard.getLayout().setActiveItem("configureThematism")},this)}},getWizard:function(){return Ext.widget("panel",{title:"",border:!1,itemId:"wizard",width:"100%",height:"100%",bodyCls:"cmdb-blue-panel",layout:"card",defaults:{border:!1,bodyPadding:20},items:[this.configureThematism,this.configureSourceFunction,this.configureFieldFunction,this.configureLayout]})},configure:function(t){this.layoutConfiguration=e(t.layoutConfiguration),this.functionConfiguration=e(t.functionConfiguration),this.thematismConfiguration=e(t.thematismConfiguration)},getCurrentAttribute:function(){return this.functionConfiguration.attribute},getCurrentStrategy:function(){return this.interactionDocument.getStrategyByDescription(this.functionConfiguration.currentStrategy)},getCurrentSourceType:function(){return this.thematismConfiguration.source},getCurrentLayer:function(){return this.thematismConfiguration.sourceLayer},getCurrentLayout:function(){return this.thematismConfiguration.sourceLayer},getCurrentAnalysisType:function(){return this.thematismConfiguration.analysis},getThematismConfiguration:function(){return this.thematismConfiguration},getFunctionConfiguration:function(){return this.functionConfiguration},getLayoutConfiguration:function(){return this.layoutConfiguration},getAnalysisDescription:function(e){switch(e){case CMDBuild.gis.constants.layers.RANGES_ANALYSIS:return CMDBuild.Translation.thematismRanges;case CMDBuild.gis.constants.layers.PUNTUAL_ANALYSIS:return CMDBuild.Translation.thematismPuntual;case CMDBuild.gis.constants.layers.GRADUATE_ANALYSIS:return CMDBuild.Translation.thematismGraduate}return CMDBuild.Translation.thematismPuntual},getSourceDescription:function(e){switch(e){case CMDBuild.gis.constants.layers.TABLE_SOURCE:return CMDBuild.Translation.thematicTable;case CMDBuild.gis.constants.layers.FUNCTION_SOURCE:return CMDBuild.Translation.thematicFunction}return CMDBuild.Translation.thematicTable},getCurrentLayerType:function(){var e=this.interactionDocument.getGeoLayerByName(this.getCurrentLayer()),t=void 0;return e&&(t=e.get("adapter").getAttributeType()),t},getLayerName:function(){return this.thematismConfiguration.layerName},close:function(){this.hide()},advanceConfigurationLayouts:function(){CMDBuild.core.LoadMask.show(),this.configureLayout.loadComponents(function(){CMDBuild.core.LoadMask.hide(),this.wizard.getLayout().setActiveItem("configureLayout")},this)},advance:function(e,t){switch(e){case"configureThematism":this.thematismConfiguration=t,this.thematismConfiguration.source===CMDBuild.gis.constants.layers.FUNCTION_SOURCE?this.configureSourceFunction.loadComponents(function(){this.wizard.getLayout().setActiveItem("configureSourceFunction")},this):this.configureFieldFunction.loadComponents(function(){this.wizard.getLayout().setActiveItem("configureFieldFunction")},this);break;case"configureFieldFunction":case"configureSourceFunction":this.functionConfiguration=t,this.advanceConfigurationLayouts()}},previous:function(e){switch(e){case"configureSourceFunction":case"configureFieldFunction":this.wizard.getLayout().setActiveItem("configureThematism");break;case"configureLayout":this.thematismConfiguration.source===CMDBuild.gis.constants.layers.FUNCTION_SOURCE?this.wizard.getLayout().setActiveItem("configureSourceFunction"):this.wizard.getLayout().setActiveItem("configureFieldFunction")}},showOnMap:function(t){this.layoutConfiguration=t;var i=this.interactionDocument.getCurrentCard().className;this.delegate.cmfg("onShowThematism",{name:this.getLayerName(),layer:this.interactionDocument.getGeoLayerByName(this.getCurrentLayer()),strategy:this.getCurrentStrategy(),configuration:{originalLayer:{className:i,name:this.thematismConfiguration.sourceLayer},thematismConfiguration:e(this.thematismConfiguration),functionConfiguration:e(this.functionConfiguration),layoutConfiguration:e(this.layoutConfiguration)}}),this.hide()},initForm:function(e,t){t&&e.items.each(function(i){var r=e.child("[name='"+i.name+"']");if("radiogroup"===i.xtype){var s={};s[i.name]=t[i.name],r.setValue(s)}else r.setValue&&r.setValue(t[i.name])})}})}(),Ext.define("CMDBuild.view.management.classes.map.proxy.Functions",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.interfaces.Rest","CMDBuild.proxy.index.Rest"],singleton:!0,readAllFunctions:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{method:"GET",url:CMDBuild.proxy.index.Rest.functions+"/"}),CMDBuild.core.interfaces.Rest.request(e)},readAttributes:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{method:"GET",url:CMDBuild.proxy.index.Rest.functions+"/"+e._id+"/attributes/"}),CMDBuild.core.interfaces.Rest.request(e)},readParameters:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{method:"GET",url:CMDBuild.proxy.index.Rest.functions+"/"+e._id+"/parameters/"}),CMDBuild.core.interfaces.Rest.request(e)},readOutput:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{method:"GET",url:CMDBuild.proxy.index.Rest.functions+"/"+e._id+"/outputs/"}),CMDBuild.core.interfaces.Rest.request(e)}}),Ext.define("CMDBuild.controller.management.common.widgets.workflow.StaticsController",{uses:["CMDBuild.core.constants.Global"],singleton:!0,filterAttributesInStep:function(e,t){var i=[];return!Ext.isEmpty(e)&&Ext.isArray(e)&&!Ext.isEmpty(t)&&Ext.isArray(t)&&Ext.Array.each(t,function(t,r,s){Ext.Array.each(e,function(e,r,s){if(e.name==t.name)return e.isnotnull=t.mandatory,e.fieldmode=t.writable?"write":"read",i.push(e),!1},this)},this),i},getInvalidAttributeAsHTML:function(e){var t=CMDBuild.controller.management.workflow.panel.form.tabs.activity.StaticsController.getInvalidField(e),i=null;return!Ext.Object.isEmpty(t)&&Ext.isObject(t)&&(i="",Ext.Object.each(t,function(e,t,r){if(!Ext.isEmpty(t)){var s=t.getFieldLabel();0==s.indexOf(CMDBuild.core.constants.Global.getMandatoryLabelFlag())&&(s=s.replace(CMDBuild.core.constants.Global.getMandatoryLabelFlag(),"")),i+="<li>"+s+"</li>"}},this),i="<ul>"+i+"</ul>"),i},getInvalidField:function(e){var t=e.getFields().getRange(),i={};return!Ext.isEmpty(t)&&Ext.isArray(t)&&Ext.Array.each(t,function(e,t,r){e.isValid()?Ext.isEmpty(i[e.name])||delete i[e.name]:i[e.name]=e},this),i}}),Ext.define("CMDBuild.proxy.management.widget.Workflow",{uses:["CMDBuild.core.constants.Global","CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readStartActivity:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.activity.readStart}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW_ACTIVITY,e)},readWorkflowByFilter:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)},updateActivity:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.activity.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW_ACTIVITY,e,!0)}}),Ext.define("CMDBuild.proxy.management.widget.LinkCards",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllCards:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)},readCardPosition:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.getPosition}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)}}),Ext.define("CMDBuild.proxy.management.widget.ManageRelation",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllRelations:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e)},removeCard:function(e){(e=Ext.isEmpty(e)?{}:e).important=!0,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e,!0)},removeRelation:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.relation.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.RELATION,e,!0)}}),Ext.require("CMDBuild.core.constants.Proxy"),Ext.define("CMDBuild.model.administration.userAndGroup.group.defaultFilters.Filter",{extend:"Ext.data.Model",fields:[{name:CMDBuild.core.constants.Proxy.CONFIGURATION,type:"auto"},{name:CMDBuild.core.constants.Proxy.DESCRIPTION,type:"string"},{name:CMDBuild.core.constants.Proxy.ENTRY_TYPE,type:"string"},{name:CMDBuild.core.constants.Proxy.ID,type:"int",useNull:!0},{name:CMDBuild.core.constants.Proxy.NAME,type:"string"},{name:CMDBuild.core.constants.Proxy.TEMPLATE,type:"boolean"}]}),Ext.define("CMDBuild.core.interfaces.FormSubmit",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.CookiesManager","CMDBuild.core.interfaces.messages.Error","CMDBuild.core.interfaces.messages.Warning","CMDBuild.core.interfaces.service.LoadMask"],singleton:!0,adapterCallback:function(e,t,i){CMDBuild.core.CookiesManager.authorizationExpirationUpdate(),CMDBuild.core.interfaces.service.LoadMask.manage(t.loadMask,!1),CMDBuild.core.interfaces.messages.Warning.display(t.result),CMDBuild.core.interfaces.messages.Error.display(t.result,t),Ext.callback(i,t.scope,[t,t.result.success,t.response])},adapterSuccess:function(e,t,i){Ext.callback(i,t.scope,[t.response,t,t.result])},adapterFailure:function(e,t,i){Ext.callback(i,t.scope,[t.response,t,t.result])},interceptorCallback:function(e){return Ext.bind(CMDBuild.core.interfaces.FormSubmit.adapterCallback,e.scope,[e.callback],!0)},interceptorFailure:function(e){return Ext.Function.createSequence(Ext.bind(CMDBuild.core.interfaces.FormSubmit.adapterFailure,e.scope,[e.failure],!0),e.callback,e.scope)},interceptorSuccess:function(e){return Ext.Function.createSequence(Ext.bind(CMDBuild.core.interfaces.FormSubmit.adapterSuccess,e.scope,[e.success],!0),e.callback,e.scope)},trapCallbacks:function(e,t,i){Ext.isEmpty(t.form)||t.form.standardSubmit||(CMDBuild.core.interfaces.service.LoadMask.manage(t.loadMask,!0),t.callback=CMDBuild.core.interfaces.FormSubmit.interceptorCallback(t),t.failure=CMDBuild.core.interfaces.FormSubmit.interceptorFailure(t),t.success=CMDBuild.core.interfaces.FormSubmit.interceptorSuccess(t))},submit:function(e){if(Ext.applyIf(e,{method:"POST",buildRuntimeForm:!1,loadMask:!0,scope:this,callback:Ext.emptyFn,failure:Ext.emptyFn,success:Ext.emptyFn}),Ext.isEmpty(e.form))if(Ext.isEmpty(e.form)&&e.buildRuntimeForm){e.params[CMDBuild.core.constants.Proxy.FORCE_DOWNLOAD_PARAM_KEY]=!0;var t=Ext.create("Ext.form.Panel",{standardSubmit:!0,url:e.url});t.submit({target:"_blank",params:e.params}),Ext.defer(function(){t.close()},100)}else _error("submit(): form object not managed","CMDBuild.core.interfaces.FormSubmit",e.form);else e.form.on("beforeaction",CMDBuild.core.interfaces.FormSubmit.trapCallbacks,this,{single:!0}),e.form.submit(e)}}),Ext.define("CMDBuild.controller.common.abstract.Routes",{extend:"Ext.app.Controller",paramsValidation:function(e){return!0},saveRoute:function(e,t,i){CMDBuild.global.Routes.setRoutePath(t)}}),Ext.define("CMDBuild.core.configurations.Routes",{singleton:!0,config:{simpleFilterSeparator:"~"},constructor:function(e){this.initConfig(e)}}),Ext.define("CMDBuild.proxy.management.routes.Card",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllCards:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.card.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CARD,e)},readClassByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.classes.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CLASS,e)}}),Ext.define("CMDBuild.proxy.management.routes.Classes",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readClassByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.classes.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.CLASS,e)}}),Ext.define("CMDBuild.controller.management.workflow.Utils",{uses:["CMDBuild.core.constants.WorkflowStates"],singleton:!0,translateStatusFromCapitalizedMode:function(e){switch(e){case CMDBuild.core.constants.WorkflowStates.getOpenCapitalized():return CMDBuild.core.constants.WorkflowStates.getOpen();case CMDBuild.core.constants.WorkflowStates.getSuspendedCapitalized():return CMDBuild.core.constants.WorkflowStates.getSuspended();case CMDBuild.core.constants.WorkflowStates.getCompletedCapitalized():return CMDBuild.core.constants.WorkflowStates.getCompleted();case CMDBuild.core.constants.WorkflowStates.getAbortedCapitalized():return CMDBuild.core.constants.WorkflowStates.getAborted();default:return e}}}),Ext.define("CMDBuild.core.constants.WorkflowStates",{singleton:!0,config:{aborted:"closed.aborted",abortedCapitalized:"ABORTED",all:"all",completed:"closed.completed",completedCapitalized:"COMPLETED",open:"open.running",openCapitalized:"OPEN",suspended:"open.not_running.suspended",suspendedCapitalized:"SUSPENDED"},constructor:function(e){this.initConfig(e)}}),Ext.define("CMDBuild.proxy.management.routes.Instance",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.instance.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW_INSTANCE,e)},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.instance.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW_INSTANCE,e)},readWorkflowByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW,e)}}),Ext.define("CMDBuild.core.constants.ModuleIdentifiers",{singleton:!0,config:{classes:"class",configuration:"configuration",customPage:"custompage",dataView:"dataview",domain:"domain",email:"email",filter:"filter",localization:"localization",lookupType:"lookuptype",menu:"menu",navigation:"navigation",navigationTree:"navigationtree",report:"report",reportSingle:"reportsingle",taskManager:"taskManager",userAndGroup:"userandgroup",utility:"utility",workflow:"workflow"},constructor:function(e){this.initConfig(e)}}),Ext.define("CMDBuild.proxy.management.routes.Workflow",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readByName:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.workflow.readByName}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WORKFLOW,e)}}),Ext.define("CMDBuild.proxy.core.Management",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAllDomains:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.domain.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DOMAIN,e)},readAllEntryTypes:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.entryType.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.ENTRY_TYPE,e)}}),Ext.define("CMDBuild.proxy.dashboard.Dashboard",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,create:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.create}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e)},readAllVisible:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.readAllVisible}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)},updateColumns:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.dashboard.columns.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.DASHBOARD,e,!0)}}),Ext.define("CMDBuild.proxy.lookup.Type",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.model.lookup.Type"],singleton:!0,create:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.lookup.type.create}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.LOOKUP,e,!0)},getStore:function(){return CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.LOOKUP,{autoLoad:!0,model:"CMDBuild.model.lookup.Type",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.lookup.type.readAll,reader:{type:"json"}},sorters:[{property:CMDBuild.core.constants.Proxy.DESCRIPTION,direction:"ASC"}]})},read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.lookup.type.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.LOOKUP,e)},readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.lookup.type.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.LOOKUP,e)},update:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.lookup.type.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.LOOKUP,e,!0)}}),Ext.define("CMDBuild.proxy.Menu",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,create:Ext.emptyFn,read:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.menu.read}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.MENU,e)},readAvailableItems:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.menu.readAvailableItems}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.MENU,e)},readConfiguration:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.menu.readConfiguration}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.MENU,e)},remove:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.menu.remove}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.MENU,e,!0)},save:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.menu.update}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.MENU,e,!0)}}),Ext.define("CMDBuild.proxy.widget.Widget",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],singleton:!0,readAll:function(e){e=Ext.isEmpty(e)?{}:e,Ext.apply(e,{url:CMDBuild.proxy.index.Json.widget.readAll}),CMDBuild.global.Cache.request(CMDBuild.core.constants.Proxy.WIDGET,e)}}),Ext.define("CMDBuild.core.window.AbstractCustomModal",{extend:"Ext.window.Window",dimensions:{},dimensionsMode:"none",constrain:!0,layout:"fit",modal:!0,resizable:!0,initComponent:function(){switch(this.dimensionsMode){case"absolute":Ext.Object.isEmpty(this.dimensions)&&Ext.apply(this.dimensions,{height:600,width:800}),Ext.isNumber(this.dimensions.height)&&(this.height=this.dimensions.height),Ext.isNumber(this.dimensions.width)&&(this.width=this.dimensions.width);break;case"percentage":Ext.Object.isEmpty(this.dimensions)&&Ext.apply(this.dimensions,{height:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.POPUP_HEIGHT_PERCENTAGE),width:CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.POPUP_WIDTH_PERCENTAGE)}),Ext.isNumber(this.dimensions.height)&&(this.height=Ext.getBody().getHeight()*(this.dimensions.height/100)),Ext.isNumber(this.dimensions.width)&&(this.width=Ext.getBody().getWidth()*(this.dimensions.width/100))}this.callParent(arguments)}}),Ext.define("CMDBuild.core.interfaces.Rest",{extend:"Ext.data.Connection",uses:["CMDBuild.core.CookiesManager","CMDBuild.core.interfaces.messages.Error","CMDBuild.core.interfaces.messages.Warning","CMDBuild.core.interfaces.service.LoadMask","CMDBuild.core.Utils"],singleton:!0,autoAbort:!1,listeners:{beforerequest:function(e,t,i){return CMDBuild.core.interfaces.Rest.trapCallbacks(e,t)}},adapterCallback:function(e,t,i,r){var s=CMDBuild.core.interfaces.Rest.decodeJson(i.responseText);CMDBuild.core.CookiesManager.authorizationExpirationUpdate(),CMDBuild.core.interfaces.service.LoadMask.manage(e.loadMask,!1),CMDBuild.global.interfaces.Configurations.get("disableAllMessages")||(CMDBuild.global.interfaces.Configurations.get("disableWarnings")||CMDBuild.core.interfaces.messages.Warning.display(s),CMDBuild.global.interfaces.Configurations.get("disableErrors")||CMDBuild.core.interfaces.messages.Error.display(s,e)),Ext.callback(r,e.scope,[e,t,i])},adapterSuccess:function(e,t,i){var r=CMDBuild.core.interfaces.Rest.decodeJson(e.responseText);Ext.callback(i,t.scope,[e,t,r])},adapterFailure:function(e,t,i){var r=CMDBuild.core.interfaces.Rest.decodeJson(e.responseText);Ext.callback(i,t.scope,[e,t,r])},decodeJson:function(e){if(e=Ext.isEmpty(e)?'{"success":true,"response":null}':e,CMDBuild.core.Utils.isJsonString(e)){Ext.isEmpty(e)||(e=e.replace(/<\/\w+>$/,""));try{return Ext.decode(e)}catch(e){_error(e,"CMDBuild.core.interfaces.Rest")}return""}return _error('invalid json string: "'+e+'"',"CMDBuild.core.interfaces.Rest"),""},interceptorCallback:function(e){return Ext.bind(CMDBuild.core.interfaces.Rest.adapterCallback,e.scope,[e.callback],!0)},interceptorFailure:function(e){return Ext.bind(CMDBuild.core.interfaces.Rest.adapterFailure,e.scope,[e.failure],!0)},interceptorSuccess:function(e){return Ext.bind(CMDBuild.core.interfaces.Rest.adapterSuccess,e.scope,[e.success],!0)},onComplete:function(e,t){var i=e.options,r=void 0,s=!0;if((r=e.aborted||e.timedout?this.createException(e):this.createResponse(e)).status<200||r.status>=400){s=!1;var o=window.location.toString().split("/");o=Ext.Array.slice(o,0,o.length-1).join("/"),r.responseText=Ext.encode({success:!1,errors:[{reason:"ORM_CUSTOM_EXCEPTION",reasonParameters:r.statusText,stacktrace:r.request.options.method+" "+o+"/"+r.request.options.url+" "+r.status+" ("+r.statusText+")"}]})}return s?(this.fireEvent("requestcomplete",this,r,i),Ext.callback(i.success,i.scope,[r,i])):(this.fireEvent("requestexception",this,r,i),Ext.callback(i.failure,i.scope,[r,i])),Ext.callback(i.callback,i.scope,[i,s,r]),delete this.requests[e.id],r},trapCallbacks:function(e,t){return CMDBuild.core.interfaces.service.LoadMask.manage(t.loadMask,!0),Ext.apply(t,{callback:CMDBuild.core.interfaces.Rest.interceptorCallback(t),failure:CMDBuild.core.interfaces.Rest.interceptorFailure(t),success:CMDBuild.core.interfaces.Rest.interceptorSuccess(t)}),!0}}),Ext.define("CMDBuild.proxy.index.Rest",{singleton:!0,fileStores:"services/rest/v2/filestores",icons:"services/rest/v2/icons",functions:"services/rest/v2/functions"}),Ext.require("CMDBuild.core.constants.Proxy"),Ext.define("CMDBuild.model.lookup.Type",{extend:"Ext.data.Model",fields:[{name:CMDBuild.core.constants.Proxy.ID,type:"string"},{name:CMDBuild.core.constants.Proxy.DESCRIPTION,type:"string"},{name:CMDBuild.core.constants.Proxy.PARENT,type:"string"},{name:CMDBuild.core.constants.Proxy.TEXT,type:"string"}]});