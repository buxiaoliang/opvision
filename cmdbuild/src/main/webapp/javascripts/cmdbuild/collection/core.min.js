!function(){Ext.Loader.setConfig({enabled:!0,disableCaching:!1,paths:{CMDBuild:"./javascripts/cmdbuild",CMDBUild:"./javascripts/cmdbuild","Ext.ux":"./javascripts/ext-"+function(e){(e=e||{}).separator=e.separator||".",e.major=e.major||!0,e.minor=e.minor||!0,e.patch=e.patch||!0,e.release=e.release||!1;var t=Ext.getVersion("extjs"),i=[];return e.major&&i.push(t.getMajor()),e.minor&&i.push(t.getMinor()),e.patch&&i.push(t.getPatch()),e.release&&i.push(t.getRelease()),i.join(e.separator)}({release:!1})+"-ux",Logger:"./javascripts/log"}})}(),Ext.define("CMDBuild.core.Data",{uses:["CMDBuild.core.configurations.Timeout","CMDBuild.core.constants.Proxy","CMDBuild.core.CookiesManager"],enableLocalized:!1,constructor:function(e){Ext.apply(this,e);var t=CMDBuild.core.CookiesManager.authorizationGet();return!Ext.isObject(CMDBuild)||Ext.isEmpty(CMDBuild)?_error("constructor(): undefined CMDBuild object",this):!Ext.isString(t)||Ext.isEmpty(t)?_error("constructor(): invalid chooky authorization key value",this,t):(Ext.Ajax.timeout=1e3*CMDBuild.core.configurations.Timeout.getBase(),Ext.Ajax[CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY]=CMDBuild.core.CookiesManager.authorizationGet(),Ext.Ajax[CMDBuild.core.constants.Proxy.LOCALIZED_HEADER_KEY]=this.enableLocalized,this.dataDefaultHeadersUpdate(),Ext.define("CMDBuild.data.proxy.Ajax",{override:"Ext.data.proxy.Ajax",timeout:1e3*CMDBuild.core.configurations.Timeout.getBase()}),Ext.define("CMDBuild.form.Basic",{override:"Ext.form.Basic",timeout:CMDBuild.core.configurations.Timeout.getBase()}),Ext.ns("CMDBuild.global"),void(CMDBuild.global.Data=this))},dataDefaultHeadersUpdate:function(){var e={};e[CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY]=CMDBuild.core.CookiesManager.authorizationGet(),e[CMDBuild.core.constants.Proxy.LOCALIZED_HEADER_KEY]=this.enableLocalized,Ext.define("CMDBuild.data.Connection",{override:"Ext.data.Connection",timeout:1e3*CMDBuild.core.configurations.Timeout.getBase(),defaultHeaders:e}),Ext.Ajax[CMDBuild.core.constants.Proxy.AUTHORIZATION_HEADER_KEY]=CMDBuild.core.CookiesManager.authorizationGet()}}),function(){Ext.define("CMDBuild.core.Utils",{uses:["CMDBuild.core.constants.Global"],singleton:!0,decodeAsBoolean:function(e){if(!Ext.isEmpty(e))switch(Ext.typeOf(e)){case"boolean":return e;case"number":return 0!=e;case"string":return"true"==e.toLowerCase()||"on"==e.toLowerCase()}return!1},deepCloneStore:function(e){var t=Ext.create("Ext.data.Store",{model:e.model});return e.each(function(i){var n=Ext.clone(i.copy().data),r=new e.model(n,n.id);t.add(r)},this),t},getEntryTypeAncestorsId:function(e){var t=[];if(!Ext.Object.isEmpty(e))for(t.push(parseInt(e.get(CMDBuild.core.constants.Proxy.ID)));!Ext.isEmpty(e)&&!Ext.isEmpty(e.get(CMDBuild.core.constants.Proxy.PARENT));)e=_CMCache.getEntryTypeById(e.get(CMDBuild.core.constants.Proxy.PARENT)),Ext.isEmpty(e)||t.push(parseInt(e.get(CMDBuild.core.constants.Proxy.ID)));return t},getEntryTypePrivilegesByName:function(e){return _CMUtils.getEntryTypePrivileges(_CMCache.getEntryTypeByName(e||""))},getExtJsVersion:function(e){(e=e||{}).separator=e.separator||".",e.major=e.major||!0,e.minor=e.minor||!0,e.patch=e.patch||!0,e.release=e.release||!1;var t=Ext.getVersion("extjs"),i=[];return e.major&&i.push(t.getMajor()),e.minor&&i.push(t.getMinor()),e.patch&&i.push(t.getPatch()),e.release&&i.push(t.getRelease()),i.join(e.separator)},getPageNumber:function(e){return 0==e?1:Ext.isEmpty(e)?2:Math.floor(parseInt(e)/CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT)+1)},groupAttributesObjects:function(e,t){(t=Ext.isArray(t)?t:[]).push("Notes");var i={},n=[];return Ext.Array.forEach(e,function(e,r,a){Ext.isEmpty(e)||Ext.Array.contains(t,e[CMDBuild.core.constants.Proxy.NAME])||(Ext.isEmpty(e[CMDBuild.core.constants.Proxy.GROUP])?n.push(e):(Ext.isEmpty(i[e[CMDBuild.core.constants.Proxy.GROUP]])&&(i[e[CMDBuild.core.constants.Proxy.GROUP]]=[]),i[e[CMDBuild.core.constants.Proxy.GROUP]].push(e)))},this),Ext.isEmpty(n)||(i[CMDBuild.Translation.management.modcard.other_fields]=n),i},hasHtmlTags:function(e){return"string"==typeof e&&/<[a-z][\s\S]*>/i.test(e)},isJsonString:function(string){return!(!Ext.isString(string)||Ext.isEmpty(string))&&(!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(string.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+string+")"))},isObjectEmpty:function(e){if(Ext.isObject(e)){var t=!0;return Ext.Object.each(e,function(e,i,n){if(Ext.isObject(i)){if(!Ext.Object.isEmpty(i))return t=!1,!1}else if(!Ext.isEmpty(i))return t=!1,!1},this),t}return!1},objectArraySort:function(e,t,i,n){return t=Ext.isString(t)?t:CMDBuild.core.constants.Proxy.DESCRIPTION,i=Ext.isString(i)?i:"ASC",n=!!Ext.isBoolean(n)&&n,Ext.isArray(e)&&!Ext.isEmpty(e)?Ext.Array.sort(e,function(e,r){var a=void 0,o=void 0;switch(Ext.isFunction(e.get)&&Ext.isFunction(r.get)?(a=!n&&Ext.isFunction(e.get(t).toLowerCase)?e.get(t).toLowerCase():e.get(t),o=!n&&Ext.isFunction(r.get(t).toLowerCase)?r.get(t).toLowerCase():r.get(t)):Ext.isEmpty(e[t])||Ext.isEmpty(r[t])||(a=!n&&Ext.isFunction(e[t].toLowerCase)?e[t].toLowerCase():e[t],o=!n&&Ext.isFunction(r[t].toLowerCase)?r[t].toLowerCase():r[t]),i){case"DESC":return a>o?-1:a<o?1:0;case"ASC":default:return a<o?-1:a>o?1:0}}):e},prependMandatoryLabel:function(e){return!Ext.isEmpty(e)&&Ext.isString(e)?CMDBuild.core.constants.Global.getMandatoryLabelFlag()+e:e},toTitleCase:function(e){return Ext.isString(e)&&!Ext.isEmpty(e)&&(e=e.charAt(0).toUpperCase()+e.slice(1)),e}}),CMDBuild.Utils=function(){var e=0;return{mergeCardsData:function(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)if(i[n]){if("object"!=typeof i[n])continue;i[n]=CMDBuild.Utils.mergeCardsData(e[n],t[n])}else i[n]=t[n];return i},getFirstSelection:function(e){return Ext.isArray(e)?e[0]:e},nextId:function(){return++e},Metadata:{extractMetaByNS:function(e,t){var i={};for(var n in e)if(0==n.indexOf(t)){i[n.substr(t.length)]=e[n]}return i}},Format:{htmlEntityEncode:function(e){return e?String(e).replace(/&/g,"&amp;"):e}},getClassPrivileges:function(e){var t=_CMCache.getEntryTypeById(e);return _CMUtils.getEntryTypePrivileges(t)},getEntryTypePrivileges:function(e){var t={write:!1,create:!1,crudDisabled:{}};if(e){var i=e.get("ui_card_edit_mode"),n=Ext.JSON.decode(i);t={write:e.get("priv_write"),create:e.isProcess()?e.isStartable():e.get("priv_create"),crudDisabled:n}}return t},getEntryTypePrivilegesByCard:function(e){var t={write:!1,create:!1,crudDisabled:{}};if(e){var i=e.get("IdClass"),n=_CMCache.getEntryTypeById(i);t=_CMUtils.getEntryTypePrivileges(n)}return t},isSimpleTable:function(e){var t=_CMCache.getEntryTypeById(e);return!!t&&"simpletable"==t.data.tableType},isProcess:function(e){return!!_CMCache.getProcessById(e)},groupAttributes:function(e,t){for(var i={},n=[],r=0;r<e.length;r++){var a=e[r];if(a&&(t||"Notes"!=a.name)){var o=a.group;o?(i[o]||(i[o]=[]),i[o].push(a)):n.push(a)}}return n.length>0&&(i[CMDBuild.Translation.management.modcard.other_fields]=n),i},foreach:function(e,t,i){if(e)for(var n=0,r=e.length;n<r;++n){var a=e[n];t.call(a,i)}},arraySearchByFunction:function(e,t){if(!Ext.isArray(e)||!Ext.isFunction(t))return null;for(var i=0,n=e.length;i<n;++i){var r=e[i];if(t(r))return r}return null},isSuperclass:function(e){var t=_CMCache.getEntryTypeById(e);return!!t&&t.get("superclass")},getAncestorsId:function(e){var t=null,i=[];if(t="CMDBuild.cache.CMEntryTypeModel"==Ext.getClassName(e)?e:_CMCache.getEntryTypeById(e))for(i.push(t.get("id"));!Ext.isEmpty(t)&&""!=t.get("parent");)t=_CMCache.getEntryTypeById(t.get("parent")),Ext.isEmpty(t)||i.push(t.get("id"));return i},getDescendantsById:function(e){for(var t=this.getChildrenById(e),i=[_CMCache.getEntryTypeById(e)],n=0;n<t.length;++n){var r=t[n],a=this.getDescendantsById(r.get("id"));i=i.concat(a)}return i},forwardMethods:function(e,t,i){Ext.isArray(i)||(i=[i]);for(var n=0,r=i.length;n<r;++n){var a=i[n];if("string"==typeof a&&"function"==typeof t[a]){var o=function(){return t[arguments.callee.$name].apply(t,arguments)};o.$name=a,e[a]=o}}},getChildrenById:function(e){var t=_CMCache.getEntryTypes(),i=[];for(var n in t)(n=t[n]).get("parent")==e&&i.push(n);return i},PollingFunction:function(e){this.success=e.success||Ext.emptyFn,this.failure=e.failure||Ext.emptyFn,this.checkFn=e.checkFn||function(){return!0},this.cbScope=e.cbScope||this,this.delay=e.delay||500,this.maxTimes=e.maxTimes||60,this.checkFnScope=e.checkFnScope||this.cbScope,this.run=function(){60==this.maxTimes&&CMDBuild.core.LoadMask.show(),this.maxTimes>0?this.checkFn.call(this.checkFnScope)?(_debug("End polling with success"),CMDBuild.core.LoadMask.hide(),this.success.call(this.cbScope)):(this.maxTimes--,Ext.Function.defer(this.run,this.delay,this)):(_debug("End polling with failure"),CMDBuild.core.LoadMask.hide(),this.failure.call())}}}}(),_CMUtils=CMDBuild.Utils,CMDBuild.extend=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)},CMDBuild.isMixedWith=function(e,t){var i=e.mixins||{};for(var n in i){var r=i[n];if(Ext.getClassName(r)==t)return!0}return!1},CMDBuild.instanceOf=function(e,t){for(;e;){if(Ext.getClassName(e)==t)return!0;e=e.superclass}return!1},CMDBuild.checkInterface=function(e,t){return CMDBuild.isMixedWith(e,t)||CMDBuild.instanceOf(e,t)},CMDBuild.validateInterface=function(e,t){if(CMDBuild.IS_NOT_CONFORM_TO_INTERFACE="The object {0} must implement the interface: {1}",!CMDBuild.checkInterface(e,t))throw Ext.String.format(CMDBuild.IS_NOT_CONFORM_TO_INTERFACE,e.toString(),t)},CMDBuild.clearComponent=function(e){e.items&&e.items.each(function(t){CMDBuild.clearComponent(t);t.getStore&&t.getStore().clearData(),t.destroy&&t.destroy(),e.remove(t)},this),e.removeAll&&e.removeAll()}}(),Ext.define("CMDBuild.override.data.proxy.Server",{override:"Ext.data.proxy.Server",constructor:function(e){this.callParent(arguments),Ext.apply(this,this.extraParams)},processResponse:function(e,t,i,n,r,a){t.response=n,this.callParent(arguments)}}),Ext.apply(Ext.data.SortTypes,{asNatural:function(e){return e.replace(/(\d+)/g,"0000000000$1").replace(/0*(\d{10,})/g,"$1")}}),Ext.require(["CMDBuild.core.interfaces.messages.Error","CMDBuild.core.interfaces.messages.Warning","CMDBuild.core.Message"]),Ext.define("CMDBuild.override.data.Store",{override:"Ext.data.Store",customLoadMethod:function(){this.load()},customLoadPageMethod:function(e){this.loadPage(e)},doSort:function(e){var t,i,n;if(this.remoteSort)this.buffered?(this.data.clear(),this.customLoadPageMethod(1)):this.customLoadMethod();else{if(this.buffered&&Ext.Error.raise({msg:"Local sorting may not be used on a buffered store"}),this.data.sortBy(e),!this.buffered)for(i=(t=this.getRange()).length,n=0;n<i;n++)t[n].index=n;this.fireEvent("datachanged",this),this.fireEvent("refresh",this)}},interceptorFunction:function(e,t,i){var n=void 0;return i||(Ext.isEmpty(t)||Ext.isEmpty(t.response)||Ext.isEmpty(t.response.responseText)||(n=Ext.decode(t.response.responseText)),CMDBuild.global.interfaces.Configurations.get("disableAllMessages")||(CMDBuild.global.interfaces.Configurations.get("disableWarnings")||CMDBuild.core.interfaces.messages.Warning.display(n),CMDBuild.global.interfaces.Configurations.get("disableErrors")||CMDBuild.core.interfaces.messages.Error.display(n,t.request))),!0},load:function(e){Ext.isEmpty(CMDBuild.global)||Ext.isEmpty(CMDBuild.global.Data)||CMDBuild.global.Data.dataDefaultHeadersUpdate(),Ext.isEmpty(e)||(e.callback=Ext.isEmpty(e.callback)||!Ext.isFunction(e.callback)?Ext.emptyFn:e.callback,e.callback=Ext.Function.createInterceptor(e.callback,this.interceptorFunction,this)),this.callParent(arguments)}}),Ext.require(["CMDBuild.core.interfaces.messages.Error","CMDBuild.core.interfaces.messages.Warning","CMDBuild.core.Message"]),Ext.define("CMDBuild.override.data.TreeStore",{override:"Ext.data.TreeStore",clearOnPageLoad:!0,currentPage:1,pageSize:void 0,getCount:function(){return this.tree.getRootNode().childNodes.length||0},getTotalCount:function(){return this.totalCount||0},interceptorFunction:function(e,t,i){var n=void 0;return i||(Ext.isEmpty(t)||Ext.isEmpty(t.response)||Ext.isEmpty(t.response.responseText)||(n=Ext.decode(t.response.responseText)),CMDBuild.global.interfaces.Configurations.get("disableAllMessages")||(CMDBuild.global.interfaces.Configurations.get("disableWarnings")||CMDBuild.core.interfaces.messages.Warning.display(n),CMDBuild.global.interfaces.Configurations.get("disableErrors")||CMDBuild.core.interfaces.messages.Error.display(n,t.request))),!0},load:function(e){(e=e||{}).params=e.params||{},e.node=e.node||this.tree.getRootNode(),e.params[this.proxy.limitParam]=e[this.proxy.limitParam]||this.pageSize,e.params[this.proxy.pageParam]=e[this.proxy.pageParam]||this.currentPage,e.params[this.nodeParam]=e.node?e.node.getId():"root",Ext.isEmpty(e)||(e.callback=Ext.isEmpty(e.callback)||!Ext.isFunction(e.callback)?Ext.emptyFn:e.callback,e.callback=Ext.Function.createInterceptor(e.callback,this.interceptorFunction,this)),this.callParent(arguments)},loadPage:function(e,t){e=Ext.isNumber(e)?e:1,t=Ext.isObject(t)?t:{},this.currentPage=e,this.read(Ext.applyIf(t,{page:e,start:(e-1)*this.pageSize,limit:this.pageSize,addRecords:!this.clearOnPageLoad}))},nextPage:function(e){this.loadPage(this.currentPage+1,e)},onProxyLoad:function(e){var t=e.getResultSet(),i=void 0;Ext.isEmpty(e)||Ext.isEmpty(e.response)||Ext.isEmpty(e.response.responseText)||(i=Ext.decode(e.response.responseText)),!e.success||!t||Ext.isEmpty(this.proxy)||Ext.isEmpty(this.proxy.reader)||Ext.isEmpty(this.proxy.reader.totalProperty)||!Ext.isObject(i)||Ext.Object.isEmpty(i)||(t.total=i.response[this.proxy.reader.totalProperty],t.totalRecords=i.response[this.proxy.reader.totalProperty],this.totalCount=t.total),this.callParent(arguments)},previousPage:function(e){this.loadPage(this.currentPage-1,e)}}),Ext.define("CMDBuild.override.form.field.Checkbox",{override:"Ext.form.field.Checkbox",constructor:function(e){e=e||{},Ext.isBoolean(e.value)&&(e.checked=e.value),this.callParent([e])}}),Ext.define("CMDBuild.override.form.field.ComboBox",{override:"Ext.form.field.ComboBox",initComponent:function(){this.callParent(arguments),this.on("enable",function(e,t){Ext.isBoolean(e.getStore().autoLoad)&&e.getStore().autoLoad&&!e.getStore().isLoading()&&e.getStore().load()},this)},setValue:function(e,t){var i=this,n=this.forceSelection;return n&&(this.forceSelection=!1),Ext.isEmpty(this.getStore())||(i=this.callParent(arguments)),n&&(this.forceSelection=!0),i}}),Ext.define("CMDBuild.override.form.field.Display",{override:"Ext.form.field.Display",uses:["CMDBuild.core.Utils"],renderer:function(e,t){return CMDBuild.core.Utils.hasHtmlTags(e)?e:e.replace(/(\r\n|\n|\r)/gm,"<br />")}}),Ext.define("CMDBuild.override.form.field.File",{override:"Ext.form.field.File",isFileUpload:function(){return!(this.disabled||!this.submitValue)},setEmptyText:function(e){e=Ext.isString(e)?e:" ",this.emptyText=e,this.applyEmptyText()}}),Ext.apply(Ext.form.field.VTypes,{alphanumextended:function(e){return this.alphanumextendedMask.test(e)},alphanumextendedText:"This field should only contain letters, numbers, underscore (_), hyphen (-). dot (.), hash (#) and at (@)",alphanumextendedMask:/^[a-zA-Z0-9_.+#@-]+$/i,alphanumlines:function(e){return this.alphanumlinesMask.test(e)},alphanumlinesText:"This field should only contain letters, numbers, underscore (_) and hyphen (-)",alphanumlinesMask:/^[a-zA-Z0-9_-]+$/i,comment:function(e){return this.commentMask.test(e)},commentText:CMDBuild.Translation.vtypeCommentText,commentMask:/^[^|]*$/i,commentextended:function(e){return this.commentextendedMask.test(e)},commentextendedText:CMDBuild.Translation.vtypeCommentExtendedText,commentextendedMask:/^[^'|]*$/i,ipv4:function(e){return this.ipv4RegExp.test(e)},ipv4RegExp:/^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$/,ipv4Mask:/[0-9.\/]/i,ipv4Text:CMDBuild.Translation.vtypeIpText,ipv6:function(e){return this.ipv6RegExp.test(e)},ipv6Mask:/[0-9a-fA-F:\/]/i,ipv6RegExp:/^s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:)))(%.+)?s*(\/([0-9]|[1-9][0-9]|1[0-1][0-9]|12[0-8]))?$/,ipv6Text:CMDBuild.Translation.vtypeIpText,multiemail:function(e){var t=e.split(","),i=!0;return Ext.Array.each(t,function(e){if(!this.email(e))return i=!1,!1},this),i},multiemailText:'This field should be an e-mail address, or a list of email addresses separated by commas (,) in the format "user@domain.com,test@test.com"',multiemailMask:/[\w.\-@'"!#$%&'*+/=?^_`{|}~,]/i,password:function(e,t){return!(!Ext.isEmpty(t.twinFieldId)&&Ext.isString(t.twinFieldId)&&!Ext.isEmpty(Ext.getCmp(t.twinFieldId))&&Ext.isFunction(Ext.getCmp(t.twinFieldId).getValue))||e==Ext.getCmp(t.twinFieldId).getValue()},passwordText:CMDBuild.Translation.passwordsDoNotMatch,time:function(e,t){return Ext.Date.parse(e,t.format)},timeText:CMDBuild.Translation.vtypeTimeText}),Ext.define("CMDBuild.override.form.FieldContainer",{override:"Ext.form.FieldContainer",name:void 0,getName:function(){return this.name}}),Ext.define("CMDBuild.override.form.FieldSet",{override:"Ext.form.FieldSet",checkboxValue:void 0,controllerxType:"checkbox",createCheckboxCmp:function(){return this.checkboxCmp=Ext.widget({xtype:this.controllerxType,hideEmptyLabel:!0,name:this.checkboxName||this.id+"-checkbox",cls:this.baseCls+"-header-checkbox",id:this.id+"-legendChk",checked:this.collapsible&&!this.collapsed,inputValue:this.checkboxValue||"on",listeners:{change:this.onCheckChange,scope:this}}),this.checkboxCmp},fieldWidthsFix:function(){this.cascade(function(e){Ext.isEmpty(e.checkboxToggle)&&e instanceof Ext.form.Field&&(e.labelWidth=e.labelWidth-10,e.width=e.width-10)})},onCheckChange:function(e,t){this.callParent(arguments),this.fireEvent("checkchange",this,t)},reset:function(){this.cascade(function(e){Ext.isEmpty(e.checkboxToggle)&&e.reset()})},setExpanded:function(e){var t=this.checkboxCmp,i=e?"expand":"collapse";return!this.collapsible||this.rendered&&!1===this.fireEvent("before"+i,this)||(e=!!e,t&&t.setValue(e),this.rendered&&(e?this.removeCls(this.baseCls+"-collapsed"):this.addCls(this.baseCls+"-collapsed")),this.collapsed=!e,e?delete this.getHierarchyState().collapsed:this.getHierarchyState().collapsed=!0,this.rendered&&(this.updateLayout({isRoot:!1}),this.fireEvent(i,this))),this}}),Ext.define("CMDBuild.override.grid.column.CheckColumn",{override:"Ext.grid.column.CheckColumn",enableCheckboxHide:!1,renderer:function(e,t,i,n,r,a,o){return Ext.isBoolean(this.enableCheckboxHide)&&this.enableCheckboxHide&&Ext.isFunction(this.isCheckboxHidden)&&this.isCheckboxHidden(e,t,i,n,r,a,o)?"":this.callParent(arguments)},isCheckboxHidden:function(e,t,i,n,r,a,o){return!1}}),Ext.define("CMDBuild.override.grid.plugin.RowExpander",{override:"Ext.grid.plugin.RowExpander",collapseAll:function(){Ext.Array.each(this.grid.getStore().getRange(),function(e,t,i){this.recordsExpanded[e.internalId]&&this.toggleRow(e.index,e)},this)}}),Ext.decode=function(e,t){var i=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;return i.lastIndex=0,i.test(e)&&(e=e.replace(i,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),Ext.JSON.decode(e,t)},Ext.define("CMDBuild.override.layout.container.Editor",{override:"Ext.layout.container.Editor",calculate:function(e){var t,i,n=this.owner,r=n.autoSize;!0===r&&(r=this.autoSizeDefault),r&&(t=this.getDimension(n,r.width,"getWidth",n.width),i=this.getDimension(n,r.height,"getHeight",n.height)),Ext.isEmpty(e.childItems[0])||e.childItems[0].setSize(t,i),e.setWidth(t),e.setHeight(i),e.setContentSize(t||n.field.getWidth(),i||n.field.getHeight())}}),Ext.define("CMDBuild.override.selection.CheckboxModel",{override:"Ext.selection.CheckboxModel",text:"&#160;",getHeaderConfig:function(){var e=!1!==this.showHeaderCheckbox;return{isCheckerHd:e,text:this.text,width:this.headerWidth,align:"center",sortable:!1,draggable:!1,resizable:!1,hideable:!1,menuDisabled:!0,dataIndex:"",cls:e?Ext.baseCSSPrefix+"column-header-checkbox ":"",renderer:Ext.Function.bind(this.renderer,this),editRenderer:this.editRenderer||this.renderEmpty,locked:this.hasLockedHeader()}}}),Ext.define("CMDBuild.override.toolbar.Paging",{override:"Ext.toolbar.Paging",customLoadMethod:function(e){var t=this;this.mask(),this.store.currentPage=e,this.store.load({callback:function(){t.unmask()}})},doRefresh:function(){var e=this.store.currentPage;!1!==this.fireEvent("beforechange",this,e)&&this.customLoadMethod(e)},moveFirst:function(){!1!==this.fireEvent("beforechange",this,1)&&this.customLoadMethod(1)},moveLast:function(){var e=this.getPageData().pageCount;!1!==this.fireEvent("beforechange",this,e)&&this.customLoadMethod(e)},moveNext:function(){var e=this.getPageData().pageCount,t=this.store.currentPage+1;t<=e&&!1!==this.fireEvent("beforechange",this,t)&&this.customLoadMethod(t)},movePrevious:function(){var e=this.store.currentPage-1;e>0&&!1!==this.fireEvent("beforechange",this,e)&&this.customLoadMethod(e)},onPagingKeyDown:function(e,t){var i,n=t.getKey(),r=this.getPageData(),a=t.shiftKey?10:1;n==t.RETURN?(t.stopEvent(),!1!==(i=this.readPageFromInput(r))&&(i=Math.min(Math.max(1,i),r.pageCount),!1!==this.fireEvent("beforechange",this,i)&&this.customLoadMethod(i))):n==t.HOME||n==t.END?(t.stopEvent(),i=n==t.HOME?1:r.pageCount,e.setValue(i)):n!=t.UP&&n!=t.PAGE_UP&&n!=t.DOWN&&n!=t.PAGE_DOWN||(t.stopEvent(),(i=this.readPageFromInput(r))&&(n!=t.DOWN&&n!=t.PAGE_DOWN||(a*=-1),(i+=a)>=1&&i<=r.pageCount&&e.setValue(i)))}}),Ext.define("CMDBuild.core.configurations.DataFormat",{singleton:!0,config:{date:"d/m/Y",dateTime:"d/m/Y H:i:s",time:"H:i:s"},constructor:function(e){this.initConfig(e)}}),Ext.require("CMDBuild.core.constants.Proxy"),Ext.define("CMDBuild.model.report.Cache",{extend:"Ext.data.Model",fields:[{name:CMDBuild.core.constants.Proxy.ACTIVE,type:"boolean"},{name:CMDBuild.core.constants.Proxy.GROUP,type:"string"},{name:CMDBuild.core.constants.Proxy.ID,type:"string"},{name:CMDBuild.core.constants.Proxy.TEXT,type:"string"},{name:CMDBuild.core.constants.Proxy.TYPE,type:"string"}]}),Ext.define("CMDBuild.DummyModel",{extend:"Ext.data.Model",fields:[],constructor:function(e){e=e||{},CMDBuild.DummyModel.setFields(Ext.Object.getKeys(e)),this.callParent(arguments)}}),Ext.define("CMTableForComboModel",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"id",type:"string"},{name:"description",type:"string"}]}),Ext.define("CMDBuild.cache.Lookup.typeComboStore",{extend:"Ext.data.Model",fields:[{name:CMDBuild.core.constants.Proxy.TYPE,type:"string"}]}),Ext.define("CMDBuild.cache.CMLookupTypeModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"parent",type:"string"},{name:"type",type:"string"}]}),Ext.define("CMDBuild.cache.CMEntryTypeModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"superclass",type:"boolean"},{name:"active",type:"boolean"},{name:"parent",type:"string"},{name:"tableType",type:"string"},{name:"type",type:"string"},{name:"name",type:"string"},{name:"priv_create",type:"boolean"},{name:"priv_write",type:"boolean"},{name:"ui_card_edit_mode",type:"object"},{name:"meta",type:"auto"},{name:"userstoppable",type:"boolean"},{name:"startable",type:"boolean"}],constructor:function(){this.callParent(arguments),this._widgets=[]},isSuperClass:function(){return this.get("superclass")},getTableType:function(){return this.get("tableType")},isProcess:function(){return"processclass"==this.get("type")},isUserStoppable:function(){return this.get("userstoppable")},isStartable:function(){return this.get("startable")},setWidgets:function(e){this._widgets=e||[]},getWidgets:function(){return this._widgets},addWidget:function(e){this._widgets.push(e)},removeWidgetById:function(e){for(var t=this._widgets,i=0,n=t.length;i<n;++i){if(t[i].id==e)return delete t[i],void t.splice(i,1)}},getName:function(){return this.get("name")},getDescription:function(){return this.get("text")},getAttachmentAutocompletion:function(){var e=this.get("meta"),t={};return e&&e.attachments&&(t=e.attachments.autocompletion||{}),t},getAttachmentCopletionRuleByGropAndMetadataName:function(e,t){var i=this.getAttachmentAutocompletion()[e],n=null;return i&&(n=i[t]||null),n},toString:function(){return this.get("name")}}),Ext.define("CMDBuild.cache.CMDomainModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"active",type:"boolean"},{name:"attributes",type:"auto"},{name:"cardinality",type:"string"},{name:"nameClass1",type:"string"},{name:"nameClass2",type:"string"},{name:"idClass1",type:"string"},{name:"idClass2",type:"string"},{name:"name",type:"string"},{name:"createPrivileges",type:"boolean"},{name:"writePrivileges",type:"boolean"},{name:"isMasterDetail",type:"boolean"},{name:"description",type:"string"},{name:"descr_1",type:"string"},{name:"descr_2",type:"string"},{name:"md_label",type:"string"},{name:"disabled1",type:"auto"},{name:"disabled2",type:"auto"}],getAttributes:function(){var e=null;return this.raw&&(e=this.raw.attributes),e||this.data.attributes||[]},hasCreatePrivileges:function(){return this.raw?this.raw.createPrivileges:this.data.createPrivileges},getSourceClassId:function(){return this.get("idClass1")},getDestinationClassId:function(){return this.get("idClass2")},getNSideIdInManyRelation:function(){var e=this.get("cardinality");return"1:N"==e?this.getDestinationClassId():"N:1"==e?this.getSourceClassId():null},getName:function(){return this.get("name")},getDescription:function(){return this.get("description")},getDetailClassId:function(){var e=this.get("cardinality"),t="";return"1:N"==e?t=this.get("idClass2"):"N:1"==e&&(t=this.get("idClass1")),t},getDetailClassName:function(){var e=this.get("cardinality"),t="";return"1:N"==e?t=this.get("nameClass2"):"N:1"==e&&(t=this.get("nameClass1")),t},getMasterClassName:function(){var e=this.get("cardinality"),t="";return"1:N"==e?t=this.get("nameClass1"):"N:1"==e&&(t=this.get("nameClass2")),t},getDetailSide:function(){var e=this.get("cardinality");return"1:N"==e?"_2":"N:1"==e?"_1":void 0}}),Ext.define("CMDBuild.cache.CMReferenceStoreModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"Description",type:"string"}]}),function(){function e(t,i){if(Ext.isObject(t.simple)){var n=t.simple;"runtime"==n.parameterType&&i.push(n)}else if(Ext.isArray(t.and)||Ext.isArray(t.or))for(var r=t.and||t.or,a=0;a<r.length;++a)e(r[a],i);return i}function t(e,i){if(Ext.isObject(e.simple)){var n=e.simple;"calculated"==n.parameterType&&i.push(n)}else if(Ext.isArray(e.and)||Ext.isArray(e.or))for(var r=e.and||e.or,a=0;a<r.length;++a)t(r[a],i);return i}function i(e,t){var r=Ext.clone(e);if(r){if(Ext.isObject(r.simple)){var a=r.simple;if("runtime"==a.parameterType){for(var o=void 0,s=0;s<t.length;s++)t[s].name==a.attribute&&(o=s);if(!Ext.isEmpty(o)){var l=t[o],d=[l.getValue()];l._cmSecondField&&d.push(l._cmSecondField.getValue()),a.value=d}}else if("calculated"==a.parameterType){d=a.value[0];"function"==typeof n[d]&&(a.value=[n[d]()])}}else if(Ext.isArray(r.and)||Ext.isArray(r.or)){var u=r.and||r.or;for(s=0;s<u.length;++s)u[s]=i(u[s],t)}return r}}Ext.define("CMDBuild.model.CMFilterModel",{extend:"Ext.data.Model",uses:["CMDBuild.core.constants.Proxy"],fields:[{name:CMDBuild.core.constants.Proxy.ID,type:"string"},{name:CMDBuild.core.constants.Proxy.NAME,type:"string"},{name:CMDBuild.core.constants.Proxy.DESCRIPTION,type:"string"},{name:CMDBuild.core.constants.Proxy.CONFIGURATION,type:"auto"},{name:CMDBuild.core.constants.Proxy.ENTRY_TYPE,type:"string"},{name:CMDBuild.core.constants.Proxy.TEMPLATE,type:"boolean"},{name:CMDBuild.core.constants.Proxy.APPLIED,type:"boolean",persist:!1},{name:CMDBuild.core.constants.Proxy.LOCAL,type:"boolean",persist:!1}],copy:function(){var e=new CMDBuild.model.CMFilterModel;return e.set(CMDBuild.core.constants.Proxy.ID,this.get(CMDBuild.core.constants.Proxy.ID)),e.setName(this.getName()),e.setDescription(this.getDescription()),e.setConfiguration(Ext.apply({},this.getConfiguration())),e.setEntryType(this.getEntryType()),e.setApplied(this.isApplied()),e.setLocal(this.isLocal()),e.setTemplate(this.isTemplate()),e.commit(),this.dirty&&e.setDirty(),e},getName:function(){return this.get(CMDBuild.core.constants.Proxy.NAME)||""},setName:function(e){this.set(CMDBuild.core.constants.Proxy.NAME,e)},getDescription:function(){return this.get(CMDBuild.core.constants.Proxy.DESCRIPTION)||""},setDescription:function(e){this.set(CMDBuild.core.constants.Proxy.DESCRIPTION,e)},getConfiguration:function(){return this.get(CMDBuild.core.constants.Proxy.CONFIGURATION)||{}},getConfigurationMergedWithRuntimeAttributes:function(e){e=e||[];var t=Ext.clone(this.getConfiguration());return t.attribute=i(t.attribute,e),t},setConfiguration:function(e){this.set(CMDBuild.core.constants.Proxy.CONFIGURATION,e)},getAttributeConfiguration:function(){return this.getConfiguration().attribute||{}},setAttributeConfiguration:function(e){var t=this.getConfiguration();delete t.attribute,Ext.isObject(e)&&Ext.Object.getKeys(e).length>0&&(t.attribute=e,this.set(CMDBuild.core.constants.Proxy.CONFIGURATION,t))},getRuntimeParameters:function(){return e(this.getAttributeConfiguration(),[])},getCalculatedParameters:function(){return t(this.getAttributeConfiguration(),[])},getRelationConfiguration:function(){return this.getConfiguration().relation||[]},setRelationConfiguration:function(e){var t=this.getConfiguration();delete t.relation,Ext.isArray(e)&&e.length>0&&(t.relation=e,this.set(CMDBuild.core.constants.Proxy.CONFIGURATION,t))},getFunctionConfiguration:function(){return this.getConfiguration().functions||[]},setFunctionConfiguration:function(e){var t=this.getConfiguration();e.length>0?t.functions=e:delete t.functions,this.set(CMDBuild.core.constants.Proxy.CONFIGURATION,t)},getEntryType:function(){return this.get(CMDBuild.core.constants.Proxy.ENTRY_TYPE)||""},setEntryType:function(e){this.set(CMDBuild.core.constants.Proxy.ENTRY_TYPE,e)},isTemplate:function(){return this.get(CMDBuild.core.constants.Proxy.TEMPLATE)||!1},setTemplate:function(e){this.set(CMDBuild.core.constants.Proxy.TEMPLATE,e)},isApplied:function(){return this.get(CMDBuild.core.constants.Proxy.APPLIED)||!1},setApplied:function(e){this.set(CMDBuild.core.constants.Proxy.APPLIED,e)},isLocal:function(){return this.get(CMDBuild.core.constants.Proxy.LOCAL)||!1},setLocal:function(e){this.set(CMDBuild.core.constants.Proxy.LOCAL,e)}});var n={};n["@MY_USER"]=function(){return CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.USER_ID)},n["@MY_GROUP"]=function(){return CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.DEFAULT_GROUP_ID)}}(),Ext.define("CMDBuild.model.CMDashboard",{extend:"Ext.data.Model",statics:{build:function(e){e.charts=e.charts||{};var t=[];for(var i in e.charts){var n=e.charts[i];n.id=i,t.push(CMDBuild.model.CMDashboardChart.build(n))}return e.charts=t,new CMDBuild.model.CMDashboard(e)}},fields:[{name:"name",type:"string"},{name:"description",type:"string"},{name:"defaultDescription",type:"string"},{name:"id",type:"int"},{name:"groups",type:"auto"},{name:"charts",type:"auto"},{name:"columns",type:"auto"}],constructor:function(){if(this.callParent(arguments),0==this.getColumns().length){for(var e,t=[],i=this.getCharts(),n=0,r=i.length;n<r;++n)(e=i[n])&&t.push(e.getId());this.setColumns([{width:1,charts:t}])}},getName:function(){return this.get("name")},getDescription:function(){return this.get("description")},getDescriptionDefault:function(){return this.get("defaultDescription")},getGroups:function(){return this.get("groups")},getCharts:function(){return this.get("charts")||[]},getChartWithId:function(e){for(var t,i=this.getCharts(),n=0,r=i.length;n<r;++n)if((t=i[n]).getId()==e)return t;return null},getColumns:function(){return this.get("columns")||[]},setColumns:function(e){this.set("columns",e)},setName:function(e){this.set("name",e)},setDescription:function(e){this.set("description",e)},setGroups:function(e){this.set("groups",e)},setCharts:function(e){this.set("charts",e)},addChart:function(e){this.getCharts().push(e);var t=this.getColumns();t.length>0&&t[0].charts.push(e.getId())},removeChart:function(e){for(var t=this.getCharts(),i=0,n=t.length;i<n;++i)if(t[i].getId()==e)return void Ext.Array.erase(t,i,1)},replaceChart:function(e,t){for(var i=this.getCharts(),n=0,r=i.length;n<r;++n)if(i[n].getId()==e)return i[n]=t,void 0},toString:function(){return Ext.getClassName(this)+" "+this.getName()}}),Ext.define("CMDBuild.model.CMDashboardChart",{extend:"Ext.data.Model",statics:{build:function(e){var t=e.dataSource;return t&&(e.dataSource=new CMDBuild.model.CMDashboardChartDataSource(t)),new CMDBuild.model.CMDashboardChart(e)}},fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"active",type:"boolean"},{name:"autoLoad",type:"boolean"},{name:"legend",type:"boolean"},{name:"type",type:"string"},{name:"height",type:"int"},{name:"dataSourceName",type:"string"},{name:"dataSourceParameters",type:"auto"},{name:"singleSeriesField",type:"string"},{name:"labelField",type:"string"},{name:"categoryAxisField",type:"string"},{name:"categoryAxisLabel",type:"string"},{name:"valueAxisFields",type:"auto"},{name:"valueAxisLabel",type:"string"},{name:"maximum",type:"int"},{name:"minimum",type:"int"},{name:"steps",type:"int"},{name:"fgcolor",type:"string"},{name:"bgcolor",type:"string"},{name:"classToUseForReferenceWidget",type:"string"},{name:"chartOrientation",type:"string"}],getName:function(){return this.get("name")},getDescription:function(){return this.get("description")},isActive:function(){return this.get("active")},isAutoload:function(){return this.get("autoLoad")},withLegend:function(){return this.get("legend")},getType:function(){return this.get("type")},getheight:function(){return this.get("height")},getMaximum:function(){return this.get("maximum")},getMinimum:function(){return this.get("minimum")},getSteps:function(){return this.get("steps")},getFgColor:function(){return this.get("fgcolor")},getBgColor:function(){return this.get("bgcolor")},getChartOrientation:function(){return this.get("chartOrientation")},getSingleSeriesField:function(){return this.get("singleSeriesField")},getLabelField:function(){return this.get("labelField")},getCategoryAxisField:function(){return this.get("categoryAxisField")},getCategoryAxisLabel:function(){return this.get("categoryAxisLabel")},getValueAxisFields:function(){return this.get("valueAxisFields")},getValueAxisLabel:function(){return this.get("valueAxisLabel")},getDataSourceName:function(){return this.get("dataSourceName")},getDataSourceInputConfiguration:function(){return this.get("dataSourceParameters")||[]}}),Ext.define("CMDBuild.model.CMDashboardChartDataSource",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"input",type:"auto"},{name:"output",type:"auto"}],getName:function(){return this.get("name")},getInput:function(){return this.get("input")},getOutput:function(){return this.get("output")}}),function(){function e(e,t){var i=void 0;return e&&"function"==typeof e.getId&&(i=e.getId()),e&&void 0===i&&"string"==typeof t&&(i=e.get(t)),i}function t(t,i,n){var r=i.length,a=0,o=e(n,t.idProperty);t.store&&t.store.each(function(s){for(var l=0;l<r;l++)void 0===n?i[l].onRowDeselect(a,suppressEvent=!0):o&&o!=e(s,t.idProperty)&&i[l].onRowDeselect(a,suppressEvent=!0);a++})}Ext.define("CMDBuild.selection.CMMultiPageSelectionModel",{extend:"Ext.selection.CheckboxModel",alias:"selection.cmmultipage",idProperty:void 0,avoidCheckerHeader:!1,bindStore:function(e,t){this.store=e,this.cmReverse=!1,this.reset(),this.cmCurrentPage=void 0,this.callParent(arguments),this.store&&(this.mon(this.store,"beforeload",function(){this._onBeforeStoreLoad.apply(this,arguments)},this),this.mon(this.store,"load",function(){this._onStoreDidLoad.apply(this,arguments)},this)),this.mon(this,"select",function(){this._addSelection.apply(this,arguments)},this),this.mon(this,"deselect",function(){this._removeSelection.apply(this,arguments)},this)},_addSelection:function(i,n){var r=e(n,this.idProperty);"SINGLE"==this.mode&&(this.reset(),t(this,this.views,n)),this.cmReverse?r&&this.cmSelections.hasOwnProperty(r)&&delete this.cmSelections[r]:r&&!this.cmSelections.hasOwnProperty(r)&&(this.cmSelections[r]=n.copy())},_removeSelection:function(t,i){var n=e(i,this.idProperty);this.cmReverse?n&&!this.cmSelections.hasOwnProperty(n)&&(this.cmSelections[n]=i.copy()):this.cmFreezedSelections||void 0===n||delete this.cmSelections[n]},reset:function(){try{this.clearSelections(),this.cmSelections={},this.cmFreezedSelections=void 0}catch(e){}},deselectAll:function(){this.reset()},_onBeforeStoreLoad:function(){this.cmFreezedSelections=Ext.clone(this.cmSelections)},hasSelection:function(){return this.getSelection().length>0},getCount:function(){return this.getSelection().length},getSelection:function(){var e=[];for(var t in this.cmSelections)e.push(this.cmSelections[t]);return e},getHeaderConfig:function(){var e=this.callParent(arguments);return("SINGLE"==this.mode||this.avoidCheckerHeader)&&(e.isCheckerHd=!1,e.cls=Ext.baseCSSPrefix+NaN),e},onHeaderClick:function(e,t,i){"SINGLE"!=this.mode&&t.isCheckerHd&&(i.stopEvent(),this.cmReverse=!t.el.hasCls(Ext.baseCSSPrefix+"grid-hd-checker-on"),this.toggleUiHeader(this.cmReverse),this.reset(),this._redoSelection())},_onStoreDidLoad:function(e,t){this.cmCurrentPage=e.currentPage,this.cmFreezedSelections&&(this.cmSelections=Ext.clone(this.cmFreezedSelections),this.cmFreezedSelections=void 0),this._redoSelection()},_redoSelection:function(){var i=this.views;t(this,i),this.cmReverse?function(t,i){var n=0,r=i.length;t.store.each(function(a){if(!t.cmSelections[e(a,t.idProperty)]){t.selected.add(a);for(var o=0;o<r;o++)i[o].onRowSelect(n,suppressEvent=!0)}n++})}(this,i):function(t,i){if(t.store){var n,r=i.length;for(var a in t.cmSelections)if(-1!=(n=t.store.findBy(function(i){if(a==e(i,t.idProperty))return t.selected.add(i),!0})))for(var o=0;o<r;o++)i[o].onRowSelect(n,suppressEvent=!0)}}(this,i)},onSelectChange:function(){Ext.selection.RowModel.prototype.onSelectChange.apply(this,arguments)}})}(),function(){function e(e,t){if("CMDBuild.model.CMFilterModel"==Ext.getClassName(t)){var i=null;if(!e)return i;var n=e.findBy(function(e){return t.getName()==e.get("name")&&t.dirty==e.dirty});return n>=0&&(i=e.getAt(n)),i}}Ext.define("CMDBuild.cache.CMCacheFilterFunctions",{addFilter:function(t,i,n){"CMDBuild.model.CMFilterModel"==Ext.getClassName(i)&&(!function(t,i){if("CMDBuild.model.CMFilterModel"==Ext.getClassName(i)){var n=e(t,i);n&&t.remove(n)}}(t,i),n?t.insert(0,i):t.add(i))},updateFilter:function(t,i){if("CMDBuild.model.CMFilterModel"==Ext.getClassName(i)){var n=e(t,i);n&&(t.remove(n),t.add(i))}},removeFilter:function(t,i){if("CMDBuild.model.CMFilterModel"==Ext.getClassName(i)){var n=e(t,i);n&&t.remove(n)}},setFilterApplied:function(t,i,n){if("CMDBuild.model.CMFilterModel"==Ext.getClassName(i)){var r=e(t,i);r&&Ext.isFunction(r.setApplied)&&r.setApplied(n)}}})}(),function(){function e(e,t){for(var i in e)if((i=e[i]).get("name")==t)return i.get("id")}function t(){s.cmFill(),o.cmFill(),a.cmFill(),l.cmFill()}var i={},n={},r={},a={cmFill:function(){},cmFake:!0},o={cmFill:function(){},cmFake:!0},s={cmFill:function(){},cmFake:!0},l={cmFill:function(){},cmFake:!0};Ext.define("CMDBUild.cache.CMCacheClassFunctions",{isClassById:function(e){return!Ext.isEmpty(i[e])},getClasses:function(){return i},getProcesses:function(){return n},getEntryTypes:function(){var e=Ext.apply({},i);return Ext.apply(e,n)},addClasses:function(e){for(var r=void 0,a=void 0,o=0,s=e.length;o<s;++o){var l=e[o];"Class"==l.name&&(r=l.id),"Activity"==l.name&&(a=l.id),"class"==l.type?this.addClass(e[o]):"processclass"==l.type&&this.addProcess(e[o])}Ext.Object.each(i,function(e,t,n){var a=t.get("parent");!Ext.isEmpty(a)&&Ext.isEmpty(i[a])&&i[e].set("parent",r)},this),Ext.Object.each(n,function(e,t,r){var o=t.get("parent");!Ext.isEmpty(o)&&Ext.isEmpty(i[o])&&n[e].set("parent",a)},this),t()},addClass:function(e){var t=Ext.create("CMDBuild.cache.CMEntryTypeModel",e);return i[e.id]=t,t},addProcess:function(e){var t=Ext.create("CMDBuild.cache.CMEntryTypeModel",e);return n[e.id]=t,t},addWidgetToEntryTypes:function(e,t){var i=this.getEntryTypes();for(var n in i){var r=i[n],a=e[r.get("name")];if(a)if(t){for(var o=[],s=0,l=a.length;s<l;++s){var d=a[s];d.active&&o.push(d)}r.setWidgets(o)}else r.setWidgets(a)}},getClassById:function(e){return i[e]},getProcessById:function(e){return n[e]},getEntryTypeById:function(e){var t=this.getClassById(e),i=this.getProcessById(e);return t||(i||void CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,Ext.String.format(CMDBuild.Translation.errors.reasons.CLASS_NOTFOUND,e)))},isEntryTypeById:function(e){var t=this.getClassById(e),i=this.getProcessById(e);return t||i},isEntryTypeByName:function(e){var t=this.getEntryTypes();for(var i in t){if(e==t[i].get("name"))return!0}return!1},getEntryTypeByName:function(e){var t=this.getEntryTypes();for(var i in t){var n=t[i];if(e==n.get("name"))return n}return CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,Ext.String.format(CMDBuild.Translation.errors.reasons.CLASS_NOTFOUND,e)),null},getEntryTypeNameById:function(e){if(void 0===r[e]){var t=this.getEntryTypeById(e);r[e]=t?t.get("name"):""}return r[e]},getSuperclassesAsStore:function(){return a.cmFake&&(a=new Ext.data.Store({model:"CMTableForComboModel",cmFill:function(){this.removeAll();var e=[];for(var t in i){var n=i[t];n.data.superclass&&e.push({id:n.data.id,description:n.data.text})}this.add(e),this.sort("description","ASC")},sorters:[{property:"description",direction:"ASC"}]})).cmFill(),a},getSuperProcessAsStore:function(){return o.cmFake&&(o=new Ext.data.Store({model:"CMTableForComboModel",cmFill:function(){this.removeAll();var e=[];for(var t in n){var i=n[t];i.data.superclass&&e.push({id:i.data.id,description:i.data.text})}this.add(e),this.sort("description","ASC")},sorters:[{property:"description",direction:"ASC"}]})).cmFill(),o},getClassesStore:function(){return s.cmFake&&(s=new Ext.data.Store({model:"CMTableForComboModel",cmFill:function(){this.removeAll();var e=[];for(var t in i){var n=i[t];"Class"!=n.data.name&&e.push({id:n.data.id,description:n.data.text,name:n.getName()})}this.add(e),this.sort("description","ASC")},sorters:[{property:"description",direction:"ASC"}]})).cmFill(),s},getClassesAndProcessesStore:function(){return l.cmFake&&(l=new Ext.data.Store({model:"CMTableForComboModel",cmFill:function(){function e(e){"simpletable"!=e.data.tableType&&"Class"!=e.data.name&&"Activity"!=e.data.name&&t.push({id:e.data.id,name:e.data.name,description:e.data.text})}this.removeAll();var t=[];for(var r in i)e(i[r]);for(var r in n)e(n[r]);this.add(t),this.sort("description","ASC")},sorters:[{property:"description",direction:"ASC"}]})).cmFill(),l},getClassRootId:function(){return e(i,"Class")},getActivityRootId:function(){return e(n,"Activity")},onClassSaved:function(e){var i=this.addClass(e);return t(),this.fireEvent("cm_class_saved",i),i},onProcessSaved:function(e){var i=this.addProcess(e);return t(),this.fireEvent("cm_process_saved",i),i},onClassDeleted:function(e){i[e]=void 0,delete i[e],t(),this.fireEvent("cm_class_deleted",e)},onProcessDeleted:function(e){n[e]=void 0,delete n[e],t(),this.fireEvent("cm_process_deleted",e)}})}(),function(){function e(e){return new Ext.data.Store({model:"CMDBuild.cache.Lookup.typeComboStore",cmOnlyLeaves:e,cmFill:function(){this.removeAll();var e=[];for(var t in n){var i=n[t];(!this.cmOnlyLeaves||this.cmOnlyLeaves&&!i.children)&&e.push([i.get("id")])}this.loadData(e),this.sort("type","ASC")},sorters:[{property:"type",direction:"ASC"}]})}CMDBuild.Constants;var t={cmFill:function(){},cmFake:!0},i={cmFill:function(){},cmFake:!0},n={},r={};Ext.define("CMDBuild.model.cache.LookupFieldStore",{extend:"Ext.data.Model",fields:[{name:"Description",type:"string"},{name:"Id",type:"int",defaultValue:""},{name:"Number",type:"int"},{name:"ParentId",type:"int"},{name:"TranslationUuid",type:"string"}]}),Ext.define("CMDBUild.cache.CMCacheLookupFunctions",{getLookupTypes:function(){return n},addLookupTypes:function(e){for(var t=0,i=e.length;t<i;++t)this.addLookupType(e[t])},addLookupType:function(e){n[e.id]=Ext.create("CMDBuild.cache.CMLookupTypeModel",e),t.cmFill(),i.cmFill()},getLookupTypeAsStore:function(){return t.cmFake&&(t=e(onlyLeaves=!1)).cmFill(),t},getLookupTypeLeavesAsStore:function(){return i.cmFake&&(i=e(onlyLeaves=!0)).cmFill(),i},onNewLookupType:function(e){this.addLookupType(e),t.cmFill(),i.cmFill(),this.fireEvent("cm_new_lookuptype",e)},onModifyLookupType:function(e){if(e.oldId)n[e.oldId]=void 0,delete n[e.oldId],this.addLookupType(e);else{n(e.id).set(e)}this.syncLookupTypesParent(e),t.cmFill(),i.cmFill(),this.fireEvent("cm_modified_lookuptype",e)},syncLookupTypesParent:function(e){for(var t in n){var i=n[t];i.get("parent")==e.oldId&&i.set("parent",e.id)}},getLookupStore:function(e){return r[e]||(r[e]=CMDBuild.proxy.Cache.getStoreLookup(e)),r[e]},getLookupchainForType:function(e){var t=[];for(e=e||"";e;){var i=!1;for(var r in n){var a=n[r];if(a.get("id")==e){t.push(e),i=!0,e=a.get("parent");break}}if(!i)break}return t}})}(),function(){function e(e,t){for(var i=0,n=e.length;i<n;++i)if(e[i].name==t.name){Ext.Array.erase(e,i,1);break}}var t={},i={},n=null,r="idClass1",a="idClass2";Ext.define("CMDBUild.cache.CMCacheDomainFunctions",{addDomains:function(e){for(var t=0,i=e.length;t<i;++t)this.addDomain(e[t])},addDomain:function(e){var i=Ext.create("CMDBuild.cache.CMDomainModel",{active:e.active,id:e.idDomain,cardinality:e.cardinality,nameClass1:e.class1,nameClass2:e.class2,idClass1:e.class1id,idClass2:e.class2id,name:e.name,createPrivileges:e.priv_create,writePrivileges:e.priv_write,isMasterDetail:e.md,description:e.description,descr_1:e.descrdir,descr_2:e.descrinv,meta:e.meta,attributes:e.attributes,md_label:e.md_label,disabled1:e.disabled1,disabled2:e.disabled2});return i.isMany=function(e){var t=this.get("cardinality");return t=t.split(":"),"_1"==e?"N"==t[0]:"N"==t[1]},t[e.idDomain]=i,i},getDomains:function(){return t},getDomainById:function(e){return t[e]},getDomainByName:function(e){for(var i in t)if((i=t[i]).get("name")==e)return i;return _debug("There are no domains with name "+e),null},getDomainNameById:function(e){if(void 0===i[e]){var t=this.getDomainById(e);i[e]=t?t.get("name"):""}return i[e]},getDomainAttributesStore:function(){if(!n){var e={INDEX:CMDBuild.core.constants.Proxy.INDEX,NAME:CMDBuild.core.constants.Proxy.NAME,DESCRIPTION:CMDBuild.core.constants.Proxy.DESCRIPTION,TYPE:CMDBuild.core.constants.Proxy.TYPE,IS_BASEDSP:"isbasedsp",IS_UNIQUE:"isunique",IS_NOT_NULL:"isnotnull",IS_INHERITED:"inherited",IS_ACTIVE:CMDBuild.core.constants.Proxy.ACTIVE,FIELD_MODE:CMDBuild.core.constants.Proxy.FIELD_MODE,GROUP:CMDBuild.core.constants.Proxy.GROUP,ABSOLUTE_CLASS_ORDER:"absoluteClassOrder",CLASS_ORDER_SIGN:"classOrderSign",EDITOR_TYPE:CMDBuild.core.constants.Proxy.EDITOR_TYPE};n=new Ext.data.Store({fields:[e.INDEX,e.NAME,e.DESCRIPTION,e.TYPE,e.IS_UNIQUE,e.IS_BASEDSP,e.IS_NOT_NULL,e.IS_INHERITED,e.FIELD_MODE,e.IS_ACTIVE,e.GROUP],autoLoad:!1,data:[],sorters:[{property:"index",direction:"ASC"}],loadForDomainId:function(e){if(this.lastDomainLoaded=e,this.removeAll(),t[e]){var i=t[e].get("attributes")||[];i.length>0&&this.loadData(i)}},reloadForLastDomainId:function(){this.loadForDomainId(this.lastDomainLoaded)}})}return n},getDirectedDomainForEntryType:function(e,t){var i=_CMCache.getDomainByName(t),n=_CMUtils.getAncestorsId(e),o=i.get(r),s=i.get(a);if(Ext.Array.contains(n,o)){var l=_CMCache.getEntryTypeById(s);if(l)return{dom_id:i.get("id"),description:i.get("descr_1")+" ("+l.get("text")+")",dst_cid:s,src_cid:o,src:"_1"}}else if(Ext.Array.contains(n,s)){var d=_CMCache.getEntryTypeById(o);if(d)return{dom_id:i.get("id"),description:i.get("descr_2")+" ("+d.get("text")+")",dst_cid:o,src_cid:s,src:"_2"}}},getDirectedDomainsByEntryType:function(e){"object"==typeof e&&(e=e.get("id"));var i=[],n=_CMUtils.getAncestorsId(e);for(var o in t){var s=(o=t[o]).get(r),l=o.get(a);if(Ext.Array.contains(n,s)){var d=_CMCache.getEntryTypeById(l);d&&i.push({dom_id:o.get("id"),description:o.get("descr_1")+" ("+d.get("text")+")",dst_cid:l,src_cid:s,src:"_1"})}if(Ext.Array.contains(n,l)){var u=_CMCache.getEntryTypeById(s);u&&i.push({dom_id:o.get("id"),description:o.get("descr_2")+" ("+u.get("text")+")",dst_cid:s,src_cid:l,src:"_2"})}}return i},getDomainsBy:function(e){var i=[];for(var n in t){var r=t[n];"function"==typeof e?e(r)&&i.push(r):i.push(r)}return i},getMasterDetailsForClassId:function(e){var i=[];for(var n in t)(n=t[n]).get("isMasterDetail")&&function(e,t){var i=e.get("cardinality"),n=e.get(r),o=e.get(a),s=_CMUtils.getAncestorsId(t);return"1:N"==i?Ext.Array.contains(s,n):"N:1"==i?Ext.Array.contains(s,o):void 0}(n,e)&&i.push(Ext.create("CMDBuild.cache.CMDomainModel",n.data));return i},onDomainSaved:function(e){var t=this.addDomain(e);return this.fireEvent("cm_domain_saved",t),t},onDomainDeleted:function(e){t[e]=void 0,delete t[e],this.fireEvent("cm_domain_deleted",e)},onDomainAttributeSaved:function(i,r){var a=t[i].get("attributes")||[];e(a,r),a.push(r),n&&n.reloadForLastDomainId()},onDomainAttributeDelete:function(i,r){e(t[i].get("attributes")||[],r),n&&n.reloadForLastDomainId()}})}(),function(){var e={},t={},i=Ext.create("Ext.data.ArrayStore",{fields:[CMDBuild.core.constants.Proxy.NAME],data:[],sorters:[{property:CMDBuild.core.constants.Proxy.NAME,direction:"ASC"}]}),n={add:"cm-dashboard-added",remove:"cm-dashboard-removed",modify:"cm-dashboard-modify"};Ext.define("CMDBuild.cache.CMCacheDashboardFunctions",{statics:{DASHBOARD_EVENTS:n},DASHBOARD_EVENTS:n,addDashboards:function(e){for(var t in e){var i=e[t];i.id=t,this.addDashboard(i)}},addDashboard:function(t){var i=CMDBuild.model.CMDashboard.build(t);i&&(e[t.id]=i,this.fireEvent(this.DASHBOARD_EVENTS.add,i))},removeDashboardWithId:function(t){e[t]&&(delete e[t],this.fireEvent(this.DASHBOARD_EVENTS.remove,t))},modifyDashboard:function(t,i){var n=e[t.id]||e[i];n&&(n.setName(t.name),n.setDescription(t.description),n.setGroups(t.groups),this.fireEvent(this.DASHBOARD_EVENTS.modify,n))},getDashboards:function(){return e},getDashboardById:function(t){return e[t]||null},setAvailableDataSources:function(e){e||(e=[]);for(var n,r=[],a=0,o=e.length;a<o;++a)n=e[a],t[n.name]={input:n.input||[],output:n.output||[]},r[a]={name:n.name};i.loadData(r)},getAvailableDataSourcesStore:function(){return i},getDataSourceInput:function(e){var i=t[e];return i?i.input:[]},getDataSourceOutput:function(e){var i=t[e];return i?i.output:[]}})}(),function(){function e(e,t){return i.findBy(function(i){return i.getName()==t&&i.getMasterTableName()==e})}var t=void 0,i=void 0;Ext.define("CMDBUild.cache.CMCacheGisFunctions",{getAllLayers:function(e){void 0===t?CMDBuild.proxy.gis.Layer.readAll({success:function(i,n,r){t=r.layers,e(t)}}):e(t)},getLayersStore:function(){var e=this;return void 0===i&&((i=new Ext.data.Store({model:"GISLayerModel",sorters:{property:"index",direction:"ASC"}})).load=function(t){e.getAllLayers(function(e){i.loadData(e),void 0!==t&&"function"==typeof t.callback&&t.callback(e)})}),i},getLayersForEntryTypeName:function(e,t){this.getAllLayers(function(i){for(var n=[],r=0,a=i.length;r<a;++r){var o=i[r];o.masterTableName==e&&n.push(o)}t(n)})},getVisibleLayersForEntryTypeName:function(e,t){this.getAllLayers(function(i){for(var n=[],r=0,a=i.length;r<a;++r){var o=i[r];Ext.Array.contains(o.visibility,e)&&n.push(o)}t(n)})},onGeoAttributeSaved:function(){t=void 0,void 0!==i&&i.load()},onGeoAttributeDeleted:function(n,r){if(t=void 0,void 0!==i){var a=e(n,r);a>=0&&i.removeAt(a)}},onGeoAttributeVisibilityChanged:function(){t=void 0}})}(),function(){Ext.ns("CMDBuild.cache"),Ext.define("CMDBuild.cache.CMCache",{extend:"Ext.util.Observable",uses:["CMDBuild.core.Message","CMDBuild.proxy.Cache","CMDBuild.proxy.common.tabs.attribute.Attribute","CMDBuild.proxy.gis.Layer","CMDBuild.proxy.index.Json"],mixins:{lookup:"CMDBUild.cache.CMCacheLookupFunctions",entryType:"CMDBUild.cache.CMCacheClassFunctions",domains:"CMDBUild.cache.CMCacheDomainFunctions",dashboards:"CMDBuild.cache.CMCacheDashboardFunctions",gis:"CMDBUild.cache.CMCacheGisFunctions",filters:"CMDBuild.cache.CMCacheFilterFunctions"},constructor:function(){this._lookupTypes={},this.toString=function(){return"CMCache"},this.callParent(arguments),this.mapOfAttributes={},this.mapOfReferenceStore={}},getAllAttributesList:function(){for(key in _CMCache.getClasses())_CMCache.getAttributeList(key,function(e){});return this.mapOfAttributes},getAttributeList:function(e,t){if(this.mapOfAttributes[e]){t(this.mapOfAttributes[e])}else this.loadAttributes(e,t)},loadAttributes:function(e,t){var i=this,n={};n[CMDBuild.core.constants.Proxy.ACTIVE]=!0,n[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(e),CMDBuild.proxy.common.tabs.attribute.Attribute.read({params:n,loadMask:!1,success:function(n,r,a){for(var o=a.attributes,s=[],l=0,d=o.length;l<d;++l){var u=o[l];"hidden"!=u.fieldmode&&s.push(u)}s.sort(function(e,t){return e.index-t.index}),i.mapOfAttributes[e]=s,t&&t(s)}})},getReferenceStore:function(e){var t=e.referencedClassName||e.referencedIdClass,i=!1,n=null;return(e.filter||e.oneTime)&&(n=this.buildReferenceStore(e),i=e.filter,e.filter=!1),this.mapOfReferenceStore[t]||(this.mapOfReferenceStore[t]=this.buildReferenceStore(e)),i&&(e.filter=i),n||this.mapOfReferenceStore[t]},buildReferenceStore:function(e){var t=this.buildParamsForReferenceRequest(e),i=!!t.CQL;return Ext.isEmpty(t.className)&&Ext.isEmpty(t.filter)?(_warning("Invalid reference property object",this,e),Ext.create("Ext.data.Store",{fields:[],data:[],baseParams:{IdClass:null}})):CMDBuild.proxy.Cache.getStoreReference(i,t)},buildParamsForReferenceRequest:function(e){var t=e.idClass||e.referencedIdClass,i={className:e.referencedClassName||_CMCache.getEntryTypeNameById(t)};return e.filter?i.filter=Ext.encode({CQL:e.filter}):i.NoFilter=!0,i},getForeignKeyStore:function(e){var t={className:e.fkDestination};return Ext.isEmpty(e.filter)?t.NoFilter=!0:t.filter=Ext.encode({CQL:e.filter}),Ext.isEmpty(t.className)&&Ext.isEmpty(t.filter)?(_warning("Invalid ForeignKey object",this,reference),Ext.create("Ext.data.Store",{fields:[],data:[],baseParams:{IdClass:null}})):CMDBuild.proxy.Cache.getStoreForeignKey(t)},isDescendant:function(e,t){function i(e,t,i){if(!e)return!1;var n={};e.cascade(function(){n[this.id]=this});var r=n[i],a=n[t];return a&&r&&r.isAncestor(a)}return t==e||i(this.getTree("class_tree"),t,e)||i(this.getTree("process_tree"),t,e)},onClassContentChanged:function(e){!function(e,t){var i=_CMUtils.getAncestorsId(t);Ext.Array.each(i,function(t){var i=e[t];i&&i.load()})}(this.mapOfReferenceStore,e)},getTableGroup:function(e){var t;if(t=e.tableType&&"standard"!=e.tableType?e.tableType:e.type,{class:"class",processclass:"processclass",simpletable:"simpletable",report:"report",lookuptype:"lookuptype",group:"group"}[t])return t;throw new Error("Unsupported node type: "+t)}}),_CMCache=Ext.create("CMDBuild.cache.CMCache")}(),function(){Ext.require(["CMDBuild.proxy.TemplateResolver"]),void 0===CMDBuild.Management&&(CMDBuild.Management={}),CMDBuild.Management.TemplateResolver=function(e){Ext.apply(this,e)};var isComboField=function(e){return e.getReadableValue};CMDBuild.Management.TemplateResolver.prototype={getVariable:function(e,t){var i=this.getQName(e),n={client:this.getActivityFormVariable,server:this.getActivityServerVariable,user:this.getCurrentUserInfo,group:this.getCurrentGroupInfo,xa:this.getExtendedAttributeVariable,js:this.getJSVariable,cql:this.getCQLVariable};if(i.namespace in{cql:"",js:""}&&!t)return CMDBuild.log.error("No direct resolver for namespace "+i.namespace),"";var r=n[i.namespace];return r?r.call(this,i.localname,t):(CMDBuild.log.error("No resolver for namespace "+i.namespace),"")},getActivityFormVariable:function(e){var t,i=this.splitLocalName(e),n=this.findFormField(i.name);return n&&(isComboField(n)?t={Id:function(){return n.getValue()},Description:function(){return n.getReadableValue()},"":function(){return CMDBuild.log.warn("It is best to specify a detail when using lookup and reference types"),n.getValue()}}[i.detail]():(i.detail&&(CMDBuild.log.warn("Detail can only be specified for lookup and reference types"),CMDBuild.core.Message.warning(CMDBuild.Translation.warning,CMDBuild.Translation.errors.template_error+" "+i.name+" "+i.detail)),t="function"==typeof n.getRawValue?n.getRawValue():n.getValue())),CMDBuild.log.debug("Activity form variable "+e+" = "+t),t},findFormField:function(e){var t=void 0;if(!Ext.isEmpty(this.getBasicForm()))var i=this.getBasicForm().getFields();return Ext.isEmpty(i)||(t=i.findBy(function(t){return!!t.CMAttribute&&t.CMAttribute.name==e})||i.findBy(function(t){return t.name==e})),t},getBasicForm:function(){return this.clientForm},getActivityServerVariable:function(e){var t=this.splitLocalName(e),i=this.getServerVars();if(i){var n=i[t.name]||"";return null!=n&&"object"==typeof n&&(n="Description"==t.detail?n.description:n.id),CMDBuild.log.debug("Activity server variable "+e+" = "+n),n}CMDBuild.log.debug("Activity server variable "+e+" = No server vars")},getServerVars:function(){return this.serverVars},splitLocalName:function(e){var t;return(t=e.indexOf("."))>0?{name:e.slice(0,t),detail:e.slice(t+1)}:(t=e.search("_value"))>0?{name:e.slice(0,t),detail:"Description"}:{name:e,detail:""}},getCurrentUserInfo:function(e){return{name:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.USERNAME),id:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.USER_ID)}[e]},getCurrentGroupInfo:function(e){return{name:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.DEFAULT_GROUP_NAME),id:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.DEFAULT_GROUP_ID)}[e]},getExtendedAttributeVariable:function(e){var t=this.xaVars[e];if("string"==typeof t){var i=this.expandTemplate(t);return CMDBuild.log.debug("Extended Attribute expanded template "+e+" = "+i),i}return CMDBuild.log.debug("Extended Attribute variable "+e+" = "+t),t},getJSVariable:function(e,t){return t.js[e]},getCQLVariable:function(e,t){var i=e.split(".");if(i.length>1){var n=i[0],r=i[1],a=t.cql[n];return a?a[r]:void 0}return CMDBuild.log.error("Can't determine field name for CQL variable "+e),""},resolveTemplates:function(e){var t=e.callback||Ext.emptyFn;e.scope&&(t=Ext.bind(t,e.scope));var i=e.attributes,n=this.getTemplateSetDeps(i,this.xaVars);CMDBuild.log.debug("External template dependencies",n);var r=this.topoSort(n);CMDBuild.log.debug("Topological order",r),this.evalTemplates(r,function(e){t(e.out,e)})},getTemplateSetDeps:function(e){for(var t={},i={},n={},r=0,a=e.length;r<a;++r){n["xa:"+e[r]]=null}return this.updateTemplateSetDeps(n,t,i),this.localDeps=i,this.externalDeps=t,t},updateTemplateSetDeps:function(e,t,i){for(var n in e)void 0===t[n]&&(t[n]=null,this.updateTemplateDeps(n,t,i))},updateTemplateDeps:function(e,t,i){var n=this.getQName(e),r=this.xaVars[n.localname];if("string"==typeof r){var a=this.extractRecursionVarsAndUpdateLocalDeps(r,i);t[e]=a,this.updateTemplateSetDeps(a,t,i)}},extractRecursionVarsAndUpdateLocalDeps:function(e,t){function i(e){var t=s.qvar.raw.split(".")[0];r[t]=!0}for(var n=this.splitTemplate(e),r={},a=0,o=n.length;a<o;++a){var s=n[a];if(s.qvar){var l=s.qvar.namespace,d={cql:i,js:i,xa:i,client:function(e){var i=s.qvar.localname.split(".")[0];t[i]=!0}};l in d&&d[l](s.qvar)}}return r},topoSort:function(e){var t={},i=[];for(var n in e)t[n]=!1;for(var n in e)this.topoVisit(e,n,i,t);return i},topoVisit:function(e,t,i,n){if(!n[t]){n[t]=!0;for(var r in e[t])this.topoVisit(e,r,i,n);i.push(t)}},evalTemplates:function(e,t,i,n){if(i||(i={cql:{},js:{},out:{}}),n||(n=0),n<e.length){var r=e[n],a=this;this.evalTemplate(r,i,function(){a.evalTemplates(e,t,i,++n)})}else t(i)},evalTemplate:function(e,t,i){var n=this;this.waitForBusyDeps(function(){CMDBuild.log.info("Evaluating template "+e);var r=n.getQName(e),a=r.localname,o=r.namespace,s=n.xaVars[a];CMDBuild.log.debug("Template",s),CMDBuild.log.debug("Current context",t),"string"==typeof s?"cql"==o?n.executeCQLTemplate(a,s,t,i):"js"==o?(t.js[a]=n.evalJSTemplate(a,s,t),i(t)):(t.out[a]=n.expandTemplate(s,t),i(t)):(t.out[a]=s,i(t))})},waitForBusyDeps:function(e){var t=this.getLocalDepsAsField(),i=!1;for(var n in t){var r=t[n];if(r&&r.templateResolverBusy){i=!0;break}}if(i){var a=this;Ext.Function.createDelayed(function(e){a.waitForBusyDeps(e)},200)(e)}else e()},executeCQLTemplate:function(e,t,i,n){var r=this.buildCQLQueryParameters(t,i);r?CMDBuild.proxy.TemplateResolver.readAllCard({params:r,loadMask:!1,success:function(t,r,a){var o=a.rows[0];i.cql[e]=o,n(i)}}):n(i)},buildCQLQueryParameters:function(e,t){if(e){for(var i={CQL:""},n=0,r=this.splitTemplate(e),a=0,o=r.length;a<o;++a){var s=r[a];if(s.qvar){var l="p"+a,d=this.getVariable(s.qvar,t);if(0!==d&&!d)return;0==n?(i.CQL+="{"+l+"}",i[l]=d):i.CQL+=d}s.text&&(i.CQL+=s.text,n^=(s.text.match(/\//g)||[]).length%2)}return i}},evalJSTemplate:function(e,t,i){CMDBuild.log.debug("JS Eval template "+t);for(var n="",r=this.splitTemplate(t),a=0,o=r.length;a<o;++a){var s=r[a];if(s.qvar){var l,d=this.getVariable(s.qvar,i);if(void 0===d)l="undefined";else{var u=d+"";l="'"+Ext.String.escape(u)+"'"}n+=l}s.text&&(n+=s.text)}return this.safeJSEval(n)},expandTemplate:function(e,t){CMDBuild.log.debug("Resolving template "+e);for(var i="",n=this.splitTemplate(e),r=0,a=n.length;r<a;++r){var o=n[r];if(o.qvar){var s=this.getVariable(o.qvar,t);if(void 0===s)return;i+=s}o.text&&(i+=o.text)}return i},splitTemplate:function(e){if(e){var t=[],i=e.split("{");t.push({text:i[0]});for(var n=1,r=i.length;n<r;++n){var a=i[n].split("}");if(2!=a.length)return void CMDBuild.log.error("Unable to parse template "+e);t.push({qvar:this.getQName(a[0]),text:a[1]})}return t}return{text:e}},getQName:function(e){if(e instanceof Object)return e;var t=e.indexOf(":");return-1==t&&(t=e.indexOf("#")),-1==t?{raw:e,namespace:"server",localname:e}:{raw:e,namespace:e.slice(0,t),localname:e.slice(t+1)}},getLocalDepsAsField:function(){var e={};for(var t in this.localDeps){var i=this.findFormField(t);e[t]=i}return e},bindLocalDepsChange:function(e,t){var i=this.getLocalDepsAsField();e=e||Ext.emptyFn,t=t||this;for(var n in i){var r=i[n];r&&(r.mon(r,"change",function(i){"Ext.ux.form.XCheckbox"==Ext.getClassName(i)||"CMDBuild.view.common.field.HtmlEditor"==Ext.getClassName(i)?Ext.callback(e,t,[r]):i.changed=!0},t),r.mon(r,"blur",function(i){i.changed&&(i.changed=!1,Ext.callback(e,t,[r]))},t))}},safeJSEval:function(stringTOEvaluate){var resultOfEval="";try{resultOfEval=eval(stringTOEvaluate)}catch(e){try{resultOfEval=eval(stringTOEvaluate.replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,""))}catch(e){_debug("Error evaluating javascript expression",stringTOEvaluate)}}return resultOfEval}}}(),Ext.define("CMDBuild.core.interfaces.Ajax",{extend:"Ext.data.Connection",uses:["CMDBuild.core.CookiesManager","CMDBuild.core.interfaces.messages.Error","CMDBuild.core.interfaces.messages.Warning","CMDBuild.core.interfaces.service.LoadMask","CMDBuild.core.Utils"],singleton:!0,autoAbort:!1,listeners:{beforerequest:function(e,t,i){return CMDBuild.core.interfaces.Ajax.trapCallbacks(e,t)}},adapterCallback:function(e,t,i,n){var r=CMDBuild.core.interfaces.Ajax.decodeJson(i.responseText);CMDBuild.core.CookiesManager.authorizationExpirationUpdate(),CMDBuild.core.interfaces.service.LoadMask.manage(e.loadMask,!1),CMDBuild.global.interfaces.Configurations.get("disableAllMessages")||(CMDBuild.global.interfaces.Configurations.get("disableWarnings")||CMDBuild.core.interfaces.messages.Warning.display(r),CMDBuild.global.interfaces.Configurations.get("disableErrors")||CMDBuild.core.interfaces.messages.Error.display(r,e)),Ext.callback(n,e.scope,[e,t,i])},adapterSuccess:function(e,t,i){var n=CMDBuild.core.interfaces.Ajax.decodeJson(e.responseText);Ext.callback(i,t.scope,[e,t,n])},adapterFailure:function(e,t,i){var n=CMDBuild.core.interfaces.Ajax.decodeJson(e.responseText);Ext.callback(i,t.scope,[e,t,n])},decodeJson:function(e){if(e=Ext.isEmpty(e)?'{"success":true,"response":null}':e,CMDBuild.core.Utils.isJsonString(e)){Ext.isEmpty(e)||(e=e.replace(/<\/\w+>$/,""));try{return Ext.decode(e)}catch(e){_error(e,"CMDBuild.core.interfaces.Ajax")}return""}return _error('invalid json string: "'+e+'"',"CMDBuild.core.interfaces.Ajax"),""},interceptorCallback:function(e){return Ext.bind(CMDBuild.core.interfaces.Ajax.adapterCallback,e.scope,[e.callback],!0)},interceptorFailure:function(e){return Ext.bind(CMDBuild.core.interfaces.Ajax.adapterFailure,e.scope,[e.failure],!0)},interceptorSuccess:function(e){return Ext.bind(CMDBuild.core.interfaces.Ajax.adapterSuccess,e.scope,[e.success],!0)},onComplete:function(e,t){var i,n=e.options,r=!0;return i=e.aborted||e.timedout?this.createException(e):this.createResponse(e),Ext.isEmpty(i.responseText)||Ext.isEmpty(Ext.decode(i.responseText).success)||(r=Ext.decode(i.responseText).success),r?(this.fireEvent("requestcomplete",this,i,n),Ext.callback(n.success,n.scope,[i,n])):(this.fireEvent("requestexception",this,i,n),Ext.callback(n.failure,n.scope,[i,n])),Ext.callback(n.callback,n.scope,[n,r,i]),delete this.requests[e.id],i},trapCallbacks:function(e,t){return CMDBuild.core.interfaces.service.LoadMask.manage(t.loadMask,!0),Ext.apply(t,{callback:CMDBuild.core.interfaces.Ajax.interceptorCallback(t),failure:CMDBuild.core.interfaces.Ajax.interceptorFailure(t),success:CMDBuild.core.interfaces.Ajax.interceptorSuccess(t)}),!0}}),Ext.define("CMDBuild.core.CMDelegable",{statics:{errors:{noInterfaceOnInit:"Define delegate interface name",wrongTypeOnAdd:function(e,t){return Ext.String.format("A delegate for {0} must implements {1}",e,t)}}},delegateInterfaceName:void 0,constructor:function(e){if("string"!=typeof e||""===e)throw Ext.getClass(this).errors.noInterfaceOnInit;this.delegateInterfaceName=e,this.delegates=[]},addDelegate:function(e){if(!CMDBuild.checkInterface(e,this.delegateInterfaceName))throw Ext.getClass(this).errors.wrongTypeOnAdd(Ext.getClassName(this),this.delegateInterfaceName);this.delegates.push(e)},removeDelegate:function(e){Ext.Array.remove(this.delegates,e)},callDelegates:function(e,t){var i=t||[];i=Ext.isArray(i)?i:[i];for(var n=0,r=null;n<this.delegates.length;++n)"function"==typeof(r=this.delegates[n])[e]&&r[e].apply(r,i)},getFromDelegates:function(e){for(var t=0,i=null;t<this.delegates.length;++t)if("function"==typeof(i=this.delegates[t])[e]){var n=i[e].apply(i);if(void 0!==n)return n}},countDelegates:function(){return this.delegates.length}}),function(){function e(t,i,n,a,o){if(n[t.nodeName]){for(var s={},l=0,d=(c=t.childNodes).length;l<d;++l){var u=c[l];s[u.nodeName]=r(u)}void 0!==a&&(s[a]=t),s[o]=t.nodeName,i.push(s)}var c;for(l=0,d=(c=t.childNodes).length;l<d;++l)e(c[l],i,n,a,o)}function t(e){var t=null;if(function(e){return e.nodeType==a}(e)){var i=e.childNodes;if(i&&i.length>0)for(var n=0;n<i.length;++n){var r=i[n];"xml"!=r.nodeName&&(t=r)}}else t=e;return t}function i(e){var t=function(e){var t=[],a="";if(e)for(var o=0,s=e.length;o<s;++o){var l=e[o];n(l)?a+=r(l)+" ":t.push(i(l))}return{children:t,textContent:a}}(e.childNodes),a=t.children.length>0,o="";o=n(e)?r(e):e.nodeName,t.textContent.length>0&&(t.textContent=": "+t.textContent);var s={text:o+t.textContent,domNode:e,iconCls:"display-none",leaf:!a};return a?s.children=t.children:s.iconCls="cmdb-tree-no-icon",s}function n(e){return e.nodeType==o}function r(e){var t="";return e.text?t=e.text:e.textContent&&(t=e.textContent),t}var a=9,o=3;Ext.define("CMDBuild.core.xml.XMLUtility",{statics:{xmlDOMFromString:function(e){var t=null;if(window.ActiveXObject&&void 0!==window.ActiveXObject)new window.ActiveXObject("Microsoft.XMLDOM")&&((t=new window.ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e));else{if(!window.DOMParser||void 0===window.DOMParser)throw new Error("No XML parser found");t=(new window.DOMParser).parseFromString(e,"text/xml")}return t},genericExtTreeFromXMLDom:function(e){var n=t(e);return n?i(n):{}},fromDOMToArrayOfObjects:function(i,n,r,a){for(var o={},s=0,l=n.length;s<l;++s)o[n[s]]=!0;var d=[],u=t(i);return null!=u&&e(u,d,o,r,a),d},serializeToString:function(e){return e.xml?e.xml:(new XMLSerializer).serializeToString(e)},getNodeText:r}})}(),Ext.define("CMDBuild.CallbackPlugin",{extend:"Ext.util.Observable",constructor:function(){this.callParent(arguments)},init:function(e){function t(e){e.callback&&(e.failure?e.failure=Ext.Function.createSequence(e.failure,e.callback,e.scope):e.failure=e.callback,e.success?e.success=Ext.Function.createSequence(e.success,e.callback,e.scope):e.success=e.callback)}var i=e.getForm();i.submit=Ext.Function.createInterceptor(i.submit,t,this),i.load=Ext.Function.createInterceptor(i.load,t,this)}});var fullemailspec=/^[\w ]*\<([^\<\>]+)\>[ ]*$/,numericRegExp=/^(([+,\-]?[0-9]+)|[0-9]*)(\.[0-9]+)?$/,numericValidation=function(e,t,i){var n={valid:!0,message:""};null==e.match(numericRegExp)&&(n={valid:!1,message:CMDBuild.Translation.vtypeNumericInvalidCharacterText});var r=e.split("."),a=Math.abs(r[0]),o=r[1];if(void 0!==i){var s=i-(t||0);a&&new String(a).length>s&&(n={valid:!1,message:Ext.String.format(CMDBuild.Translation.vtypeNumericMaxIntegerDigitsText,s)})}return void 0!==t&&o&&o.length>t&&(n={valid:!1,message:Ext.String.format(CMDBuild.Translation.vtypeNumericMaxDecimalDigitsText,t)}),n};Ext.apply(Ext.form.VTypes,{emailaddrspec:function(e){var t=e.match(fullemailspec);return t&&(e=t[1]),Ext.form.VTypes.email(e)},emailaddrspecText:Ext.form.VTypes.emailText,emailaddrspeclist:function(e){for(var t=e.split(","),i=0,n=t.length;i<n;++i){var r=Ext.String.trim(t[i]);if(r&&!Ext.form.VTypes.emailaddrspec(r))return!1}return!0},emailaddrspeclistText:Ext.form.VTypes.emailText,emailOrBlank:function(e){return 0==e.length||this.email(e)},emailOrBlankText:Ext.form.VTypes.emailText,numeric:function(e,t){var i=numericValidation(e,t.scale,t.precision);return t.vtypeText=i.message,i.valid}}),function(){Ext.override(Ext.form.FormPanel,{getInvalidFieldsAsHTML:function(){var e="";return this.cascade(function(t){t&&t instanceof Ext.form.Field&&(t.isValid()||(e+="<li>"+t.fieldLabel+"</li>"))}),""==e?null:"<ul>"+e+"</ul>"},isReadOnly:function(e){return!!e&&e.initialConfig.CMDBuildReadonly},setFieldsEnabled:function(e){if(!this.MODEL_STRUCTURE)return function(e){if(this.cascade(function(t){t&&t instanceof Ext.form.Field&&t.isVisible()&&(e||!t.initialConfig.CMDBuildReadonly)&&t.enable()}),this.buttons)for(var t=0;t<this.buttons.length;t++)this.buttons[t]&&this.buttons[t].enable()}.call(this,e);var t=this.MODEL_STRUCTURE;this.cascade(function(i){if(i&&i instanceof Ext.form.Field){var n=i._name||i.name;(e||!t[n].immutable)&&i.enable()}})},setFieldsDisabled:function(){if(this.MODEL_STRUCTURE){this.MODEL_STRUCTURE;this.cascade(function(e){e&&e instanceof Ext.form.Field&&e.disable&&e.disable()})}else(function(){if(this.cascade(function(e){e&&e instanceof Ext.form.Field&&!(e instanceof Ext.form.DisplayField)&&"hidden"!=e.getXType()&&e.disable()}),this.buttons)for(var e=0;e<this.buttons.length;e++)this.buttons[e]&&this.buttons[e].disable()}).call(this)},enableAllField:function(){var e=this.getForm().items.items;this.formIsDisable=!1;for(var t=0;t<e.length;t++)e[t].enable()},disableAllField:function(){var e=this.getForm().items.items;this.formIsDisable=!0;for(var t=0;t<e.length;t++)e[t].disable()},forEachField:function(e){for(var t=this.getForm().items,i=0;i<t.length;i++){e(t[i])}}}),Ext.override(Ext.form.field.HtmlEditor,{initDefaultFont:function(){}}),Ext.override(Ext.picker.Date,{selectToday:function(){var e=this.todayBtn,t=this.handler;return e&&!e.disabled&&(this.setValue(new Date),this.fireEvent("select",this,this.value),t&&t.call(this.scope||this,this,this.value),this.onSelect()),this},setValue:function(e){return this.value=e,this.update(this.value)}}),Ext.override(Ext.form.Hidden,{validateValue:function(e){return!1!==this.allowBlank||e.length>0}}),Ext.override(Ext.form.FieldSet,{syncSize:function(){Ext.form.FieldSet.superclass.syncSize.call(this);for(var e=this.items.items,t=0;t<e.length;t++){var i=e[t];i&&i.syncSize&&i.syncSize()}}})}(),Ext.ns("CMDBuild"),CMDBuild.FormPlugin=function(e){Ext.apply(this,e)},Ext.extend(CMDBuild.FormPlugin,Ext.util.Observable,{init:function(e){var t=e.getForm();e.clearForm=function(){var e={};t.items.each(function(t){e[t.getName()]=""}),t.setValues(e)},e.autoComplete=function(e,t,i){var n=e.getValue();""!=n&&n!=i||e.setValue(t)}}}),Ext.define("CMDBuild.form.HexColorField",{extend:"Ext.form.ColorField",editable:!1,setValue:function(e){e&&"#"==e[0]&&(e=e.slice(1)),CMDBuild.form.HexColorField.superclass.setValue.call(this,e)},getValue:function(){var e=this.value;return e&&"#"!=e[0]&&(e="#"+e),e}}),function(){Ext.define("CMDBuild.form.RangeSliders",{extend:"Ext.container.Container",maxSliderField:void 0,minSliderField:void 0,initComponent:function(){if(!this.maxSliderField)throw new Error("You must assign a maxSliderField to the RangeSliderFieldset");if(!this.minSliderField)throw new Error("You must assign a minSliderField to the RangeSliderFieldset");this.items=[this.minSliderField,this.maxSliderField],this.callParent(arguments),function(e){e.on("enable",function(){e.maxSliderField.enable(),e.minSliderField.enable()}),e.on("disable",function(){e.maxSliderField.disable(),e.minSliderField.disable()})}(this),function(e){e.maxSliderField.on("dragstart",function(e,t){e.startDragValue=e.getValue()}),e.maxSliderField.on("dragend",function(t,i){t.getValue()<e.minSliderField.getValue()&&t.setValue(e.minSliderField.getValue()),t.startDragValue=void 0})}(this),function(e){e.minSliderField.on("dragstart",function(e,t){e.startDragValue=e.getValue()}),e.minSliderField.on("dragend",function(t,i){t.getValue()>e.maxSliderField.getValue()&&t.setValue(e.maxSliderField.getValue()),t.startDragValue=void 0})}(this)},disable:function(){this.maxSliderField.disable(),this.minSliderField.disable()},enable:function(){this.maxSliderField.enable(),this.minSliderField.enable()}})}(),Ext.define("CMDBuild.SetValueOnLoadPlugin",{extend:"Ext.util.Observable",init:function(e){e.valueNotFoundText="",e.store.on("load",function(){this.valueNotFoundText=this.initialConfig.valueNotFoundText,this.store&&this.setValue(this.getValue())},e)}}),function(){Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.BaseAttribute=function(){},CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator={EQUAL:"equal",NOT_EQUAL:"notequal",NULL:"isnull",NOT_NULL:"isnotnull",GREATER_THAN:"greater",LESS_THAN:"less",BETWEEN:"between",LIKE:"like",CONTAIN:"contain",NOT_CONTAIN:"notcontain",BEGIN:"begin",NOT_BEGIN:"notbegin",END:"end",NOT_END:"notend",NET_CONTAINS:"net_contains",NET_CONTAINED:"net_contained",NET_CONTAINSOREQUAL:"net_containsorequal",NET_CONTAINEDOREQUAL:"net_containedorequal",NET_RELATION:"net_relation"},CMDBuild.WidgetBuilders.BaseAttribute.prototype={getQueryCombo:function(e){var t=new Ext.data.SimpleStore({fields:["id","type"],data:this.getQueryOptions()});return new Ext.form.ComboBox({labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description,labelSeparator:"",hideLabel:!0,name:e.name+"_ftype",queryMode:"local",store:t,value:this.getDefaultValueForQueryCombo(),valueField:"id",displayField:"type",triggerAction:"all",forceSelection:!0,allowBlank:!0,width:130})},getDefaultValueForQueryCombo:function(){return CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator.EQUAL},getQueryOptions:function(){throw new Error("not implemented")},buildField:function(e,t){var i=this.buildAttributeField(e);return i.hideLabel=t,this.markAsRequired(i,e)},buildAttributeField:function(){throw new Error("not implemented")},markAsRequired:function(e,t){return(t.isnotnull||"required"==t.fieldmode)&&(e.allowBlank=!1,e.fieldLabel&&(e.fieldLabel="* "+e.fieldLabel)),e},buildReadOnlyField:function(e){var t=new Ext.form.DisplayField({allowBlank:!0,labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,width:CMDBuild.core.constants.FieldWidths.STANDARD_BIG,submitValue:!1,name:e.name,disabled:!1,isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())}});return this.markAsRequired(t,e)},buildGridHeader:function(e){throw new Error("not implemented")},buildCellEditor:function(e){return CMDBuild.Management.FieldManager.getFieldForAttr(e,readOnly=!1)},getFieldSetForFilter:function(e,t){var i=Ext.apply({},{fieldmode:"write",name:e.name},e),n=this.buildField(i,!0),r=this.getQueryCombo(i);return this.buildFieldsetForFilter(n,r,i,t)},buildFieldsetForFilter:function(e,t,i,n){return this.genericBuildFieldsetForFilter([e],t,i,n)},genericBuildFieldsetForFilter:function(e,t,i,n){return Ext.create("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel",{attributeName:i.name,conditionCombo:t,valueFields:e,taskManager:n})}},Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanelDelegate",{onFilterAttributeConditionPanelRemoveButtonClick:Ext.emptyFn}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel",{extend:"Ext.container.Container",mixins:{delegable:"CMDBuild.core.CMDelegable"},taskManager:!1,defaults:{margins:"0 5 0 0"},filterType:"fixed",layout:{type:"hbox",pack:"start",align:"top"},hideMode:"offsets",attributeName:"",conditionCombo:"",valueFields:[],selectAtRuntimeCheckDisabled:!0,constructor:function(){this.mixins.delegable.constructor.call(this,"CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanelDelegate"),this.callParent(arguments)},initComponent:function(){var e=this;this.removeFieldButton=Ext.create("Ext.button.Button",{iconCls:"delete",handler:function(){e.callDelegates("onFilterAttributeConditionPanelRemoveButtonClick",[e])}}),this.fieldInputParameter=Ext.create("Ext.form.field.Checkbox",{boxLabel:CMDBuild.Translation.inputParameter,listeners:{scope:this,change:function(t,i,n,r){e.filterType=i?"runtime":"fixed","fixed"===e.filterType?e.valueFieldsContainer.show():e.valueFieldsContainer.hide()}}}),Ext.apply(this,{items:[{xtype:"container",items:[this.removeFieldButton]},{xtype:"container",items:[this.conditionCombo]}]}),this.callParent(arguments),this.onConditionComboSelectStrategy=this.buildOnConditionComboSelectStrategy(),this.valueFieldsContainer=Ext.create("Ext.container.Container",{items:this.valueFields}),this.add(this.valueFieldsContainer),this.taskManager||this.add({xtype:"container",items:[this.fieldInputParameter]}),this.conditionCombo.setValue=Ext.Function.createSequence(this.conditionCombo.setValue,function(t){e.onConditionComboSelectStrategy.run(this.getValue())},this.conditionCombo)},showOr:function(){this.orPanel||(this.orPanel=new Ext.container.Container({html:"or"})),this.add(this.orPanel)},hideOr:function(){this.orPanel&&this.remove(this.orPanel)},getData:function(){var e,t=[];this.isDateInTaskManager()?(this.filterType=this.valueFields.items.items[0].getValue(),e="expression"===this.filterType?this.valueFields.items.items[2].items.items:this.valueFields.items.items[1].items.items):e=this.valueFields;for(var i=0;i<e.length;++i){(r=e[i]).isDisabled()||t.push(r.getValue())}var n={simple:{attribute:this.attributeName,operator:this.conditionCombo.getValue(),value:t}};n.simple.parameterType=this.filterType;var r=this.valueFields[0];if("CMDBuild.Management.ReferenceField.Field"==Ext.getClassName(r)){var a=r.CMAttribute;a&&("User"==a.referencedClassName&&-1==r.getValue()?(n.simple.parameterType="calculated",n.simple.value=["@MY_USER"]):"Role"==a.referencedClassName&&-1==r.getValue()&&(n.simple.parameterType="calculated",n.simple.value=["@MY_GROUP"]))}return n},setData:function(e){if(!Ext.isEmpty(e)){this.conditionCombo.setValue(e.operator),this.fieldInputParameter.setValue("runtime"===e.parameterType);var t;if(this.isDateInTaskManager())if(this.valueFields.items.items[0].setValue(e.parameterType),"expression"===e.parameterType)t=this.valueFields.items.items[2].items.items;else{t=this.valueFields.items.items[1].items.items;var i=[];Ext.Array.each(e.value,function(e){i.push(new Date(e))}),e.value=i}else t=this.valueFields;for(var n=0;n<e.value.length;++n){var r=t[n];try{r.setValue(e.value[n])}catch(e){}}}},buildOnConditionComboSelectStrategy:function(){return 1==this.valueFields.length?new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.SingleStrategy(this.valueFields):2==this.valueFields.length?new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.DoubleStrategy(this.valueFields):this.isDateInTaskManager()?new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.TaskDateStrategy(this.valueFields):(_debug("There is no Strategy for this value fields",this.valueFields),new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.Strategy)},isDateInTaskManager:function(){return this.taskManager&&"Ext.container.Container"===Ext.ClassManager.getName(this.valueFields)}}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.Strategy",{constructor:function(e,t){this.valueFields=e},run:Ext.emptyFn}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.SingleStrategy",{extend:"CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.Strategy",run:function(e){for(var t=this.needsFieldToSetAValue(e),i=0,n=this.valueFields.length;i<n;++i){this.valueFields[i].setDisabled(t)}},needsFieldToSetAValue:function(e){return e==CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator.NULL||e==CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator.NOT_NULL}}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.DoubleStrategy",{extend:"CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.SingleStrategy",constructor:function(e){this.callParent(arguments)},run:function(e){this.callParent(arguments),this.valueFields[1].setDisabled("between"!==e)}})}(),Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.SimpleQueryAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.SimpleQueryAttribute,CMDBuild.WidgetBuilders.BaseAttribute),CMDBuild.WidgetBuilders.SimpleQueryAttribute.prototype.getQueryOptions=function(){var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator;return[[e.EQUAL,CMDBuild.Translation.equals],[e.NULL,CMDBuild.Translation.isNull],[e.NOT_NULL,CMDBuild.Translation.isNotNull]]},CMDBuild.WidgetBuilders.SimpleQueryAttribute.prototype.needsDoubleFielForQuery=function(){return!1},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.RangeQueryAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.RangeQueryAttribute,CMDBuild.WidgetBuilders.BaseAttribute),CMDBuild.WidgetBuilders.RangeQueryAttribute.prototype.getQueryOptions=function(){var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator;return[[e.EQUAL,CMDBuild.Translation.equals],[e.NULL,CMDBuild.Translation.isNull],[e.NOT_NULL,CMDBuild.Translation.isNotNull],[e.NOT_EQUAL,CMDBuild.Translation.different],[e.GREATER_THAN,CMDBuild.Translation.greaterThan],[e.LESS_THAN,CMDBuild.Translation.lessThan],[e.BETWEEN,CMDBuild.Translation.between]]},CMDBuild.WidgetBuilders.RangeQueryAttribute.prototype.buildFieldsetForFilter=function(e,t,i,n){var r=e.cloneConfig();return r.hideLabel=!0,r.disable(),this.genericBuildFieldsetForFilter([e,r],t,i,n)},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.TextualQueryAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.TextualQueryAttribute,CMDBuild.WidgetBuilders.BaseAttribute),CMDBuild.WidgetBuilders.TextualQueryAttribute.prototype.getQueryOptions=function(){var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator;return[[e.BEGIN,CMDBuild.Translation.beginsWith],[e.CONTAIN,CMDBuild.Translation.contains],[e.END,CMDBuild.Translation.endsWith],[e.EQUAL,CMDBuild.Translation.equals],[e.NOT_BEGIN,CMDBuild.Translation.doesNotBeginWith],[e.NOT_CONTAIN,CMDBuild.Translation.doesNotContain],[e.NOT_END,CMDBuild.Translation.doesNotEndWith],[e.NOT_EQUAL,CMDBuild.Translation.different],[e.NOT_NULL,CMDBuild.Translation.isNotNull],[e.NULL,CMDBuild.Translation.isNull]]},CMDBuild.WidgetBuilders.TextualQueryAttribute.prototype.getDefaultValueForQueryCombo=function(){return CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator.CONTAIN},CMDBuild.WidgetBuilders.TextualQueryAttribute.prototype.needsDoubleFielForQuery=function(){return!1},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.DecimalAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.DecimalAttribute,CMDBuild.WidgetBuilders.RangeQueryAttribute),CMDBuild.WidgetBuilders.DecimalAttribute.prototype.MAXWIDTH=100,CMDBuild.WidgetBuilders.DecimalAttribute.prototype.customVType="numeric",CMDBuild.WidgetBuilders.DecimalAttribute.prototype.buildGridHeader=function(e){return{header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,flex:this.MAXWIDTH}},CMDBuild.WidgetBuilders.DecimalAttribute.prototype.buildAttributeField=function(e){return new Ext.form.TextField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,name:e.name,allowBlank:!e.isnotnull,width:CMDBuild.core.constants.FieldWidths.LABEL+this.MAXWIDTH,scale:e.scale,precision:e.precision,vtype:this.customVType,CMAttribute:e})},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.DoubleAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.DoubleAttribute,CMDBuild.WidgetBuilders.DecimalAttribute),CMDBuild.WidgetBuilders.DoubleAttribute.prototype.buildAttributeField=function(e){var t=CMDBuild.WidgetBuilders.DoubleAttribute.superclass.buildAttributeField(e);return t.scale=void 0,t.precision=void 0,t},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.IntegerAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.IntegerAttribute,CMDBuild.WidgetBuilders.DecimalAttribute),CMDBuild.WidgetBuilders.IntegerAttribute.prototype.buildAttributeField=function(e){var t=CMDBuild.WidgetBuilders.IntegerAttribute.superclass.buildAttributeField(e);return t.scale=0,t.precision=void 0,t},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.IPAddressAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.IPAddressAttribute,CMDBuild.WidgetBuilders.DecimalAttribute),CMDBuild.WidgetBuilders.IPAddressAttribute.prototype.MAXWIDTH=150,CMDBuild.WidgetBuilders.IPAddressAttribute.prototype.customVType="ipv4",CMDBuild.WidgetBuilders.IPAddressAttribute.prototype.getQueryOptions=function(){var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator;return[[e.EQUAL,CMDBuild.Translation.equals],[e.NOT_NULL,CMDBuild.Translation.isNotNull],[e.NET_CONTAINS,CMDBuild.Translation.contains],[e.NET_CONTAINED,CMDBuild.Translation.contained],[e.NET_CONTAINSOREQUAL,CMDBuild.Translation.containsorequal],[e.NET_CONTAINEDOREQUAL,CMDBuild.Translation.containedorequal],[e.NET_RELATION,CMDBuild.Translation.relation]]},CMDBuild.WidgetBuilders.IPAddressAttributeV6=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.IPAddressAttributeV6,CMDBuild.WidgetBuilders.IPAddressAttribute),CMDBuild.WidgetBuilders.IPAddressAttributeV6.prototype.customVType="ipv6",CMDBuild.WidgetBuilders.IPAddressAttributeV6.prototype.MAXWIDTH=300,Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.DateAttribute=function(){this.format="d/m/Y",this.fieldWidth=100,this.headerWidth=60},CMDBuild.extend(CMDBuild.WidgetBuilders.DateAttribute,CMDBuild.WidgetBuilders.RangeQueryAttribute),CMDBuild.WidgetBuilders.DateAttribute.prototype.buildGridHeader=function(e){return{header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,flex:this.headerWidth,format:this.format}},CMDBuild.WidgetBuilders.DateAttribute.prototype.buildAttributeField=function(e){return new Ext.form.DateField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,name:e.name,allowBlank:!e.isnotnull,format:this.format,width:CMDBuild.core.constants.FieldWidths.LABEL+this.fieldWidth,CMAttribute:e})},CMDBuild.WidgetBuilders.DateAttribute.prototype.buildFieldsetForFilter=function(e,t,i,n){var r,a=[],o=e.cloneConfig();if(o.hideLabel=!0,o.disable(),a.push(e,o),n){(r=Ext.create("Ext.container.Container",{layout:"hbox"})).add(this.buildValueTypeCombo()),this.date_fields=Ext.create("Ext.container.Container",{margins:"0 0 0 5",items:a}),r.add(this.date_fields);var s=[],l=new Ext.form.TextField({name:"expr_"+i.name,width:250,emptyText:"{function:foo(bar,baz)}",submitEmptyText:!1}),d=l.cloneConfig();d.hideLabel=!0,d.disable(),s.push(l,d),this.expression_fields=Ext.create("Ext.container.Container",{margins:"0 0 0 5",hidden:!0,items:s}),r.add(this.expression_fields)}else r=a;return this.genericBuildFieldsetForFilter(r,t,i,n)},CMDBuild.WidgetBuilders.DateAttribute.prototype.buildValueTypeCombo=function(){var e=this;return new Ext.form.ComboBox({hideLabel:!0,name:"filterTypeCombo",queryMode:"local",store:new Ext.data.ArrayStore({id:0,fields:["id","type"],data:[["fixed",CMDBuild.Translation.filterTypeNormal],["expression",CMDBuild.Translation.filterTypeExpression]]}),value:"fixed",valueField:"id",displayField:"type",triggerAction:"all",forceSelection:!0,listeners:{change:function(t,i,n,r){e.filterType=i,"expression"===i?(e.date_fields.hide(),e.expression_fields.show()):(e.date_fields.show(),e.expression_fields.hide())}}})},CMDBuild.WidgetBuilders.DateAttribute.prototype.buildOnConditionComboSelectStrategy=function(){return this.taskManager?new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.TaskDateStrategy(this.valueFields):new CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.DoubleStrategy(this.valueFields)},Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.TaskDateStrategy",{extend:"CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanel.SingleStrategy",constructor:function(e){this.callParent(arguments)},run:function(e){var t=this.needsFieldToSetAValue(e),i="between"!==e,n=this.valueFields.items.items[1].items.items,r=this.valueFields.items.items[2].items.items;n[0].setDisabled(t),n[1].setDisabled(t||i),r[0].setDisabled(t),r[1].setDisabled(t||i)}}),Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.DateTimeAttribute=function(){this.format="d/m/Y H:i:s",this.fieldWidth=150,this.headerWidth=100},CMDBuild.extend(CMDBuild.WidgetBuilders.DateTimeAttribute,CMDBuild.WidgetBuilders.DateAttribute),Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.TimeAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.TimeAttribute,CMDBuild.WidgetBuilders.DateAttribute),CMDBuild.WidgetBuilders.TimeAttribute.prototype.format="H:i:s",CMDBuild.WidgetBuilders.TimeAttribute.prototype.buildAttributeField=function(e){return new Ext.form.TextField({labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,labelAlign:"right",fieldLabel:e.description||e.name,name:e.name,allowBlank:!e.isnotnull,format:this.format,vtype:"time",width:CMDBuild.core.constants.FieldWidths.STANDARD_SMALL,CMAttribute:e})},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.BooleanAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.BooleanAttribute,CMDBuild.WidgetBuilders.SimpleQueryAttribute),CMDBuild.WidgetBuilders.BooleanAttribute.prototype.buildGridHeader=function(e){var t=9*e.name.length,i=new Ext.ux.CheckColumn({header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,width:t,cmReadOnly:!0});return Ext.isEmpty(e)||Ext.isEmpty(e.fieldmode)||"read"!=e.fieldmode||(i=new Ext.ux.CheckColumn({header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,width:t,cmReadOnly:!0,processEvent:Ext.emptyFn})),i},CMDBuild.WidgetBuilders.BooleanAttribute.prototype.buildReadOnlyField=function(e){var t=new Ext.form.BooleanDisplayField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description,name:e.name,disabled:!1,isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())}});return this.markAsRequired(t,e)},CMDBuild.WidgetBuilders.BooleanAttribute.prototype.buildAttributeField=function(e){return new Ext.ux.form.XCheckbox({labelAlign:"right",fieldLabel:e.description||e.name,labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,name:e.name,CMAttribute:e})},CMDBuild.WidgetBuilders.ComboAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.ComboAttribute,CMDBuild.WidgetBuilders.SimpleQueryAttribute),CMDBuild.WidgetBuilders.ComboAttribute.prototype.buildGridHeader=function(e){return{header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,flex:60}},CMDBuild.WidgetBuilders.ComboAttribute.prototype.buildReadOnlyField=function(e){var t=Ext.apply({},e);return t.name=e.name,CMDBuild.WidgetBuilders.ComboAttribute.superclass.buildReadOnlyField(t)},CMDBuild.WidgetBuilders.ComboAttribute.prototype.getQueryOptions=function(){var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator;return[[e.EQUAL,CMDBuild.Translation.equals],[e.NULL,CMDBuild.Translation.isNull],[e.NOT_NULL,CMDBuild.Translation.isNotNull],[e.NOT_EQUAL,CMDBuild.Translation.different]]},function(){function e(e){var t=this,i=this.getPosition();if(this.editingWindow){if(this.editingWindow.pos[0]==i[0]&&this.editingWindow.pos[1]==i[1])return;this.editingWindow.destroy(),delete this.editingWindow}var n=function(e){for(var t=CMDBuild.Management.FieldManager.getFieldForAttr(e,readOnly=!1),i=t.items.items,n=0,r=i.length;n<r;++n){var a=i[n];a.hideLabel=!0,a.padding="0 0 0 0"}return t}(e);this.editingWindow=new Ext.window.Window({pos:i,x:i[0],y:i[1],width:t.getWidth(),draggable:!1,closable:!1,items:[n],buttonAlign:"center",buttons:[{xtype:"button",text:CMDBuild.Translation.ok,handler:function(){var e,i=n.getValue(),r=n.getRawValue(),a=t.store.find(t.valueField,i);if(-1==a){var o={};o[t.displayField]=r,o[t.valueField]=i,e=t.store.add(o)[0]}else e=t.store.getAt(a);t.setValue(i),t.fireEvent("select",t,e),t.editingWindow.destroy(),delete t.editingWindow}},{xtype:"button",text:CMDBuild.Translation.cancel,handler:function(){t.editingWindow.destroy(),delete t.editingWindow}}]}).show()}Ext.require(["CMDBuild.core.Utils"]),Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.LookupAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.LookupAttribute,CMDBuild.WidgetBuilders.ComboAttribute),CMDBuild.WidgetBuilders.LookupAttribute.prototype.buildAttributeField=function(e){return CMDBuild.Management.LookupCombo.build(e)},CMDBuild.WidgetBuilders.LookupAttribute.prototype.markAsRequired=function(e,t){return e},CMDBuild.WidgetBuilders.LookupAttribute.prototype.buildReadOnlyField=function(e){var t=new Ext.form.DisplayField({allowBlank:!0,labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,width:CMDBuild.core.constants.FieldWidths.STANDARD_BIG,submitValue:!1,name:e.name,disabled:!1,isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())},getReadableValue:function(){return this.currentValue?this.currentValue.description:null},getValue:function(){return this.currentValue?this.currentValue.id:null}}),i=t.setValue;return t.setValue=function(n){if(!Ext.isEmpty(n)){this.currentValue=n;var r=_CMCache.getLookupStore(e.lookup);if(n.hasOwnProperty(CMDBuild.core.constants.Proxy.DESCRIPTION))n=n[CMDBuild.core.constants.Proxy.DESCRIPTION];else if(n.hasOwnProperty("Description"))n=n.Description;else if(n.hasOwnProperty(CMDBuild.core.constants.Proxy.ID)){var a=n[CMDBuild.core.constants.Proxy.ID];n=r.findRecord("Id",a).get("Description")}else if(n.hasOwnProperty("Id")){a=n.Id;n=r.findRecord("Id",a).get("Description")}else if("string"==typeof n&&!isNaN(parseInt(n))){a=parseInt(n);n=r.findRecord("Id",a).get("Description")}i.call(t,n)}},(e.isnotnull||"required"==e.fieldmode)&&(t.allowBlank=!1,t.fieldLabel&&(t.fieldLabel=CMDBuild.core.Utils.prependMandatoryLabel(t.fieldLabel))),t},CMDBuild.WidgetBuilders.LookupAttribute.prototype.buildCellEditor=function(t){var i=CMDBuild.Management.FieldManager.getFieldForAttr(t,readOnly=!1);if(i.isMultiLevel){var n=function(e){return new CMDBuild.view.common.field.CMErasableCombo({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.fieldLabel||e.name,labelSeparator:":",name:e.name,hiddenName:e.name,store:new Ext.data.Store({fields:["Id","Description"],data:[]}),queryMode:"local",triggerAction:"all",valueField:"Id",displayField:"Description",allowBlank:!0,CMAttribute:e})}(t);return n.on("focus",function(){e.call(this,t)},n),n}return i},CMDBuild.WidgetBuilders.LookupAttribute.prototype.genericBuildFieldsetForFilter=function(e,t,i,n){var r=t[0];if(r instanceof CMDBuild.field.MultiLevelLookupPanel){var a=new Ext.button.Button({iconCls:"delete",border:!1,padding:"3 0 0 3"}),o=new Ext.Panel({columnWidth:.2,html:"or",border:!1,bodyCls:"x-panel-body-default-framed"});r.columnWidth=.5,r.items.each(function(e){e.padding=0});return new Ext.panel.Panel({frame:!1,border:!1,bodyCls:"x-panel-body-default-framed",removeButton:a,fieldsetCategory:n,queryCombo:i,hideMode:"offsets",layout:{type:"hbox",pack:"start",align:"top"},defaults:{margins:"0 5 0 0"},items:[a,i,r,o],getAttributeField:function(){return t[0]},getQueryCombo:function(){return i},getOrPanel:function(){return o}})}return CMDBuild.WidgetBuilders.BaseAttribute.prototype.genericBuildFieldsetForFilter.apply(this,arguments)}}(),function(){function e(e,t){var i=_CMCache.getDomainById(e.idDomain),n=[];if(i)for(var r=i.data.attributes||[],a=0,o=null;a<r.length;++a)if((o=r[a]).isbasedsp){var s=Ext.apply({},o);s.name="_"+e.name+"_"+s.name;var l=CMDBuild.Management.FieldManager.getFieldForAttr(s,t);l.margin="0 0 0 5",l&&(l.cmDomainAttribute=!0,n.push(l))}return n}Ext.require(["CMDBuild.proxy.Card"]);var t=-1,i="* "+CMDBuild.Translation.loggedUser+" *",n="@MY_USER",r=-1,a="* "+CMDBuild.Translation.loggedGroup+" *",o="@MY_GROUP";Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.ReferenceAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.ReferenceAttribute,CMDBuild.WidgetBuilders.ComboAttribute),CMDBuild.WidgetBuilders.ReferenceAttribute.prototype.getFieldSetForFilter=function(e,s){var l=Ext.apply({},{fieldmode:"write",name:e.name,filter:!1,oneTime:!0},e),d=this.buildField(l,hideLabel=!0,skipSubAttributes=!0);!function(e,s){var l=null;if("User"==s.referencedClassName?l=new CMDBuild.cache.CMReferenceStoreModel({Id:t,Description:i}):"Role"==s.referencedClassName&&(l=new CMDBuild.cache.CMReferenceStoreModel({Id:r,Description:a})),!Ext.isEmpty(l)){var d=e.ensureToHaveTheValueInStore;e.ensureToHaveTheValueInStore=function(i){return i==t||i==t||d.call(e,i)};var u=e.setValue;e.setValue=function(i){return i==n?i=t:i==o&&(i=r),u.call(e,i)},e.getStore().on("load",function(t,i,n,r){t.sort("Description"),t.find("Id",-1)<0&&t.insert(0,l),t.sort=Ext.emptyFn,e.setValue(e.getValue())},this)}}(d,e);var u=this.getQueryCombo(l);return this.buildFieldsetForFilter(d,u,l,s)},CMDBuild.WidgetBuilders.ReferenceAttribute.prototype.buildField=function(e,t,i){var n=this.buildAttributeField(e,i);return n.hideLabel=t,Ext.isEmpty(n.mainField)?this.markAsRequired(n,e):this.markAsRequired(n.mainField,e),n},CMDBuild.WidgetBuilders.ReferenceAttribute.prototype.buildCellEditor=function(e){return CMDBuild.Management.FieldManager.getFieldForAttr(e,readOnly=!1,skipSubFields=!0)},CMDBuild.WidgetBuilders.ReferenceAttribute.prototype.buildAttributeField=function(t,i){var n=[];return i||(n=e(t,display=!1)),CMDBuild.Management.ReferenceField.build(t,n)},CMDBuild.WidgetBuilders.ReferenceAttribute.prototype.buildReadOnlyField=function(t){var i=new Ext.form.DisplayField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,width:CMDBuild.core.constants.FieldWidths.STANDARD_BIG,fieldLabel:t.description||t.name,submitValue:!1,name:t.name,disabled:!1,isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())},getReadableValue:function(){return this.currentValue?this.currentValue.description:null},getValue:function(){return this.currentValue?this.currentValue.id:null}}),n=e(t,display=!0),r=i.setValue;if(i.setValue=function(e){if(!Ext.isEmpty(e))if(this.currentValue=e,e.hasOwnProperty(CMDBuild.core.constants.Proxy.DESCRIPTION)?e=e[CMDBuild.core.constants.Proxy.DESCRIPTION]:e.hasOwnProperty("Description")?e=e.Description:e.hasOwnProperty(CMDBuild.core.constants.Proxy.ID)?e=e[CMDBuild.core.constants.Proxy.ID]:e.hasOwnProperty("Id")?e=e.Id:"string"!=typeof e||isNaN(parseInt(e))||(e=parseInt(e)),Ext.isNumber(e)&&!Ext.isEmpty(e)){var n={};n[CMDBuild.core.constants.Proxy.CARD_ID]=e,n[CMDBuild.core.constants.Proxy.CLASS_NAME]=t.referencedClassName,CMDBuild.proxy.Card.read({params:n,loadMask:!1,scope:this,success:function(e,t,n){n=n[CMDBuild.core.constants.Proxy.CARD],r.call(i,n.Description)}})}else r.call(i,e)},n.length>0){var a={xtype:"container",layout:"hbox",items:[new CMDBuild.field.CMToggleButtonToShowReferenceAttributes({subFields:n}),this.markAsRequired(i,t)]};return i.labelWidth-=20,new Ext.container.Container({items:[a].concat(n)})}return this.markAsRequired(i,t)}}(),Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.ForeignKeyAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.ForeignKeyAttribute,CMDBuild.WidgetBuilders.ComboAttribute),CMDBuild.WidgetBuilders.ForeignKeyAttribute.prototype.buildAttributeField=function(e){return CMDBuild.Management.ForeignKeyField.build(e)},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.StringAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.StringAttribute,CMDBuild.WidgetBuilders.TextualQueryAttribute),CMDBuild.WidgetBuilders.StringAttribute.prototype.MAXWIDTH=100,CMDBuild.WidgetBuilders.StringAttribute.prototype.buildGridHeader=function(e){var t=10*e.len;return t>this.MAXWIDTH&&(t=this.MAXWIDTH),{header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,flex:t,renderer:CMDBuild.Utils.Format.htmlEntityEncode}},CMDBuild.WidgetBuilders.StringAttribute.prototype.buildReadOnlyField=function(e){var t=new CMDBuild.view.common.field.CMDisplayField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,width:CMDBuild.core.constants.FieldWidths.STANDARD_BIG,submitValue:!1,name:e.name,disabled:!1,style:{overflow:"hidden"},isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())}});return this.markAsRequired(t,e)},CMDBuild.WidgetBuilders.StringAttribute.prototype.buildAttributeField=function(e){var t;return t=e.len>this.MAXWIDTH?new Ext.form.TextArea({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,name:e.name,allowBlank:!e.isnotnull,width:CMDBuild.core.constants.FieldWidths.STANDARD_BIG}):new Ext.form.TextField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,name:e.name,maxLength:e.len,allowBlank:!e.isnotnull,width:CMDBuild.core.constants.FieldWidths.LABEL+function(e){return(e=13*e+12)<CMDBuild.core.constants.FieldWidths.STANDARD_BIG_FIELD_ONLY?e:CMDBuild.core.constants.FieldWidths.STANDARD_BIG_FIELD_ONLY}(e.len)}),this.customVType&&(t.vtype=this.customVType),t.CMAttribute=e,t},CMDBuild.WidgetBuilders.StringAttribute.prototype.buildCellEditor=function(e){return new Ext.form.TextField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:e.description||e.name,name:e.name,maxLength:e.len,allowBlank:!e.isnotnull})},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.CharAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.CharAttribute,CMDBuild.WidgetBuilders.StringAttribute),CMDBuild.WidgetBuilders.CharAttribute.prototype.buildAttributeField=function(e){var t=Ext.apply({},e);return t.len=1,CMDBuild.WidgetBuilders.CharAttribute.superclass.buildAttributeField(t)},function(){var e="Id";Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.CustomListAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.CustomListAttribute,CMDBuild.WidgetBuilders.ComboAttribute),CMDBuild.WidgetBuilders.CustomListAttribute.prototype.buildAttributeField=function(t){return new CMDBuild.view.common.field.CMErasableCombo({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:t.description||t.name,labelSeparator:":",name:t.name,hiddenName:t.name,store:new Ext.data.Store({fields:[e],data:function(t){for(var i=[],n=t||[],r=0;r<n.length;++r){var a={};a[e]=n[r],i.push(a)}return i}(t.values)}),queryMode:"local",triggerAction:"all",valueField:e,displayField:e,allowBlank:!t.isnotnull,CMAttribute:t})}}(),TEXT_EDITOR_TYPE={plain:"PLAIN",html:"HTML"},Ext.ns("CMDBuild.WidgetBuilders"),CMDBuild.WidgetBuilders.TextAttribute=function(){},CMDBuild.extend(CMDBuild.WidgetBuilders.TextAttribute,CMDBuild.WidgetBuilders.StringAttribute),CMDBuild.WidgetBuilders.TextAttribute.prototype.buildAttributeField=function(e){if(e.editorType!=TEXT_EDITOR_TYPE.html){var t=Ext.apply({},e);return t.len=this.MAXWIDTH+1,CMDBuild.WidgetBuilders.TextAttribute.superclass.buildAttributeField(t)}return Ext.create("CMDBuild.view.common.field.HtmlEditor",{labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,width:CMDBuild.core.constants.FieldWidths.EDITOR_HTML,fieldLabel:e.description||e.name,name:e.name,disabled:!1,CMAttribute:e})},CMDBuild.WidgetBuilders.StringAttribute.prototype.buildGridHeader=function(e){var t=10*e.len;return t>this.MAXWIDTH&&(t=this.MAXWIDTH),{header:e.description,sortable:!0,dataIndex:e.name,hidden:!e.isbasedsp,flex:t,renderer:"stripTags"}},Ext.define("CMDBuild.view.common.field.CMBaseCombo",{extend:"Ext.form.field.ComboBox",alias:"cmbasecombo",uses:["CMDBuild.core.constants.FieldWidths"],cmGreatestItem:"",initComponent:function(){Ext.applyIf(this,{maxWidth:CMDBuild.core.constants.FieldWidths.STANDARD_BIG}),this.callParent(arguments),this.mon(this.store,"load",function(e,t,i,n){n&&n.add?this._growSizeFix(t||[]):this._growSizeFix()},this),this.mon(this.store,"add",function(e,t){this._growSizeFix(t||[])},this),this.mon(this,"render",function(){this._growSizeFix()},this),this.mon(this,"focus",function(){this._growSizeFixFail&&this._growSizeFix()},this),this.on("blur",function(){this.clearStoreFilteringInSafeMode()},this)},_growSizeFix:function(e){if(this.isVisible(deep=!0)){for(var t,i=e||this.store.getRange(),n=0,r=i.length;n<r;++n)t=i[n].get(this.displayField),this.setGreatestItem(t);this.setSizeLookingTheGreatestItem(),this._growSizeFixFail=!1}else this._growSizeFixFail=!0},setGreatestItem:function(e){this.cmGreatestItem.length<e.length&&(this.cmGreatestItem=e)},getReadableValue:function(){return this.getRawValue()},setSizeLookingTheGreatestItem:function(){if(this.cmGreatestItem&&this.bodyEl){var e=new Ext.util.TextMetrics,t=e.getWidth(this.cmGreatestItem)+"px";this.bodyEl.dom.firstChild.style.width=t,this.bodyEl.dom.style.width=t;var i=e.getWidth(this.cmGreatestItem);this.labelEl&&(i+=this.labelEl.dom.clientWidth);var n=i+this.getTriggersLength()+20;this.setWidth(n),e.destroy()}},getTriggersLength:function(){try{return 20*this.triggerEl.elements.length}catch(e){return 0}},setValue:function(e){this.callParent([this.extractIdIfValueIsObject(e)])},extractIdIfValueIsObject:function(e){return null==e||"object"!=typeof e||Ext.isArray(e)||(e=e[CMDBuild.core.constants.Proxy.ID]),"string"!=typeof e||isNaN(parseInt(e))||(e=parseInt(e)),e},onKeyUp:function(e,t){if(e.isNavKeyPress())return this.callParent(arguments);return""==this.getRawValue()?this.clearStoreFilteringInSafeMode():this.callParent(arguments)},clearStoreFilteringInSafeMode:function(){var e=this.getStore();this.queryFilter.setValue(""),e.filter()}}),Ext.define("CMDBuild.view.common.field.CMErasableCombo",{extend:"CMDBuild.view.common.field.CMBaseCombo",alias:"cmerasablecombo",trigger1cls:Ext.form.field.ComboBox.triggerCls,trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",hideTrigger1:!1,hideTrigger2:!1,onTrigger1Click:Ext.form.field.ComboBox.prototype.onTriggerClick,onTrigger2Click:function(){this.disabled||this.setValue([""])}}),Ext.define("CMDBuild.view.common.field.CMGroupSelectionList",{extend:"Ext.ux.form.MultiSelect",uses:["CMDBuild.proxy.common.field.multiselect.Group"],considerAsFieldToDisable:!0,fieldLabel:CMDBuild.Translation.enabledGroups,name:CMDBuild.core.constants.Proxy.GROUPS,dataFields:[CMDBuild.core.constants.Proxy.NAME,CMDBuild.core.constants.Proxy.ID,CMDBuild.core.constants.Proxy.DESCRIPTION],valueField:CMDBuild.core.constants.Proxy.ID,displayField:CMDBuild.core.constants.Proxy.DESCRIPTION,allowBlank:!0,initComponent:function(){Ext.applyIf(this,{store:CMDBuild.proxy.common.field.multiselect.Group.getStore()}),this.callParent(arguments)},updateReadOnly:Ext.emptyFn,reset:function(){this.setValue([])},selectAll:function(){var e=[];this.store.data.each(function(t,i,n){e.push(t.data.name)}),this.setValue(e)}}),function(){function e(e){return!t[e.type]}var t={BOOLEAN:new CMDBuild.WidgetBuilders.BooleanAttribute,DECIMAL:new CMDBuild.WidgetBuilders.DecimalAttribute,INTEGER:new CMDBuild.WidgetBuilders.IntegerAttribute,DOUBLE:new CMDBuild.WidgetBuilders.DoubleAttribute,DATE:new CMDBuild.WidgetBuilders.DateAttribute,TIMESTAMP:new CMDBuild.WidgetBuilders.DateTimeAttribute,TIME:new CMDBuild.WidgetBuilders.TimeAttribute,LOOKUP:new CMDBuild.WidgetBuilders.LookupAttribute,REFERENCE:new CMDBuild.WidgetBuilders.ReferenceAttribute,FOREIGNKEY:new CMDBuild.WidgetBuilders.ForeignKeyAttribute,STRING:new CMDBuild.WidgetBuilders.StringAttribute,TEXT:new CMDBuild.WidgetBuilders.TextAttribute,CHAR:new CMDBuild.WidgetBuilders.CharAttribute,INET:new CMDBuild.WidgetBuilders.IPAddressAttribute,INETV6:new CMDBuild.WidgetBuilders.IPAddressAttributeV6,LIST:new CMDBuild.WidgetBuilders.CustomListAttribute};Ext.define("CMDBuild.Management.FieldManager",{statics:{loadAttributes:function(e,t){_CMCache.getAttributeList(e,t)},getAttributesMap:function(){return t},getFieldForAttr:function(i,n,r){if("hidden"!=i.fieldmode&&!e(i)){if(n||"read"==i.fieldmode)return t[i.type].buildReadOnlyField(i);if("INET"==i.type){console.log("attribute.type == 'INET'",i);var a="ipv6"==i.ipType?"INETV6":"INET";return t[a].buildField(i,hideLabel=void 0,r)}return t[i.type].buildField(i,hideLabel=void 0,r)}},getHeaderForAttr:function(i){return"hidden"==i.fieldmode||e(i)?void 0:t[i.type].buildGridHeader(i)},getFieldSetForFilter:function(i,n){if(!e(i))return t[i.type].getFieldSetForFilter(i,n)},getCellEditorForAttribute:function(i){if(!e(i))return t[i.type].buildCellEditor(i)}}})}(),Ext.define("Ext.form.BooleanDisplayField",{extend:"Ext.form.DisplayField",setRawValue:function(e){this.rendered&&(e=(e=CMDBuild.core.Utils.decodeAsBoolean(e))?Ext.MessageBox.buttonText.yes:Ext.MessageBox.buttonText.no,this.htmlEncode&&(e=Ext.util.Format.htmlEncode(e))),this.callParent([e])}}),function(){Ext.form.field.Display.override({allowBlank:!0,setValue:function(e){null!=e&&"object"==typeof e&&(e=e.description),this.callOverridden([e]),this._addTargetToLinks()},_addTargetToLinks:function(){var e=this.getContentTarget();if(e){var t=Ext.DomQuery.select("a",e.dom);if(t)for(var i=0,n=t.length;i<n;++i)t[i].target="_blank"}},isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())}}),Ext.define("CMDBuild.view.common.field.CMDisplayField",{extend:"Ext.form.field.Display",allowBlank:!0,constructor:function(){this.callParent(arguments),this.expandButtonMarkup=Ext.DomHelper.markup({tag:"div",cls:"cmdisplayfield-expandbutton"})},setValue:function(){this.hideExpandButton(),this.rendered&&this.inputEl&&this.inputEl.setHeight("auto"),this.callParent(arguments),this.rendered&&this.getHeight()>100&&(this.showExpandButton(),this.inputEl&&this.inputEl.setHeight(100))},showExpandButton:function(){var e=this.inputEl;e&&!this.expandButtonEl&&(this.expandButtonEl=Ext.DomHelper.insertBefore(e,this.expandButtonMarkup,returnElement=!0),function(e,t){e.mon(t,"click",function(){var t=new Ext.form.field.Display({xtype:"displayfield",hideLabel:!0,margin:"8 10"}),i=Ext.create("CMDBuild.core.window.AbstractModal",{title:e.fieldLabel,items:[{xtype:"container",region:"center",items:[t]}],buttonAlign:"center",autoScroll:!0,buttons:[{text:CMDBuild.Translation.close,handler:function(){i.destroy()}}]}).show();t.setValue(e.getValue())})}(this,this.expandButtonEl)),this.expandButtonEl.show()},hideExpandButton:function(){this.expandButtonEl&&this.expandButtonEl.hide()},isValid:function(){return!!this.allowBlank||!Ext.isEmpty(this.getValue())}})}(),Ext.define("CMDBuild.view.common.field.HtmlEditor",{extend:"Ext.ux.form.field.TinyMCE",uses:["CMDBuild.core.Utils"],customConfigurations:{common:{skin:"extjs",skin_variant:"silver",schema:"html5",language:"en",theme_advanced_row_height:27,delta_height:1,width:"100%",theme_advanced_resizing:!1,theme_advanced_resize_horizontal:!1,relative_urls:!1,convert_urls:!1},full:{theme:"advanced",plugins:"autolink,lists,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template,wordcount,advlist",theme_advanced_buttons1:"save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,styleselect,formatselect,fontselect,fontsizeselect",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute,|,styleprops,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,pagebreak,restoredraft",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"none"},standard:{theme:"advanced",plugins:"autolink,paste,fullscreen",theme_advanced_buttons1:"bold,italic,underline,|,fontsizeselect,|,forecolor,backcolor,|,justifyleft,justifycenter,justifyright,justifyfull,|,link,unlink,|,bullist,numlist,|,pastetext,pasteword,|,cleanup,removeformat,|,fullscreen,|,code",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"none"}},dirty:!1,tinyMCEConfig:"standard",considerAsFieldToDisable:!0,minHeight:150,initComponent:function(){(Ext.isEmpty(this.tinyMCEConfig)||Ext.isString(this.tinyMCEConfig)||!Ext.Array.contains(["full","standard"],this.tinyMCEConfig))&&(this.tinyMCEConfig="standard"),this.tinyMCEConfig=Ext.Object.merge(this.customConfigurations.common,this.customConfigurations[this.tinyMCEConfig]);var e=CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.LANGUAGE).split("_");this.tinyMCEConfig.language=e.length>1?e[0]:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.LANGUAGE),Ext.isEmpty(CMDBuild.core.Management)&&(this.tinyMCEConfig.popup_css="javascripts/ext-"+CMDBuild.core.Utils.getExtJsVersion()+"-ux/form/field/tinymce/themes/advanced/skins/extjs/dialog_silver.css"),Ext.isEmpty(CMDBuild.core.Administration)&&(this.tinyMCEConfig.skin_variant="blue"),this.callParent(arguments),this.on("change",function(e,t,i,n){this.setDirty()},this)},initValue:function(){this.dirty=!1},isDirty:function(){if(!Ext.isEmpty(this.getEditor()))try{return this.getEditor().isDirty()||this.dirty}catch(e){}return!1},setDirty:function(){this.dirty=!0},suspendEvents:Ext.emptyFn}),function(){function e(e){return!("required"==e.fieldmode||e.isnotnull)}Ext.define("CMDBuild.view.common.field.LookupField",{uses:["CMDBuild.proxy.Cache"],extend:"CMDBuild.view.common.field.CMErasableCombo",plugins:new CMDBuild.SetValueOnLoadPlugin,parentId:"",initComponent:function(){this.callParent(arguments),this.mon(this,"focus",function(){this._growSizeFixFail&&this._growSizeFix(),this.filterStoreByParentId()},this)},getErrors:function(e){return Ext.isEmpty(e)||Ext.isEmpty(this.getStore())||-1!=this.getStore().find(this.valueField,this.getValue())?this.callParent(arguments):[CMDBuild.Translation.errors.invalidLookupValue]},getValue:function(){var e=this.callParent(arguments);return Ext.isNumber(e)?e:""},setValue:function(e){this.callParent(arguments),this.validate()},onTrigger2Click:function(){this.disabled||(this.focus(),this.chainedClear())},chainedClear:function(){this.setValue([""]),this.childField&&(this.childField.setParentIdAndFilterStore(void 0),this.childField.chainedClear())},setValueAndUpdateParents:function(e){if(this.store){if(""==e||void 0===e)this.clearValue(),this.setParentIdAndFilterStore(void 0);else{this.store.clearFilter(),this.setValue(e);var t=this.store.find("Id",e),i=this.store.getAt(t);i?this.setParentIdAndFilterStore(i.get("ParentId")):this.setParentIdAndFilterStore(void 0),this.validate()}this.parentField&&this.parentField.setValueAndUpdateParents(this.parentId)}else _error("Lookup without store")},setParentIdAndFilterStore:function(e){this.parentId!=e&&(this.parentId=e,this.filterStoreByParentId())},filterStoreByParentId:function(){var e=this.parentId||"";this.store.filterBy(function(t,i){return t.get("ParentId")==e})}}),Ext.define("CMDBuild.field.MultiLevelLookupPanel",{uses:["CMDBuild.proxy.Cache"],extend:"Ext.panel.Panel",hiddenField:void 0,initComponent:function(){if(!this.hiddenField)throw"Error in MultiLevelLookup, hiddenField or CMAttribute is missing";this.items=this.items||[],this.items.push(this.hiddenField),this.callParent(arguments)},border:!1,frame:!1,autoHeight:!0,hideMode:"offsets",labelWidth:150,bodyCls:"x-panel-default-framed",isMultiLevel:!0,bodyStyle:{padding:"0"},setValue:function(e){this.hiddenField.setValue(e)},getValue:function(){return this.hiddenField.getValue()},isValid:function(){return this.hiddenField.isValid()},getRawValue:function(){var e="";return this.items.each(function(t,i){t!==this.hiddenField&&(i>0&&(e+=" - "),e+=t.getRawValue())}),e}}),Ext.define("CMDBuild.Management.LookupCombo",{uses:["CMDBuild.proxy.Cache"],statics:{build:function(i){var r;if(0==i.lookupchain.length)(r=n(i)).isMultiLevel=!1;else if(1==i.lookupchain.length)(r=n(i)).isMultiLevel=!1;else{var a=function(t){return new CMDBuild.Management.LookupHiddenField({CMAttribute:t,name:t.name,allowBlank:e(t),value:null})}(i);r=new CMDBuild.field.MultiLevelLookupPanel({items:t(i,a),hiddenField:a,name:i.name})}return r}}}),Ext.define("CMDBuild.Management.LookupHiddenField",{uses:["CMDBuild.proxy.Cache"],extend:"Ext.form.Hidden",updateParentsIfLoaded:function(){var e=this.getValue();e&&(e=parseInt(e)),this.lastCombo&&this.lastCombo.setValueAndUpdateParents(e)},filterByParentId:function(e){this.setValueAndFireChange(e)},chainedClear:function(){this.setValueAndFireChange("")},setValueAndFireChange:function(e){var t=this.getValue()||"";t!=e&&(this.setValue(e,!0),this.fireEvent("change",this,e,t),this.fireEvent("blur",this))},setValue:function(e,t){null!=e&&"object"==typeof e&&(e=e.id),this.callParent([e]),t||this.updateParentsIfLoaded()},setParentIdAndFilterStore:Ext.emptyFn});var t=function(e,t){var o,s,l,d=e.lookupchain,u=[],c=null;for(o=0,s=d.length;o<s;++o){var h=d[s-o-1],m=r(e,h);(l=n(m,0!=o)).submitValue=!1,c&&(l.parentField=c,c.childField=l),u.push(l),a(l,c),c=l}for(i(t,l),o=0,s=u.length;o<s;++o){var f=l.store;l=u[o],f.mon(f,"load",function(){t.updateParentsIfLoaded()})}return u},i=function(e,t){e.lastCombo=t,t.childField=e,e.getReadableValue=function(){return t.getRawValue()}},n=function(t,i){var n,r,a;i?(n="",r="",a="0 0 0 "+(CMDBuild.core.constants.FieldWidths.LABEL+5)):(n=t.description||t.name,e(t)||(n="* "+n),r=":");var o=new CMDBuild.view.common.field.LookupField({labelAlign:"right",labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,fieldLabel:n,labelSeparator:r,padding:a,name:t.name,hiddenName:t.name,store:CMDBuild.proxy.Cache.getStoreLookup(t.lookup),queryMode:"local",triggerAction:"all",lazyInit:!1,valueField:"Id",displayField:"Description",allowBlank:e(t),minChars:1,CMAttribute:t});return o.filterByParentId=function(e){var t;if(this.setParentIdAndFilterStore(e),1==this.store.getCount()){t=this.store.getAt(0).get("Id"),this.setValue(t)}else this.clearValue();this.childField&&this.childField.filterByParentId(t)},o.on("select",function(e,t,i){this.childField&&this.childField.filterByParentId(t[0].get("Id"))},o),o},r=function(e,t){return{lookup:t,isnotnull:e.isnotnull,fieldmode:e.fieldmode,description:e.description,name:e.name+"_"+t}},a=function(e,t){t&&e.on("beforequery",function(e){e.combo.lastQuery=e.query})}}(),function(){function e(e,t){var i=null;try{i=e.proxy.extraParams.filter}catch(e){}(i=i?Ext.decode(i):{}).query=t,e.proxy.extraParams.filter=Ext.encode(i),e.loadPage(1)}Ext.define("CMDBuild.field.GridSearchField",{extend:"Ext.form.field.Trigger",trigger1Cls:Ext.baseCSSPrefix+"form-search-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",validationEvent:!1,validateOnBlur:!1,hideTrigger1:!1,hideTrigger2:!1,initComponent:function(){this.callParent(arguments),this.on("specialkey",function(e,t){t.getKey()==t.ENTER&&this.onTrigger1Click()},this)},onTrigger1Click:function(){e(this.grid.getStore(),this.getRawValue())},onTrigger2Click:function(e){this.disabled||this.reset()},onUnapplyFilter:function(){this.setValue("")},reset:function(){this.setValue("");e(this.grid.getStore(),this.getRawValue())}})}(),Ext.define("CMDBuild.field.LocaleSearchField",{extend:"CMDBuild.field.GridSearchField",onTrigger1Click:function(){var e=this.getRawValue().toUpperCase();this.grid.getStore().filterBy(function(t,i){for(var n in t.data){if(-1!=(t.data[n]+"").toUpperCase().search(e))return!0}return!1})}}),function(){function e(){this.setValue([""])}Ext.define("CMDBuild.view.common.field.SearchableCombo",{extend:"CMDBuild.view.common.field.CMBaseCombo",uses:["CMDBuild.proxy.Card"],trigger1Cls:Ext.baseCSSPrefix+"form-arrow-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",trigger3Cls:Ext.baseCSSPrefix+"form-search-trigger",hideTrigger1:!1,hideTrigger2:!1,hideTrigger3:!1,gridExtraConfig:{},searchWindowReadOnly:!1,initComponent:function(){this.labelAlign="right",this.callParent(arguments)},searchWindow:null,onTrigger1Click:function(){function e(){this.storeIsLargerThenLimit()?this.onTrigger3Click():this.onTriggerClick()}this.store.isLoading()?this.store.on("load",e,this,{single:!0}):e.call(this)},onTrigger2Click:function(){this.disabled||(e.call(this),this.focus(),this.blur())},onTrigger3Click:function(e){"string"!=typeof e&&(e=""),this.createSearchWindow(e)},storeIsLargerThenLimit:function(){return null!==this.store&&this.store.getTotalCount()>CMDBuild.configuration.instance.get("referenceComboStoreLimit")},createSearchWindow:function(e){if(!this.disabled&&!this.searchWindow){var t=Ext.Function.bind(this.buildSearchWindow,this,[this.store.baseParams,e],!0),i=this.store.baseParams.IdClass;if(!i){var n=this.store.baseParams.className;if(n){var r=_CMCache.getEntryTypeByName(n);r&&(i=r.get("id"))}}i&&CMDBuild.Management.FieldManager.loadAttributes(i,t)}},buildSearchWindow:function(e,t,i){var n=Ext.apply({},t);delete n.NoFilter,this.searchWindow=new CMDBuild.Management.ReferenceSearchWindow({ClassName:this.store.baseParams.className,selModel:new CMDBuild.selection.CMMultiPageSelectionModel({mode:"SINGLE",idProperty:"Id"}),extraParams:n,gridConfig:this.gridExtraConfig||{},readOnly:this.searchWindowReadOnly,searchFieldValue:i}),this.searchWindow.on("cmdbuild-referencewindow-selected",function(e){this.addToStoreIfNotInIt(e),this.focus(),this.setValue(e.get("Id")),this.fireEvent("cmdbuild-reference-selected",e,this)},this),this.searchWindow.on("close",function(){this.searchWindow&&(this.searchWindow.destroy(),delete this.searchWindow)},this),this.searchWindow.on("destroy",function(){this.searchWindow&&delete this.searchWindow},this),this.searchWindow.show()},addToStoreIfNotInIt:function(e){var t=e.get("Id");if(this.getStore()&&-1==this.getStore().find("Id",t)){var i=Ext.apply({cardId:t},this.getStore().baseParams);CMDBuild.proxy.Card.read({params:i,loadMask:!1,scope:this,success:function(e,i,n){-1==this.getStore().find("Id",t)&&this.getStore().add({Id:t,Description:n.card.Description}),this.setValue(t),this.validate()}})}},recordDescriptionFixedForCarriageReturnBugOnComboBoxes:function(e){try{return e.get("Description").replace(/\n/g," ")}catch(e){_error("CMDBuild.view.common.field.SearchableCombo recordDescriptionFixedForCarriageReturnBugOnComboBoxes error",e)}},onKeyUp:function(){this.storeIsLargerThenLimit()?this.onTrigger3Click(this.getRawValue()):this.callParent(arguments)},reset:e})}(),Ext.define("CMDBuild.field.CMToggleButtonToShowReferenceAttributes",{extend:"Ext.button.Button",subFields:[],enableToggle:!0,iconCls:"down",cls:"clearButtonBGandBorder",initComponent:function(){for(var e=0,t=null;e<this.subFields.length;++e)(t=this.subFields[e])&&t.hide()},listeners:{toggle:function(e,t){t?e.setIconCls("up-hover"):e.setIconCls("down-hover");for(var i=0,n=null;i<e.subFields.length;++i)(n=e.subFields[i])&&n.setVisible(t)},mouseover:function(e){"down"==e.iconCls?e.setIconCls("down-hover"):e.setIconCls("up-hover")},mouseout:function(e){"down-hover"==e.iconCls?e.setIconCls("down"):e.setIconCls("up")}}}),function(){function e(e){return e.findParentByType("form")}var t="_SystemFieldFilter";Ext.define("CMDBuild.Management.ReferenceField",{uses:["CMDBuild.proxy.Card"],statics:{build:function(i,n,r){var a;r=r||{};if(i.filter){var o=CMDBuild.Utils.Metadata.extractMetaByNS(i.meta,"system.template.");o[t]=i.filter,a=new CMDBuild.Management.TemplateResolver({getBasicForm:function(){if(!Ext.isEmpty(e(s)))return e(s).getForm()},xaVars:o})}var s=Ext.create("CMDBuild.Management.ReferenceField.Field",Ext.applyIf(r,{attribute:i,templateResolver:a}));return n&&n.length>0?function(e,t){e.on("change",function(e,i,n,r){Ext.Function.defer(function(e){!Ext.isEmpty(t)&&Ext.isArray(t)&&Ext.Array.each(t,function(t,i,n){!Ext.isEmpty(t)&&t.rendered&&t.setDisabled(Ext.isEmpty(e.getValue()))},this)},100,this,[e])},this);var i={xtype:"container",layout:"hbox",margin:"0 0 5 0",items:[Ext.create("CMDBuild.field.CMToggleButtonToShowReferenceAttributes",{subFields:t}),e]};return e.labelWidth-=20,Ext.create("Ext.container.Container",{margin:"0 0 5 0",mainField:e,items:[i].concat(t),resolveTemplate:function(t){e.resolveTemplate(t)}})}(s,n):s},buildEditor:function(e,t,i){return t=t||null,Ext.create("CMDBuild.Management.ReferenceField.Field",{parentDelegate:i,attribute:e,templateResolver:t,_growSizeFix:Ext.emptyFn})}}}),Ext.define("CMDBuild.Management.ReferenceField.Field",{extend:"CMDBuild.view.common.field.SearchableCombo",uses:["CMDBuild.proxy.Card"],mixins:{observable:"Ext.util.Observable"},parentDelegate:void 0,attribute:void 0,initComponent:function(){var e=this.attribute,t=_CMCache.getReferenceStore(e);t.on("loadexception",function(){field.setValue("")}),Ext.apply(this,{fieldLabel:e.description||e.name,labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,name:e.name,store:t,queryMode:"local",valueField:"Id",displayField:"Description",allowBlank:!e.isnotnull,grow:!0,minChars:1,filtered:!1,CMAttribute:e,listConfig:{loadMask:!1}}),this.callParent(arguments)},listeners:{beforerender:function(e,t){e.getStore().load({scope:this,callback:function(t,i,n){Ext.isEmpty(e.getStore())||Ext.isEmpty(this.attribute)||Ext.isEmpty(this.attribute.meta)||"true"!==this.attribute.meta["system.type.reference."+CMDBuild.core.constants.Proxy.PRESELECT_IF_UNIQUE]||1!=e.getStore().getCount()||e.setValue(t[0].get("Id"))}})}},getErrors:function(e){return Ext.isEmpty(e)||Ext.isEmpty(this.getStore())||-1!=this.getStore().find(this.valueField,this.getValue())?this.callParent(arguments):[CMDBuild.Translation.errors.valueDoesNotMatchFilter]},getValue:function(){var e=this.callParent(arguments);return Ext.isNumber(e)?e:""},setValue:function(e){Ext.isEmpty(this.getStore())||(e=this.extractIdIfValueIsObject(e),Ext.isEmpty(this.attribute)||Ext.isEmpty(this.attribute.meta)||"true"!==this.attribute.meta["system.type.reference."+CMDBuild.core.constants.Proxy.PRESELECT_IF_UNIQUE]||1!=this.getStore().getCount()||(e=this.getStore().getAt(0).get("Id")),(this.ensureToHaveTheValueInStore(e)||this.store.isOneTime)&&this.callParent([e]),this.validate())},ensureToHaveTheValueInStore:function(e){if(e=function(e,t){return(t=CMDBuild.Utils.getFirstSelection(t))&&"object"==typeof t&&"function"==typeof t.get&&(t=t.get(e.valueField)),t}(this,e),!(Ext.isEmpty(e)||this.store.isLoading()||-1!=this.getStore().find(this.valueField,e)||Ext.isEmpty(this.attribute)||Ext.isEmpty(this.attribute.meta))){var t=Ext.apply({cardId:e},this.getStore().baseParams);return CMDBuild.proxy.Card.read({params:t,loadMask:!1,scope:this,success:function(t,i,n){Ext.isEmpty(this.getStore())||-1!=this.getStore().find(this.valueField,e)||this.getStore().add({Id:e,Description:n.card.Description}),this.setValue(e),Ext.isEmpty(this.parentDelegate)||Ext.isEmpty(this.parentDelegate.view)||!this.parentDelegate.view.getView().isVisible()||this.parentDelegate.view.getView().refresh()}}),!1}return!0},resolveTemplate:function(e){(e=Ext.isObject(e)?e:{}).scope=Ext.isObject(e.scope)?e.scope:this,!Ext.isObject(this.templateResolver)||Ext.Object.isEmpty(this.templateResolver)||this.isDisabled()?Ext.isFunction(e.callback)&&Ext.callback(e.callback,e.scope):(Ext.isFunction(e.callback)&&(this.regenerationCallbackParameters=Ext.clone(e)),this.templateResolver.resolveTemplates({attributes:[t],scope:this,callback:function(i,n){var r=this.templateResolver.buildCQLQueryParameters(i[t]);if(this.filtered=!0,Ext.isObject(r)&&!Ext.Object.isEmpty(r))this.getStore().baseParams.filter=Ext.encode({CQL:r.CQL}),this.getStore().load({scope:this,callback:function(e,t,i){Ext.isEmpty(this.getStore())||Ext.isEmpty(this.attribute)||Ext.isEmpty(this.attribute.meta)||"true"!==this.attribute.meta["system.type.reference."+CMDBuild.core.constants.Proxy.PRESELECT_IF_UNIQUE]||1!=this.getStore().getCount()||this.setValue(e[0].get("Id")),this.addListenerToDeps(),Ext.isObject(this.regenerationCallbackParameters)&&!Ext.isEmpty(this.regenerationCallbackParameters)&&Ext.isFunction(this.regenerationCallbackParameters.callback)&&(Ext.callback(this.regenerationCallbackParameters.callback,this.regenerationCallbackParameters.scope),delete this.regenerationCallbackParameters)}});else{var a={};a[this.getStore().root]=[],a[this.getStore().totalProperty]=0,this.getStore().loadData(a),this.addListenerToDeps(),Ext.isFunction(e.callback)&&(Ext.callback(e.callback,e.scope),delete this.regenerationCallbackParameters)}}}))},addListenerToDeps:function(){Ext.isObject(this.templateResolver)&&!Ext.Object.isEmpty(this.templateResolver)&&Ext.Object.each(this.templateResolver.getLocalDepsAsField(),function(e,t,i){Ext.isObject(t)&&!Ext.Object.isEmpty(t)&&Ext.isFunction(t.resumeEvents)&&Ext.isFunction(t.un)&&Ext.isFunction(t.on)&&(t.hasListener("change")&&t.un("change",this.depsChangeEventManager,this),t.on("change",this.depsChangeEventManager,this))},this)},depsChangeEventManager:function(e,t,i,n){this.reset(),this.resolveTemplate()},isFiltered:function(){return void 0!==this.templateResolver},setServerVarsForTemplate:function(e){this.templateResolver&&(this.templateResolver.serverVars=e)}})}(),CMDBuild.Management.ForeignKeyField={build:function(e){var t=_CMCache.getForeignKeyStore(e);return new CMDBuild.view.common.field.SearchableCombo({plugins:new CMDBuild.SetValueOnLoadPlugin,fieldLabel:e.description,labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,name:e.name,store:t,queryMode:"local",valueField:"Id",displayField:"Description",triggerAction:"all",allowBlank:!e.isnotnull,grow:!0,minChars:1,filtered:!1,CMAttribute:e})}},Ext.define("CMDBuild.view.common.CMUnconfiguredModPanel",{extend:"Ext.panel.Panel",cls:"cmdbuild_unconfigured_modpanel",bodyStyle:{"padding-top":"5em"},frame:!1,border:!1}),Ext.define("CMDBUild.view.common.CMFormFunctions",{enableCMButtons:function(){this.iterateOverCMButtons(function(e){e&&e.enable&&e.enable()})},disableCMButtons:function(){this.iterateOverCMButtons(function(e){e&&e.disable&&e.disable()})},disableCMTbar:function(){this.iterateOverCMTBar(function(e){e&&e.disable&&e.disable()})},disableFields:function(){this.cascade(function(e){e&&(e instanceof Ext.form.Field||e instanceof Ext.form.FieldSet||e.considerAsFieldToDisable)&&e.disable()})},disableModify:function(e){this._cmEditMode=!1,this.disableFields(),this.disableCMButtons(),e?this.enableCMTbar():this.disableCMTbar()},enableCMTbar:function(){this.iterateOverCMTBar(function(e){e&&e.enable&&!e.disabledForGroup&&e.enable()})},enableModify:function(e){this._cmEditMode=!0,this.enableFields(e),this.disableCMTbar(),this.enableCMButtons()},enableTabbedModify:function(e){this._cmEditMode=!0,this.enableTabbedFields(e),this.disableCMTbar(),this.enableCMButtons()},enableFields:function(e){this.cascade(function(t){if(t&&(t instanceof Ext.form.Field||t instanceof Ext.form.FieldSet||t.considerAsFieldToDisable)){t._name||t.name;(e||!t.cmImmutable)&&t.isVisible()&&t.enable()}})},enableTabbedFields:function(e){this.cascade(function(t){if(t&&(t instanceof Ext.form.Field||t instanceof Ext.form.FieldSet||t.considerAsFieldToDisable)){t._name||t.name;(e||!t.cmImmutable)&&t.enable()}})},focusOnFirstEnabled:function(){var e=!1;this.cascade(function(t){t&&t instanceof Ext.form.Field&&(t.disabled||e||(t.focus(),e=!0))})},getData:function(e){if(e){var t={};return this.cascade(function(e){e&&e.submitValue&&(e instanceof Ext.form.Field||e instanceof Ext.form.field.Base||e instanceof Ext.form.field.HtmlEditor)&&(t[e.name]=e.getValue())}),t}return this.getForm().getValues()},getNonValidFields:function(){var e=[];return this.cascade(function(t){t&&(t instanceof Ext.form.Field||t instanceof Ext.form.field.Field)&&!t.disabled&&(t.isValid()||e.push(t))}),e},initValues:function(){this.getForm()&&Ext.each(this.getForm().getFields().getRange(),function(e){e.isDirty()&&e.initValue()})},iterateOverCMButtons:function(e){this.iterateOverArray(this.cmButtons,e)},iterateOverCMTBar:function(e){this.iterateOverArray(this.cmTBar,e)},iterateOverArray:function(e,t){for(var i=0,n=(e=e||[]).length;i<n;++i)t(e[i])},reset:function(){try{this.getForm().setValues(),this.getForm().reset()}catch(e){}}}),function(){function e(e,t,i,n,r,a){this.callDelegates("onCMCardGridIconRowClick",[e,r.target.className,t])}Ext.define("CMDBuild.view.management.common.CMCardGridDelegate",{uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],onCMCardGridSelect:function(e,t){},onCMCardGridDeselect:function(e,t){},onCMCardGridBeforeLoad:function(e){},onCMCardGridLoad:function(e){},onCMCardGridColumnsReconfigured:function(e){},onCMCardGridIconRowClick:function(e,t,i){}}),Ext.define("CMDBuild.view.management.common.CMCardGridPagingBar",{extend:"Ext.toolbar.Paging",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],grid:void 0,doRefresh:function(e){if(this.grid){var t=this.grid.getSelectionModel();t&&t.deselectAll()}return this.callOverridden(arguments)}}),Ext.define("CMDBuild.view.management.common.CMCardGrid",{extend:"Ext.grid.Panel",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json","CMDBuild.core.constants.Global"],mixins:{delegable:"CMDBuild.core.CMDelegable"},delegate:void 0,controllerAdvancedFilterButtons:void 0,CLASS_COLUMN_DATA_INDEX:"IdClass_value",columns:[],extraParams:void 0,forceSelectionOfFirst:!1,skipSelectFirst:!1,cmPaginate:!0,cmBasicFilter:!0,cmAdvancedFilter:!0,cmAddGraphColumn:!0,cmAddPrintButton:!0,constructor:function(e){this.mixins.delegable.constructor.call(this,"CMDBuild.view.management.common.CMCardGridDelegate"),this.callParent(arguments)},initComponent:function(){this.loadMask=!1,this.store=this.getStoreForFields([]),this.cmPaginate&&function(e){var t=[];e.cmBasicFilter&&(e.gridSearchField=new CMDBuild.field.GridSearchField({grid:e}),t.push(e.gridSearchField)),e.cmAdvancedFilter&&(e.controllerAdvancedFilterButtons=Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.filter.advanced.Advanced",{masterGrid:e}),_CMUtils.forwardMethods(e,e.controllerAdvancedFilterButtons.getView(),["enableClearFilterButton","disableClearFilterButton","setFilterButtonLabel"]),t.push(e.controllerAdvancedFilterButtons.getView())),e.cmAddPrintButton&&(e.printGridMenu=Ext.create("CMDBuild.core.buttons.iconized.split.Print",{formatList:[CMDBuild.core.constants.Proxy.PDF,CMDBuild.core.constants.Proxy.CSV],mode:"legacy",disabled:!0}),t.push(e.printGridMenu)),e.pagingBar=new CMDBuild.view.management.common.CMCardGridPagingBar({grid:e,store:e.store,displayInfo:!0,displayMsg:"{0} - {1} "+CMDBuild.Translation.of+" {2}",emptyMsg:CMDBuild.Translation.noTopicsToDisplay,items:t}),e.bbar=e.pagingBar}(this),this.viewConfig={stripeRows:!0,autoScroll:!1,overflowX:"hidden",overflowY:"auto"},this.layout={type:"fit",reserveScrollbar:!0},this.callParent(arguments),this.mon(this,"beforeitemclick",e,this),this.mon(this,"select",function(e,t){this.callDelegates("onCMCardGridSelect",[e,t])},this),this.mon(this,"deselect",function(e,t){this.callDelegates("onCMCardGridDeselect",[e,t])},this),this.on("columnhide",function(e,t,i){this.getStore().reload()},this),this.on("columnshow",function(e,t,i){this.getStore().reload()},this)},shouldSelectFirst:function(){var e=this.forceSelectionOfFirst&&!this.skipSelectFirst;return this.skipSelectFirst=!1,e},skipNextSelectFirst:function(){this.skipSelectFirst=!0},updateStoreForClassId:function(e,t){var i=this;this.loadAttributes(e,function(n){function r(e){t&&t.cb?t.cb.call(t.scope||e):e.store.loadPage(1)}i.currentClassId==e?r(i):(i.currentClassId=e,i.gridSearchField&&i.gridSearchField.setValue(""),i.cmAdvancedFilter&&i.controllerAdvancedFilterButtons.cmfg("entryTypeSet",{value:_CMCache.getEntryTypeById(e).getData()}),i.printGridMenu&&i.printGridMenu.setDisabled(!e),i.setColumnsForClass(n),i.setGridSorting(n),r(i))})},loadAttributes:function(e,t){_CMCache.getAttributeList(e,t)},loadPage:function(e,t){t=t||{},scope=t.scope||this,cb=t.cb||function(e){e[2]||CMDBuild.core.Message.error(null,{text:CMDBuild.Translation.errors.anErrorHasOccurred})},this.mon(this,"load",cb,scope,{single:!0}),this.getStore().loadPage(Math.floor(e))},reload:function(e){e=Ext.isBoolean(e)&&e,this.getStore().load({scope:this,callback:function(t,i,n){if(n&&(i.start>0&&Ext.isEmpty(t)&&this.loadPage(1),e))if(this.getSelectionModel().hasSelection()){var r=this.getStore().findRecord("Id",this.getSelectionModel().getSelection()[0].get("Id"));Ext.isEmpty(r)||this.getSelectionModel().select(r)}else this.getSelectionModel().select(0)}})},getVisibleColumns:function(){for(var e=this.columns,t=[],i=0,n=e.length;i<n;i++){var r=e[i];if(!r.hidden&&r.dataIndex&&"Id"!=r.dataIndex){var a=r.dataIndex;if(a){var o=a.lastIndexOf("_value");o>=0&&(a=a.slice(0,o)),t.push(a)}}}return t},setColumnsForClass:function(e){var t=this.buildColumnsForAttributes(e),i=this.getStoreForFields(t.fields);this.suspendLayouts(),this.reconfigure(i,t.headers),this.resumeLayouts(!0),this.pagingBar&&this.pagingBar.bindStore(i),this.callDelegates("onCMCardGridColumnsReconfigured",this)},buildColumnsForAttributes:function(e){this.classAttributes=e;var t=[],i=[];_CMUtils.isSuperclass(this.currentClassId)&&t.push(this.buildClassColumn());for(var n=0;n<e.length;n++){var r=e[n],a=CMDBuild.Management.FieldManager.getHeaderForAttr(r);a&&a.dataIndex!=this.CLASS_COLUMN_DATA_INDEX?(this.addRendererToHeader(a),t.push(a),i.push(a.dataIndex)):"Description"==r.name&&i.push("Description")}return t=t.concat(this.buildExtraColumns()),this.cmAddGraphColumn&&CMDBuild.configuration.graph.get(CMDBuild.core.constants.Proxy.ENABLED)&&function(e){var t=_CMCache.getClassById(this.currentClassId);!Ext.isEmpty(t)&&t.get("tableType")!=CMDBuild.core.constants.Global.getTableTypeSimpleTable()&&Ext.isArray(e)&&e.push(Ext.create("Ext.grid.column.Action",{align:"center",width:30,sortable:!1,hideable:!1,menuDisabled:!0,fixed:!0,items:[Ext.create("CMDBuild.core.buttons.iconized.Graph",{withSpacer:!0,tooltip:CMDBuild.Translation.openRelationGraph,scope:this,handler:function(e,t,i,n,r,a,o){Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.graph.Window",{parentDelegate:this,classId:a.get("IdClass"),cardId:a.get("id")})}})]}))}.call(this,t),{headers:t,fields:i}},setGridSorting:function(e){if(this.store.sorters){this.store.sorters.clear();for(var t=[],i=0,n=e.length;i<n;++i){var r=e[i],a={},o=r.classOrderSign*r.absoluteClassOrder;0!=o&&(a.property=r.name,o>0?a.direction="ASC":(a.direction="DESC",o=-o),t[o]=a)}for(i=0,n=t.length;i<n;++i){(a=t[i])&&this.store.sorters.add(a)}}},addRendererToHeader:function(e){e.renderer=function(t,i,n,r,a,o,s){return void 0===(t=t||n.get(e.dataIndex))||null==t?"":("object"==typeof t?t=t.description:"boolean"==typeof t?t=t?Ext.MessageBox.buttonText.yes:Ext.MessageBox.buttonText.no:"string"==typeof t&&(t=Ext.util.Format.stripTags(t)),t)}},getStoreForFields:function(e){var t=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),i=this.buildStore(e,t);return this.mon(i,"beforeload",function(e,t){this.callDelegates("onCMCardGridBeforeLoad",this),this.fireEvent("beforeload",arguments);var i=this.getStore().getProxy().extraParams;return!(!Ext.isObject(i)||Ext.Object.isEmpty(i)||!Ext.isString(i[CMDBuild.core.constants.Proxy.CLASS_NAME])||Ext.isEmpty(i[CMDBuild.core.constants.Proxy.CLASS_NAME]))&&(i[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(this.getVisibleColumns()),!0)},this),this.mon(i,"load",function(e,t){if(this.callDelegates("onCMCardGridLoad",this),this.fireEvent("load",arguments),this.shouldSelectFirst()&&!this.getSelectionModel().hasSelection()&&t&&t.length>0)try{this.getSelectionModel().select(0)}catch(e){this.fireEvent("cmWrongSelection"),CMDBuild.log.info("Not selected the first record"),_trace()}},this),i},buildStore:function(e,t){return e.push({name:"Id",type:"int"}),e.push({name:"IdClass",type:"int"}),e.push(this.CLASS_COLUMN_DATA_INDEX),CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!1,fields:e,pageSize:t,remoteSort:!0,proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.card.readAll,reader:{type:"json",root:"rows",totalProperty:"results",idProperty:"Id"},extraParams:this.getStoreExtraParams()}})},getStoreExtraParams:function(){var e={className:""};return this.currentClassId&&(e.className=_CMCache.getEntryTypeNameById(this.currentClassId)),this.CQL&&((e=Ext.apply(e,this.CQL)).filter=Ext.encode(this.CQL)),e},buildExtraColumns:function(){return[]},buildClassColumn:function(){return{header:CMDBuild.Translation.subClass,width:100,sortable:!1,dataIndex:this.CLASS_COLUMN_DATA_INDEX}},disableFilterMenuButton:function(){this.cmAdvancedFilter&&this.controllerAdvancedFilterButtons.getView().disable()},enableFilterMenuButton:function(){this.cmAdvancedFilter&&this.controllerAdvancedFilterButtons.getView().enable()},applyFilterToStore:function(e){try{var t=e;"string"!=typeof t&&(t=Ext.encode(e)),this.getStore().proxy.extraParams.filter=t}catch(t){_debug("I'm not able to set the filter to the store",this,e)}}})}(),function(){Ext.define("CMDBuild.view.management.common.CMCardListWindow",{extend:"CMDBuild.core.window.AbstractModal",ClassName:void 0,idClass:void 0,filterType:void 0,readOnly:void 0,selModel:void 0,selType:"rowmodel",multiSelect:!1,extraParams:{},gridConfig:{},initComponent:function(){if(void 0===this.idClass&&void 0===this.ClassName)throw"There are no Class Id or Class Name to load";this.title=CMDBuild.Translation.management.modcard.title+function(e){var t=_CMCache.getEntryTypeById(e.getIdClass()),i="";return t&&(i=t.getDescription()),i}(this),this.grid=new CMDBuild.view.management.common.CMCardGrid(this.buildGrdiConfiguration()),this.setItems(),this.callParent(arguments),this.mon(this.grid.getSelectionModel(),"selectionchange",this.onSelectionChange,this),this.mon(this.grid,"itemdblclick",this.onGridDoubleClick,this)},show:function(){this.callParent(arguments);var e=this.getIdClass();return this.grid.updateStoreForClassId(e),this},setItems:function(){this.items=[this.grid],this.readOnly||"class"!=_CMCache.getEntryTypeById(this.getIdClass()).get("type")||(this.tbar=[this.addCardButton=this.buildAddButton()])},buildAddButton:function(){var e=Ext.create("CMDBuild.core.buttons.iconized.split.add.Card"),t=_CMCache.getEntryTypeById(this.getIdClass());return e.updateForEntry(t),this.mon(e,"cmClick",function(e){var t=new CMDBuild.view.management.common.CMCardWindow({withButtons:!0,title:e.className});new CMDBuild.controller.management.common.CMCardWindowController(t,{cmEditMode:!0,card:null,entryType:e.classId}),t.show(),this.mon(t,"destroy",function(){this.grid.reload()},this)},this),e},getIdClass:function(){if(this.idClass)return this.idClass;var e=_CMCache.getEntryTypeByName(this.ClassName);if(e)return e.getId();throw"No class info for "+Ext.getClassName(this)},buildGrdiConfiguration:function(){var e=Ext.apply(this.gridConfig,{cmAdvancedFilter:!1,columns:[],CQL:this.extraParams,frame:!1,border:!1,selType:this.selType,multiSelect:this.multiSelect});return void 0===this.selModel?e.selType=this.selType:e.selModel=this.selModel,e},onSelectionChange:Ext.emptyFn,onGridDoubleClick:Ext.emptyFn})}(),Ext.define("CMDBuild.Management.ReferenceSearchWindow",{extend:"CMDBuild.view.management.common.CMCardListWindow",initComponent:function(){this.selection=null,this.saveButton=new Ext.Button({text:CMDBuild.Translation.save,name:"saveButton",disabled:!0,handler:this.onSave,scope:this}),this.buttonAlign="center",this.buttons=[this.saveButton],this.callParent(arguments),this.on("show",function(){if(this.grid.gridSearchField){var e=this;Ext.Function.createDelayed(function(){e.grid.gridSearchField.focus(),e.grid.gridSearchField.setValue(e.searchFieldValue)},100)()}},this,{single:!0})},buildGrdiConfiguration:function(){var e=this.callParent(arguments),t=this.extraParams;return Ext.apply(e,{getStoreExtraParams:function(){return t}})},onSelectionChange:function(e,t){t.length>0?(this.saveButton.enable(),this.selection=t[0]):(this.saveButton.disable(),this.selection=null)},onGridDoubleClick:function(){this.onSave()},onSave:function(){null!=this.selection&&this.fireEvent("cmdbuild-referencewindow-selected",this.selection),this.destroy()}}),function(){function e(e,t){t?(e.updatePickerPosition(),e.picker.filtersCount()?(e.selectAppliedFilter(),e.picker.show()):(e.callDelegates("onFilterMenuButtonNewActionClick",e),e.showListButton.toggle())):e.picker.hide()}var t={saveFilter:"action-filter-save",modifyFilter:"action-filter-modify",removeFilter:"action-filter-remove",cloneFilter:"action-filter-clone"},i=CMDBuild.Translation.searchFilter,n=CMDBuild.Translation.clearFilter,r=(CMDBuild.Translation.save,CMDBuild.Translation.modify,CMDBuild.Translation.clone,CMDBuild.Translation.remove,CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator),a={};a[r.EQUAL]=CMDBuild.Translation.equals,a[r.NOT_EQUAL]=CMDBuild.Translation.different,a[r.NULL]=CMDBuild.Translation.isNull,a[r.NOT_NULL]=CMDBuild.Translation.isNotNull,a[r.GREATER_THAN]=CMDBuild.Translation.greaterThan,a[r.LESS_THAN]=CMDBuild.Translation.lessThan,a[r.BETWEEN]=CMDBuild.Translation.between,a[r.CONTAIN]=CMDBuild.Translation.contains,a[r.NOT_CONTAIN]=CMDBuild.Translation.doesNotContain,a[r.BEGIN]=CMDBuild.Translation.beginsWith,a[r.NOT_BEGIN]=CMDBuild.Translation.doesNotBeginWith,a[r.END]=CMDBuild.Translation.endsWith,a[r.NOT_END]=CMDBuild.Translation.doesNotEndWith;Ext.define("CMDBuild.view.management.common.filter.CMFilterMenuButton",{extend:"Ext.container.ButtonGroup",mixins:{delegable:"CMDBuild.core.CMDelegable"},constructor:function(){this.mixins.delegable.constructor.call(this,"CMDBuild.delegate.common.filter.CMFilterMenuButtonDelegate"),this.callParent(arguments)},initComponent:function(){this.picker=null;var r=this;this.showListButton=new Ext.button.Button({text:i,iconCls:"searchFilter",enableToggle:!0,toggleHandler:function(i,n){return function(i,n,r){null==i.picker?i.picker=new CMDBuild.view.management.common.filter.CMFilterMenuButtonPicker({onStoreDidLoad:function(){e(i,r)},entryType:i.entryType,listeners:{beforeitemclick:function(e,n,r,a,o,s){var l=o.target.className,d={};d[t.saveFilter]="onFilterMenuButtonSaveActionClick",d[t.modifyFilter]="onFilterMenuButtonModifyActionClick",d[t.removeFilter]="onFilterMenuButtonRemoveActionClick",d[t.cloneFilter]="onFilterMenuButtonCloneActionClick","string"==typeof d[l]?(i.callDelegates(d[l],[i,n.copy()]),i.deselectPicker()):i.callDelegates("onFilterMenuButtonApplyActionClick",[i,n.copy()])},addFilter:function(){i.callDelegates("onFilterMenuButtonNewActionClick",i)},show:function(e){var t=Ext.getBody().getViewSize(),n=e.getBox(),r=i.getBox();if(t&&n&&r&&n.bottom>t.height){var a=n.height+r.height;e.setPosition(n.x,n.y-a)}}}}):e(i,r)}(r,0,n)}}),this.clearButton=new Ext.button.Button({text:n,iconCls:"searchFilterClear",disabled:!0,handler:function(){r.callDelegates("onFilterMenuButtonClearActionClick",r)}}),this.items=[this.showListButton,this.clearButton],this.callParent(arguments),this.mon(this,"move",function(e,t,i){this.showListButton.toggle(!1)},this)},disable:function(){this.clearButton.disable(),this.showListButton.disable()},enable:function(){this.clearButton.enable(),this.showListButton.enable()},reconfigureForEntryType:function(e){this.entryType=e,null!=this.picker&&(this.picker.destroy(),this.picker=null)},updatePickerPosition:function(e){var t=e||this.getBox();null!=this.picker&&this.picker.setPosition(t.x+5,t.y+t.height)},setFilterButtonLabel:function(e){var t=i,n=i;e&&(t=Ext.String.ellipsis(e,20),n=e),this.showListButton.setTooltip(n),this.showListButton.setText(t)},deselectPicker:function(){this.picker.deselect()},load:function(){this.picker.load()},selectAppliedFilter:function(){this.picker.selectAppliedFilter()},enableClearFilterButton:function(){this.clearButton.enable()},disableClearFilterButton:function(){this.clearButton.disable()},getFilterStore:function(){var e=null;return this.picker&&(e=this.picker.getStore()),e}})}(),function(){CMDBuild.Translation.searchFilter,CMDBuild.Translation.clearFilter,CMDBuild.Translation.save,CMDBuild.Translation.modify,CMDBuild.Translation.clone,CMDBuild.Translation.remove;var e=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator,t={};t[e.EQUAL]=CMDBuild.Translation.equals,t[e.NOT_EQUAL]=CMDBuild.Translation.different,t[e.NULL]=CMDBuild.Translation.isNull,t[e.NOT_NULL]=CMDBuild.Translation.isNotNull,t[e.GREATER_THAN]=CMDBuild.Translation.greaterThan,t[e.LESS_THAN]=CMDBuild.Translation.lessThan,t[e.BETWEEN]=CMDBuild.Translation.between,t[e.CONTAIN]=CMDBuild.Translation.contains,t[e.NOT_CONTAIN]=CMDBuild.Translation.doesNotContain,t[e.BEGIN]=CMDBuild.Translation.beginsWith,t[e.NOT_BEGIN]=CMDBuild.Translation.doesNotBeginWith,t[e.END]=CMDBuild.Translation.endsWith,t[e.NOT_END]=CMDBuild.Translation.doesNotEndWith;Ext.define("CMDBuild.view.management.common.filter.CMRuntimeParameterWindowField",{extend:"Ext.form.FieldContainer",valueField:null,initComponent:function(){this.fieldLabel=(this.valueField.fieldLabel||"")+" - "+t[this.valueField._cmOperator],this.labelAlign="top",this.labelSeparator=null,this.valueField.hideLabel=!0,this.valueField.flex=2,this.labelStyle="font-weight: 100 !important; color: #000000 !important",this.layout="hbox",this.items=[this.valueField],this.valueField._cmOperator==e.BETWEEN&&(this.valueField2=CMDBuild.Management.FieldManager.getFieldForAttr(this.valueField.CMAttribute),this.valueField2.hideLabel=!0,this.valueField2.flex=2,this.items.push({xtype:"splitter"}),this.valueField._cmSecondField=this.valueField2,this.items.push(this.valueField2)),this.callParent(arguments)}})}(),function(){var e={saveFilter:"action-filter-save",modifyFilter:"action-filter-modify",removeFilter:"action-filter-remove",cloneFilter:"action-filter-clone"},t=(CMDBuild.Translation.searchFilter,CMDBuild.Translation.clearFilter,{save:CMDBuild.Translation.save,modify:CMDBuild.Translation.modify,clone:CMDBuild.Translation.clone,remove:CMDBuild.Translation.remove}),i="images/icons/disk.png",n="images/icons/disk_disabled.png",r="images/icons/modify.png",a="images/icons/clone.png",o="images/icons/cross.png",s=CMDBuild.WidgetBuilders.BaseAttribute.FilterOperator,l={};l[s.EQUAL]=CMDBuild.Translation.equals,l[s.NOT_EQUAL]=CMDBuild.Translation.different,l[s.NULL]=CMDBuild.Translation.isNull,l[s.NOT_NULL]=CMDBuild.Translation.isNotNull,l[s.GREATER_THAN]=CMDBuild.Translation.greaterThan,l[s.LESS_THAN]=CMDBuild.Translation.lessThan,l[s.BETWEEN]=CMDBuild.Translation.between,l[s.CONTAIN]=CMDBuild.Translation.contains,l[s.NOT_CONTAIN]=CMDBuild.Translation.doesNotContain,l[s.BEGIN]=CMDBuild.Translation.beginsWith,l[s.NOT_BEGIN]=CMDBuild.Translation.doesNotBeginWith,l[s.END]=CMDBuild.Translation.endsWith,l[s.NOT_END]=CMDBuild.Translation.doesNotEndWith;Ext.define("CMDBuild.view.management.common.filter.CMFilterMenuButtonPicker",{extend:"Ext.window.Window",entryType:null,onStoreDidLoad:Ext.emptyFn,baseCls:"",initComponent:function(){this.closable=!1,this.draggable=!1,this.resizable=!1,this.frame=!0,this.border=!1,this.rowTemplate='<p class="filterMenuButtonGrid-name" title="{0} - {1}">{1}</p>',this.cls="filterMenuButtonGrid";var s=this,l=CMDBuild.proxy.Filter.newUserStore();this.grid=new Ext.grid.Panel({width:300,maxHeight:200,autoScroll:!0,hideHeaders:!0,store:l,tbar:[{text:CMDBuild.Translation.add,iconCls:"add",handler:function(){s.fireEvent("addFilter")}}],columns:[{renderer:function(e,t,i,n,r,a,o){var l=Ext.String.ellipsis(i.getDescription(),50),d=Ext.String.ellipsis(i.getName(),45);i.dirty&&(d+="*");var u=""==Ext.String.trim(l)?d:l;return Ext.String.format(s.rowTemplate,d,u)},flex:1,menuDisabled:!0,hideable:!1},{width:100,fixed:!0,sortable:!1,renderer:function(s,l,d,u,c,h,m){if(d.isTemplate())return"";var f='<img style="cursor:pointer" title="{0}" class="{1}" src="{2}"/>',g=d.dirty?i:n;return Ext.String.format(f,t.save,e.saveFilter,g)+Ext.String.format(f,t.modify,e.modifyFilter,r)+Ext.String.format(f,t.clone,e.cloneFilter,a)+Ext.String.format(f,t.remove,e.removeFilter,o)},align:"center",menuDisabled:!0,hideable:!1}]}),this.relayEvents(this.grid,["beforeitemclick","select"]),this.items=[this.grid],this.callParent(arguments),this.load()},filtersCount:function(){return this.grid.getStore().count()},deselect:function(){this.grid.getSelectionModel().deselectAll()},selectAppliedFilter:function(){this.deselect();var e=this.grid.getStore().findRecord("applied",!0);null!=e&&this.grid.getSelectionModel().select(e)},getStore:function(){return this.grid.getStore()},load:function(){var e={};e[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.entryType.getName(),this.getStore().load({callback:this.onStoreDidLoad,params:e})}})}(),Ext.define("CMDBuild.view.common.filter.CMFilterConfigurationWindow",{extend:"CMDBuild.view.management.common.filter.CMFilterWindow",readOnly:!1,buildButtons:function(){var e=this,t=[{text:CMDBuild.Translation.cancel,handler:function(){e.callDelegates("onCMFilterWindowAbortButtonClick",[e])}}];this.readOnly?this.buttons=t:this.buttons=[{text:CMDBuild.Translation.save,handler:function(){e.callDelegates("onCMFilterWindowSaveButtonClick",[e,e.getFilter()])}}].concat(t)},buildFilterAttributePanel:function(){return new CMDBuild.view.management.common.filter.CMFilterAttributes({attributes:this.attributes,className:this.className,readOnly:this.readOnly})}}),function(){function e(t,n){n.simple?function(e,t){if(!t||!t.simple)return;var n=t.simple.attribute||"",r=_CMUtils.arraySearchByFunction(e.attributes,function(e){return e.name==n});r&&i(e,r,t.simple)}(t,n):function(t,i){for(var n=i.or||i.and||[],r=0,a=n.length;r<a;++r)e(t,n[r])}(t,n)}function t(e){var t=function(e){var t=[],n=CMDBuild.Utils.groupAttributes(e.attributes,allowNoteFiled=!1);for(var r in n){for(var a=[],o=n[r],s=0,l=o.length;s<l;++s)a.push({text:o[s].description,attribute:o[s],handler:function(){i(e,this.attribute)}});t.push({text:r,menu:a})}return t}(e);e.menu.removeAll(),1==t.length?e.menu.add(t[0].menu):e.menu.add(t)}function i(e,t,i){var n=t.name;if(t.selectAtRuntimeCheckDisabled=!1,Ext.suspendLayouts(),Ext.isEmpty(e.fieldsetCategory[n])){var r=Ext.create("CMDBuild.view.management.common.filter.CMFilterAttributes.AttributeFieldset",{title:t.description,attributeName:n,taskManager:e.taskManager});r.addDelegate(e),e.fieldsetCategory[n]=r,e.add(r)}var a=Ext.create("CMDBuild.Management.FieldManager.getFieldSetForFilter",t,e.taskManager);e.fieldsetCategory[n].addCondition(a),a.setData(i),Ext.resumeLayouts(),e.doLayout()}Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributes.AttributeFieldsetDelegate",{onAttributeFieldsetIsEmpty:Ext.emptyFn}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributes",{extend:"Ext.form.Panel",mixins:{attributeFieldsetDelegate:"CMDBuild.view.management.common.filter.CMFilterAttributes.AttributeFieldsetDelegate"},title:CMDBuild.Translation.attributes,autoScroll:!0,bodyCls:"x-panel-default-framed",defaults:{padding:"5 5 0 5"},layout:{type:"vbox",align:"stretch"},items:[],attributes:{},readOnly:!1,initComponent:function(){this.fieldsetCategory={};var e=[];this.readOnly||(this.menu=Ext.create("Ext.menu.Menu"),t(this),e.push({text:CMDBuild.Translation.chooseAnAttribute,iconCls:"add",menu:this.menu})),this.filterButton&&(e.push("->"),e.push(this.filterButton),this.resetFilterButton=Ext.create("Ext.button.Button",{text:CMDBuild.Translation.clearFilter,iconCls:"delete"}),e.push(this.resetFilterButton)),this.tbar=e,this.mon(this,"added",function(e){e.menu&&e.menu.registerWithOwnerCt()}),this.callParent(arguments)},updateMenuForClassId:function(e){this.readOnly||(this.currentClassId=e,_CMCache.getAttributeList(e,Ext.bind(function(e){this.attributes=e,t(this)},this)))},removeAllFieldsets:function(){CMDBuild.clearComponent(this),this.fieldsetCategory={}},cleanFildsetCategory:function(){this.fieldsetCategory={}},getData:function(){var e=[],t={};return this.items.each(function(t){"function"==typeof t.getData&&e.push(t.getData())}),1==e.length?t=e[0]:e.length>1&&(t={and:e}),t},setData:function(t){e(this,t)},onAttributeFieldsetIsEmpty:function(e){this.remove(e),delete this.fieldsetCategory[e.attributeName]}}),Ext.define("CMDBuild.view.management.common.filter.CMFilterAttributes.AttributeFieldset",{extend:"Ext.form.FieldSet",mixins:{delegable:"CMDBuild.core.CMDelegable",conditionDelegate:"CMDBuild.view.management.common.filter.CMFilterAttributeConditionPanelDelegate"},attributeName:"",constructor:function(){this.mixins.delegable.constructor.call(this,"CMDBuild.view.management.common.filter.CMFilterAttributes.AttributeFieldsetDelegate"),this.callParent(arguments)},initComponent:function(){this.defaults={padding:"0 0 5 0"},this.callParent(arguments)},addCondition:function(e){e.addDelegate(this),this.items.length>=1&&this.items.last().showOr(),Ext.suspendLayouts(),this.add(e),Ext.resumeLayouts()},getData:function(){var e=[],t={};return this.items.each(function(t){"function"==typeof t.getData&&e.push(t.getData())}),1==e.length?t=e[0]:e.length>1&&(t={or:e}),t},onFilterAttributeConditionPanelRemoveButtonClick:function(e){Ext.suspendLayouts(),this.remove(e),Ext.resumeLayouts();this.items.length>0?this.items.last().hideOr():this.callDelegates("onAttributeFieldsetIsEmpty",this)}})}(),function(){function e(e){return e.view.controllerAdvancedFilterButtons.getView().getFilterStore()}function t(t,i,n){_CMCache.addFilter(e(t),i,n)}function i(i,a,o){if(a.getRuntimeParameters().length>0&&!o)n(i,a);else{if(r(i),i.appliedFilter=a,a.dirty){t(i,a,!0)}var s=""==Ext.String.trim(a.getDescription())?a.getName():a.getDescription();i.view.setFilterButtonLabel(s),i.view.applyFilterToStore(a.getConfigurationMergedWithRuntimeAttributes(o)),i.view.enableClearFilterButton(),i.view.loadPage(1),function(t,i){_CMCache.setFilterApplied(e(t),i,!0)}(i,a)}}function n(e,t){var i=t.getRuntimeParameters(),n=[],r=i.length>0;if(r){var a=t.getEntryType(),o=_CMCache.getEntryTypeByName(a);if(o&&_CMCache.getAttributeList(o.getId(),function(e){for(var t=0;t<i.length;++t)for(var r=i[t],a=0;a<e.length;++a){var o=Ext.apply({},e[a]);if(o.fieldmode="write",o.name==r.attribute){o=function(e){Ext.isObject(e)&&!Ext.Object.isEmpty(e)&&Ext.isString(e[CMDBuild.core.constants.Proxy.FILTER])&&!Ext.isEmpty(e[CMDBuild.core.constants.Proxy.FILTER])&&CMDBuild.core.templateResolver.Utils.hasTemplates(e[CMDBuild.core.constants.Proxy.FILTER])&&(e[CMDBuild.core.constants.Proxy.FILTER]=null);return e}(o);var s=CMDBuild.Management.FieldManager.getFieldForAttr(o);s._cmOperator=r.operator,n.push(s);break}}}),!Ext.isEmpty(n)&&Ext.isArray(n)){var s=new CMDBuild.view.management.common.filter.CMRuntimeParameterWindow({runtimeAttributes:n,filter:t,title:t.getName()});s.addDelegate(e),s.show()}}return r}function r(t){t.gridSM.hasSelection()&&t.gridSM.deselectAll(),t.appliedFilter&&(!function(t,i){_CMCache.setFilterApplied(e(t),i,!1)}(t,t.appliedFilter),t.appliedFilter=void 0),t.view.setFilterButtonLabel(),t.view.applyFilterToStore({}),t.view.disableClearFilterButton()}function a(e,t,i){var n=e.view;n.updateStoreForClassId(t,{cb:function(){var t=CMDBuild.core.Utils.getPageNumber(i),r=CMDBuild.configuration.instance.get(CMDBuild.core.constants.Proxy.ROW_LIMIT),a=i%r;n.loadPage(t,{cb:function(){var t=arguments[0];try{e.gridSM.deselectAll(),e.gridSM.select(a),Ext.isEmpty(e.view)||Ext.isEmpty(e.view.plugins)||Ext.isEmpty(e.view.plugins[0])||"activityrowexpander"!=e.view.plugins[0].ptype||e.view.plugins[0].toggleRow(a,e.view.getStore().getAt(a))}catch(e){n.fireEvent("cmWrongSelection"),_warning("I was not able to select the record at "+a,this)}t[2]||CMDBuild.core.Message.error(null,{text:CMDBuild.Translation.errors.anErrorHasOccurred})}})}})}Ext.define("CMDBuild.controller.management.common.CMCardGridController",{uses:["CMDBuild.core.Message","CMDBuild.core.templateResolver.Utils","CMDBuild.proxy.Card","CMDBuild.core.Utils","CMDBuild.view.management.common.filter.CMRuntimeParameterWindow"],mixins:{observable:"Ext.util.Observable",filterWindow:"CMDBuild.view.management.common.filter.CMFilterWindowDelegate",saveFilterWindow:"CMDBuild.view.management.common.filter.CMSaveFilterWindowDelegate",runtimeFilterParamsWindow:"CMDBuild.delegate.common.filter.CMRuntimeParameterWindowDelegate"},timer:void 0,constructor:function(e,t){if(this.mixins.observable.constructor.call(this,arguments),void 0===e)throw"OOO snap, you have not passed a view to me";this.view=e,this.view.delegate=this,this.supercontroller=t,this.gridSM=this.view.getSelectionModel(),this.CMEVENTS={cardSelected:"cm-card-selected",wrongSelection:"cm-wrong-selection",gridVisible:"cm-visible-grid",itemdblclick:"itemdblclick",load:"load"},this.addEvents(this.CMEVENTS.cardSelected),this.addEvents(this.CMEVENTS.wrongSelection),this.addEvents(this.CMEVENTS.gridVisible),this.relayEvents(this.view,["itemdblclick","load"]),this.mon(this.gridSM,"selectionchange",this.onCardSelected,this),this.mon(this.view,"cmWrongSelection",this.onWrongSelection,this),this.mon(this.view,"cmVisible",this.onGridIsVisible,this),this.mon(this.view.printGridMenu,"click",this.onPrintGridMenuClick,this),this.stateDelegate=this.buildStateDelegate()},buildStateDelegate:function(){var e=new CMDBuild.state.CMCardModuleStateDelegate,t=this;e.onEntryTypeDidChange=function(e,i,n,r){t.onEntryTypeSelected(i,n,r)},e.onCardDidChange=function(e,i){if(i){var n=t.gridSM.getSelection();if(Ext.isArray(n)&&n.length>0)n=n[0];else if(0===n.length)return void t.openCard({Id:i.get("Id"),IdClass:i.get("IdClass")});if(!Ext.isEmpty(n)&&!Ext.isEmpty(n.get)&&Ext.isFunction(n.get)){var r=n.get("Id");if(r&&r==i.get("Id"))return;t.openCard({Id:i.get("Id"),IdClass:i.get("IdClass")})}}},_CMCardModuleState.addDelegate(e)},getEntryType:function(){return _CMCardModuleState.entryType},onEntryTypeSelected:function(e,t,n){if(e){r(this);var a,o=this;a=t?function(){o.openCard(t,retryWithoutFilter=!0)}:function(){if(n){var t={};"CMDBuild.model.CMFilterModel"==Ext.getClassName(n)?(t=n,o.view.enableFilterMenuButton()):t=Ext.create("CMDBuild.model.CMFilterModel",{configuration:Ext.decode(n),entryType:e.get("name"),name:CMDBuild.Translation.parameters}),i(o,t)}else o.view.loadPage(1,{cb:function(e){var t=e[1];if(t&&t.length>0)try{o.gridSM.select(0)}catch(e){_debug(e)}e[2]||CMDBuild.core.Message.error(null,{text:CMDBuild.Translation.errors.anErrorHasOccurred})}})},o.view.updateStoreForClassId(o.getEntryType().get("id"),{cb:a})}},onAddCardButtonClick:function(){this.gridSM.deselectAll()},onPrintGridMenuClick:function(e){if(Ext.isString(e)&&!Ext.isEmpty(e)){var t=Ext.apply({},this.view.getStore().proxy.extraParams);t[CMDBuild.core.constants.Proxy.ATTRIBUTES]=Ext.encode(this.view.getVisibleColumns()),t[CMDBuild.core.constants.Proxy.SORT]=Ext.encode(this.view.getStore().getSorters()),t[CMDBuild.core.constants.Proxy.TYPE]=e,this.controllerPrintWindow=Ext.create("CMDBuild.controller.common.panel.gridAndForm.panel.common.print.Window",{parentDelegate:this}),this.controllerPrintWindow.cmfg("panelGridAndFormPrintWindowShow",{format:e,mode:"view",params:t})}},onCardSelected:function(e,t,i){if(Ext.isArray(t)&&!Ext.isEmpty(t)){void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0);var n=this;this.timer=setTimeout(function(){n._onCardSelected(e,t,i)},100)}},_onCardSelected:function(e,t,i){t=t[0],Ext.isNumber(t.get("Id"))&&!Ext.isEmpty(t.get("Id"))&&Ext.isString(t.get("IdClass_value"))&&!Ext.isEmpty(t.get("IdClass_value"))&&CMDBuild.proxy.Card.read({params:{cardId:t.get("Id"),className:_CMCache.getEntryTypeNameById(t.get("IdClass"))},loadMask:!1,scope:this,success:function(e,t,i){i=i[CMDBuild.core.constants.Proxy.CARD],Ext.isObject(i)&&!Ext.Object.isEmpty(i)?_CMCardModuleState.setCard(new CMDBuild.DummyModel(i)):_error("onCardSelected(): unmanaged response",this,i)}})},onWrongSelection:function(){this.fireEvent(this.CMEVENTS.wrongSelection)},onGridIsVisible:function(e){e&&_CMCardModuleState.card&&this.openCard({Id:_CMCardModuleState.card.get("Id"),IdClass:_CMCardModuleState.card.get("IdClass")});var t=this.gridSM.getSelection();this.fireEvent(this.CMEVENTS.gridVisible,e,t)},onCardSaved:function(e){this.openCard(e,!0)},onCardDeleted:function(){this.view.reload()},onCloneCard:function(){this.gridSM.deselectAll()},openCard:function(e,t){var i=this,n=this.view.getStore();if(n&&n.proxy&&n.proxy.extraParams){var o=Ext.apply({},n.proxy.extraParams);o[CMDBuild.core.constants.Proxy.CARD_ID]=e.Id,o[CMDBuild.core.constants.Proxy.CLASS_NAME]=_CMCache.getEntryTypeNameById(e.IdClass),o[CMDBuild.core.constants.Proxy.FLOW_STATUS]=o[CMDBuild.core.constants.Proxy.STATE],o[CMDBuild.core.constants.Proxy.SORT]=Ext.encode(function(e){for(var t=e.getSorters(),i=[],n=0,r=t.length;n<r;++n){var a=t[n];i.push({property:a.property,direction:a.direction})}return i}(n)),CMDBuild.proxy.Card.readPosition({params:o,loadMask:!1,success:function(o,s,l){var d=(l=l[CMDBuild.core.constants.Proxy.RESPONSE])[CMDBuild.core.constants.Proxy.POSITION];if(l[CMDBuild.core.constants.Proxy.HAS_POSITION])a(i,e.IdClass,d);else{if(t)return i.view.gridSearchField.onUnapplyFilter(),r(i),delete n.proxy.extraParams[CMDBuild.Translation.errors.reasons.FILTER],i.openCard(e,!1);i._onGetPositionFailureWithoutForcingTheFilter(l),CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,Ext.String.format(CMDBuild.Translation.errors.reasons.CARD_NOTFOUND,e.IdClass)),i.view.store.loadPage(1)}}})}},reload:function(e){this.view.reload(e)},_onGetPositionSuccessForcingTheFilter:function(e,t,i){this.view;r(this),a(this,e.IdClass,t)},_onGetPositionFailureWithoutForcingTheFilter:function(){CMDBuild.core.Message.info(void 0,CMDBuild.Translation.cardNotMatchFilter)},unApplyFilter:r,onFilterMenuButtonApplyActionClick:function(e){e.getRuntimeParameters().length>0?n(this,e):(this.appliedFilter=e,e.dirty&&t(this,e,!0),this.view.setFilterButtonLabel(""==Ext.String.trim(e.getDescription())?e.getName():e.getDescription()),this.view.applyFilterToStore(e.getConfigurationMergedWithRuntimeAttributes()),this.view.enableClearFilterButton(),this.view.loadPage(1))},onRuntimeParameterWindowSaveButtonClick:function(e,t){i(this,t,e.runtimeAttributes),e.destroy()}})}(),function(){function e(e,t,i){return{xtype:"checkcolumn",header:t,align:"center",dataIndex:i,width:90,fixed:!0,menuDisabled:!0,hideable:!1,listeners:{checkchange:function(t,i,n){var r=e.store.getAt(i);e.callDelegates("onCMDomainGridCheckedColumn",[e,this,n,r])}}}}var t=CMDBuild.Translation.administration.modClass.domainProperties;Ext.define("CMDBuild.model.CMDomainGridModel",{extend:"Ext.data.Model",fields:[{name:"domain",type:"auto"},{name:"destination",type:"auto"},{name:"source",type:"auto"},{name:"direction",type:"string"},{name:"orientedDescription",type:"string"},{name:"noone",type:"boolean",defaultValue:!1},{name:"any",type:"boolean",defaultValue:!1},{name:"oneof",type:"boolean",defaultValue:!1},{name:"checkedCards",type:"auto"}],getDomain:function(){return this.get("domain")},getDestination:function(){return this.get("destination")},getSource:function(){return this.get("source")},setDestinationFromId:function(e){this.set("destination",_CMCache.getEntryTypeById(e)),this.commit()},getDirection:function(){return this.get("direction")},getCheckedCards:function(){var e=this.get("checkedCards");return e||(e=[],this.set("checkedCards",e)),e},setCheckedCards:function(e){return _debug("setCheckedCards"),e||(e=[]),this.set("checkedCards",e)},addCheckedCard:function(e){_debug("add card info",e);-1==this.getCheckedCardIndex(e)&&this.getCheckedCards().push(e)},removeCheckedCard:function(e){_debug("remove card info",e);var t=this.getCheckedCardIndex(e);t>=0&&this.setCheckedCards(Ext.Array.erase(this.getCheckedCards(),t,1))},getCheckedCardIndex:function(e){for(var t=this.getCheckedCards(),i=0,n=t.length;i<n;++i){var r=t[i];if(r.className==e.className&&r.id==e.id)return i}return-1},getType:function(){var e=null;return this.get("any")?e="any":this.get("noone")?e="noone":this.getCheckedCards().length>0&&(e="oneof"),e},setType:function(e){var t="any"==e,i="noone"==e,n="oneof"==e;this.set("any",t),this.set("noone",i),this.set("oneof",n),this.commit()},hasName:function(e){return this.getDomain().getName()==e}}),Ext.define("CMDBuild.view.management.common.filter.CMDomainGridDelegate",{onCMDomainGridSelect:function(e,t){},onCMDomainGridCheckedColumn:function(e,t,i,n){},onCMDomainGridDestinationClassChange:function(e,t){}}),Ext.define("CMDBuild.view.management.common.filter.CMDomainGrid",{extend:"Ext.grid.Panel",mixins:{delegable:"CMDBuild.core.CMDelegable"},className:void 0,constructor:function(){this.mixins.delegable.constructor.call(this,"CMDBuild.view.management.common.filter.CMDomainGridDelegate"),this.callParent(arguments)},initComponent:function(){this.columns=this.getColumnsConfiguration(),this.store=new CMDBuild.view.management.common.filter.CMDomainGrid.Store,this.plugins=[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2})],this.callParent(arguments),this.load(),this.mon(this,"select",function(e,t){var i=t.get("destination");i&&this.destinationComboStore.fillForEntryTypeId(i.getId()),this.callDelegates("onCMDomainGridSelect",[this,t])},this),this.mon(this,"edit",function(e,t){var i=t.column.getEditor().getValue();t.record.setDestinationFromId(i),this.callDelegates("onCMDomainGridDestinationClassChange",[this,i])},this),this.mon(this,"render",function(){this.destinationCombo.ownerCt=this.ownerCt},this)},getColumnsConfiguration:function(){this.destinationComboStore=new CMDBuild.view.management.common.filter.CMDomainGrid.DestinationComboStore,this.destinationCombo=new Ext.form.field.ComboBox({store:this.destinationComboStore,displayField:"descr",valueField:"id",queryMode:"local",triggerAction:"all"});return[{flex:1,header:t.domain,renderer:function(e,t,i){return i.getDomain().getDescription()}},{dataIndex:"orientedDescription",flex:1,header:CMDBuild.Translation.direction},{field:this.destinationCombo,flex:1,header:t.class_destination,renderer:function(e,t,i){return i.getDestination().getDescription()}},{header:CMDBuild.Translation.relations,columns:[e(this,CMDBuild.Translation.noOne,"noone"),e(this,CMDBuild.Translation.any,"any"),e(this,CMDBuild.Translation.fromSelection,"oneof")]}]},load:function(e){this.store.load(this.className),"function"==typeof e&&e()}}),Ext.define("CMDBuild.view.management.common.filter.CMDomainGrid.Store",{extend:"Ext.data.Store",model:"CMDBuild.model.CMDomainGridModel",load:function(e){var t=[],i=_CMCache.getEntryTypeByName(e);i&&(t=_CMCache.getDirectedDomainsByEntryType(i)),CMDBuild.clearComponent(this);for(var n=0,r=t.length;n<r;++n){var a=t[n],o=_CMCache.getDomainById(a.dom_id),s=new CMDBuild.model.CMDomainGridModel({domain:o,destination:_CMCache.getEntryTypeById(a.dst_cid),source:_CMCache.getEntryTypeById(a.src_cid),direction:a.src,orientedDescription:"_1"==a.src?o.get("descr_1"):o.get("descr_2")});this.add(s)}}}),Ext.define("CMDBuild.view.management.common.filter.CMDomainGrid.DestinationComboStore",{extend:"Ext.data.Store",fields:["id","descr"],fillForEntryTypeId:function(e){CMDBuild.clearComponent(this);var t=_CMCache.getEntryTypes(),i=[];for(var n in t)(n=t[n]).get("parent")!=e&&n.get("id")!=e||i.push({id:n.get("id"),descr:n.get("text")});this.add(i)}})}(),function(){function e(e,t){var i=e.cardGrid.getSelectionModel();i&&i.clearSelections(),e.cardGrid.updateStoreForClassId(t);var n=e.currentDomain.get("oneof");e.cardGrid.setDisabled(!n),void 0===e.currentDomain.cards&&(e.currentDomain.cards={})}function t(e){return{className:_CMCache.getEntryTypeNameById(e.get("IdClass")),id:e.get("Id")}}Ext.define("CMDBuild.controller.management.common.filter.CMRelationsController",{extend:"CMDBuild.controller.management.common.CMCardGridController",mixins:{cardGridDelegate:"CMDBuild.view.management.common.CMCardGridDelegate"},constructor:function(){this.callParent(arguments),this.view.addDelegate(this)},buildStateDelegate:function(){},onCardSelected:function(e,t){},getEntryType:function(){var e=this.supercontroller.currentDomain.getDestination().getId();return _CMCache.getEntryTypeById(e)},onCMCardGridSelect:function(e,i){this.supercontroller.currentDomain.addCheckedCard(t(i))},onCMCardGridDeselect:function(e,i){this.supercontroller.ignoreDeselect||this.supercontroller.currentDomain.removeCheckedCard(t(i))},onCMCardGridBeforeLoad:function(e){this.supercontroller.ignoreDeselect=!0},onCMCardGridLoad:function(e){this.supercontroller.ignoreDeselect=!1;if(!Ext.isEmpty(this.supercontroller.currentDomain))for(var t=this.supercontroller.currentDomain.getCheckedCards(),i=0,n=t.length;i<n;++i){var r=t[i],a=e.store.findBy(function(e){return r.className==_CMCache.getEntryTypeNameById(e.get("IdClass"))&&r.id==e.get("Id")});a>=0&&e.getSelectionModel().select(a,!0)}}}),Ext.define("CMDBuild.view.management.common.filter.CMRelations",{extend:"Ext.panel.Panel",title:CMDBuild.Translation.relations,mixins:{domainGridDelegate:"CMDBuild.view.management.common.filter.CMDomainGridDelegate"},className:void 0,initComponent:function(){this.ignoreDeselect=!1,this.domainGrid=Ext.create("CMDBuild.view.management.common.filter.CMDomainGrid",{border:!1,className:this.className,cls:"cmdb-border-bottom",region:"center"}),this.domainGrid.addDelegate(this),this.cardGrid=Ext.create("CMDBuild.view.management.common.CMCardGrid",{border:!1,split:!0,height:"70%",cls:"cmdb-border-top",frame:!1,multiSelect:!0,selType:"checkboxmodel",region:"south",disabled:!0}),new CMDBuild.controller.management.common.filter.CMRelationsController(this.cardGrid,this),this.layout="border",this.items=[this.domainGrid,this.cardGrid],this.callParent(arguments)},getData:function(){var e=[];return this.domainGrid.store.each(function(t){var i=t.getType();if(null!=i){var n={domain:t.getDomain().getName(),type:i,destination:t.getDestination().getName(),source:t.getSource().getName(),direction:t.getDirection()};"oneof"==i&&(n.cards=t.getCheckedCards()),e.push(n)}}),e},setData:function(e){var t=this,i=e||[];this.domainGrid.load(function(){for(var e=0,n=i.length;e<n;++e){var r=null,a=i[e],o=t.domainGrid.store.findBy(function(e){return e.hasName(a.domain)&&e.getDirection()==a.direction});o>=0&&(r=t.domainGrid.store.getAt(o)),r&&(r.setType(a.type),r.setCheckedCards(a.cards))}})},onCMDomainGridSelect:function(t,i){this.currentDomain=i,e(this,this.currentDomain.getDestination().getId())},onCMDomainGridCheckedColumn:function(e,t,i,n){if(i&&n.setType(t.dataIndex),this.currentDomain){var r=this.currentDomain.getDomain(),a=n.getDomain();if(r.getName()==a.getName()){var o="oneof"==t.dataIndex&&i;this.cardGrid.setDisabled(!o)}}},onCMDomainGridDestinationClassChange:function(t,i){e(this,i)}})}(),Ext.define("Functions",{extend:"Ext.data.Model",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],fields:[{name:"name",type:"string"}]}),Ext.define("CMDBuild.view.management.common.filter.CMFunctions",{extend:"Ext.panel.Panel",uses:["CMDBuild.core.constants.Proxy","CMDBuild.proxy.index.Json"],title:CMDBuild.Translation.functionLabel,bodyCls:"x-panel-body-default-framed cmdb-border-top",bodyStyle:{padding:"5px 5px 0px 5px"},cls:"x-panel-body-default-framed",className:void 0,initComponent:function(){Ext.apply(this,{labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,width:CMDBuild.core.constants.FieldWidths.ADMINISTRATION_BIG}),this.functionsCombo=Ext.create("Ext.form.ComboBox",{fieldLabel:CMDBuild.Translation.functionLabel,store:CMDBuild.global.Cache.requestAsStore(CMDBuild.core.constants.Proxy.UNCACHED,{autoLoad:!0,model:"Functions",proxy:{type:"ajax",url:CMDBuild.proxy.index.Json.functions.readAll,reader:{type:"json",root:CMDBuild.core.constants.Proxy.RESPONSE}},sorters:[{property:CMDBuild.core.constants.Proxy.NAME,direction:"ASC"}]}),name:CMDBuild.core.constants.Proxy.FUNCTION,displayField:CMDBuild.core.constants.Proxy.NAME,valueField:CMDBuild.core.constants.Proxy.NAME,trigger1Cls:Ext.baseCSSPrefix+"form-arrow-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-clear-trigger",hideTrigger1:!1,hideTrigger2:!1,onTrigger2Click:function(){this.setValue("")}}),this.items=[this.functionsCombo],this.callParent(arguments)},setData:function(e){e&&e.length>0?this.functionsCombo.setValue(e[0].name):this.functionsCombo.setValue("")},getData:function(){var e=this.functionsCombo.getValue();return e?[{name:e}]:[]}}),function(){Ext.define("CMDBuild.delegate.common.filter.CMFilterChooserWindowDelegate",{alternateClassName:"CMDBuild.delegate.common.field.CMFilterChooserWindowDelegate",onCMFilterChooserWindowRecordSelect:function(e,t){}}),Ext.define("CMDBuild.view.common.filter.CMFilterChooserWindow",{alternateClassName:"CMDBuild.view.common.field.CMFilterChooserWindow",extend:"CMDBuild.view.management.common.filter.CMFilterWindow",uses:["CMDBuild.core.constants.Proxy","CMDBuild.core.Message","CMDBuild.proxy.Filter"],mixins:{delegable:"CMDBuild.core.CMDelegable"},layout:"border",className:"",firstShowDetectEvent:"activate",saveButtonText:CMDBuild.Translation.ok,abortButtonText:CMDBuild.Translation.cancel,filterTabToEnable:{attributeTab:!0,relationTab:!0,functionTab:!0},constructor:function(){this.mixins.delegable.constructor.call(this,"CMDBuild.delegate.common.field.CMFilterChooserWindowDelegate"),this.callParent(arguments)},setFilter:function(e){this.filter=e,this.filterAttributesPanel.removeAllFieldsets(),this.filterAttributesPanel.setData(this.filter.getAttributeConfiguration()),this.filterRelationsPanel.setData(this.filter.getRelationConfiguration()),this.filterFunctionsPanel.setData(this.filter.getFunctionConfiguration())},buildButtons:function(){var e=this;this.buttons=[{text:e.saveButtonText,handler:function(){e.callDelegates("onCMFilterWindowSaveButtonClick",[e,e.getFilter()])}},{text:e.abortButtonText,handler:function(){e.callDelegates("onCMFilterWindowAbortButtonClick",[e])}}]},buildItems:function(){this.callParent(arguments),this.buildGrid(),this.tabPanel=Ext.create("Ext.tab.Panel",{region:"center",border:!1,items:[]}),this.filterTabToEnable.attributeTab&&this.tabPanel.add(this.filterAttributesPanel),this.filterTabToEnable.relationTab&&this.tabPanel.add(this.filterRelationsPanel),this.filterTabToEnable.functionTab&&this.tabPanel.add(this.filterFunctionsPanel),this.items=[this.grid,this.tabPanel]},buildGrid:function(){var e=this,t=CMDBuild.proxy.Filter.newGroupStore(this.className);Ext.apply(this,{grid:Ext.create("Ext.grid.Panel",{autoScroll:!0,border:!1,cls:"cmdb-border-bottom",frame:!1,height:"40%",region:"north",split:!0,store:t,columns:[{text:CMDBuild.Translation.name,dataIndex:CMDBuild.core.constants.Proxy.NAME,flex:1},{text:CMDBuild.Translation.descriptionLabel,dataIndex:CMDBuild.core.constants.Proxy.DESCRIPTION,flex:1}],dockedItems:[Ext.create("Ext.toolbar.Toolbar",{dock:"top",itemId:CMDBuild.core.constants.Proxy.TOOLBAR_TOP,items:["->",this.includeUsersFiltersCheckbox=Ext.create("Ext.form.field.Checkbox",{boxLabel:CMDBuild.Translation.includeUsersFilters,boxLabelCls:"cmdb-toolbar-item",inputValue:!0,uncheckedValue:!1,checked:!1,scope:this,handler:function(e,t){this.grid.getStore().reload()}})]}),Ext.create("Ext.toolbar.Paging",{dock:"bottom",itemId:CMDBuild.core.constants.Proxy.TOOLBAR_BOTTOM,store:t,displayInfo:!0,displayMsg:"{0} - {1} "+CMDBuild.Translation.of+" {2}",emptyMsg:CMDBuild.Translation.noTopicsToDisplay})],listeners:{itemclick:function(t,i,n,r,a,o){e.callDelegates("onCMFilterChooserWindowRecordSelect",[e,i])}}})}),this.grid.getStore().on("load",function(){this.evaluateSystemFiltersCheckbox(this.includeUsersFiltersCheckbox.getValue())},this)},evaluateSystemFiltersCheckbox:function(e){var t={};t[CMDBuild.core.constants.Proxy.CLASS_NAME]=this.className,e&&CMDBuild.proxy.Filter.read({params:t,loadMask:!1,scope:this,success:function(e,t,i){i=i[CMDBuild.core.constants.Proxy.FILTERS],this.grid.getStore().loadData(i,!0)}})},setWindowTitle:function(){this.title=CMDBuild.Translation.views+" - "+CMDBuild.Translation.filterView}});var e=CMDBuild.Translation.set,t=CMDBuild.Translation.notSet;Ext.define("CMDBuild.view.common.filter.CMFilterChooser",{alternateClassName:"CMDBuild.view.common.field.CMFilterChooser",extend:"Ext.form.FieldContainer",mixins:{filterChooserWindowDelegate:"CMDBuild.delegate.common.field.CMFilterChooserWindowDelegate",filterWindow:"CMDBuild.view.management.common.filter.CMFilterWindowDelegate"},layout:"hbox",className:null,filter:null,considerAsFieldToDisable:!0,filterTabToEnable:{attributeTab:!0,relationTab:!0,functionTab:!0},initComponent:function(){var t=this;this.label=Ext.create("Ext.form.field.Display",{value:e,disabledCls:"cmdb-displayfield-disabled"}),this.chooseFilterButton=Ext.create("Ext.button.Button",{tooltip:CMDBuild.Translation.setFilter,iconCls:"privileges",border:!1,style:{"margin-left":"5px"},scope:t,handler:function(){t.showFilterChooserPicker()}}),this.clearFilterButton=Ext.create("Ext.button.Button",{tooltip:CMDBuild.Translation.clearFilter,iconCls:"privilegesClear",border:!1,scope:t,disabled:!0,handler:function(){t.clearSelection()}}),this.items=[this.label,this.chooseFilterButton,this.clearFilterButton],this.callParent(arguments)},showFilterChooserPicker:function(){var e=this,t=this.className;if(Ext.isEmpty(t))CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,Ext.String.format(CMDBuild.Translation.errors.reasons.CLASS_NOTFOUND,t));else{var i=this.filter||Ext.create("CMDBuild.model.CMFilterModel",{entryType:t,local:!0,name:CMDBuild.Translation.newSearchFilter+" "+_CMUtils.nextId()}),n=_CMCache.getEntryTypeByName(t);_CMCache.getAttributeList(n.getId(),function(n){var r=Ext.create("CMDBuild.view.common.field.CMFilterChooserWindow",{filter:i,attributes:n,className:t,filterTabToEnable:e.filterTabToEnable});r.addDelegate(e),r.show()})}},clearSelection:function(){this.reset()},setClassName:function(e){this.className=e;var t=this.getFilter();t&&t.getEntryType()!=e&&this.reset()},setFilter:function(i){this.filter=i,null==i?(this.label.setValue(t),this.clearFilterButton.disable()):(this.label.setValue(e),this.label.isDisabled()||this.clearFilterButton.enable()),this.doLayout()},reset:function(){this.setFilter(null)},getFilter:function(){return this.filter},getValue:function(){return this.getFilter()},isValid:function(){return!Ext.isEmpty(this.getFilter().getConfiguration())},disable:function(){this.items.each(function(e){e.disable()}),this.callParent(arguments)},enable:function(){this.items.each(function(e){e.enable()}),this.callParent(arguments)},onCMFilterChooserWindowRecordSelect:function(e,t){e.setFilter(t)},onCMFilterWindowSaveButtonClick:function(e,t){this.setFilter(t),e.destroy()},onCMFilterWindowAbortButtonClick:function(e){e.destroy()}})}(),function(){Ext.define("CMDBuild.view.management.dashboard.CMChartPortletForm",{extend:"Ext.form.Panel",uses:["CMDBuild.core.constants.Proxy"],initComponent:function(){this.callParent(arguments),this.configureForChartParameters()},configureForChartParameters:function(){for(var e,t=this.chartConfiguration.getDataSourceInputConfiguration(),i=0,n=t.length;i<n;++i)e=function(e,t){var i={STRING:function(e){var t={classes:function(e){var t=new CMDBuild.view.common.field.CMErasableCombo({plugins:[new CMDBuild.SetValueOnLoadPlugin],name:e.name,fieldLabel:e.name,labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,labelAlign:"right",valueField:"name",displayField:"description",editable:!1,store:_CMCache.getClassesAndProcessesStore(),queryMode:"local",allowBlank:!e.required});return t.setValue(e.defaultValue),t},user:function(e){return new Ext.form.field.Hidden({name:e.name,value:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.USERNAME)})},group:function(e){return new Ext.form.field.Hidden({name:e.name,value:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.DEFAULT_GROUP_NAME)})}};return"function"==typeof t[e.fieldType]?t[e.fieldType](e):i.DEFAULT(e)},INTEGER:function(e){var t=parseInt(e.defaultValue)||null,n={classes:function(e){var t=new CMDBuild.view.common.field.CMErasableCombo({plugins:[new CMDBuild.SetValueOnLoadPlugin],name:e.name,fieldLabel:e.name,labelWidth:CMDBuild.core.constants.FieldWidths.LABEL,labelAlign:"right",valueField:"id",displayField:"description",editable:!1,store:_CMCache.getClassesAndProcessesStore(),queryMode:"local",allowBlank:!e.required});return t.setValue(e.defaultValue),t},lookup:function(e){var n,r=e.lookupType;if("string"!=typeof r)n=i.DEFAULT(e);else{var a={description:e.name,name:e.name,isnotnull:e.required,fieldmode:"write",type:"LOOKUP",lookup:r,lookupchain:_CMCache.getLookupchainForType(r)};n=CMDBuild.Management.FieldManager.getFieldForAttr(a,readonly=!1,skipSubField=!0)}return n.setValue(t),n},user:function(e){return new Ext.form.field.Hidden({name:e.name,value:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.USER_ID)})},group:function(e){return new Ext.form.field.Hidden({name:e.name,value:CMDBuild.configuration.runtime.get(CMDBuild.core.constants.Proxy.DEFAULT_GROUP_ID)})},card:function(e){var i=e[CMDBuild.core.constants.Proxy.REQUIRED],n=e[CMDBuild.core.constants.Proxy.FILTER],r={};Ext.isEmpty(n)||Ext.Object.each(n[CMDBuild.core.constants.Proxy.CONTEXT],function(e,t,i){r["system.template."+e]=t},this);var a=CMDBuild.Management.ReferenceField.build({description:(i?"* ":"")+e[CMDBuild.core.constants.Proxy.NAME],filter:Ext.isEmpty(n)?null:n[CMDBuild.core.constants.Proxy.EXPRESSION],isnotnull:i,meta:r,name:e[CMDBuild.core.constants.Proxy.NAME],referencedIdClass:_CMCache.getEntryTypeByName(e.classToUseForReferenceWidget).get("id")});return!Ext.isEmpty(a)&&Ext.isFunction(a.resolveTemplate)&&a.resolveTemplate(),a.setValue(t),a}};return"function"==typeof n[e.fieldType]?n[e.fieldType](e):i.DEFAULT(e)},DEFAULT:function(e){var t={name:e.name,type:e.type,description:e.name,isnotnull:e.required},i=CMDBuild.Management.FieldManager.getFieldForAttr(t,readonly=!1,skipSubField=!0);if(i)return i.setValue(e.defaultValue),i}};return"function"==typeof i[e.type]?i[e.type](e):i.DEFAULT(e)}(t[i]),this.add(e)},checkStoreLoad:function(e){var t="chart"+this.id,i=Ext.create("CMDBuild.core.RequestBarrier",{id:t,callback:e});this.cascade(function(e){Ext.isEmpty(e)||!Ext.isFunction(e.getStore)||Ext.isEmpty(e.getStore())||Ext.isEmpty(e.getStore().getProxy())||Ext.isEmpty(e.getStore().getProxy().url)||e.getStore().load({callback:i.getCallback(t)})}),i.finalize(t,!0)}})}(),function(){function e(e,t){var i=e.getBgColor()||"#ffffff",n=e.getFgColor()||"#99CC00";return{xtype:"chart",layout:"fit",store:t,insetPadding:25,flex:1,animate:{easing:"elasticIn",duration:1e3},axes:[{type:"gauge",position:"gauge",minimum:e.getMinimum()||0,maximum:e.getMaximum()||1e3,steps:e.getSteps()||20,margin:5}],series:[{type:"gauge",field:e.getSingleSeriesField(),donut:60,colorSet:[n,i]}]}}function t(e,t){var i={};return"vertical"==e.getChartOrientation()?(i.category="bottom",i.values="left",i.type="column"):(i.category="left",i.values="bottom",i.type="bar"),{xtype:"chart",legend:e.withLegend(),store:t,animate:{easing:"elasticIn",duration:1e3},axes:[{type:"Numeric",position:i.values,fields:e.getValueAxisFields(),title:e.getValueAxisLabel(),minimum:0,grid:!0},{type:"Category",position:i.category,fields:e.getCategoryAxisField(),title:e.getCategoryAxisLabel()}],series:[{type:i.type,axis:i.values,tips:{trackMouse:!0,width:200,height:25,renderer:function(e,t){this.setTitle(t.value[0]+": "+t.value[1])}},highlight:!0,xField:e.getCategoryAxisField(),yField:e.getValueAxisFields()}]}}function i(e,t){function i(e,t){return{type:"line",highlight:{size:7,radius:7},axis:"left",xField:e,yField:t,tips:{trackMouse:!0,width:200,height:25,renderer:function(i,n){this.setTitle(i.get(e)+": "+i.get(t))}}}}for(var n=[],r=e.getValueAxisFields()||[],a=e.getCategoryAxisField(),o=0,s=r.length;o<s;++o){var l=r[o];n.push(i(a,l))}return{xtype:"chart",legend:e.withLegend(),store:t,animate:{easing:"elasticIn",duration:1e3},axes:[{type:"Numeric",position:"left",fields:e.getValueAxisFields(),title:e.getValueAxisLabel(),minimum:0,grid:!0},{type:"Category",position:"bottom",fields:e.getCategoryAxisField(),title:e.getCategoryAxisLabel()}],series:n}}function n(e,t){return{xtype:"chart",legend:e.withLegend(),animate:{easing:"elasticIn",duration:2e3},store:t,series:[{type:"pie",field:e.getSingleSeriesField(),showInLegend:!0,highlight:{segment:{margin:5}},label:{field:e.getLabelField(),display:"rotate",contrast:!0,font:"1.3em Arial"},tips:{trackMouse:!0,width:140,height:28,renderer:function(i,n){var r=0;t.each(function(t){r+=t.get(e.getSingleSeriesField())}),this.setTitle(i.get(e.getLabelField())+": "+Math.round(i.get(e.getSingleSeriesField())/r*100)+"%")}}}]}}Ext.define("CMDBuild.view.management.dashboard.CMChartPortlet",{extend:"Ext.app.Portlet",chartConfiguration:null,store:null,initComponent:function(){var e=[];this.withParamsForm=this.chartConfiguration.getDataSourceInputConfiguration().length>0,this.withParamsForm&&(this.editParamsButton=new Ext.button.Button({tooltip:CMDBuild.Translation.common.tooltip.editParameters,enableToggle:!0,iconCls:"edit_form",toggleHandler:function(e,i){i?t.showParamsForm():t.hideParamsForm()}}),e.push(this.editParamsButton)),this.chart=new Ext.panel.Panel({region:"center",layout:"fit",border:!1}),this.tableView=new CMDBuild.view.management.dashboard.CMChartPortletTableView({cls:"cmdb-border-top",region:"south",split:!0,autoScroll:!0,height:0,border:!1,store:Ext.create("Ext.data.JsonStore",{fields:["fake"],data:[]}),columns:[{header:" ",dataIndex:"fake"}]}),this.form=new CMDBuild.view.management.dashboard.CMChartPortletForm({chartConfiguration:this.chartConfiguration,region:"north",frame:!1,bodyCls:"x-panel-body-default-framed cmdb-border-bottom",cls:"cmdb-border-bottom",style:{padding:"0 0 3px 0"},bodyStyle:{padding:"5px 0 0 0"},buttons:[{text:CMDBuild.Translation.load,handler:function(){t.delegate&&t.delegate.onFormLoadButtonClick(this.form)}}]});var t=this;this.reloadButton=new Ext.button.Button({disabled:!0,iconCls:"arrow_refresh",tooltip:CMDBuild.Translation.common.tooltip.reload,handler:function(){t.delegate&&t.delegate.onReloadButtonClick()}}),this.showTableViewButton=new Ext.button.Button({iconCls:"table",tooltip:CMDBuild.Translation.common.tooltip.showData,enableToggle:!0,disabled:!0,toggleHandler:function(e,i){t.tableView.cmFake&&(t.tableView.updateForStore(t.store),t.tableView.setHeight(120));var n=t.getHeight();i?(t.tableView.show(),n+=t.tableView.getHeight()):(n-=t.tableView.getHeight(),t.tableView.hide()),t.adjustSize(n),t.doLayout()}}),e.push(this.showTableViewButton,this.reloadButton),this.chartBuilder=new CMDBuild.view.management.dashboard.CMChartConfigurationReader,this.title=this.chartConfiguration.getDescription()||this.chartConfiguration.getName()||"",this.layout="border",this.height=100,this.items=[this.chart,this.tableView,this.form],this.tbar=e,this.resizable={handles:"n s"},this.callParent(arguments)},renderChart:function(){if(this.chartConfiguration&&this.store&&(this.chart.removeAll(),this.chart.add(this.chartBuilder.buildChart(this.chartConfiguration,this.store)),this.showTableViewButton.enable(),this.reloadButton.enable(),this.doLayout(),!this.chartRendered))try{this.chart.setHeight(250),this.adjustSize(this.getHeight()+250),this.chartRendered=!0}catch(e){_debug("Chart portlet: Rendering issue")}},showParamsForm:function(e){e&&this.editParamsButton?this.editParamsButton.toggle(!0):(this.form.show(),this.adjustSize(this.getHeight()+this.form.getHeight()))},hideParamsForm:function(e){e&&this.editParamsButton?this.editParamsButton.toggle(!1):(this.adjustSize(this.getHeight()-this.form.getHeight()),this.form.hide())},setDelegate:function(e){this.delegate=e},formIsValid:function(){return this.form.getForm().isValid()},formIsLoading:function(){return this.form.isLoading()},checkStoreLoad:function(e){this.form.checkStoreLoad(e)},adjustSize:function(e){this.setSize({height:e,width:this.getWidth()})},findField:function(e){return this.form.getForm().findField(e)}}),Ext.define("CMDBuild.view.management.dashboard.CMChartPortletTableView",{extend:"Ext.grid.Panel",cmFake:!0,updateForStore:function(e){var t=e.model.create(),i=[];for(var n in t.data)i.push({header:n,dataIndex:n,flex:1});this.reconfigure(e,i),this.cmFake=!1}}),Ext.define("CMDBuild.view.management.dashboard.CMDashboardColumn",{extend:"Ext.app.PortalColumn",addChart:function(e,t,i){if(i||e.isActive()){var n=new CMDBuild.view.management.dashboard.CMChartPortlet({chartConfiguration:e,store:t});return this.add(n),n}return null}}),Ext.define("CMDBuild.view.management.dashboard.CMChartWindow",{extend:"CMDBuild.core.window.AbstractModal",initComponent:function(){this.chartPortlet=new CMDBuild.view.management.dashboard.CMChartPortlet({chartConfiguration:this.chartConfiguration,store:this.store,closable:!1,collapsible:!1,draggable:!1,resizable:!1}),Ext.apply(this,{items:[this.chartPortlet],layout:"fit"}),this.callParent(arguments)}}),Ext.define("CMDBuild.view.management.dashboard.CMChartConfigurationReader",{buildChart:function(r,a){var o={gauge:e,bar:t,line:i,pie:n};return"function"==typeof o[r.getType()]?o[r.getType()](r,a):{xtype:"panel"}}})}(),Ext.require("CMDBuild.core.Message"),Ext.define("CMDBuild.controller.common.CMBasePanelController",{alternateClassName:"CMDBuild.controller.CMBasePanelController",constructor:function(e){this.view=e,this.view.on("CM_iamtofront",this.onViewOnFront,this)},callback:function(){CMDBuild.core.LoadMask.hide()},callMethodForAllSubcontrollers:function(e,t){if(!Ext.isEmpty(this.subcontrollers))for(var i in this.subcontrollers){var n=this.subcontrollers[i];n&&"function"==typeof n[e]&&n[e].apply(n,t)}},onViewOnFront:function(e){CMDBuild.log.info("onPanelActivate "+this.view.title,this,e)},validate:function(e){var t=e.getNonValidFields();if(!Ext.isEmpty(e)&&t.length>0){var i=CMDBuild.Translation.errors.invalid_fields+'<ul style="text-align: left;">';for(index in t)i+="<li>"+t[index].fieldLabel+"</li>";return i+="</ul>",CMDBuild.core.Message.error(CMDBuild.Translation.common.failure,i,!1),!1}return!0}}),Ext.define("CMDBuild.controller.common.CMUnconfiguredModPanelController",{extend:"CMDBuild.controller.CMBasePanelController",onViewOnFront:function(){this.view.update("<div>"+arguments[0]+"</div>")}}),Ext.define("CMDBuild.controller.management.classes.StaticsController",{uses:["CMDBuild.core.constants.Global"],singleton:!0,getInvalidAttributeAsHTML:function(e){var t=CMDBuild.controller.management.classes.StaticsController.getInvalidField(e),i=null;return!Ext.Object.isEmpty(t)&&Ext.isObject(t)&&(i="",Ext.Object.each(t,function(e,t,n){if(!Ext.isEmpty(t)){var r=t.getFieldLabel();0==r.indexOf(CMDBuild.core.constants.Global.getMandatoryLabelFlag())&&(r=r.replace(CMDBuild.core.constants.Global.getMandatoryLabelFlag(),"")),i+="<li>"+r+"</li>"}},this),i="<ul>"+i+"</ul>"),i},getInvalidField:function(e){var t=e.getFields().getRange(),i={};return!Ext.isEmpty(t)&&Ext.isArray(t)&&Ext.Array.each(t,function(e,t,n){"CMDBuild.view.common.field.CMDisplayField"!=Ext.getClassName(e)&&"Ext.form.field.Display"!=Ext.getClassName(e)&&(Ext.isFunction(e.isValid)&&!e.isValid()?i[e.name]=e:Ext.isEmpty(i[e.name])||delete i[e.name])},this),i}}),Ext.define("CMDBuild.controller.common.CMDashboardColumnController",{buildChart:function(e,t){var i=CMDBuild.controller.common.chart.CMChartPortletController.buildStoreForChart(e),n=t.addChart(e,i);n&&CMDBuild.controller.common.chart.CMChartPortletController.build(n,e,i,this.dashboard.getId())},onColumnRender:function(e){for(var t,i=0,n=e.charts.length;i<n;++i)(t=this.dashboard.getChartWithId(e.charts[i]))&&Ext.Function.createDelayed(fn=this.buildChart,delay=1,scope=this,[t,e])()}}),Ext.define("CMDBuild.controller.common.chart.CMChartPortletControllerPreviewStrategy",{uses:["CMDBuild.proxy.dashboard.Chart"],doRequest:function(e,t){function i(e){n.store.loadData(e),o=!0}var n=e,r=(n.chartConfiguration.getId(),n.readParamsFromForm()),a=n.chartConfiguration.getDataSourceName(),o=!1;CMDBuild.proxy.dashboard.Chart.readForPreview({params:{dataSourceName:a,params:Ext.encode(r)},loadMask:!1,scope:this,success:function(e,t,n){i((n.response||{}).rows||[])},callback:function(){t&&"function"==typeof t&&t(o)}||Ext.emptyFn})}}),Ext.define("CMDBuild.controller.common.chart.CMChartPortletControllerDefaultStrategy",{uses:["CMDBuild.proxy.dashboard.Chart"],doRequest:function(e,t){function i(e){n.store.loadData(e),s=!0}var n=e,r=n.dashboardId,a=n.chartConfiguration.getId(),o=n.readParamsFromForm(),s=!1;CMDBuild.proxy.dashboard.Chart.read({params:{dashboardId:r,chartId:a,params:Ext.encode(o)},loadMask:!1,scope:this,success:function(e,t,n){var r=n.response||{};i(r=r.rows||[])},callback:function(){t&&"function"==typeof t&&t(s)}||Ext.emptyFn})}}),Ext.define("CMDBuild.controller.common.chart.CMChartPortletController",{uses:["CMDBuild.proxy.dashboard.Chart"],statics:{buildStoreForChart:function(e){var t=[];return e.getSingleSeriesField()?(t=[e.getSingleSeriesField()],e.getLabelField()&&(t=t.concat(e.getLabelField()))):t=[e.getCategoryAxisField()].concat(e.getValueAxisFields()),Ext.create("Ext.data.JsonStore",{fields:t,data:[]})},build:function(e,t,i,n){var r=new CMDBuild.controller.common.chart.CMChartPortletControllerDefaultStrategy;return new CMDBuild.controller.common.chart.CMChartPortletController(e,t,i,n,r)},buildForPreview:function(e,t,i,n){var r=new CMDBuild.controller.common.chart.CMChartPortletControllerPreviewStrategy;return new CMDBuild.controller.common.chart.CMChartPortletController(e,t,i,n,r)}},constructor:function(e,t,i,n,r){this.dashboardId=n,this.view=e,this.chartConfiguration=t,this.store=i,this.strategy=r,this.view.setDelegate(this),t.isAutoload()?this.onFormLoadButtonClick():this.view.showParamsForm(toggle=!0)},readParamsFromForm:function(){for(var e,t,i={},n=this.chartConfiguration.getDataSourceInputConfiguration(),r=0,a=n.length;r<a;++r)e=n[r],(t=this.view.findField(e.name))&&(i[e.name]=t.getValue());return i},doRequest:function(e){var t=this;e=Ext.Function.createSequence(e||Ext.emptyFn,function(){t.unmaskView()}),this.maskView(),this.strategy.doRequest(this,e)},maskView:function(){var e=this.view.getEl();e&&e.mask(CMDBuild.Translation.common.loading)},unmaskView:function(){var e=this.view.getEl();e&&e.unmask()},onReloadButtonClick:function(e){var t=this;this.view.checkStoreLoad(function(){t.view.formIsValid()?t.doRequest(e):t.view.showParamsForm(toggle=!0)})},onFormLoadButtonClick:function(){var e=this;this.onReloadButtonClick(function(t){!e.view.chartRendered&&t&&e.view.renderChart(),0==e.chartConfiguration.getDataSourceInputConfiguration().length&&e.view.hideParamsForm(toggle=!0)})}}),Ext.define("CMDBuild.bim.data.CMBIMProjectModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"lastCheckin",type:"auto"},{name:"active",type:"boolean"},{name:"cardBinding",type:"int"}]}),Ext.define("CMDBuild.bim.data.CMBimLayerModel",{extend:"Ext.data.Model",fields:[{name:"className",type:"string"},{name:"description",type:"string"},{name:"active",type:"boolean"},{name:"root",type:"boolean"},{name:"exported",type:"boolean"},{name:"container",type:"boolean"},{name:"rootreference",type:"string"}]});