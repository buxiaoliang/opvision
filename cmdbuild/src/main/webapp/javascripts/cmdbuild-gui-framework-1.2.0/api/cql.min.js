function Configurator(output){function cleanString(e){if(!e)return e;var t=new RegExp("'"+QUOTE,"g"),i=e.replace(t,"'");return t=new RegExp(QUOTE+"'","g"),i=i.replace(t,"'"),t=new RegExp('"'+QUOTE,"g"),i=i.replace(t,'"'),t=new RegExp(QUOTE+'"',"g"),i=i.replace(t,'"'),t=new RegExp(QUOTE,"g"),i=i.replace(t,"'")}var HOOKMANAGERNOTDEFINED="Non e' stato definito un manager Cql",QUOTE="CMDBUILD_QUOTE";this.debug=!1,this.output=output,this.manager={xa:{isVariableManager:!0,getValue:function(e,t,i,a){var r=t.split(".");2==r.length&&"Id"==r[1]?i.apply(a,[4444]):i.apply(a,["xa__"+e+" "+t])}},user:{isVariableManager:!0,getValue:function(e,t,i,a){var r=$.Cmdbuild.authentication.getAuthenticationToken();$.Cmdbuild.utilities.proxy.getSession(r,function(e){var t={page:0,start:0,limit:1,filter:{attribute:{simple:{attribute:"Username",operator:"equal",value:[e[0].username]}}},filterType:"attribute"};$.Cmdbuild.utilities.proxy.getCardList("User",t,function(e,t){e.length&&i.apply(a,[e[0]._id])},this)},this,[])}},client:{isVariableManager:!0,getValue:function(e,t,i,a){var r=$.Cmdbuild.elementsManager.getElement(e),n={};$.Cmdbuild.elementsManager.getParams(r,n);var s=$.Cmdbuild.dataModel.forms[e],l=t.split(".");if(l.length>1&&"DESCRIPTION"==l[1].toUpperCase()){var o={field:l[0],form:e};s.getClientDescription(o,function(e){i.apply(a,[e])},this)}else{var u=s.getValue({field:l[0],form:e});i.apply(a,[u])}}},server:{isVariableManager:!0,getValue:function(e,t,i,a){try{var r=$.Cmdbuild.dataModel.forms[e],n=t.split(".");if(n.length>1&&"DESCRIPTION"==n[1].toUpperCase()){var s={field:n[0],form:e};r.getServerDescription(s,function(e){i.apply(a,[e])},this)}else{var l=$.Cmdbuild.dataModel.getValue(e,n[0]);i.apply(a,[l])}}catch(o){console.log("Error on server variable "+e+" "+t+" "+o.message),i.apply(a,[void 0])}}},cql:{isVariableManager:!1,getValue:function(e,t,i,a){if(-1!=t.indexOf($.Cmdbuild.global.CQLUNDEFINEDVALUE))return void i.apply(a,[void 0]);t=cleanString(t);var r={filter:{CQL:t}},n={success:function(e){e=e,i.apply(a,[e])},fail:function(e){i.apply(a,[[]])}};$.Cmdbuild.utilities.proxy.getCqlResult(r,n,this)}},js:{isQuotedManager:!0,isVariableManager:!1,getValue:function(e,t,i,a){var r=new RegExp($.Cmdbuild.global.CQLUNDEFINEDVALUE,"g"),n=t.replace(r,"undefined"),s=this.safeJSEval(n);i.apply(a,[s])},safeJSEval:function(stringTOEvaluate){stringTOEvaluate=cleanString(stringTOEvaluate);var resultOfEval="";output({type:"debug",msg:"***********safeJSEval "+stringTOEvaluate});try{resultOfEval=eval(stringTOEvaluate)}catch(e){try{resultOfEval=eval(stringTOEvaluate.replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,""))}catch(ee){output({type:"debug",msg:"Error evaluating javascript expression "+stringTOEvaluate})}}return output({type:"debug",msg:"***********safeJSEval evaluated "+resultOfEval}),resultOfEval}}},this.changed=function(e,t){var i={form:e,field:t};$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldRefresh?$.Cmdbuild.custom.commands.fieldRefresh(i):$.Cmdbuild.standard.commands.fieldRefresh(i)},this.cleanString=function(e){return cleanString(e)}}function cqlEvaluate(e,t,i){var a=function(e){console.log("cql.manager: "+e.msg)},r=new Configurator(a),n=new CqlManager(r),s={};for(var l in e.meta)n.lexer.analize(e.meta[l]),s[l]=new treeObject(r,n.lexer.tree,null,e.form);n.lexer.analize(e.filter);var o=new treeObject(r,n.lexer.tree,s,e.form);o.resolve(!1,function(e){e=r.cleanString(e),t.apply(i,[e])},this)}function CqlManager(e){this.configurator=e,this.lexer=new lexer(this.configurator),this.commandsTable=new commandsTable(this.configurator),this.metaTable=new commandsTable(this.configurator),this.variablesTable=new variablesTable(this.configurator),this.compile=function(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.filter&&("string"==typeof a.filter&&(a.filter=JSON.parse(a.filter)),(a.filter.text||a.filter.expression)&&this.compileAttribute(e,a))}this.variablesTable.generate(e,this.commandsTable)},this.compileAttribute=function(e,t){var i=t.filter.text;if(i||(i=t.filter.expression),t.filter&&i){this.lexer.analize(i),this.commandsTable.prepareEntry(e,t.name);var a=this.lexer.tree.slice();for(var r in t.filter.params){this.lexer.analize(t.filter.params[r]);var n=r.split("."),s=n[n.length-1];this.commandsTable.pushMeta(e,t.name,s,this.lexer.tree)}this.commandsTable.push(e,t.name,a)}},this.onFilterChanged=function(e){alert(e.form+" "+e.field)},this.fieldChanged=function(e,t){this.variablesTable.fieldChanged(e,t)},this.resolve=function(t,i,a,r){this.commandsTable.resolve(t,i,function(t){t=e.cleanString(t),a.apply(r,[t])},this)},this.isUndefined=function(e){return-1!=e.indexOf($.Cmdbuild.global.CQLUNDEFINEDVALUE)}}function lexer(e){this.configurator=e,this.CQLSINTAXERRORBADFORMATTEDCOMMAND="Cql sintax error bad formatted command",this.tree=[],this.stack=[],this.stackPointer=0,this.originalCommand="",this.analize=function(e){if(this.stackPointer=0,this.tree=[],this.stack=[this.tree],this.originalCommand=e,this.stackStrings=[],this._analize(" "+e,!1),this.trimFirstSpaceOnTree(this.tree),0!=this.stackPointer){console.log(this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand);var t=new Error({message:this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand});throw t}},this.trimFirstSpaceOnTree=function(e){if(e.length>0&&"object"==typeof e[0]&&"text"==e[0].type){e[0].value;e[0].value=e[0].value.substr(1)}},this._analize=function(e,t){if(""!=e){this.stackStrings.push(e);var i=e.indexOf("{"),a=e.indexOf("}");if(this.stackPointer<0){console.log(this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+e+" "+this.originalCommand,this.stackStrings);var r=new Error({message:this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand});throw r}if(-1==a&&-1==i){var n=e;this.pushToken(n,t)}else if(i>a||-1==i){var n=e.substr(0,a);this.pushToken(n,t),this.stackPointer+="{"===e.substr(a+1,1)?0:-1,this._analize(e.substr(a+1),!1)}else if(0==i)this._analize(e.substr(i+1),!0);else{var n=e.substr(0,i),s=this.stack[this.stackPointer];this.pushToken(n,t),s.push([]),this.stackPointer+=1,this.stack[this.stackPointer]=s[s.length-1],this._analize(e.substr(i),!1)}}},this.pushToken=function(e,t){var i=this.stack[this.stackPointer];if(""!=e){var a=e.split(":");2==a.length&&t?i.push({type:"object",manager:a[0],value:a[1]}):i.push({type:"text",value:e})}}}function variablesTable(e){this.configurator=e,this.table={},this.generate=function(e,t){this.table[e]=[];var i=t.getForm(e);if(i)for(var a in i){var r=t.getTree(e,a),n=t.getMeta(e,a);if(!r)return;this.generateVariables(e,a,r.getTree(),n)}},this.getField=function(e,t,a){for(i=0;i<e.length;i++){var r=e[i];if(r.form==t&&r.field==a)return r}return null},this.generateVariables=function(e,t,i,a){for(var r=0;r<i.length;r++)if(void 0==i[r].type)this.generateVariables(e,t,i[r],a);else if("object"==i[r].type){var n=i[r].value.split(".");this.getField(this.table[e],e,t);this.table[e].push({form:e,field:t,manager:i[r].manager,variable:n[0]})}if(a)for(var s in a)this.generateVariables(e,t,a[s].getTree(),null)},this.fieldChanged=function(e,t){var i={};if(!this.table[e])return void console.log("No dependancies for "+e+"."+t);for(var a=0;a<this.table[e].length;a++){var r=this.table[e][a];r.variable!=t||i[r.field]||(i[r.field]=!0,this.isVariableManager(r.manager)||this.fieldChanged(e,r.field))}for(var n in i)this.configurator.changed(e,n)},this.debug=function(){for(var e in this.table)for(var t=0;t<this.table[e].length;t++){var i=this.table[e][t];this.configurator.output({type:"debug",msg:i.form+"|"+i.field+"|"+i.variable+"|"+i.manager})}},this.isVariableManager=function(e){return this.configurator.manager[e].isVariableManager}}function commandsTable(e){this.configurator=e,this.table={},this.prepareEntry=function(e,t){this.table[e]||(this.table[e]={}),this.table[e][t]={}},this.push=function(t,i,a){this.table[t][i].tree=new treeObject(e,a,this.getMeta(t,i),t)},this.pushMeta=function(t,i,a,r){this.table[t][i].meta||(this.table[t][i].meta={}),this.table[t][i].meta[a]=new treeObject(e,r,this.getMeta(t,i),t)},this.getForm=function(e){return this.table[e]?this.table[e]:void 0},this.getTree=function(e,t){return this.table[e]&&this.table[e][t]?this.table[e][t].tree:null},this.getMeta=function(e,t){return this.table[e]&&this.table[e][t]?this.table[e][t].meta:null},this.resolve=function(e,t,i,a){this.getTree(e,t)?this.getTree(e,t).resolve(!1,function(e){i.apply(a,[e])},this):i.apply(a,[""])},this.debug=function(){for(var e in this.table)for(var t in this.table[e]){var i=e+"|"+t;i+="|"+this.getTree(e,t).write(),this.configurator.output({type:"debug",msg:i});for(var a in this.getMeta(e,t)){var i=e+" "+t+"-->meta-->"+a;i+="|"+this.getMeta(e,t)[a].write(),this.configurator.output({type:"debug",msg:i})}}},this.isVariableManager=function(e){return this.configurator.manager[e].isVariableManager}}function treeObject(e,t,i,a){this.configurator=e,this.tree=t,this.meta=i,this.form=a,this.getTree=function(){return this.tree},this.write=function(){return this.writeTree(this.tree)},this.writeTree=function(e){for(var t="",i=0;i<e.length;i++)t+=void 0==e[i].type?"+"+this.writeTree(e[i]):"object"==e[i].type?"+["+e[i].manager+"]"+e[i].value:"+"+e[i].value;return t},this.resolve=function(e,t,i){if(null==this.tree||this.tree.length<=0)return void t.apply(i,[""]);try{var a=this.tree.slice();this.resolveTree(a,"",e,function(e){t.apply(i,[e])},this)}catch(r){t.apply(i,[void 0])}},this.quote=function(e,t){var i=t?"CMDBUILD_QUOTE":"";return i+e+i},this.resolveTree=function(e,t,i,a,r){if(e.length<=0)return void a.apply(r,[t]);var n=e[0];if(e.splice(0,1),n.manager&&this.configurator.manager[n.manager].isQuotedManager===!0&&(i=!0),void 0==n.type){var s=n.slice();this.resolveTree(s,"",i,function(n){this.resolveTree(e,t+n,i,a,r)},this)}else if("object"==n.type){var l="",o=n.value.split(".");this.isInMyMeta(o[0])?this.resolveMeta(o[0],i,function(s){void 0==s&&(s=$.Cmdbuild.global.CQLUNDEFINEDVALUE,this.resolveTree(e,t+s,i,a,r)),this.evaluate(n.manager,this.form,s,function(s){var l=n.value.split(".");void 0===s&&(s=$.Cmdbuild.global.CQLUNDEFINEDVALUE),l.length>1&&s.length>0&&(s=s[0][l[1]]),this.resolveTree(e,t+this.quote(s,i),!1,a,r)},this)},this):(l=n.value,this.evaluate(n.manager,this.form,l,function(n){void 0===n&&(n=$.Cmdbuild.global.CQLUNDEFINEDVALUE),this.resolveTree(e,t+this.quote(n,i),!1,a,r)},this))}else this.resolveTree(e,t+n.value,i,a,r)},this.isInMyMeta=function(e){return this.meta?this.meta&&this.meta[e]:!1},this.resolveMeta=function(e,t,i,a){this.meta[e].resolve(t,function(e){i.apply(a,[e])},this)},this.evaluate=function(e,t,i,a,r){this.configurator.manager[e]?this.configurator.manager[e].getValue(t,i,function(e){a.apply(r,[e])},this):output(HOOKMANAGERNOTDEFINED+": "+e)}}function configurator(e){var t="Non e' stato definito un manager Cql";this.debug=!1,this.manager={xa:{getValue:function(i,a){e(t+": xa")}},client:{getValue:function(i,a){e(t+": client")}},server:{getValue:function(i,a){e(t+": server")}}},this.changed=function(e){},this.output=function(t){e(t)}}
//# sourceMappingURL=cql.min.js.map