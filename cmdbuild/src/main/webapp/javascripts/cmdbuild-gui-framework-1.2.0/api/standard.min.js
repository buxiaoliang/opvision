!function(e){var t={tab:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+i.form).tabs("option","active",t.activeTab)},navigate:function(t){try{var i=e.Cmdbuild.elementsManager.getElement(t.form),a=e.Cmdbuild.utilities.getFields(i);a&&a.fields&&(a.form=t.form,e.Cmdbuild.dataModel.putFormFields(a)),e.Cmdbuild.utilities.include(i,this.navigateIncludeCB,{xmlForm:i,param:t},void 0)}catch(n){console.log("Commands navigate "+n.message,t,n.stack)}},navigateIncludeCB:function(t){var i=t.xmlForm,a=t.param;e.Cmdbuild.elementsManager.getParams(i,a);var n=e.Cmdbuild.elementsManager.isObserving(i,a.form),d=e.Cmdbuild.standard[a.type]||e.Cmdbuild.custom[a.type];if(!a.type||!d)throw new e.Cmdbuild.errorsManager.getError({message:e.Cmdbuild.errorsManager.CMERROR,type:e.Cmdbuild.errorsManager.PARAMNOTCORRECT,param:"type",method:"navigate",element:a.form});if(!n||"true"===a.fromObserving){var r=e.Cmdbuild.dataModel.resolveVariables(a);try{var s=d,o=void 0;e.Cmdbuild.dataModel.forms[a.form]?o=e.Cmdbuild.dataModel.forms[a.form]:(o=new s,e.Cmdbuild.dataModel.forms[a.form]=o),e.Cmdbuild.standard.contextStack.pop(r),e.Cmdbuild.standard.contextStack.push(r),o.init(r)}catch(l){console.log(l,l.stack)}}},advance:function(t){function i(i){if(t.dialog)return void e.Cmdbuild.standard.commands.dialogClose(t);var a=e.Cmdbuild.dataModel.model[t.form].data;return a._id||(a._id=i._id,a._type=i._type),t.navigationForm?void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer}):void e.Cmdbuild.utilities.proxy.getActivity(a._type,a._id,function(i){if(0!=i.length)e.Cmdbuild.standard.commands.navigate({form:t.form,container:t.container,className:a._type,cardId:a._id,activityInstanceId:i[0]._id});else if(t.tab){var n=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+n.tabbedForm).tabs("option","active",t.tab)}},this)}try{t.formObject=e.Cmdbuild.dataModel.forms[t.form],e.Cmdbuild.dataModel.change(t,{success:function(){e.Cmdbuild.dataModel.flush(t,i)},scope:this})}catch(a){e.Cmdbuild.errorsManager.popup(a)}},save:function(t){function i(i){return t.dialog?void e.Cmdbuild.standard.commands.dialogClose(t):void 0}try{t.ldap&&e.Cmdbuild.ldap.write({form:t.form,ldapDescriptor:t.ldap}),t.formObject=e.Cmdbuild.dataModel.forms[t.form],e.Cmdbuild.dataModel.change(t,{success:function(){return e.Cmdbuild.dataModel.flush(t,i),t.navigationForm?void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer}):void 0},scope:this})}catch(a){e.Cmdbuild.errorsManager.popup(a)}},cancel:function(t){try{var i=e.Cmdbuild.elementsManager.getElement(t.form);if(e.Cmdbuild.elementsManager.getParams(i,t),t.backend=e.Cmdbuild.utilities.getBackend(t.backend),t.formObject=e.Cmdbuild.dataModel.forms[t.form],e.Cmdbuild.dataModel.reset(t),t.navigationForm)return void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer})}catch(a){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.commands.cancel"),a}},dialogExec:function(t){$select=e("#"+t.toExecCommand),$select.trigger("itemselectedfromgrid"),e("#"+t.dialog).dialog("close")},dialogClose:function(t){if(t.dialog){var i=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+i.dialog).dialog("close")}},dialogCancel:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);i.form&&i.selection&&e.Cmdbuild.standard.grid.cancelSelection(i.form),e("#"+i.dialog).dialog("close")},fieldChanged:function(t){var i=e("#"+t.id),a=i.attr("name");a&&""!=a||(a=i.attr("fieldName"),e.Cmdbuild.errorsManager.warn("Attribute fieldName is deprecated. Use name."));var n=i.attr("form");n&&""!=n||(n=i.attr("formName"),e.Cmdbuild.errorsManager.warn("Attribute formName is deprecated. Use form.")),e.Cmdbuild.CqlManager.fieldChanged(n,a)},deleteRow:function(t){var i=e.Cmdbuild.dataModel.forms[t.form],a=i.getBackend();a.deleteRow({form:t.form})},attach:function(t){var i=e.Cmdbuild.dataModel.forms[t.form],a=i.getBackend(),n=[],d=e("#"+t.description).val(),r=e("#"+t.category).val(),s=document.getElementById(t.id).files[0],o=e("#"+t.id).val();if(s||n.push({field:e("#"+t.id).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),""==e.trim(d)&&n.push({field:e("#"+t.description).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),""==e.trim(r)&&n.push({field:e("#"+t.category).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),n.length>0)return void e.Cmdbuild.errorsManager.popupOnRequestFields(n);var l=new FileReader;l.readAsText(s),l.onload=function(i){var n=new FormData;n.append("file",s),n.append("attachment",new Blob([JSON.stringify({_description:d,_category:r})],{type:"application/json"})),e("#"+t.description).val(""),e("#"+t.category).val(""),e("#"+t.id).val(""),a.addRow({form:param.form,row:{description:d,category:r,document:o,formdata:n}})}},fieldRefresh:function(t){var i=e.Cmdbuild.dataModel.forms[t.form];i.refreshField(t)},reportParamsSend:function(t){try{t.type="form",e.Cmdbuild.dataModel.change(t,{success:function(){var i=e.Cmdbuild.dataModel.getValues(t.form),a={};for(var n in i){var d=n.replace(/_PT_/g,".");d=d.replace(/_SP_/g," "),a[d]=i[n]}var r=e.Cmdbuild.utilities.getBackend(t.backend);r.showReport(a)},scope:this})}catch(i){e("#"+t.dialog).dialog("close"),e.Cmdbuild.errorsManager.log(i),e.Cmdbuild.errorsManager.popup(i)}e("#"+t.dialog).dialog("close")},requestReportParameters:function(t){var i=e.Cmdbuild.utilities.getBackend(t.backend);e.Cmdbuild.utilities.setAttributesInteractivity(t.attributes);for(var a=0;a<t.attributes.length;a++)t.attributes[a].name=t.attributes[a].name.replace(/[.]/g,"_PT_"),t.attributes[a].name=t.attributes[a].name.replace(/[ ]/g,"_SP_");i.data.attributes=t.attributes,e.Cmdbuild.standard.commands.navigate(t)},printReport:function(t){var i=e.Cmdbuild.elementsManager.getElement(t.form),a={};e.Cmdbuild.elementsManager.getParams(i,a);var n=e.Cmdbuild.utilities.getBackend(a.backend),d=e.Cmdbuild.dataModel.getValue(t.form,"id"),r=e.Cmdbuild.dataModel.getValue(t.form,"type");t.typeReport=r,t.id=d,t.form=t.formDialog,n.requestReport(t)},saveattachments:function(e){this.dialogClose(e)},deleteMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.forms[i.formData],n=a.getBackend();n.deleteMail(i),this.refreshGrid(i,function(){})},replyMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);e.Cmdbuild.standard.commands.navigate({form:i.navigationForm,dialog:i.navigationDialog})},refreshMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.forms[i.formData],n=e.Cmdbuild.dataModel.getValues(i.form),d=a.getBackend().widgets;e.Cmdbuild.dataModel.detachObserving(),e.Cmdbuild.widgets.refreshTemplate(i.formData,d,n.fromTemplate),e.Cmdbuild.dataModel.attachObserving();var r=this;this.TM=setTimeout(function(){r.refreshGrid(i,function(){})},500)},refreshGrid:function(t,i,a){var n=e.Cmdbuild.dataModel.forms[t.form];n.paginationSettings.firstRow=0;var d=e("#"+t.form).DataTable();d.ajax.reload(function(e){i&&i.apply(a)})},synchronizeMails:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.getWidgetWindow(i.widgetName),n=e.Cmdbuild.standard.grid.getChecked(i.form),d=a.data.type,r=a.data.templates,s=e.Cmdbuild.standard.widgetDiv.widgetName(d);e.Cmdbuild.widgets[s]&&e.Cmdbuild.widgets[s].setSynchronization&&e.Cmdbuild.widgets[s].setSynchronization(r,n,!0,!1);for(var o=0;o<r.length;o++){var l=r[o];"true"==n[l._id]&&e.Cmdbuild.widgets.ManageEmail.cqlResolve(i.formData,l,function(){},this)}e("#"+i.dialog).dialog("close")},noSynchronizeMails:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.getWidgetWindow(i.widgetName),n=a.data.templates,d=a.data.type,r=e.Cmdbuild.standard.widgetDiv.widgetName(d);e.Cmdbuild.widgets[r]&&e.Cmdbuild.widgets[r].setSynchronization&&e.Cmdbuild.widgets[r].setSynchronization(n,{},!1,!1),e("#"+i.dialog).dialog("close")},downloadAttachment:function(t){var i,a=e.Cmdbuild.dataModel.resolveVariable(t.className),n=e.Cmdbuild.dataModel.resolveVariable(t.cardId),d=e.Cmdbuild.dataModel.resolveVariable(t.attachmentName),r=e.Cmdbuild.dataModel.resolveVariable(t.attachmentId);e.Cmdbuild.dataModel.isAClass(a)?i=e.Cmdbuild.global.getApiUrl()+"classes/"+a+"/cards/"+n:e.Cmdbuild.dataModel.isAProcess(a)&&(i=e.Cmdbuild.global.getApiUrl()+"processes/"+a+"/instances/"+n);var s=i+"/attachments/"+r+"/"+encodeURIComponent(d)+"?CMDBuild-Authorization="+e.Cmdbuild.authentication.getAuthenticationToken();window.location.replace(s)},openreport:function(t){var i=new e.Cmdbuild.standard.openreport;i.init(t)}};e.Cmdbuild.standard.commands=t}(jQuery),function(e){var t={grid:{pagelength:10},reference:{displayAttribute:"Description",optionsLimit:20,sort:{field:"Description",direction:"ASC"}},widgets:{customform:{disableinlineediting:!1}}};e.Cmdbuild.standard.configuration=t}(jQuery),function(e){var t=function(){this.param=void 0,this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i="";i+=e.Cmdbuild.elementsManager.insertChildren(t);var a=e.Cmdbuild.utilities.getWidgetsFromXML(t),n=[];a&&a.length&&e.each(a,function(e,t){n.push(t)}),n&&n.length&&(e.Cmdbuild.widgets.prepareFields(n),i+=e.Cmdbuild.standard.widgetDiv.getWidgetDiv({container:this.param.container,form:this.param.form,readOnly:this.param.readonly,widgets:n}));var d=e("#"+this.param.container)[0];d.innerHTML=i,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(r){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),r}}};e.Cmdbuild.standard.div=t}(jQuery),function(e){var t={canvas3d:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div  "+a+"></div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"canvas3d",id:n}),i},dialog:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div"+a+"></div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"dialog",id:n}),i},spinner:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d=e.Cmdbuild.elementsManager.getEvent("onChange",t),r=e.Cmdbuild.elementsManager.getParams(t),s=r.value,o="<input  "+a+" name='value' valueType='spinner' value='"+s+"'></input>",l=e.Cmdbuild.elementsManager.getXmlElementId(t);e.Cmdbuild.scriptsManager.push({script:"spinner",id:l,spin:d,value:s,min:r.min?r.min:1,max:r.max?r.max:1e5});var i=e.Cmdbuild.elementsManager.wrapInFormRow(n,o,"input");return i},checkbox:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=t.getAttribute("text");a=a?a:"false";var n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),r="";"true"==a&&(r=" checked ");var s=e.Cmdbuild.elementsManager.insertLabel(t),o=t.getAttribute("formName"),l=" formName='"+o+"' ",u="<input type='checkbox'"+r+n+l+d+"value='"+a+"' />",c=e.Cmdbuild.elementsManager.wrapInFormRow(s,u,"checkbox");return e.Cmdbuild.scriptsManager.push({script:"checkbox",id:i}),c},button:function(t){var i=e.Cmdbuild.elementsManager.getParams(t),a=e.Cmdbuild.dataModel.resolveVariables(i);if(void 0!==a.condition&&!a.condition)return"";var n="";n+=e.Cmdbuild.elementsManager.insertLabel(t);var d=e.Cmdbuild.elementsManager.getText(t),r=e.Cmdbuild.elementsManager.getCommonAttributes(t),s=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),o="true"==a.readOnly?" disabled ":"";n+="<input type='button'"+r+s+o+" value='"+d+"' />",n+=e.Cmdbuild.elementsManager.insertReturn(t);var l=e.Cmdbuild.elementsManager.getXmlElementId(t);return i&&e.Cmdbuild.dataModel.prepareCallerParameters(l,i),e.Cmdbuild.scriptsManager.push({script:"button",id:l}),n},upload:function(t){var i=e.Cmdbuild.elementsManager.insertLabel(t),a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onChange"),r=a+": <input type='file' name='filename'"+n+d+" />";r+=e.Cmdbuild.elementsManager.insertReturn(t);var s=e.Cmdbuild.elementsManager.wrapInFormRow(i,r,"upload");return s},iframe:function(t){var i=e.Cmdbuild.utilities.escapeHtml(t.getAttribute("src")),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<iframe src='"+i+"'"+a+"/>";return n+=e.Cmdbuild.elementsManager.insertReturn(t)},title:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<h2 "+n+a+" >"+i+"</h2>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},p:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<span "+n+a+" >"+i+"</span>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},span:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<span "+n+a+" >"+i+"</span>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},h1:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h1 "+a+">"+i+"</h1>";return n},h2:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h2 "+a+">"+i+"</h2>";return n},h3:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h3 "+a+">"+i+"</h3>";return n},br:function(e){var t="<br />";return t},img:function(t){var i="",a=t.getAttribute("src");if(!a){var n=e.Cmdbuild.elementsManager.getParams(t),d=e.Cmdbuild.dataModel.resolveVariables(n);a=d.src}var r=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<img"+r+"src='"+a+"' />",i+=e.Cmdbuild.elementsManager.insertReturn(t)},input:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d="",r=t.getAttribute("interactivity"),s=r&&r==e.Cmdbuild.global.READ_ONLY,o=t.getAttribute("maxlength");null!==o&&(a+=" maxlength='"+o+"' "),s?(d=i,d+="<input type='hidden'"+a+"value='"+(i?i:"")+"' />"):d="<input type='text'"+a+"value='"+i+"' />";var l=e.Cmdbuild.elementsManager.wrapInFormRow(n,d,"input",s);return l},integer:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d="",r=t.getAttribute("interactivity"),s=r&&r==e.Cmdbuild.global.READ_ONLY;s?(d+=i,d+="<input type='hidden'"+a+"value='"+(i?i:"")+"' />"):d+="<input type='text'"+a+"value='"+i+"' />";var o=e.Cmdbuild.elementsManager.wrapInFormRow(n,d,"integer",s),l=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"integer",id:l}),o},date:function(t){var i=e.Cmdbuild.elementsManager.getCommonAttributes(t),a=e.Cmdbuild.elementsManager.getXmlElementId(t),n=e.Cmdbuild.elementsManager.getParams(t),d=t.getAttribute("text");d=d||"",d=e.Cmdbuild.utilities.convertDateDB2GUI(d,n.type),e.Cmdbuild.scriptsManager.push({script:"date",id:a,type:n.type});var r,s=e.Cmdbuild.elementsManager.insertLabel(t),o=t.getAttribute("interactivity"),l=o&&o==e.Cmdbuild.global.READ_ONLY;l?(r=d,r+="<input isDate='"+n.type+"' type='hidden'"+i+"value='"+(d?d:"")+"' />"):r="<input isDate='"+n.type+"' type='text'"+i+"value='"+d+"' />";var u=e.Cmdbuild.elementsManager.wrapInFormRow(s,r,"date",l);return u},textarea:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=e.Cmdbuild.elementsManager.getParams(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.elementsManager.insertLabel(t),r="",s=a&&a.isHtml?!0:!1,o=t.getAttribute("rows"),l=t.getAttribute("cols"),u="";u=!s&&a&&a.rawText?a.rawText.trim():e.Cmdbuild.elementsManager.getText(t);var c=t.getAttribute("interactivity"),m=c&&c==e.Cmdbuild.global.READ_ONLY,g=t.getAttribute("maxlength");if(null!==g&&(n+=" maxlength='"+g+"' "),m){if(s){var h=document.createElement("div");h.innerHTML=u,h.childNodes.length&&(r='<div class="textareaReadOnly">'+h.childNodes[0].nodeValue+"</div>")}else r=u.replace(/(?:\r\n|\r|\n)/g,"<br />");r+="<textarea class='hiddentextarea'>"+(u?u:"")+"</textarea>"}else r="<textarea  cols='"+l+"' rows='"+o+"' type='text'"+n+"value='"+u+"'>"+u+"</textarea>";var f=e.Cmdbuild.elementsManager.wrapInFormRow(d,r,"textarea",m);return s&&(a={script:"htmlText",id:i},e.Cmdbuild.scriptsManager.push(a)),f},lookup:function(t){var i,a=e.Cmdbuild.elementsManager.getXmlElementId(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.elementsManager.getParams(t),r=e.Cmdbuild.utilities.getEventLikeString(t,"onChange"),s=e.Cmdbuild.elementsManager.insertLabel(t),o=t.getAttribute("interactivity"),l=o&&o==e.Cmdbuild.global.READ_ONLY;l?i="<input type='hidden'"+n+"value='"+(""|d.value)+"' />":(i="",i+="<select "+n+r+">",i+="</select>",i+="");var u=e.Cmdbuild.elementsManager.wrapInFormRow(s,i,"lookup",l);return d={script:"lookup",id:a,backend:d.backend,lookupName:d.lookupName,value:d.value,readOnly:l},e.Cmdbuild.scriptsManager.push(d),u},select:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.getParams(t);n=e.Cmdbuild.dataModel.resolveVariables(n);var d=e.Cmdbuild.utilities.getEventLikeString(t,"onChange");n=e.extend({script:"select",id:i},n),e.Cmdbuild.scriptsManager.push(n);var r=e.Cmdbuild.elementsManager.insertLabel(t),s="<select "+a+d+">";s+="</select>";var o=t.getAttribute("interactivity"),l=o&&o==e.Cmdbuild.global.READ_ONLY,u=e.Cmdbuild.elementsManager.wrapInFormRow(r,s,"select",l);return u},reference:function(t){var i,a,n=e.Cmdbuild.elementsManager.getXmlElementId(t),d=e.Cmdbuild.elementsManager.getCommonAttributes(t),r=e.Cmdbuild.elementsManager.getParams(t),s=r.backend,o=e.Cmdbuild.elementsManager.insertLabel(t),l=t.getAttribute("interactivity"),u=l&&l==e.Cmdbuild.global.READ_ONLY;if(u)i="<input type='hidden'"+d+"value='"+(""|r.value)+"' />";else{a='$.Cmdbuild.standard.referenceField.onSearchLookup("'+n+'", "'+r.container+'")';var c='$.Cmdbuild.standard.referenceField.onClearLookup("'+n+'")';r.toExecCommand=n,i="<select "+d+" backend='"+s+"' className='"+r.className+"' eventSearch = '"+a+"'>",i+="<option selected></option>",i+="</select>";var m=t.getAttribute("formName"),g=t.getAttribute("fieldName");r.fieldName=g,r.formName=m,i+=this.lookupButtons(n,r.container,a,c),this.lookupDialog(n,r)}var h=e.Cmdbuild.elementsManager.wrapInFormRow(o,i,"reference",u);return r={script:"reference",id:n,eventSearch:a,backend:r.backend,className:r.className,value:r.value,readOnly:u,formNRows:r.formNRows},e.Cmdbuild.scriptsManager.push(r),h},openEntry:function(t,i){var a="",n="",d=e.Cmdbuild.elementsManager.getText(t),r=e.Cmdbuild.elementsManager.getCommonAttributes(t),s=e.Cmdbuild.elementsManager.getXmlElementId(t),o=e.Cmdbuild.elementsManager.getParams(t),l=e.Cmdbuild.dataModel.resolveVariables(o);if(l&&e.Cmdbuild.dataModel.prepareCallerParameters(s,l),0==l.show||1==l.hide)return"";var u=e.Cmdbuild.utilities.getEventLikeString(t,"onClick",'$.Cmdbuild.utilities.currentMenu("'+s+'", "'+i+'");return false;');if(a+="<li "+r+"><span class='ui-icon ui-icon-carat-1-e'></span><a id='"+s+"_aElement' title='"+n+"' href='#'"+u+">"+d+"</a>",t.childNodes.length>0){a+="<ul class='ui-menu'>";for(var c=0;c<t.childNodes.length;c++)"openEntry"==t.childNodes[c].nodeName&&(a+=this.openEntry(t.childNodes[c],i));a+="</ul>"}return a+="</li>",e.Cmdbuild.scriptsManager.push({script:"openMenu",id:s+"_aElement"}),a},openMenu:function(t){var i="",a=e.Cmdbuild.elementsManager.getXmlElementId(t);i+="<ul id='"+a+"' class='ui-menu'>";for(var n=0;n<t.childNodes.length;n++)"openEntry"==t.childNodes[n].nodeName&&(i+=this.openEntry(t.childNodes[n],a));return i+="</ul>"},text:function(t){var i="";i+=e.Cmdbuild.elementsManager.insertLabel(t);var a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<span"+n+">"+a+"</span>",i+=e.Cmdbuild.elementsManager.insertReturn(t)},entry:function(t){var i="",a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onClick");i+="<li"+n+"><a href='#'"+d+">"+a+"</a>";var r=e.Cmdbuild.elementsManager.insertChildren(t);return""!=r&&(i+="<ul>"+r+"</ul>"),i+="</li>"},menu:function(t){var i="",a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<ul"+n+">";var d=e.Cmdbuild.elementsManager.getXmlElementId(t);return null!=a&&(i+="<a href='#'>"+a+"</a>"),i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</ul>",i+=e.Cmdbuild.elementsManager.insertReturn(t),e.Cmdbuild.scriptsManager.push({script:"menu",id:d}),i},divform:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<div"+a+"/>"},div:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t),d=e.Cmdbuild.elementsManager.getEvent("onInit",t),r=e.Cmdbuild.elementsManager.getParams(t);return e.Cmdbuild.dataModel.prepareCallerParameters(n,r),d&&(d.script="init",d.id=n,e.Cmdbuild.scriptsManager.push(d)),i},dl:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<dl"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</dl>"},dd:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<dd"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</dd>"},override:function(t){var i=t.getAttribute("container"),a=e("#"+i)[0],n=e.Cmdbuild.elementsManager.insertChildren(t);return a.innerHTML=n,""},gridNavigationBar:function(t){var i="",a={};e.Cmdbuild.elementsManager.getParams(t,a);var n=a.form;return i+="<input type='text' id='"+n+"_filtertext' />",i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_filter","ui-icon-search",'$.Cmdbuild.standard.gridMenu.onFilter("'+n+'", "")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.gridMenu.onClearFilter("'+n+'")'),i+="<span id='"+n+"_pageCount' class='cmdbuildGridNavigationCount'></span>",i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("begin", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("previous", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("next", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("end", "'+n+'")')},grid:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a="<table id='"+i+"' class='display' style='width: 100%;'></table>",n={script:"grid",id:i};return e.Cmdbuild.elementsManager.getParams(t,n),n.onClick=e.Cmdbuild.elementsManager.getEvent("onClick",t),e.Cmdbuild.scriptsManager.push(n),a},lookupButtons:function(t,i,a,n){var d="";return d+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t+"_search","ui-icon-search",a),d+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t+"_clearFilter","ui-icon-closethick",n)},lookupDialog:function(t,i){var a="<form id='"+t+"_dialog' >";a+="<params>",a+="<type>popup</type>",a+="</params>",a+="<div id='"+t+"_dialogDiv' class='cmdbuild-dialog-content'>",a+="<onInit>",a+="<command>navigate</command>",a+="<container>"+t+"_dialogDiv</container>",a+="<form>"+t+"_dialogGrid</form>",a+="<formName>"+i.formName+"</formName>",a+="<fieldName>"+i.fieldName+"</fieldName>",a+="<cqlRefForm>"+i.cqlRefForm+"</cqlRefForm>",a+="<cqlRefField>"+i.cqlRefField+"</cqlRefField>",a+="</onInit>",a+="<form id='"+t+"_dialogGrid'>",a+="<params>",a+="<type>grid</type>",a+="<className>"+i.className+"</className>",a+="<backend>"+i.backend+"</backend>",a+="<nRows>"+e.Cmdbuild.global.getApplicationConfig().grid.pagelength+"</nRows>",a+="<lookup>true</lookup>",a+="<navigation>false</navigation>",a+=i.sort,a+=i.direction,a+="</params>",a+="<onDblClick>",a+="<command>dialogExec</command>",a+="<toExecCommand>"+i.toExecCommand+"</toExecCommand>",a+="<bReference>"+i.bReference+"</bReference>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onDblClick>",a+="</form>",a+="</div>",a+="<div class='cmdbuild-dialog-footer'>",a+="<button text='Ok' id='"+t+"_dialogOk'>",a+="<onClick>",a+="<command>dialogExec</command>",a+="<toExecCommand>"+i.toExecCommand+"</toExecCommand>",a+="<bReference>"+i.bReference+"</bReference>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onClick>",a+="</button>",a+="<button text='Cancel' id='"+t+"_dialogCancel'>",a+="<onClick>",a+="<command>dialogClose</command>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onClick>",a+="</button>",a+="</div>",a+="</form>";var n=new DOMParser;xDoc=n.parseFromString(a,"text/xml");var d=xDoc.documentElement,r=e.Cmdbuild.elementsManager.getElement(i.container);r.appendChild(d)}};e.Cmdbuild.standard.elements=t}(jQuery),function(e){function t(t){var i={};return e.each(t,function(e,t){t.defaultValue?i[t.name]=t.defaultValue:i[t.name]=void 0}),i}function i(e){var t=[];if(e.filter(function(e){var i=e.group;return i&&i.trim()?i.trim():i=s,-1==t.indexOf(i)&&t.push(i)}),-1!==t.indexOf(s)){var i=t.indexOf(s),a=t.length-1;t=r(t,i,a)}return t}function a(t){var i=e("<form></form>").attr("action","#").attr("name",t).attr("id",t);return i}function n(t,i){var a=e("<div></div>").attr("id",t+"_tabbed"),n=e("<ul></ul>");return a.append(n),e.each(i,function(i,r){var o=e("<li></li>"),l=r;l===s&&(l="Other");var u=e("<a></a>").attr("href","#"+d(t,r)).text(l);n.append(o.append(u));var c=e("<div></div>").attr("id",d(t,r));a.append(c)}),a.tabs(),a}function d(e,t){return t=t?t:s,t=t.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"-").toLowerCase(),e+"-tab-"+t}function r(e,t,i){for(;0>t;)t+=e.length;for(;0>i;)i+=e.length;if(i>=e.length)for(var a=i-e.length;a--+1;)e.push(void 0);return e.splice(i,0,e.splice(t,1)[0]),e}var s="_NOGROUP_",o=function(){this.config={},this.backend=void 0,this.customFields=[],this.customWidgets=[],this.xmlForm=void 0,this.init=function(t){this.config=t,this.xmlForm=e.Cmdbuild.elementsManager.getElement(this.config.form),this.customFields=e.Cmdbuild.utilities.getFields(this.xmlForm),this.customWidgets=e.Cmdbuild.utilities.getWidgetsFromXML(this.xmlForm);try{var i=e.Cmdbuild.utilities.getBackend(t.backend),a=new i(t,this.show,this);this.setBackend(a)}catch(n){console.log("WARNING: No data message "+n.message);var d=e("#"+this.param.container)[0];d.innerHTML="<h1>NO DATA</h1>"}},this.show=function(){var d=this,r=this.config.form,o=this.getBackendAttributes();if(e.Cmdbuild.dataModel.evaluateJSONAttributes(o,this.customFields),e.Cmdbuild.CqlManager.compile(r,o),this.config.emptyForm&&"true"==this.config.emptyForm){var l=t(o);this.setBackendData(l)}e.Cmdbuild.dataModel.push({form:this.config.form,type:"form",data:this.getBackendData()});var u=e("#"+this.config.container);u.empty();var c=a(this.config.form);u.append(c);var m,g=!1;this.config.noGroup&&"true"==this.config.noGroup?m=[s]:(m=i(o),m.length>1&&(g=!0,c.append(n(r,m))));var h=this.getBackendData(),f=e.Cmdbuild.utilities.getFormValidatorObject();e.each(o,function(t,i){var a=h[i._id];d.isReadOnlyForm()&&(i.writable=!1),!i.writable||null!=a&&void 0!=a||(a=i.defaultValue);var n=e.Cmdbuild.fieldsManager.generateHTML(i,r,d.config.container,a),s=e.Cmdbuild.fieldsManager.getFieldValidator(i);if(s&&s.rules&&!e.isEmptyObject(s.rules)&&(f.rules[i._id]=s.rules),g){var o=d.getTabId(r,i.group);e("#"+o).append(n)}else c.append(n);i.type!==e.Cmdbuild.fieldsManager.types.TEXT||"HTML"!==i.editorType||i.writable!==!0&&"true"!==i.writable||n.find("textarea").cleditor()[0].refresh()}),c.validate(f),this.updateWidgets();var b=this.getBackendWidgets();if(b&&b.length){e.Cmdbuild.widgets.prepareFields(b);var p=e.Cmdbuild.standard.widgetDiv.getWidgetDiv({container:this.config.container,form:this.config.form,readOnly:this.isReadOnlyForm(),widgets:b}),C=e(p);C.find("input[type=button]").button();var v=C.filter("div[id$='_widgetDialog']").remove();c.append(C),v.dialog({autoOpen:!1,dialogClass:e.Cmdbuild.global.getThemeCSSClass(),closeText:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),modal:!0,show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}}),e.Cmdbuild.widgets.evaluateCqlFields(this.config.form,b,!0),e.Cmdbuild.widgets.initialize(this.config.form,b)}var k=e.Cmdbuild.utilities.getButtonsFromXML(this.xmlForm);if(k){var w=e(k);w.find("input[type=button]").button(),c.append(w)}var M=e.Cmdbuild.elementsManager.insertChildren(this.xmlForm);M&&c.append(M),this.config.onInitComplete&&window[this.config.onInitComplete]()},this.getTabId=d,this.refreshField=function(t){var i=e.Cmdbuild.fieldsManager.getFieldId(t.form,t.field),a=e("#"+i);a.length?a.trigger("refreshfield"):e.Cmdbuild.widgets.refreshCqlField(t.form,this.getBackend().widgets)},this.getValue=function(t){var i=e.Cmdbuild.fieldsManager.getFieldId(t.form,t.field),a=e.Cmdbuild.utilities.getHtmlFieldValue("#"+i);return null===a&&(a=e.Cmdbuild.dataModel.getValue(t.form,t.field)),a},this.flush=function(e,t,i){this.getBackend().updateData(e,t,i)},this.change=function(t,i,a){function n(){var n=[],d=e("#"+this.config.form),r=this.getBackendAttributes(),s=e.Cmdbuild.widgets.getWidgetsErrors(this.config.form,this.getBackendWidgets());if(!d.valid()||s.length){var o=d.validate().errorList;e.each(o,function(t,i){var a=e(i.element).attr("name"),d=e.grep(r,function(e){return e._id==a}),s=d.length>0?d[0]:null;s&&n.push({field:s.description,message:i.message})}),e.each(s,function(e,t){n.push({field:"Widget "+t.label,message:t.error})})}else e.each(r,function(i,a){var n=e.Cmdbuild.fieldsManager.getFieldId(t.form,a._id);t.data[a._id]=e.Cmdbuild.utilities.getHtmlFieldValue("#"+n)});i.apply(a,[n])}var d=this.getBackend();d.getWidgets?e.Cmdbuild.widgets.getWidgetsData(this.config.form,d.getWidgets(),n,this):n.apply(this)},this.reset=function(t){for(var i in t.data){var a=e.Cmdbuild.fieldsManager.getFieldId(t.form,i),n=e("#"+a);n&&n.val(t.data[i])}},this.getClientDescription=function(e,t,i){var a=this.getBackendAttributes(),n=this.getValue(e);this.getDescription(e,a,n,function(e){t.apply(i,[e])},this)},this.getServerDescription=function(t,i,a){if(!this.getBackend().getOriginalAttributes)return console.log("Backend without original attributes on form: "+t.form,this.getBackend()),void i.apply(a,[""]);var n=this.getBackend().getOriginalAttributes(),d=e.Cmdbuild.dataModel.getValue(t.form,t.field);this.getDescription(t,n,d,function(e){i.apply(a,[e])},this)},this.getDescription=function(t,i,a,n,d){for(var r=void 0,s=0;s<i.length;s++)if(i[s].name==t.field){r=i[s];break}r&&a?e.Cmdbuild.utilities.getFieldDescription(r,a,function(e){n.apply(d,[e])}):n.apply(d,[a||""])},this.updateWidgets=function(){var t=this.getBackendWidgets();this.customWidgets&&this.customWidgets.length&&(void 0===t&&(t=[]),e.each(this.customWidgets,function(e,i){t.push(i)}),this.setBackendWidgets(t))},this.isReadOnlyForm=function(){return this.getBackend().isReadOnly&&this.getBackend().isReadOnly()?!0:this.config.readonly&&"true"==this.config.readonly},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.getBackendData=function(){var e=this.getBackend();return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),
e.data)},this.setBackendData=function(e){var t=this.getBackend();t.setData?t.setData(e):(console.warn("Missing setData method for backend "+this.config.backend),t.data=e)},this.getBackendAttributes=function(){var e=this.getBackend();return e.getAttributes?e.getAttributes():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.attributes)},this.setBackendAttributes=function(e){var t=this.getBackend();t.setAttributes?t.setAttributes(e):(console.warn("Missing setAttributes method for backend "+this.config.backend),t.attributes=e)},this.getBackendWidgets=function(){var e=this.getBackend();return e.getWidgets?e.getWidgets():(console.warn("Missing getWidgets method for backend "+this.config.backend),e.widgets)},this.setBackendWidgets=function(e){var t=this.getBackend();t.setWidgets?t.setWidgets(e):(console.warn("Missing setWidgets method for backend "+this.config.backend),t.widgets=e)}};e.Cmdbuild.standard.form=o}(jQuery),function(e){var t=function(){this.param=void 0,this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i="";i+=e.Cmdbuild.elementsManager.insertChildren(t);var a=e("#"+this.param.container)[0];i+="<div id='container'>",i+="<style> #graph-container { top: 0; bottom: 0; left: 0; right: 0; position: absolute;} </style>",i+="<div id='graph-container'></div></div>",a.innerHTML=i,e.Cmdbuild.scriptsManager.push({script:"graph",id:"graph-container",className:this.param.className,cardId:this.param.cardId}),e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(n){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),n}}};e.Cmdbuild.standard.graph=t}(jQuery),function(e){function t(t){return t.emptyGridI18nMessage?e.Cmdbuild.translations.getTranslation(t.emptyGridI18nMessage,t.emptyGridMessage?t.emptyGridMessage:t.emptyGridI18nMessage):t.emptyGridMessage?t.emptyGridMessage:""}var i=13,a=function(){this.currentPage=0,this.nRows=10,this.paginationSettings={},this.checked={},this.bkChecked={},this.config={},this.id=null,this.init=function(t){if(this.config=t,t.selectedItemId){var i=e.Cmdbuild.dataModel.resolveVariable(this.config.selectedItemId);t.positionOf=i}var a=e.Cmdbuild.utilities.getBackend(t.backend);this.backend=new a(this.config,this.onBackendLoaded,this)},this.onBackendLoaded=function(){var a=this.config;this.bkChecked=e.Cmdbuild.utilities.clone(this.checked),this.id=a.form;var n=e.Cmdbuild.elementsManager.getElement(this.id);e.Cmdbuild.elementsManager.getRowButtons(n,a),e.Cmdbuild.elementsManager.getColumnsCommands(n,a);var d=e.Cmdbuild.utilities.getFields(n);d&&d.fields&&(d.form=this.id,e.Cmdbuild.dataModel.putFormFields(d)),this.onDblClick=e.Cmdbuild.elementsManager.getEvent("onDblClick",n),this.paginationSettings={nRows:a.nRows||nRows,nTotalRows:0,firstRow:0,condition:a.condition,hookParent:"true"===a.hookParent,parent:a.parent,singleSelect:1==a.singleSelect?!0:!1,onClick:e.Cmdbuild.elementsManager.getEvent("onClick",n),onChange:e.Cmdbuild.elementsManager.getEvent("onChange",n),className:a.className,cardId:a.cardId,allowSorting:a.allowSorting&&"false"==a.allowSorting?!1:!0,allowScrollX:a.allowScrollX&&"false"==a.allowScrollX?!1:!0,fixedLeftColumns:a.fixedLeftColumns?a.fixedLeftColumns:0,fixedRightColumns:a.fixedRightColumns?a.fixedRightColumns:0,onInitComplete:a.onInitComplete?a.onInitComplete:null,fnRowCallback:a.fnRowCallback?a.fnRowCallback:null,emptyGridMessage:t(a),rawParam:a};var r="true"==a.withComboProcesses?this.gridHeader(this.id):"";"true"==a.lookup&&(r+=this.gridButtons(this.id)),r+="<table id='"+this.id+"' class='display' width='100%'></table>",e.Cmdbuild.eventsManager.deferEvents();var s=e("#"+a.container)[0];r+=e.Cmdbuild.elementsManager.insertChildren(n),"false"!=a.navigation&&(r+=this.gridButtons(this.id)),s.innerHTML=r,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents();var o=this.id;e("#"+this.id+"_filtertext").keypress(function(t){return t.which==i?(e.Cmdbuild.standard.grid.onFilter(o),!1):void 0}),this.chargeFilter()},this.reset=function(e){alert("grid reset "+e.type+" "+e.form)},this.change=function(e){alert("grid change "+e.type+" "+e.form)},this.chargeFilter=function(){this.paginationSettings.backend=this.backend;var t=this.paginationSettings.rawParam;t.grid=this,t.cqlRefForm&&t.cqlRefField?e.Cmdbuild.CqlManager.resolve(t.cqlRefForm,t.cqlRefField,this.show,this):this.show("")},this.show=function(t){var i=this.paginationSettings.backend;i.noValidFilter=void 0===t,this.paginationSettings.backend=this.backend;try{this.updateFirstRowFromSelectedItem();var a=this.paginationSettings.rawParam;a.grid=this,a.fieldName&&a.formName&&t&&(this.paginationSettings.backend.filter.CQL=t),e.Cmdbuild.dataModel.evaluateXmlAttributes(this.id,this.paginationSettings.backend.getAttributes()),this.showAttributes(a);var n=this,d=a.sort?this.getIndexColumn(a.sort):this.getFirstValidColumn(),r=a.direction?a.direction.toLowerCase():"asc",s=void 0,o=void 0,l=void 0;a.scroll&&(s=a.scrollHeight+"px",o=!0,l=!1);var u=e("#"+this.id).dataTable({scrollY:s,scrollCollapse:o,paging:l,pageLength:n.nRows,lengthChange:!1,bProcessing:!0,bServerSide:!0,searching:!1,paging:!1,scrollX:n.paginationSettings.allowScrollX,info:!1,ordering:n.paginationSettings.allowSorting,aaSorting:[[d,r]],ajax:function(t,i,a){var d=n.getParamFormLoadData(a);n.paginationSettings.backend.loadData(d,function(){var t={data:n.getData()};if(i(t),n.convertReferencedValues(),t.data&&t.data.length){var a=0;if(n.paginationSettings.rawParam.selectedItemId){var d=this.paginationSettings.backend.positions,r=this.paginationSettings.rawParam.selectedItemId;if(d&&r){var s=d[r];if(s){var o=this.paginationSettings.nRows;a=s%o,this.paginationSettings.rawParam.selectedItemId=void 0}}}var l=e("#"+n.id+' tbody tr:not(".cmdbuildGroupByHeader"):eq('+a+")"),u=e("#"+n.id).DataTable();n.paginationSettings.hookParent&&n.paginationSettings.parent.getSelection?n.selectRows(n.paginationSettings.parent.getSelection()):n.selectRow(n.id,u,l,a,!1),n.onLoad(),n.disableRowButtons()}else e.Cmdbuild.dataModel.setCurrentIndex(n.id,-1),n.onLoad()},n)},columns:n.paginationSettings.attributesInGrid,columnDefs:n.getNoAttributeColumns(),fnInitComplete:n.paginationSettings.onInitComplete?e.Cmdbuild.dataModel.resolveVariable(n.paginationSettings.onInitComplete):null,fnRowCallback:n.paginationSettings.fnRowCallback?e.Cmdbuild.dataModel.resolveVariable(n.paginationSettings.fnRowCallback):null,drawCallback:function(e){n.drawCallback(this,n,a,e)},language:{zeroRecords:n.paginationSettings.emptyGridMessage}});if(a.groupBy){var c=e("#"+this.id).DataTable();c.columns([0]).visible(!1,!1),c.order([[0,"asc"]])}new e.fn.dataTable.FixedColumns(u,{iLeftColumns:n.paginationSettings.fixedLeftColumns,iRightColumns:n.paginationSettings.fixedRightColumns}),u.on("order.dt",function(){e(e.fn.dataTable.tables(!0)).DataTable().columns.adjust()}),e("#"+this.id+" tbody").on("click","tr",function(t){var i=e(this).parents("table");n.id=i.attr("id");var d=e("#"+n.id).DataTable();(!e(this).hasClass("selected")||n.paginationSettings.hookParent)&&n.selectRow(a.form,d,e(this),d.row(this).index(),t.ctrlKey),e.Cmdbuild.eventsManager.onEvent(n.paginationSettings.onClick)}),this.onDblClick&&e("#"+n.id+" tbody").on("dblclick","tr",function(){e.Cmdbuild.eventsManager.executeEvent(n.onDblClick)}),e("#"+this.id+" tbody").on("click","span",function(t){var i=e(this).parents("table");n.id=i.attr("id");var d=e("#"+n.id).DataTable(),r=e(this).parents("tr");n.selectRow(a.form,d,r,d.row(r).index(),t.ctrlKey);var s=jQuery.parseJSON(e(this).attr("method"));e.Cmdbuild.eventsManager.onEvent(s)})}catch(m){throw e.Cmdbuild.errorsManager.log(m),m}},this.disableRowButtons=function(){var t=this.id,i=0,a=this.paginationSettings.backend;e("#"+t+" tbody tr").each(function(t){if(!e(this).hasClass("cmdbuildGroupByHeader")&&a.disableRowButtons){for(var n=a.disableRowButtons(i),d=0;d<n.length;d++){var r=e(this).find("."+n[d]);e(r).removeClass(n[d])}i++}})},this.onLoad=function(){this.paginationSettings.hookParent&&this.paginationSettings.parent.onLoad&&this.paginationSettings.parent.onLoad()},this.convertReferencedValues=function(){for(var t=e("#"+this.id).DataTable(),i=this.paginationSettings.backend,a=i.getData(),n=0;n<a.length;n++)for(var d=0;d<this.paginationSettings.attributesInGrid.length;d++)this.convertReferencedValue(a,t,n,d)},this.convertReferencedValue=function(t,i,a,n){var d=t[a],r=this.paginationSettings.attributesInGrid[n],s=d[r.name];r&&s?e.Cmdbuild.utilities.getFieldDescription(r,s,function(e){i.cell(a,n).data(e),i.columns.adjust()}):(i.cell(a,n).data(s||""),i.columns.adjust())},this.addColumnsCommands=function(){var t=this.paginationSettings.rawParam.columnsCommands,i=this,a=[];return e.each(t,function(e,t){var n=i.getIndexColumn(t.attribute);a.push({targets:n,mRender:function(e,i,a){var n="";if(e){var d=t.tooltip?" title = '"+t.tooltip+"' ":"";n="<span "+d+" class='commandcell "+t.icon+"' method='"+JSON.stringify(t.onClick)+"'>"+e+"</span>"}return n}})}),a},this.drawCallback=function(t,i,a,n){if(a.groupBy){var d=t.api(),r=d.rows({page:"current"}).nodes(),s=null;d.column(0,{page:"current"}).data().each(function(t,i){s!==t&&(e(r).eq(i).before('<tr class="cmdbuildGroupByHeader"><td colspan="6">'+t+"</td></tr>"),s=t)})}},this.selectRows=function(t){for(var i=e("#"+this.id).DataTable(),a=this.paginationSettings.backend.getData(),n=0;n<a.length;n++){var d=a[n],r=i.row(n).node();t[d.id]?e(r).addClass("selected"):e(r).removeClass("selected")}},this.selectRow=function(t,i,a,n,d){e.Cmdbuild.dataModel.setCurrentIndex(t,n),i.$("tr.selected").removeClass("selected"),a.addClass("selected"),this.paginationSettings.onChange&&(this.paginationSettings.onChange.addSelection=d,e.Cmdbuild.eventsManager.onEvent(this.paginationSettings.onChange))},this.getNoAttributeColumns=function(){for(var t=[],i=this.paginationSettings.backend.getAttributes(),a=0,n=0;i&&n<i.length;n++){var d=i[n];if(d.displayableInList===!0||"true"===d.displayableInList){if("IMAGEBUTTON"==d.type){var r=d.tooltip?" title = '"+d.tooltip+"' ":"";d.text?d.text:"";t.push({width:d.text?null:20,targets:a,data:null,title:"&nbsp;",orderable:!1,defaultContent:"<span "+r+" class='"+d.className+"' method='"+d.onClick+"'>"+(d.text?d.text:"")+"</span>"})}else if("ROWSELECTIONCHECK"==d.type){var s=this,r=d.tooltip?" title = '"+d.tooltip+"' ":"";t.push({width:20,targets:a,data:null,title:"&nbsp;",orderable:!1,render:function(e,t,i,a){var n=e[0]?" checked ":"";return"<input name='rowSelectionCheck' "+r+" type='checkbox' "+n+" onclick='$.Cmdbuild.standard.grid.clickOnCheck(this, \""+s.id+"\")'>"}})}a++}}var o=this.addColumnsCommands();return e.merge(t,o)},this.getFirstValidColumn=function(){for(var e=0;e<this.paginationSettings.attributesInGrid.length;e++){var t=this.paginationSettings.attributesInGrid[e].type;if("IMAGEBUTTON"!=t&&"ROWSELECTIONCHECK"!=t)return e}},this.showAttributes=function(t){try{var i=this.paginationSettings.backend.getAttributes();this.paginationSettings.attributesInGrid=[],e.Cmdbuild.utilities.sortAttributes(i),t.rowButtons&&e.Cmdbuild.elementsManager.loadIconButtons(i,t.rowButtons,t.positionButtons),"true"===t.selection&&e.Cmdbuild.elementsManager.pushSelectionCheck(i,"left");for(var a=0;a<i.length;a++){var n=i[a];(n.displayableInList===!0||"true"===n.displayableInList)&&this.paginationSettings.attributesInGrid.push({name:n.name,title:n.description,tooltip:n.tooltip,type:n.type,length:n.length,targetClass:n.targetClass,lookupType:n.lookupType,scale:n.scale})}}catch(d){e.Cmdbuild.errorsManager.log(d)}},this.getIndexColumn=function(e){for(var t=0;t<this.paginationSettings.attributesInGrid.length;t++)if(this.paginationSettings.attributesInGrid[t].name==e)return t;return 0},this.getParamFormLoadData=function(e){return param=this.paginationSettings,param.sort=this.paginationSettings.attributesInGrid[e.aaSorting[0][0]].name,param.direction="asc"==e.aaSorting[0][1]?"ASC":"DESC",param.form||(param.form=this.id),param},this.getData=function(){try{"true"===this.paginationSettings.rawParam.selectionDefault&&this.selectAll();var t=this.paginationSettings.backend,i=t.getData();e.Cmdbuild.dataModel.push({form:this.id,type:"grid",currentIndex:t.getTotalRows()>0?0:-1,data:i});for(var a=[],n=0;n<i.length;n++){for(var d=i[n],r=[],s=0;s<this.paginationSettings.attributesInGrid.length;s++){var o=void 0;o="selectionCheck"==this.paginationSettings.attributesInGrid[s].name?this.checked[d._id]:this.getFieldValue(d,this.paginationSettings.attributesInGrid[s]),r.push(o)}a.push(r)}return this.paginationSettings.nTotalRows=t.getTotalRows(),this.enableGridButtons(this.id),this.setPageCount(this.id),a}catch(l){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.grid.getData "+l.message),l}},this.getFieldValue=function(t,i){return t[i.name]?"lookup"==i.type?"":"reference"==i.type?"":-1!=["date","time","timestamp","dateTime"].indexOf(i.type)?e.Cmdbuild.utilities.convertDateDB2GUI(t[i.name],i.type):"text"===i.type||"string"===i.type?e("<div></div>").html(t[i.name]).text():t[i.name]||"":""},this.gridHeader=function(t){var i="<div class='cmdbuildGridHeaderWrapper'>",a=t+"_processStatuses",n=" id='"+a+"' class='cmdbuildGridProcessStatuses' ",d=" onChange='$.Cmdbuild.standard.grid.onSelectStatus(\""+a+'", "'+this.id+"\")'";i+="<select "+n+d+">",i+="</select>";var r={script:"select",id:a,backend:"Select",processName:this.paginationSettings.className,value:"$fromBackend"};return e.Cmdbuild.scriptsManager.push(r),i+="</div>"},this.newgridButtons=function(e){var t="<div class='cmdbuildGridNavigationWrapper'>";return t+="<div class='cmdbuildGridFilterContainer'>",t+="<!--[if IE]><br/><input type='text' ",t+=" size='20' value='Ignore field IE bug fix'",t+="/><br/><![endif]-->",t+="<input type='text' id='"+e+"_filtertext' />",t+=this.gridButton(e+"_filter","ui-icon-search",'$.Cmdbuild.standard.gridMenu.onFilter("'+e+'")'),t+=this.gridButton(e+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.gridMenu.onClearFilter("'+e+'")'),t+="</div>",t+="<div class='cmdbuildGridNavigationContainer'>",t+=this.gridButton(e+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("begin", "'+e+'")'),t+=this.gridButton(e+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("previous", "'+e+'")'),t+=this.gridButton(e+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("next", "'+e+'")'),t+=this.gridButton(e+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("end", "'+e+'")'),t+="<p id='"+e+"_pageCount' class='cmdbuildGridNavigationCount'>Page 1 of 123</p>",t+="</div>",t+='<div class="cmdbuildClear"></div>',t+="</div>"},this.gridButtons=function(e){var t="<div class='cmdbuildGridNavigationWrapper'>";return t+="<div class='cmdbuildGridFilterContainer'>",t+="<input type='text' id='"+e+"_filtertext' />",t+=this.gridButton(e+"_filter","ui-icon-search",'$.Cmdbuild.standard.grid.onFilter("'+e+'")'),t+=this.gridButton(e+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.grid.onClearFilter("'+e+'")'),t+="</div>",t+="<div class='cmdbuildGridNavigationContainer'>",t+=this.gridButton(e+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.grid.onNavigate("begin", "'+e+'")'),t+=this.gridButton(e+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.grid.onNavigate("previous", "'+e+'")'),t+=this.gridButton(e+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.grid.onNavigate("next", "'+e+'")'),t+=this.gridButton(e+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.grid.onNavigate("end", "'+e+'")'),t+="<p id='"+e+"_pageCount' class='cmdbuildGridNavigationCount'>Page 1 of 123</p>",t+="</div>",t+='<div class="cmdbuildClear"></div>',t+="</div>"},this.enableGridButtons=function(t){var i=parseInt(this.paginationSettings.firstRow),a=parseInt(this.paginationSettings.nRows),n=parseInt(this.paginationSettings.nTotalRows);e("#"+t+"_init").button("option","disabled",0==i),e("#"+t+"_previous").button("option","disabled",0==i),e("#"+t+"_next").button("option","disabled",i+a>=n),e("#"+t+"_end").button("option","disabled",i+a>=n)},this.setPageCount=function(t){var i=parseInt(this.paginationSettings.firstRow),a=parseInt(this.paginationSettings.nRows),n=parseInt(this.paginationSettings.nTotalRows),d=e.Cmdbuild.utilities.formatVarString(e.Cmdbuild.global.GRIDROWSCOUNT,parseInt(i/a)+1,parseInt((n+a-1)/a),n);e("#"+t+"_pageCount").html(d)},this.gridButton=function(t,i,a){return e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t,i,a)},this.getBackend=function(){return this.paginationSettings.backend},this.selectAll=function(){var e=this.paginationSettings.backend;this.checked={};for(var t=0;t<e.getTotalRows();t++)this.checked[e.data[t]._id]="true"},this.updateFirstRowFromSelectedItem=function(){var e=this.paginationSettings.backend.positions,t=this.paginationSettings.rawParam.selectedItemId;if(e&&t){var i=e[t];if(i){var a=this.paginationSettings.nRows,n=Math.floor(i/a)*a;this.paginationSettings.firstRow=n}}}};e.Cmdbuild.standard.grid=a,e.Cmdbuild.standard.grid.onSelectStatus=function(t,i){var a=e.Cmdbuild.utilities.getHtmlFieldValue("#"+t),n=e.Cmdbuild.dataModel.forms[i],d=n.getBackend();if(d.setFilter){d.setFilter({flowStatus:a});var r=e("#"+i).DataTable();r.ajax.reload(function(e){})}else e.Cmdbuild.errorsManager.log("The method setFilter is not defined on the grid backend")},e.Cmdbuild.standard.grid.onFilter=function(t){var i=e.Cmdbuild.dataModel.forms[t];i.paginationSettings.firstRow=0;var a=e("#"+t+"_filtertext").val();i.paginationSettings.backend.filter.query=e.trim(a);var n=e("#"+t).DataTable();n.ajax.reload(function(e){})},e.Cmdbuild.standard.grid.onClearFilter=function(t){var i=e.Cmdbuild.dataModel.forms[t];i.paginationSettings.firstRow=0,i.paginationSettings.backend.filter.query="",e("#"+t+"_filtertext").val("");var a=e("#"+t).DataTable();a.ajax.reload(function(e){})},e.Cmdbuild.standard.grid.cancelSelection=function(t){var i=e.Cmdbuild.dataModel.forms[t];i&&(i.checked=e.Cmdbuild.utilities.clone(i.bkChecked))},e.Cmdbuild.standard.grid.clearSelection=function(t){var i=e.Cmdbuild.dataModel.forms[t];i&&(i.checked={})},e.Cmdbuild.standard.grid.getChecked=function(t){var i=e.Cmdbuild.dataModel.forms[t];return i?i.checked:{}},e.Cmdbuild.standard.grid.clickOnCheck=function(t,i){var a=t.checked,n=e(t).parents("table"),d=n.attr("id"),r=e("#"+d).DataTable(),s=e(t).parents("tr"),o=e.Cmdbuild.dataModel.forms[i];o.selectRow(i,r,s,r.row(s).index());var l=e.Cmdbuild.dataModel.getValues(i),u=e(n).find("input[name='rowSelectionCheck']");o.paginationSettings.singleSelect&&(u.each(function(){this!=t&&e(this).attr("checked",!1)}),o.checked=[]),o.checked[l._id]=a},e.Cmdbuild.standard.grid.onNavigate=function(t,i){var a=e.Cmdbuild.dataModel.forms[i],n=parseInt(a.paginationSettings.firstRow),d=parseInt(a.paginationSettings.nRows),r=parseInt(a.paginationSettings.nTotalRows);switch(t){case"begin":n=0;break;case"end":n=r>0&&d>0?Math.floor(r/d)*d:0;break;case"previous":var s=n-d;n=s>0?s:0;break;case"next":n+=d;break;default:n=0}a.paginationSettings.firstRow=n;var o=e("#"+i).DataTable();o.ajax.reload(function(e){})}}(jQuery),function(e){var t=function(t){this.param=t,this.lookupTree={},this.lookupValue={},this.init=function(){if(!this.param.lookupType&&this.param.lookupName)this.param.lookupType=this.param.lookupName,console.warn("lookupName parameter is deprecated. Use lookupType.");else if(!this.param.lookupType&&!this.param.lookupName)return void e.Cmdbuild.errorsManager.error("No lookup type specified");this.param.value&&(this.lookupValue[this.param.lookupType]=this.param.value),this.generateLookupTypeTree(this.param.lookupType)},this.generateLookupTypeTree=function(t,i){var a=this;e.Cmdbuild.utilities.proxy.getLookupType(t,{},function(n,d){var r={type:n.name,values:[]};n.parent&&(r.parent=n.parent),i&&(r.child=i),e.Cmdbuild.utilities.proxy.getLookupData(t,{active:!0},function(t,i){if(r.values=t,a.lookupTree[n.name]=r,n.parent&&a.lookupValue[n.name]){var d=a.lookupValue[n.name],s=e.grep(t,function(e){return e._id==d});s.length&&(a.lookupValue[s[0].parent_type]=s[0].parent_id)}n.parent?a.generateLookupTypeTree(n.parent,n.name):a.generateHTML()},this)},this)},this.generateHTML=function(){var t=e("#"+this.param.id),i=this.param.lookupType;if(this.param.readOnly)return void this.showReadOnlyLookup(i);if(!this.lookupTree[i])return void console.log("NOT FOUND : this.lookupTree["+i+"]");if(this.lookupTree[i].parent){if(t.attr("rel",this._getRelValueByType(i)),t.selectmenu("widget").addClass("selectmenu-newrow"),this.lookupValue[i]){var a=this.lookupTree[i].parent,n=this.lookupValue[a];this.updateChildSelect(i,n)}this.addParentSelect(this.lookupTree[this.param.lookupType].parent,t)}else this.addOptions(t,this.lookupTree[i].values)},this.addOptions=function(t,i){t.empty();var a=this,n=e("<option>");t.append(n),e.each(i,function(i,n){var d=e("<option>").attr("value",n._id);d.text(n.description),a.lookupValue[n._type]==n._id&&d.attr("selected","selected"),t.append(d)}),t.selectmenu("refresh")},this.addParentSelect=function(t,i){var a=this,n=this.lookupTree[t],d=e("<select>");d.attr("rel",this._getRelValueByType(t)),i.before(d),i.before("<div></div>"),d.selectmenu({change:function(e,t){a.updateChildSelect(n.child,t.item.value)}}),n.parent?selectfield.selectmenu().addClass("selectmenu-newrow"):this.addOptions(d,n.values)},this.updateChildSelect=function(t,i){var a=this.lookupTree[t],n=[],d=e("select[rel='"+this._getRelValueByType(t)+"']");e.each(a.values,function(e,t){t.parent_id==i&&n.push(t)}),this.addOptions(d,n)},this.showReadOnlyLookup=function(t){if(!e.isEmptyObject(this.lookupValue)){var i=this.lookupTree[t].values,a=this.lookupValue[t],n=this.getSelectedItem(i,a),d=e("#"+this.param.id);n&&(d.after(n.description),n.parent_type&&(d.after(" / "),this.showReadOnlyLookup(n.parent_type)))}},this.getSelectedItem=function(t,i){var a;return e.each(t,function(e,t){t._id==i&&(a=t)}),a},this._getRelValueByType=function(e){return this.param.id+e},this.init()};e.Cmdbuild.standard.lookupField=t,e.Cmdbuild.standard.lookupField.setValue=function(t,i){var a=e("#"+t);a.val(""),a.selectmenu("refresh")},e.Cmdbuild.standard.lookupField.clearValue=function(t){var i=e("#"+t);i.val(""),i.selectmenu("refresh")}}(jQuery),function(e){var t="selectedNavItem",i="cmdbuild_navigation",a=function(){this.id=null,this.config={},this.backend=void 0,this.tree={},this.init=function(t){this.config=t,this.id=t.form,t.labelField||(t.labelField="_description"),t.idField||(t.idField="_id");var i=e.Cmdbuild.utilities.getBackend(t.backend);this.backend=new i(t,this.onInitComplete,this)},this.onInitComplete=function(){var e={},t=this;this.backend.loadData(e,function(){t.show()},this)},this.show=function(){var a=this.backend.getData();e.Cmdbuild.dataModel.push({form:this.id,type:"navigation",currentIndex:-1,data:a});try{this.organizeTree()}catch(n){e.Cmdbuild.errorsManager.popup(n)}var d=e("#"+this.config.container),s=this.generateUL("root",this.config.form,i);d.append(s),this.config.collapsible&&(r.walk(this.config.form),d.addClass("collapsibleNavigation")),d.children("ul").children("li:first-child").children("a:first-child").addClass(t)},this.organizeTree=function(){this.tree={};var t=this,i=this.config.parentField;if(!i){var a=new Error("Missing parentField parameter.");throw a.name="ConfigurationError",a}e.each(this.backend.getData(),function(e,a){var n=a[i];n||null!==n||(n="root"),-1===Object.keys(t.tree).indexOf(n.toString())&&(t.tree[n]=[]),t.tree[n].push(a)})},this.generateUL=function(i,a,r){var s=this,o="rel-itemid",l=this.config.labelField,u=this.config.idField,c=e("<ul></ul>");a&&c.attr("id",a),r&&c.addClass(r);var m=this.tree[i];return m&&e.each(m,function(i,a){var r=a[u],m=e("<li></li>"),g=e("<a></a>").attr("href","#").attr(o,r).text(a[l]).click(function(){var i=e(this);e("#"+s.config.container+" ."+t).removeClass(t),i.addClass(t);var a=n(s.backend.getData(),u,i.attr(o));return d(s.config.form,a),!1});m.append(g),-1!==Object.keys(s.tree).indexOf(r.toString())&&m.append(s.generateUL(r.toString())),c.append(m)}),c}},n=function(e,t,i){for(var a=0;a<e.length;a+=1)if(e[a][t]==i)return a},d=function(t,i){e.Cmdbuild.dataModel.setCurrentIndex(t,i)},r={collapse:function(e){e.slideToggle(500)},walk:function(t){var i=this;e("a","#"+t).each(function(){var t,a=e(this);a.parent();if(a.next().is("ul")){var n=a.next();t=e("<span></span>").addClass("navCommandIcon"),t.click(function(e){e.preventDefault(),i.collapse(n),t.toggleClass("active")})}else t=e("<span></span>").addClass("navBullet").html("&bull;");a.before(t)})}};e.Cmdbuild.standard.navigation=a}(jQuery),function(e){function t(t){var i=e("<form></form>").attr("action","#").attr("name",t).attr("id",t);return i}function i(t,i){if(t.valid()){var a={};return e.each(i,function(i,n){var d=e.Cmdbuild.fieldsManager.getFieldId(t.attr("id"),n._id);a[n._id]=e.Cmdbuild.utilities.getHtmlFieldValue("#"+d)}),a}var n=[],d=t.validate().errorList;return e.each(d,function(t,a){var d=e(a.element).attr("name"),r=e.grep(i,function(e){return e._id==d}),s=r.length>0?r[0]:null;s&&n.push({field:s.description,message:a.message})}),void e.Cmdbuild.errorsManager.popupOnRequestFields(n)}var a=function(){this.config=null,this.id=null,this.backend=null,this.init=function(t){this.config=t,this.config.backend="OpenReport";var i=e.Cmdbuild.utilities.getBackend(this.config.backend);this.backend=new i(this.config,this.onInitialized,this)},this.onInitialized=function(){return this.getBackend().getReportId()?void(this.getBackendAttributes().length>1||!this.config.extension?this.showAttributesPopup():this.openReport({_extension:this.config.extension})):!1},this.openReport=function(t){var i=t._extension;window.open(e.Cmdbuild.utilities.proxy.getURIForReportDownload(this.getBackend().getReportId(),i,t))},this.showAttributesPopup=function(){var a=this,n="openreport_"+this.getBackend().getReportId(),d=n+"_dialogcontainer",r=e(e.Cmdbuild.global.getConfigurationDocument());r.find("DATA").append(e("<div></div>").attr("id",d));var s=n+"_form_container",o=e("<div></div>").attr("id",s),l=t(n+"_form");l.appendTo(o);this.getBackendAttributes(),e.Cmdbuild.utilities.getFormValidatorObject(),e("<div />").attr("id",n+"_dialog").html(o).dialog({title:a.getBackend().getReportDescription(),dialogClass:e.Cmdbuild.global.getThemeCSSClass()+" dialogOverflowVisible",closeText:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),width:700,height:400,buttons:[{text:"OK",click:function(){var t=i(l,a.getBackendAttributes());void 0!==t&&(a.openReport(t),e(this).dialog("close"))}}],close:function(t,i){return e(this).dialog("destroy"),r.find("#"+d).remove(),!1},create:function(e,t){a.drawForm(l,d,a.getBackendAttributes())}})},this.drawForm=function(t,i,a){var n=e.Cmdbuild.utilities.getFormValidatorObject(),d={method:"evaluate",fields:{}};this.config.extension&&(d.fields._extension={defaultValue:this.config.extension,writable:!1}),e.isEmptyObject(this.config.customattrs)||e.extend(d.fields,this.config.customattrs),e.isEmptyObject(d.fields)||e.Cmdbuild.dataModel.evaluateJSONAttributes(a,d),e.each(a,function(a,d){var r=e.Cmdbuild.fieldsManager.generateHTML(d,t.attr("id"),i,d.defaultValue),s=e.Cmdbuild.fieldsManager.getFieldValidator(d);s&&s.rules&&!e.isEmptyObject(s.rules)&&(n.rules[d._id]=s.rules),t.append(r)}),t.validate(n)},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.getBackendData=function(){var e=this.getBackend();return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),e.data)},this.getBackendAttributes=function(){var e=this.getBackend();return e.getAttributes?e.getAttributes():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.attributes)}};e.Cmdbuild.standard.openreport=a}(jQuery),function(e){var t=function(){this.config={},this.init=function(t){try{this.config=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{e.Cmdbuild.eventsManager.deferEvents();var t=e("#"+this.config.dialog),i=e.Cmdbuild.elementsManager.getElement(this.config.form),a=e.Cmdbuild.elementsManager.insertChildren(i);t.html(a),t.dialog("option","dialogClass",e.Cmdbuild.global.getThemeCSSClass());var n=this.config.width,d=this.config.height;t.dialog("option","height",d||e.Cmdbuild.global.modalMaxHeight),t.dialog("option","width",n||e.Cmdbuild.global.modalMaxWidth);var r=this.config.title,s=this.config.i18nTitle;s&&(r=e.Cmdbuild.translations.getTranslation(s,r)),t.dialog("option","title",r).dialog("open"),e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(o){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),o}}};e.Cmdbuild.standard.popup=t}(jQuery),function(e){function t(t,i){return t&&"class"===t||!t&&e.Cmdbuild.dataModel.isAClass(i)}function i(t,i){return t&&"process"===t||!t&&e.Cmdbuild.dataModel.isAProcess(i)}function a(e,a,n){return n?n:t(e,a)?s:i(e,a)?o:void 0}function n(t){var i=e("<div></div>").attr("id",t);i.dialog({autoOpen:!1,modal:!0,dialogClass:e.Cmdbuild.global.getThemeCSSClass(),closeText:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}})}function d(a,n){return t(n,a)?e.Cmdbuild.utilities.getClassDescription(a):i(n,a)?e.Cmdbuild.utilities.getProcessDescription(a):void 0}function r(t,i){e(t.target).trigger("searchreferenceitem")}var s="CardList",o="ReferenceActivityList",l=function(i){this.config=i,this.backend=void 0,this.init=function(){this.config.displayAttribute||(this.config.displayAttribute=e.Cmdbuild.standard.configuration.reference.displayAttribute),this.config.optionsLimit||(this.config.optionsLimit=e.Cmdbuild.standard.configuration.reference.optionsLimit),this.config.sortAttribute||(this.config.sortAttribute=e.Cmdbuild.standard.configuration.reference.sort.attribute),this.config.sortDirection||(this.config.sortDirection=e.Cmdbuild.standard.configuration.reference.sort.direction);var t=a(this.config.targetType,this.config.targetClass,this.config.customBackend),i=e.Cmdbuild.utilities.getBackend(t),n={className:this.config.targetClass};this.setBackend(new i(n,this.initReference,this))},this.initReference=function(){var t=this,i=e("#"+this.config.id);n(this.config.id+"_lookupDialog"),e.Cmdbuild.standard.elements.lookupDialog(this.config.id,{formName:i.attr("form"),fieldName:i.attr("name"),className:this.config.targetClass,backend:a(this.config.targetType,this.config.targetClass,this.config.customBackend),toExecCommand:this.config.id,bReference:"",cqlRefForm:this.config.cqlRefForm,cqlRefField:this.config.cqlRefField,container:this.config.container,sort:this.config.sortAttribute,direction:this.config.sortDirection}),i.on({clearreference:function(e){t.clear()},searchreferenceitem:function(i){var a=t.config.id;e.Cmdbuild.standard.commands.navigate({form:a+"_dialog",dialog:a+"_lookupDialog",title:d(t.config.targetClass,t.config.targetType),width:"90%"})},itemselectedfromgrid:function(i){var a=e.Cmdbuild.dataModel.getValue(t.config.id+"_dialogGrid","_id");t.updateValue(a)},refreshfield:function(e){t.loadReference()}}),this.loadReference()},this.loadReference=function(){var t=this;return this.config.readOnly?void this.loadReadOnlyReference():void e.Cmdbuild.CqlManager.resolve(t.config.cqlRefForm,t.config.cqlRefField,function(i){return void 0==i||e.Cmdbuild.CqlManager.isUndefined(i)?void t.addEmptyOption():(i&&(t.config.filter={CQL:i},t.getBackend().filter=this.config.filter),void t.loadData())},this)},this.loadReadOnlyReference=function(){var i=this;if(this.config.value){var a=e("#"+this.config.id),n=e("<span></span>").addClass("referenceLabel");
a.after(n),t(this.config.targetType,this.config.targetClass)?e.Cmdbuild.utilities.proxy.getCardData(this.config.targetClass,this.config.value,{},function(e,t){n.text(e[i.config.displayAttribute]),i.fieldReady()},this):e.Cmdbuild.utilities.proxy.getCardProcess(this.config.targetClass,this.config.value,{},function(e,t){n.text(e[i.config.displayAttribute]),i.fieldReady()},this)}},this.addEmptyOption=function(){var t=e("#"+this.config.id);t.empty();var i=e("<option></option>").attr("selected","selected");t.append(i),t.val(""),this.fieldChanged(),this.fieldReady()},this.addOptionsFromBackend=function(){var t=this,i=e("#"+this.config.id);i.empty();var a=this.getBackend().getData(),n="true"===this.config.mandatory||this.config.mandatory===!0;i.append(e("<option></option>")),e.each(a,function(d,r){var s=e("<option></option>").attr("value",r._id).text(r[t.config.displayAttribute]);(r._id==t.config.value||1===a.length&&(n||t.config.preselectIfUnique))&&(s.attr("selected","selected"),i.val(t.config.value)),i.append(s)}),this.fieldChanged(),this.fieldReady()},this.addOptionForCurrentValue=function(){var i=this,a=e("#"+this.config.id);a.empty(),t(this.config.targetType,this.config.targetClass)?e.Cmdbuild.utilities.proxy.getCardData(this.config.targetClass,this.config.value,{},function(t,n){a.append(e("<option></option>").attr("value",t._id).text(t[i.config.displayAttribute])),a.val(t._id),i.fieldChanged(),i.fieldReady()},this):e.Cmdbuild.utilities.proxy.getCardProcess(this.config.targetClass,this.config.value,{},function(t,n){a.append(e("<option></option>").attr("value",t._id).text(t[i.config.displayAttribute])),a.val(t._id),i.fieldChanged(),i.fieldReady()},this)},this.fieldChanged=function(){e.Cmdbuild.custom.commands&&e.Cmdbuild.custom.commands.fieldChanged?e.Cmdbuild.custom.commands.fieldChanged(this.config):e.Cmdbuild.standard.commands.fieldChanged(this.config),e("#"+this.config.id).selectmenu("refresh"),e("#"+this.config.id).trigger("cmdbuildfieldchanged")},this.fieldReady=function(){e("#"+this.config.id).trigger("cmdbuildfieldready")},this.loadData=function(){var e=this,t={page:0,start:0,nRows:e.config.optionsLimit,sort:e.config.sortAttribute,direction:e.config.sortDirection};this.getBackend().loadData(t,this.showReference,this)},this.showReference=function(t,i){var a=e("#"+this.config.id),n=this.getBackend().getTotalRows()<this.config.optionsLimit;n?this.addOptionsFromBackend():this.config.value?this.addOptionForCurrentValue():this.addEmptyOption(),a.off("selectmenuopen",r),n||a.on("selectmenuopen",r)},this.updateValue=function(t){var i=this;this.config.value=t,this.getBackend().getTotalRows()<this.config.optionsLimit?(e("#"+i.config.id).val(t),i.fieldChanged()):i.addOptionForCurrentValue()},this.clear=function(){var t=e("#"+this.config.id),i=this.getBackend().getTotalRows()<this.config.optionsLimit;i?(t.val(""),this.fieldChanged()):this.addEmptyOption()},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.init()};e.Cmdbuild.standard.referenceField=l}(jQuery),function(e){function t(){return{paginate:{first:"«",previous:"‹",next:"›",last:"»"},info:$.Cmdbuild.translations.getTranslation("cgf_pagination_info","Page _PAGE_ of _PAGES_ (records _TOTAL_)"),search:$.Cmdbuild.translations.getTranslation("cgf_pagination_search","Search"),aria:{paginate:{first:$.Cmdbuild.translations.getTranslation("cgf_pagination_first","First"),previous:$.Cmdbuild.translations.getTranslation("cgf_pagination_previous","Previous"),next:$.Cmdbuild.translations.getTranslation("cgf_pagination_next","Next"),last:$.Cmdbuild.translations.getTranslation("cgf_pagination_last","Last")}}}}var i=function(){this.id=null,this.config=null,this.backend=null,this.reports=null,this.init=function(e){this.config=e,this.id=this.config.form;var t=$.Cmdbuild.elementsManager.getElement(this.config.form);this.reports=$.Cmdbuild.utilities.getReportsOverrides(t),this.updateConfig();var i=$.Cmdbuild.utilities.getBackend("Reports"),a=new i(param,this.show,this);this.setBackend(a)},this.updateConfig=function(){void 0===this.config.nRows&&(this.config.nRows=$.Cmdbuild.global.getApplicationConfig().grid.pagelength),void 0===this.config.showsearch?this.config.showsearch=!0:this.config.showsearch="true"==this.config.showsearch,void 0===this.config.enablesorting?this.config.enablesorting=!0:this.config.enablesorting="true"==this.config.enablesorting},this.show=function(){var e=this,i=$("#"+this.config.container);i.addClass("cgf-reporslist-container"),i.empty();var a=$("<table></table>").attr("id",this.id).addClass("display");a.appendTo(i),a.DataTable({columns:[{name:"description",orderable:e.config.enablesorting,data:"description",title:$.Cmdbuild.translations.getTranslation("cgf_label_description","Description")}],pageLength:e.config.nRows,lengthChange:!1,info:!0,processing:!0,serverSide:!0,searching:e.config.showsearch,language:t(),ajax:function(t,i,a){e.loadData(t,i,a)}}),this.addEventsListeners()},this.loadData=function(e,t,i){var a=this,n={limit:e.length,start:e.start,searchTherm:e.search.value,sort:[]};$.each(e.order,function(e,t){n.sort.push({property:i.aoColumns[t.column].data,direction:t.dir.toUpperCase()})}),a.getBackend().loadData(n,function(e,i){t({data:e,recordsTotal:i.total,recordsFiltered:i.total})},this)},this.addEventsListeners=function(){var e=this,t=$("#"+this.id).DataTable();$("#"+this.id+" tbody").on("click","tr",function(){e.onSelectRow(this,t)}),$("#"+this.id+" tbody tr").css("cursor","pointer")},this.onSelectRow=function(e,t){var i=this,a=t.row(e).data();this.getBackend().getReportInfo(a._id,function(e,t){var a=i.reports[e.title],n=null;a&&a.extension&&(n=a.extension),$.Cmdbuild.standard.commands.openreport({id:e._id,extension:n,customattrs:a&&a.attributes})},this)},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e}};$.Cmdbuild.standard.reportslist=i}(jQuery),function($){var scripts={init:function(e){$.Cmdbuild.eventsManager.onEvent(e)},htmlText:function(e){$("#"+e.id).cleditor()},spinner:function(e){var t=e.max,i=e.min;$("#"+e.id).spinner({spin:function(a,n){return n.value>t?($(this).spinner("value",t),!1):n.value<i?($(this).spinner("value",i),!1):void $.Cmdbuild.eventsManager.onEvent(e.spin)},change:function(a,n){return n.value>t?($(this).spinner("value",t),!1):n.value<i?($(this).spinner("value",i),!1):void $.Cmdbuild.eventsManager.onEvent(e.spin)}})},lookup:function(param){try{param.readOnly||($("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}}));var objectField=new $.Cmdbuild.standard.lookupField(param);$("#"+param.id)[0].objectField=objectField}catch(e){throw $.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.scripts.lookup "+e.message),e}},select:function(param){try{$("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}});var objectField=new $.Cmdbuild.standard.selectField(param);$("#"+param.id)[0].objectField=objectField}catch(e){$.Cmdbuild.errorsManager.log(e)}},reference:function(param){try{param.readOnly||($("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}}));var objectField=new $.Cmdbuild.standard.referenceField(param);$("#"+param.id)[0].objectField=objectField}catch(e){throw $.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.scripts.lookup "+e.message),e}},checkbox:function(e){$('input[type="checkbox"][id="'+e.id+'"]').change(function(){e.value=this.checked?!0:!1,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(e):$.Cmdbuild.standard.commands.fieldChanged(e),this.checked?$('label[for="'+e.id+'"]').addClass("checked"):$('label[for="'+e.id+'"]').removeClass("checked")})},integer:function(e){try{}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.integer"),$.Cmdbuild.errorsManager.log(t),t}},openMenu:function(e){try{$("#"+e.id).tooltip({content:$("#"+e.id).attr("title")})}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.openMenu"),$.Cmdbuild.errorsManager.log(t),t}},date:function(e){try{var t=$("#"+e.id);switch(e.type){case"timestamp":t.datetimepicker({dateFormat:"dd/mm/yy",timeFormat:"HH:mm:ss"});break;case"time":t.timepicker({timeFormat:"HH:mm:ss"});break;case"dateTime":t.datetimepicker({dateFormat:"dd/mm/yy",timeFormat:"HH:mm:ss"});break;case"date":t.datepicker({dateFormat:"dd/mm/yy"})}}catch(i){throw i.message!=$.Cmdbuild.errorsManager.CMERROR&&(i.message+="\n$.Cmdbuild.standard.scripts.date"),$.Cmdbuild.errorsManager.log(i),i}},dialog:function(e){$("#"+e.id).dialog({autoOpen:!1,modal:!0,closeText:$.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),beforeClose:e.callback?e.callback:function(){},show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}})},menu:function(e){$("#"+e.id).menu()},grid:function(e){try{e.backend=$.Cmdbuild.utilities.getBackend(e.backend)}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.grid"),$.Cmdbuild.errorsManager.log(t),t}},button:function(e){$("#"+e.id).button({icons:{primary:e.icon},text:!1}).click(function(e){e.preventDefault()})},graph:function(e){var t={defaultNodeColor:"#ec5148",defaulLabelColor:"#99f",defaultEdgeColor:"#aaa",edgeColor:"default",labelSizeRatio:".5",labelThreshold:.1},i=new sigma({container:e.id,settings:t});visit(e.className,e.cardId,e.description,{},{},{},i),i.startForceAtlas2()}};$.Cmdbuild.standard.scripts=scripts}(jQuery),function(e){var t=function(t){this.config=null,this.backend=void 0,this.init=function(){try{var i=this;if(this.config=t,this.config.options)i.show();else if(this.config.backend){var a=e.Cmdbuild.utilities.getBackend(this.config.backend);this.backend=new a(this.config,function(){i.show()},this)}}catch(n){e.Cmdbuild.errorsManager.log(n)}},this.show=function(){var e=this;setTimeout(function(){e.config.readOnly===!0||"true"===e.config.readOnly?e.drawReadOnlySelect():e.drawOptions()},300)},this.drawOptions=function(){var t=e("#"+this.config.id),i=this.getValue();if(t.empty(),!this.config.hideEmptyOption){var a=e("<option></option>").attr("value","").attr("entryValue","");i||a.attr("selected","selected"),t.append(a)}e.each(this.getData(),function(a,n){var d=e("<option></option>").attr("value",n.value).attr("entryValue",n.value).text(n.label);i&&i==n.value&&d.attr("selected","selected"),t.append(d)}),t.selectmenu("refresh"),this.onInitComplete()},this.drawReadOnlySelect=function(){var t=this.getValue(),i=e("#"+this.config.id);e.each(this.getData(),function(a,n){return t&&t==n.value?(i.parent().find("span").remove(),void i.after(e("<span></span>").text(n.label))):void 0})},this.getValue=function(){return"$fromBackend"==this.config.value?this.backend.getValue():this.config.value},this.onInitComplete=function(){this.config.refreshGridAfterInit&&e.Cmdbuild.standard.commands.refreshGrid({form:this.config.refreshGridAfterInit})},this.getBackendData=function(){var e=this.backend;return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),e.data)},this.getData=function(){var t=[];if(this.config.options)t=this.config.options;else{var i=this.getBackendData();e.each(i,function(e,i){t.push({value:i._id,label:i.description})})}return t},this.init()};e.Cmdbuild.standard.selectField=t,e.Cmdbuild.standard.selectField.setValue=function(t,i){var a=e("#"+t);a.val(""),a.selectmenu("refresh")},e.Cmdbuild.standard.selectField.clearValue=function(t){var i=e("#"+t);i.val(""),i.selectmenu("refresh")}}(jQuery),function(e){var t=function(){this.param=void 0,this.forms=[],this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);this.forms=this.getForms(t),this.prepareParams(this.forms),this.includeForms()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.show"),i}},this.showCB=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i=e.Cmdbuild.elementsManager.getXmlElementId(t);this.forms=this.getForms(t);var a="<div id='"+i+"'>";a+=this.insertTitles(this.forms),a+=this.insertForms(this.forms),a+="</div>";var n=e("#"+this.param.container)[0];n.innerHTML=a,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents(),e("#"+i).tabs({activate:function(t,i){e(e.fn.dataTable.tables(!0)).DataTable().columns.adjust(),e.Cmdbuild.standard.tabbed.fireChangeTab(i.newPanel[0].id)}})}catch(d){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.show"),d}},this.getForms=function(t){var i=[],a=e(t);return a.children("form").each(function(t){var a=e(this),n=e.Cmdbuild.elementsManager.getParams(a),d=e.Cmdbuild.utilities.getFields(a);d&&e.Cmdbuild.dataModel.putFormFields(d);var r=a.attr("title"),s=a.attr("i18nTitle");s&&(r=e.Cmdbuild.translations.getTranslation(s,r)),i.push({form:this,title:r,id:a.attr("id"),include:a.attr("include"),classes:a.attr("class"),invisible:a.attr("invisible"),params:n})}),i},this.prepareParams=function(t){try{for(var i=0;i<t.length;i++)t[i].params&&e.Cmdbuild.dataModel.prepareCallerParameters(t[i].id,t[i].params)}catch(a){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.prepareParams"),a}},this.insertTitles=function(t){try{var i="";i+="<ul>";for(var a=0;a<t.length;a++){var n="";"true"===t[a].invisible&&(n=" class='invisible' "),i+="<li "+n+"><a href='#"+t[a].id+"'>"+t[a].title+"</a></li>"}return i+="</ul>"}catch(d){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.insertTitles"),d}},this.includeForms=function(){if(this.forms.length<=0)return void this.showCB();var t=this.forms[0];this.forms.splice(0,1),e.Cmdbuild.utilities.include(t.form,this.includeForms,{},this)},this.insertForms=function(t){try{for(var i="",a=0;a<t.length;a++)i+="<div id='"+t[a].id+"' class='"+t[a].classes+"'>",i+=e.Cmdbuild.elementsManager.insertChildren(t[a].form),i+="</div>";return i}catch(n){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.insertForms"),n}}};e.Cmdbuild.standard.tabbed=t,e.Cmdbuild.standard.tabbed.fireChangeTab=function(t){var i=e.Cmdbuild.elementsManager.getElement(t);e.Cmdbuild.dataModel.pushParametersOnStack(t);var a=e.Cmdbuild.elementsManager.getEvent("onClick",i);e.Cmdbuild.eventsManager.onEvent(a)}}(jQuery),function(e){function t(e,t,i,a){var n=e+"_"+t._id,d="<button ",r=t.label.replace(/'/g,"\\'");return d+=" id='"+n+"' ",d+=" text='"+r+"' ",d+=">",d+="<onClick>",d+="<command>navigate</command>",d+="<dialog>"+n+"_widgetDialog</dialog>",d+="<container>"+i+"</container>",d+="<form>"+n+"_dialogForm</form>",d+="<title>"+t.label+"</title>",d+="</onClick>",d+="<params>",d+="<dialog>"+n+"_widgetDialog</dialog>",d+="<widgetId>"+n+"</widgetId>",d+="<widgetClassName>"+t.data.className+"</widgetClassName>",d+="<singleSelect>"+t.data.singleSelect+"</singleSelect>",d+="<formData>"+e+"</formData>",d+="<selection>"+(1==t.data.noSelect?"false":"true")+"</selection>",d+="<editable>"+t.data.allowCardEditing+"</editable>",d+="<readOnly>"+("true"==a?"true":"false")+"</readOnly>",d+="<widgetName>"+n+"</widgetName>",d+="</params>",d+="</button>"}function i(t,i){var a="<form title='Example' id='"+t+"_dialogForm'";if(i.data&&i.data.template)a+=' include="'+i.data.template+'"';else{var n=e.Cmdbuild.standard.widgetDiv.widgetName(i.type)+".xml";a+=" include='widgets/"+n+"'",a+=" fileType='core'"}return a+=" withId='"+t+"'",a+=" class='cmdbuildTabbedForm'/>"}var a={getWidgetDiv:function(t){try{var i=this.createXmlDiv(t.form,t.widgets,t.container,t.readOnly);if(null===i)return"";var a="";return a+=e.Cmdbuild.elementsManager.toHtml(i),a+=this.createAllPopups(t.form,t)}catch(n){e.Cmdbuild.errorsManager.popup(n)}},createXmlDiv:function(t,i,a,n){for(var d="",r=0;r<i.length;r++){var s=i[r];(!n||s.data.alwaysenabled)&&(d+=this.createXmlButton(t,s,a,n))}if(""===d)return null;var o="<div";o+=" class='ui-widget-content ui-corner-all cmdbuild-widget-container' ",o+=" withReturn='true' ",o+=">",o+=d,o+="</div>";for(var r=0;r<i.length;r++){var s=e.Cmdbuild.standard.widgetDiv.widgetName(i[r].type);e.Cmdbuild.widgets[s]&&e.Cmdbuild.widgets[s].cleanData(t,i[r])}var l=new DOMParser;return xDoc=l.parseFromString(o,"text/xml"),xDoc.documentElement},createXmlButton:function(i,a,n,d){var r,s=e.Cmdbuild.standard.widgetDiv.widgetName(a.type);return r=e.Cmdbuild.widgets[s]&&e.Cmdbuild.widgets[s].createXmlButton?e.Cmdbuild.widgets[s].createXmlButton(i,a,n,d):t(i,a,n,d)},createXmlDialog:function(e){var t="<dialog id='"+e+"_widgetDialog'></dialog>",i=new DOMParser;return xDoc=i.parseFromString(t,"text/xml"),xDoc.documentElement},createAllPopups:function(t,i){for(var a="",n=0;n<i.widgets.length;n++){var d=t+"_"+i.widgets[n]._id,r={data:i.widgets[n].data,form:t};if(e.Cmdbuild.dataModel.getWidgetWindow(d))e.Cmdbuild.dataModel.substituteWidgetWindow(d,r);else{var s=this.createXmlDialog(d);a+=e.Cmdbuild.elementsManager.toHtml(s),e.Cmdbuild.dataModel.putWidgetWindow(d,r)}this.widgetForm(d,i,i.widgets[n])}return a},widgetForm:function(t,a,n){var d,r=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);d=e.Cmdbuild.widgets[r]&&e.Cmdbuild.widgets[r].widgetForm?e.Cmdbuild.widgets[r].widgetForm(t,n):i(t,n);var s=new DOMParser;xDoc=s.parseFromString(d,"text/xml");var o=xDoc.documentElement,l=e.Cmdbuild.elementsManager.getElement(a.container);l.appendChild(o)},getFiter:function(e){var t="";return t}};e.Cmdbuild.standard.widgetDiv=a,e.Cmdbuild.standard.widgetDiv.widgetName=function(e){var t=e.split(".");return t[t.length-1]}}(jQuery),function(e){function t(t){var i=e("<form></form>").attr("action","#").attr("name",t).attr("id",t);return i}var i=function(){this.config=null,this.id=null,this.backend=null,this.init=function(t){this.config=t,this.config.backend="CustomFormWidget",this.id=t.form;var i=e.Cmdbuild.utilities.getBackend(this.config.backend);this.backend=new i(this.config,this.show,this)},this.show=function(){function i(t,d){var r=a.change();if(r.length>0&&"form"===a.getBackendWidgetConfig().layout){var s="errorDialog",o=e.Cmdbuild.errorsManager.getAttributesErrorsMessage(r);return e.Cmdbuild.utilities.showConfirmPopup("Error!",o,s,{text:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),click:function(){e("#"+s).dialog("close"),u.off("dialogbeforeclose",i);var t=e("#"+u.attr("aria-describedby"));t.dialog("close")}},{text:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_fixerrors","Fix errors"),click:function(){e("#"+s).dialog("close")}},400,400),!1}if(u.off("dialogbeforeclose"),n.remove(),a.getBackend().isFromGrid()){var l=e.Cmdbuild.dataModel.forms[a.config.gridId];l.refreshTable()}}var a=this;e.Cmdbuild.CqlManager.compile(this.config.instanceForm,this.getBackendAttributes());var n=e("#"+this.config.container);n.empty();var d=t(this.id);d.appendTo(n),e.isEmptyObject(this.getBackend().getData())&&this.getBackend().addEmptyRecord();var r=this.getBackendAttributes(),s=this.getBackendData(),o=e.Cmdbuild.utilities.getFormValidatorObject();e.each(r,function(t,i){var n=s[i._id];a.readonlyForm()&&(i.writable=!1);var r=e.Cmdbuild.fieldsManager.generateHTML(i,a.id,a.config.container,n,a.config.instanceForm),l=i,u=e.Cmdbuild.fieldsManager.getFieldValidator(l);u&&u.rules&&!e.isEmptyObject(u.rules)&&(o.rules[i._id]=u.rules),d.append(r),i.type!==e.Cmdbuild.fieldsManager.types.TEXT||"HTML"!==i.editorType||i.writable!==!0&&"true"!==i.writable||r.find("textarea").cleditor()[0].refresh()}),d.validate(o);var l;l=this.getBackend().isFromGrid()?a.config.gridId+"_form_dialog":this.config.instanceForm+"_"+this.config.widgetId+"_widgetDialog";var u=e("#"+this.config.container).parents("[role=dialog]");u.on("dialogbeforeclose",i)},this.readonlyForm=function(){var e=this.getBackendWidgetConfig().capabilities;return e.readOnly&&(e.readOnly===!0||"true"===e.readOnly)},this.change=function(){var t=this,i=e("#"+this.id),a=this.getBackendAttributes(),n=this.getBackendData(),d=n[t.getBackend().extraproperties.ID],r=[];if(t.getBackend().removeRowErrors(d),!i.valid()){var s=i.validate().errorList;e.each(s,function(i,n){var s,o=e(n.element).attr("name"),l=e.grep(a,function(e){return e._id==o}),u=l.length>0?l[0]:null;u&&(s={field:u.description,message:n.message},r.push(s));var c=t.getBackend().getFieldErrors(d,u.name);c||(c=[]),c.push(s),t.getBackend().updateAttributeErrors(d,u.name,c)})}return e.each(a,function(i,a){var d=e.Cmdbuild.fieldsManager.getFieldId(t.id,a._id),r=e.Cmdbuild.utilities.getHtmlFieldValue("#"+d);r!==n[a._id]&&t.getBackend().updateRecordProperty(n[t.getBackend().extraproperties.ID],a.name,r)}),r},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.getBackendData=function(){var e=this.getBackend();return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),e.data)},this.setBackendData=function(e){var t=this.getBackend();t.setData?t.setData(e):(console.warn("Missing setData method for backend "+this.config.backend),t.data=e)},this.getBackendAttributes=function(){var e=this.getBackend();return e.getAttributes?e.getAttributes():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.attributes)},this.setBackendAttributes=function(e){var t=this.getBackend();t.setAttributes?t.setAttributes(e):(console.warn("Missing setAttributes method for backend "+this.config.backend),t.attributes=e)},this.getBackendWidgetConfig=function(){var e=this.getBackend();return e.getWidgetConfig?e.getWidgetConfig():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.widgetConfig)}};e.Cmdbuild.standard.customform_form=i}(jQuery),function(e){function t(t,a){var n=[],d=a.getBackend().extraproperties.ID,r=a.getBackend().extraproperties.COMMANDS;return n.push({title:d,name:d,data:d,visible:!1}),e.each(t,function(e,t){var r=void 0!==t.hidden&&(t.hidden===!1||"false"===t.hidden),s=t.description;t.mandatory&&(s="* "+s);var o={title:s,name:t.name,data:t.name,id:t._id,type:t.type,visible:r,createdCell:function(e,n,s,o,l){r&&i(e,t,s[d],n,a)}};("reference"===t.type||"lookup"===t.type)&&(o.sType="reference-sorter"),n.push(o)}),jQuery.fn.dataTableExt.oSort["reference-sorter-asc"]=function(t,i){var n=e("#"+a.id+" input[value="+t+"]:first-child").parent().text(),d=e("#"+a.id+" input[value="+i+"]:first-child").parent().text();return d>n},jQuery.fn.dataTableExt.oSort["reference-sorter-desc"]=function(e,t){return jQuery.fn.dataTableExt.oSort["reference-sorter-asc"](t,e)},n.push({title:"",name:r,data:r,width:"85px",createdCell:function(t,i,n,r,s){e(t).append(e("<a></a>").attr("href","#").button({disabled:!a.permissions._modify,icons:{primary:"ui-icon-pencil"},label:e.Cmdbuild.translations.getTranslation("cgf_core_cfw_modify_row","Modify row"),text:!1}).click(function(){return a.modifyRow(n[d]),!1})),e(t).append(e("<a></a>").attr("href","#").button({disabled:!a.permissions._clone,icons:{primary:"ui-icon-copy"},label:e.Cmdbuild.translations.getTranslation("cgf_core_cfw_clone_row","Clone row"),text:!1}).click(function(){return a.cloneRow(n[d]),!1})),e(t).append(e("<a></a>").attr("href","#").button({disabled:!a.permissions._delete,icons:{primary:"ui-icon-trash"},label:e.Cmdbuild.translations.getTranslation("cgf_core_cfw_delete_row","Delete row"),text:!1}).click(function(){a.deleteRow(n[d],t);var i=500,r=e(this).attr("aria-describedby");return e("#"+r).fadeOut(i),setTimeout(function(){e("#"+r).remove()},i),!1}))}}),n}function i(t,i,n,r,s){e(t).empty();var o=e.extend({},i,{_id:"row_"+n+"_"+i.name,writable:!1}),l=e.Cmdbuild.fieldsManager.getFormField(o,s.id,s.config.container,r);e(t).append(l);var u=s.getBackend().getFieldErrors(n,i.name);u.length&&e(t).addClass(d),s.permissions._modify&&i.writable&&!e.Cmdbuild.global.getApplicationConfig().widgets.customform.disableinlineediting&&(e(t).off("clickoutside"),e(t).click(function(){return a(t,i,n,r,s),!1}))}function a(t,a,n,r,s){function o(){var d=e._data(t,"events");d&&d.clickoutside||m.on("clickoutside",function(d,r){if(!e(r).closest("#ui-datepicker-div, .ui-datepicker-header").length){var o=[];if(!g.valid()){var l=g.validate().errorList;e.each(l,function(e,t){o.push({field:a.description,message:t.message})})}s.getBackend().updateAttributeErrors(n,a.name,o);var u=b.val();return i(t,a,n,u,s),s.updateRowValue(n,a.name,u),!1}})}function l(){m.off("clickoutside")}function u(){m.off("click")}var c="row_"+n+"_"+a.name,m=e(t);m.removeClass(d);var g=e("<form></form>").attr("name",c+"_fieldform").attr("id",c+"_fieldform").submit(function(){return!1});m.empty(),g.appendTo(m);var h=e.extend({},a,{_id:c,mandatory:!1}),f=e.Cmdbuild.fieldsManager.getFormField(h,g.attr("id"),s.config.container,r,s.config.instanceForm);g.append(f);var b=f;e.isArray(f)&&(b=f[0]),b.focus();var p=e.Cmdbuild.utilities.getFormValidatorObject(),C=e.Cmdbuild.fieldsManager.getFieldValidator(h);C&&C.rules&&!e.isEmptyObject(C.rules)&&(p.rules[c]=C.rules),g.validate(p),a.type===e.Cmdbuild.fieldsManager.types.REFERENCE?(b.on({cmdbuildfieldready:function(){u(),o()},searchreferenceitem:function(){l()}}),e("#"+b.attr("id")+"_lookupDialog").on("dialogclose",function(e,t){o()})):(u(),o())}function n(t){var i=[];return i.push(e("<a></a>").attr("href","#").button({disabled:!t.permissions._add,icons:{primary:"ui-icon-plusthick"},label:e.Cmdbuild.translations.getTranslation("cgf_core_cfw_add_row","Add row"),text:!0}).click(function(){return t.addEmptyRow(),!1})),i}var d="errorfield-cell",r=function(){this.config={},this.id=null,this.backend=null,this.permissions={_add:!1,_modify:!1,_delete:!1,_clone:!1,_export:!1,_import:!1},this.maxid=null,this.init=function(t){this.config=t,this.config.backend="CustomFormWidget",this.id=t.form;var i=e.Cmdbuild.utilities.getBackend(this.config.backend);this.backend=new i(this.config,this.show,this)},this.show=function(){function i(t,n){var d=a.getBackend().getAllErrors();if(d&&d.length){var r="errorDialog",s=e.Cmdbuild.errorsManager.getAttributesErrorsMessage(d);return e.Cmdbuild.utilities.showConfirmPopup("Error!",s,r,{text:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_close","Close"),click:function(){e("#"+r).dialog("close"),l.off("dialogbeforeclose",i);var t=e("#"+l.attr("aria-describedby"));t.dialog("close")}},{text:e.Cmdbuild.translations.getTranslation("cgf_core_dialog_fixerrors","Fix errors"),click:function(){e("#"+r).dialog("close")}},400,400),!1}}var a=this;e.Cmdbuild.CqlManager.compile(this.config.instanceForm,this.getBackendAttributes()),this.initPermissions();var d=e("#"+this.config.container);d.empty();var r=e("<div></div>").attr("id",this.getButtonsContainerId());r.append(n(this)),e("#"+this.config.container).append(r);var s=e("<table></table>").attr("id",this.id).addClass("display");e("#"+this.config.container).append(s);var o=this.getBackendData();s.DataTable({columns:t(this.getBackendAttributes(),this),paging:!1,searching:!1,info:!1,data:o,language:{zeroRecords:"",emptyTable:""}}),s.on({customformrefreshgrid:a.refreshTable});var l=e("#"+this.config.container).parents("[role=dialog]");l.on("dialogbeforeclose",i)},this.initPermissions=function(){var e=this.getBackendWidgetConfig().capabilities;(!e.readOnly||e.readOnly!==!0&&"true"!==e.readOnly)&&((e.addDisabled===!1||"false"==e.addDisabled)&&(this.permissions._add=!0),(e.modifyDisabled===!1||"false"===e.modifyDisabled)&&(this.permissions._modify=!0),(e.deleteDisabled===!1||"false"===e.deleteDisabled)&&(this.permissions._delete=!0),(e.cloneDisabled===!1||"false"===e.cloneDisabled)&&(this.permissions._clone=!0),(e.exportDisabled===!1||"false"===e.exportDisabled)&&(this.permissions._export=!0),(e.importDisabled===!1||"false"===e.importDisabled)&&(this.permissions._import=!0))},this.addRow=function(t){var i=e("#"+this.id).DataTable();i.row.add(t).draw()},this.addEmptyRow=function(){var e=this.getBackend().addEmptyRecord();this.addRow(e)},this.updateRowValue=function(e,t,i){this.getBackend().updateRecordProperty(e,t,i)},this.cloneRow=function(e){var t=this.getBackend().cloneRecord(e);t&&this.addRow(t)},this.deleteRow=function(t,i){this.getBackend().removeRecord(t);var a=e("#"+this.id).DataTable();a.row(e(i).parents("tr")).remove().draw()},this.modifyRow=function(t){var i=this,a=i.id+"_"+t,n=i.config.instanceForm+"_"+i.config.widgetId,d=n+"customform_widget_grid_form_dialog";e.Cmdbuild.dataModel.prepareCallerParameters(a,{instanceForm:i.config.instanceForm,widgetId:i.config.widgetId,recordId:t,gridId:i.id,fromGrid:!0,formDialog:d}),e.Cmdbuild.eventsManager.onEvent({id:a,command:"navigate",dialog:d,form:n+"include_customform_widget_grid_form_dialog",title:i.getBackendWidgetConfig().label})},this.refreshTable=function(){var t=e("#"+this.id).DataTable();t.rows().clear(),t.rows.add(this.getBackendData()).draw()},this.getButtonsContainerId=function(){return this.id+"_buttons"},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.getBackendData=function(){var e=this.getBackend();return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),e.data)},this.setBackendData=function(e){var t=this.getBackend();t.setData?t.setData(e):(console.warn("Missing setData method for backend "+this.config.backend),t.data=e)},this.getBackendAttributes=function(){var e=this.getBackend();return e.getAttributes?e.getAttributes():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.attributes)},this.setBackendAttributes=function(e){var t=this.getBackend();t.setAttributes?t.setAttributes(e):(console.warn("Missing setAttributes method for backend "+this.config.backend),t.attributes=e)},this.getBackendWidgetConfig=function(){var e=this.getBackend();return e.getWidgetConfig?e.getWidgetConfig():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.widgetConfig)}};e.Cmdbuild.standard.customform_grid=r}(jQuery),function(e){function t(i,a,n,d,r){function s(a,s,l,u){n[a]={data:u,saveType:e.Cmdbuild.widgets[l].saveMethod,widgetType:s},t(i,o,n,d,r)}var o=a.slice();if(n||(n={}),o.length){var l=o.splice(0,1)[0],u=e.Cmdbuild.standard.widgetDiv.widgetName(l.type);if(e.Cmdbuild.widgets[u])if(e.Cmdbuild.widgets[u].getWidgetData)e.Cmdbuild.widgets[u].getWidgetData(i,l,function(e){s(l._id,l.type,u,e)});else{var c=e.Cmdbuild.widgets[u].save(i,l);s(l._id,l.type,u,c)}else console.warn("Widget "+l.type+" not found!")}else e.Cmdbuild.authProxy.unmaskRequest(),d.apply(r,[n])}var i={SAVEONCARD:"SAVEONCARD",SAVEAFTER:"SAVEAFTER",getWidgetsData:function(i,a,n,d){e.Cmdbuild.authProxy.maskRequest(),t(i,a,{},n,d)},getWidgetsErrors:function(t,i){var a=[];return i&&i.length&&e.each(i,function(i,n){var d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]?e.Cmdbuild.widgets[d].getWidgetErrors&&(werrors=e.Cmdbuild.widgets[d].getWidgetErrors(t,n),werrors&&werrors.length&&e.each(werrors,function(e,t){a.push({label:n.label,error:t,id:n._id})})):console.warn("Widget "+n.type+" not found!");
}),a},saveOnDataWidgets:function(t,i){var a=[];e.each(i,function(t,i){if(i.saveType==e.Cmdbuild.widgets.SAVEONCARD){var n={};if(".CustomForm"===i.widgetType)n=i.data;else if(".NavigationTree"===i.widgetType)n=i.data;else for(var d in i.data)n[d]={};a.push({_id:t,output:n})}}),t._widgets=a},savePostponedWidgets:function(t,i,a,n,d,r){var s=t.slice();s=e.grep(s,function(t,a){return i[t._id].saveType==e.Cmdbuild.widgets.SAVEAFTER}),this.savePostponedWidgetsRecursive(s,i,a,n,function(){d.apply(r,[])},this)},savePostponedWidgetsRecursive:function(t,i,a,n,d,r){if(t.length<=0)return void d.apply(r,[]);var s=t[0];t.splice(0,1);var o=i[s._id];if(!o)return void d.apply(r,[]);if(o.saveType==e.Cmdbuild.widgets.SAVEAFTER){var l=e.Cmdbuild.standard.widgetDiv.widgetName(o.widgetType);e.Cmdbuild.widgets[l].flush(a,i[s._id].data,s._id,n,function(){this.savePostponedWidgetsRecursive(t,i,a,n,d,r)},this)}else this.savePostponedWidgetsRecursive(t,i,a,n,d,r)},evaluateCqlFields:function(t,i){for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].evaluateCql&&e.Cmdbuild.widgets[d].evaluateCql(t,n)}},initialize:function(t,i){for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].initialize&&e.Cmdbuild.widgets[d].initialize(t,n)}},refreshCqlField:function(t,i){void 0===i&&(i=[]);for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].refreshCqlField&&e.Cmdbuild.widgets[d].refreshCqlField(t,n)}},refreshTemplate:function(t,i,a){for(var n=0;n<i.length;n++){var d=i[n],r=e.Cmdbuild.standard.widgetDiv.widgetName(d.type);e.Cmdbuild.widgets[r]&&e.Cmdbuild.widgets[r].refreshTemplate&&e.Cmdbuild.widgets[r].refreshTemplate(t,i[n],a)}},prepareFields:function(t){for(var i=0;i<t.length;i++){var a=t[i],n=e.Cmdbuild.standard.widgetDiv.widgetName(a.type);e.Cmdbuild.widgets[n]&&e.Cmdbuild.widgets[n].prepareFields&&e.Cmdbuild.widgets[n].prepareFields(a)}}};e.Cmdbuild.widgets=i}(jQuery),function(e){function t(t){var i=e("<span></span>").addClass("ui-icon").addClass("navTreeIcon");return t.prepend(i),i}function i(t){var i=e("<span></span>").addClass("ui-icon").addClass("navTreeIcon");return t.prepend(i),i}var a="nodeid",n="loaded",d=500,r=function(){this.config=null,this.id=null,this.backend=null,this.init=function(t){this.config=t,this.config.backend="NavigationTreeWidget",this.id=t.form;var i=e.Cmdbuild.utilities.getBackend(this.config.backend);this.backend=new i(this.config,this.show,this)},this.show=function(){var t=this,i=e("#"+this.config.container);i.empty();var a=e("<div></div>").attr("id",this.id);a.appendTo(i),$navTreeContainer=e("<div></div>").addClass("collapsibleNavigation").addClass("ui-state-default"),$navTreeContainer.appendTo(a);var n=this.getBackend().getRootNode();this.getBackend().getNodeItems(n,null,function(e,i){var a=t.createNavigationItems($navTreeContainer,e,n,!0);t.createNextLevelItems(a)},this)},this.createNextLevelItems=function(t){var d=this;e.each(t.children("li"),function(t,r){var s=e(r);if("0"===s.attr(n)){var o=s.children("input:checkbox"),l=o.val(),u=d.getBackend().getChildrenNodes(s.attr(a));e.each(u,function(e,t){d.getBackend().getNodeItems(t,l,function(i,a){i.length&&d.createNavigationItems(s,i,t,!1),u.length===e+1&&d.initializeNavTreeLevel(s)},d)}),u.length||i(s),s.attr(n,"1")}})},this.initializeNavTreeLevel=function(a){var n=this;if(a.children("ul").length){var r=e(a.children("ul")),s=t(a);a.addClass("nodewithchildren"),s.click(function(e){e.preventDefault(),r.slideToggle(d),setTimeout(function(){a.toggleClass("active")},d),n.createNextLevelItems(r)})}else i(a);a.prepend(s)},this.createNavigationItems=function(t,i,d,r){var s=this,o=e("<ul></ul>").addClass("cmdbuild_navigation");return t.append(o),e.each(i,function(t,i){var r=e("<li></li>").attr(a,d._id).attr(n,"0").appendTo(o),l=e("<label></label>").appendTo(r),u=e("<input></input>").attr("type","checkbox").val(i._id).change(function(){var t="#"+s.id+" input[value="+i._id+"]";this.checked?e(t).prop("checked",!0):e(t).prop("checked",!1),s.getBackend().addRemoveSelection(i._id,i._type)});s.getBackend().isSelected(i._id)&&u.prop("checked",!0),u.appendTo(l);var c=(e("<span></span>").addClass("navItemIcon").addClass("ui-icon").appendTo(l),e("<em></em>"));d.domain&&(d.target.name===d.domain.source?c.text(d.domain.descriptionInverse):c.text(d.domain.descriptionDirect)),c.appendTo(l);var m="";i.Code&&(m+=" ["+i.Code+"] "),m+=i.Description;e("<span></span>").text(m).appendTo(l)}),o},this.getBackend=function(){return this.backend}};e.Cmdbuild.standard.navigationtree=r}(jQuery);
//# sourceMappingURL=standard.min.js.map