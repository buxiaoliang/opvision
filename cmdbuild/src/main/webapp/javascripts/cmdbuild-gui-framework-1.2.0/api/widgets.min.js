!function(i){var t={METADATA_ERRORS:"errors",METADATA_HASDATA:"hasdata",saveMethod:i.Cmdbuild.widgets.SAVEONCARD,initialize:function(t,a){var e=this.formName(t,a),d={};d[this.METADATA_ERRORS]=[],i.Cmdbuild.dataModel.push({form:e,type:"customformwidget",data:null,metadata:d})},formName:function(i,t){var a=i+"_"+t._id+"_customform";return a},getWidgetData:function(t,a,e){var d=i.Cmdbuild.dataModel.forms[t];if("InstanceAndCustomFormWidgets"===d.config.backend&&a.active&&"form"===a.data.layout){var l=[],n=i.Cmdbuild.dataModel.getData(t),r=d.getBackend(),o=r.extractWidgetAttributes(a),s={};i.each(o,function(i,t){s[t.originalName]=n[t.name]}),l.push(JSON.stringify(s)),e(l)}else var m=this,r=new i.Cmdbuild.standard.backend.CustomFormWidget({instanceForm:t,widgetId:a._id},function(){var t=[];i.each(r.getRawData(),function(i,a){t.push(JSON.stringify(a))}),e(t)},m)},getWidgetErrors:function(t,a){var e=[],d=this.formName(t,a);a.required&&!i.Cmdbuild.dataModel.getMetaData(d,this.METADATA_HASDATA)&&e.push(i.Cmdbuild.translations.getTranslation("cgf_core_cfw_required","Data required"));var l=i.Cmdbuild.dataModel.getMetaData(d,this.METADATA_ERRORS);return l&&l.length&&e.push(i.Cmdbuild.translations.getTranslation("cgf_core_cfw_wrongdata","Wrong data")),e},cleanData:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.cleanForm(e)},createXmlButton:function(i,t,a,e){var d,l=i+"_"+t._id,n=(t.data,t.label.replace(/'/g,"\\'"));return d="<button ",d+=" id='"+l+"' ",d+=" text='"+n+"' >",d+="		<onClick>",d+="			<command>navigate</command>",d+="			<dialog>"+l+"_widgetDialog</dialog>",d+="			<container>"+a+"</container>",d+="			<form>"+l+"_dialogForm</form>",d+="			<title>"+t.label+"</title>",d+="		</onClick>",d+="		<params>",d+="			<dialog>"+l+"_widgetDialog</dialog>",d+="			<formDialog>"+l+"_widgetDialog</formDialog>",d+="			<widgetId>"+t._id+"</widgetId>",d+="			<instanceForm>"+i+"</instanceForm>",d+="			<fromGrid>false</fromGrid>",d+="		</params>",d+="</button>"},widgetForm:function(i,t){var a=t.data,e="CustomForm";"form"===a.layout?e+="_form":"grid"===a.layout&&(e+="_grid"),e+=".xml";var d='<form title="'+t.label+'" id="'+i+'_dialogForm"';return d+=' include="widgets/'+e+'"',d+=' fileType="core"',d+=' withId="'+i+'"',d+=' class="cmdbuildTabbedForm" />'}};i.Cmdbuild.widgets.CustomForm=t}(jQuery),function(i){var t={saveMethod:i.Cmdbuild.widgets.SAVEONCARD,save:function(t,a){var e=this.formName(t,a),d=i.Cmdbuild.dataModel.forms[e];if(!d)return{};var l={};for(var n in d.checked){var r=d.checked[n];r&&(l[n]={})}return l},formName:function(i,t){var a=i+"_"+t._id+"grid";return a},cleanData:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.cleanForm(e)}};i.Cmdbuild.widgets.LinkCards=t}(jQuery),function(i){var t={FIELDTAG:"CMDBUILDFIELDTAG",ROWBUTTONREGENERATE:"refresh",ROWBUTTONREPLY:"btnIconReply",ROWBUTTONDELETE:"deleteIconButton",ROWBUTTONMODIFY:"pencilGoIcon",mailAttributes:["account","bcc","body","cc","date","delay","from","_id","keepSynchronization","noSubjectPrefix","notifyWith","promptSynchronization","status","subject","template","to","condition"],template2MailTable:{condition:"condition",account:"account",bccAddresses:"bcc",content:"body",toAddresses:"to",ccAddresses:"cc",fromAddress:"from",subject:"subject",keepSynchronization:"keepSynchronization"},saveMethod:i.Cmdbuild.widgets.SAVEAFTER,save:function(t,a){var e=(this.formName(t,a),i.Cmdbuild.dataModel.forms[t]);if(!e)return{};var d={data:e.getBackendData().mails,bkData:e.getBackendData().bkMails,name:a._id};return d},formName:function(i,t){var a=i+"_"+t._id+"formattachements";return a},cleanData:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.cleanForm(e)},prepareFields:function(i){for(var t=0;t<i.data.templates.length;t++)i.data.templates[t]=this.template2Mail(i.data.templates[t]),null===i.data.templates[t].condition&&(i.data.templates[t].condition="'true'")},evaluateCqlSingleTemplate:function(t,a,e){var d=this.getAttributes(t,a,e);this.compileAttributes(t,d),e.attributes=d,i.Cmdbuild.CqlManager.variablesTable.generate(t,i.Cmdbuild.CqlManager.commandsTable)},evaluateCql:function(t,a){for(var e=0;e<a.data.templates.length;e++){var d=a.data.templates[e],l=this.getAttributes(t,a,d);this.compileAttributes(t,l),d.attributes=l}i.Cmdbuild.CqlManager.variablesTable.generate(t,i.Cmdbuild.CqlManager.commandsTable)},createField:function(i,t,a){a.push({name:i,filter:{text:t[i],params:t.variables}})},getAttributes:function(i,t,a){var e=[];return this.createField("subject",a,e),this.createField("body",a,e),this.createField("to",a,e),this.createField("from",a,e),this.createField("cc",a,e),this.createField("bcc",a,e),this.createField("condition",a,e),this.createField("keepSynchronization",a,e),e},setSynchronization:function(i,t,a,e){for(var d=0;d<i.length;d++){var l=i[d];l.promptSynchronization=!1,a&&t[l._id]?l.keepSynchronization=!0:l.keepSynchronization=!1}},compileAttributes:function(t,a){for(var e=0;e<a.length;e++)i.Cmdbuild.CqlManager.compileAttribute(t,a[e])},initializeAllTemplates:function(t,a,e,d,l,n,r){if(e.length<=0)return void n.apply(r);var o=e[0];if(e.splice(0,1),!o._id){var s="guiTmpMail_"+d+"_"+(""|l.ActivityInstanceId);o._id=s}l.mails.push({_id:o._id,status:"draft"}),this.evaluateCqlSingleTemplate(t,a,o),i.Cmdbuild.widgets.ManageEmail.cqlResolve(t,o,function(){this.initializeAllTemplates(t,a,e,d+1,l,n,r)},this)},initialize:function(t,a){this.widget=a;var e=i.Cmdbuild.dataModel.forms[t],d=e.getBackendData();d.mails=[],d.bkMails=[],this.config={instanceForm:t,editProcess:e.config.readonly===!1||"false"===e.config.readonly},this.initializeAllTemplates(t,a,a.data.templates.slice(),0,d,function(){this.loadMails(e.config,e.getBackend(),function(){},this)},this)},refreshCqlFieldTemplates:function(t,a,e,d,l){if(e.length<=0)return void d.apply(l);var n=e[0];e.splice(0,1);var r=n.keepSynchronization,o=n.promptSynchronization;if(r)if(o){if(formObject.initializationPhase===!1){var s=t+"_"+a._id;i.Cmdbuild.dataModel.pushSingleParameterOnStack("widgetName",s),i.Cmdbuild.dataModel.pushSingleParameterOnStack("formData",t),i.Cmdbuild.standard.commands.navigate({command:"navigate",form:"mailSynchronization",dialog:"syncMailDialog"}),n.promptSynchronization=!1,this.refreshCqlFieldTemplates(t,a,e,d,l)}}else this.evaluateCqlSingleTemplate(t,a,n),i.Cmdbuild.widgets.ManageEmail.cqlResolve(t,n,function(){this.refreshCqlFieldTemplates(t,a,e,d,l)},this);else this.refreshCqlFieldTemplates(t,a,e,d,l)},refreshCqlField:function(t,a){var e=i.Cmdbuild.dataModel.forms[t];if(1!=e.initializationPhase&&this.busy!==!0){this.busy=!0;var d=this;this.refreshCqlFieldTemplates(t,a,a.data.templates.slice(),function(){d.busy=!1},this)}},loadMails:function(t,a,e,d){t.cardId?i.Cmdbuild.utilities.proxy.getProcessMails(t.className,t.cardId,function(i){this.callbackLoadMails(a,t.className,t.cardId,i,e,d)},this):e.apply(d,[])},callbackLoadMails:function(t,a,e,d,l,n){if(d.length<=0)return void l.apply(n);var r=d[0];d.splice(0,1),i.Cmdbuild.utilities.proxy.getProcessSingleMail(a,e,r._id,function(r){"draft"===r.status&&r.keepSynchronization&&this.config.editProcess?i.Cmdbuild.utilities.proxy.deleteProcessMail(a,e,r._id,function(){},this):(t.data.mails.push(r),t.data.bkMails.push(i.Cmdbuild.utilities.clone(r)),this.callbackLoadMails(t,a,e,d,l,n))},this)},template2Mail:function(i){var t={};for(var a in i)this.template2MailTable[a]?t[this.template2MailTable[a]]=i[a]:t[a]=i[a];return t}};i.Cmdbuild.widgets.ManageEmail=t,i.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField=function(t,a,e,d,l){var n=i.Cmdbuild.dataModel.forms[t],r=n.getBackendData();i.Cmdbuild.CqlManager.resolve(t,a,function(t){var n=i.Cmdbuild.widgets.ManageEmail.getMail(r.mails,e._id);n[a]=t,n.fromTemplate=e._id,d&&d.apply(l,[t])},this)},i.Cmdbuild.widgets.ManageEmail.cqlResolve=function(t,a,e,d){var l=a.attributes.slice();i.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(t,a,l,function(){e.apply(d,[])},this)},i.Cmdbuild.widgets.ManageEmail.cqlResolveCallback=function(t,a,e,d,l){if(e.length<=0)return void d.apply(l,[]);var n=e[0];e.splice(0,1),i.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField(t,n.name,a,function(){i.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(t,a,e,d,l)},this)},i.Cmdbuild.widgets.ManageEmail.refreshTemplate=function(t,a,e){for(var d=0;d<a.data.templates.length;d++){var l=a.data.templates[d];if(l._id==e){i.Cmdbuild.widgets.ManageEmail.cqlResolve(t,l,function(){},this);break}}},i.Cmdbuild.widgets.ManageEmail.getMail=function(i,t){for(var a=0;a<i.length;a++)if(i[a]._id==t)return i[a]},i.Cmdbuild.widgets.ManageEmail.isDifferent=function(t,a){for(var e=0;e<i.Cmdbuild.widgets.ManageEmail.mailAttributes.length;e++){var d=i.Cmdbuild.widgets.ManageEmail.mailAttributes[e];if(a[d]!=t[d])return!0}return!1},i.Cmdbuild.widgets.ManageEmail.searchAttribute=function(i,t){for(var a in i){var e=a.indexOf(this.FIELDTAG),d=a;if(e>-1&&(d=d.substr(0,e)),d===t)return i[a]}},i.Cmdbuild.widgets.ManageEmail.copyMail=function(t){for(var a={},e=0;e<i.Cmdbuild.widgets.ManageEmail.mailAttributes.length;e++){var d=i.Cmdbuild.widgets.ManageEmail.mailAttributes[e];a[d]=i.Cmdbuild.widgets.ManageEmail.searchAttribute(t,d)}return a},i.Cmdbuild.widgets.ManageEmail.deleteMails=function(t,a){for(var e=0;e<a.bkData.length;e++){for(var d=!1,l=a.bkData[e],n=0;n<a.data.length;n++){var r=a.data[n];if(l._id==r._id){d=!0;break}}d||i.Cmdbuild.utilities.proxy.deleteProcessMail(t.type,t.id,l._id,function(){},this)}},i.Cmdbuild.widgets.ManageEmail.flush=function(t,a,e,d,l,n){if(!a.data)return l||console.log(Error().stack),void l.apply(n,[]);var r=a.data.slice();i.Cmdbuild.widgets.ManageEmail.flushRecursive(t,r,a.bkData,function(){this.deleteMails(t,a),l.apply(n,[])},this)},i.Cmdbuild.widgets.ManageEmail.flushRecursive=function(t,a,e,d,l){if(a.length<=0)return void d.apply(l,[]);var n=a[0];a.splice(0,1);var r=i.Cmdbuild.widgets.ManageEmail.copyMail(n);if("'true'"!==r.condition)return void i.Cmdbuild.widgets.ManageEmail.flushRecursive(t,a,e,d,l);var o=i.grep(e,function(i){return i._id==r._id});if(o.length>0){var s=o[0];if(i.Cmdbuild.widgets.ManageEmail.isDifferent(s,r)){var m=i.Cmdbuild.widgets.ManageEmail.copyMail(r);i.Cmdbuild.utilities.proxy.putProcessMail(t.type,t.id,m._id,m,function(){i.Cmdbuild.widgets.ManageEmail.flushRecursive(t,a,e,d,l)},this)}else i.Cmdbuild.widgets.ManageEmail.flushRecursive(t,a,e,d,l)}else{var m=i.Cmdbuild.widgets.ManageEmail.copyMail(r);m._id;delete m._id,delete m.condition,i.Cmdbuild.utilities.proxy.postProcessMail(t.type,t.id,m,function(){i.Cmdbuild.widgets.ManageEmail.flushRecursive(t,a,e,d,l)},this)}}}(jQuery),function(i){var t={saveMethod:i.Cmdbuild.widgets.SAVEONCARD,formName:function(i,t){var a=i+"_"+t._id+"_navigationtree";return a},initialize:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.push({form:e,type:"navigationtreewidget",data:[]})},cleanData:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.cleanForm(e)},save:function(t,a){return i.Cmdbuild.dataModel.getData(this.formName(t,a))},createXmlButton:function(i,t,a,e){var d,l=i+"_"+t._id,n=t.label.replace(/'/g,"\\'");return d="<button ",d+=" id='"+l+"' ",d+=" text='"+n+"' >",d+="		<onClick>",d+="			<command>navigate</command>",d+="			<dialog>"+l+"_widgetDialog</dialog>",d+="			<container>"+a+"</container>",d+="			<form>"+l+"_dialogForm</form>",d+="			<title>"+t.label+"</title>",d+="		</onClick>",d+="		<params>",d+="			<dialog>"+l+"_widgetDialog</dialog>",d+="			<widgetId>"+t._id+"</widgetId>",d+="			<instanceForm>"+i+"</instanceForm>",d+="		</params>",d+="</button>"}};i.Cmdbuild.widgets.NavigationTree=t}(jQuery),function(i){var t={data:{},saveMethod:i.Cmdbuild.widgets.SAVEAFTER,save:function(t,a){return{data:i.Cmdbuild.dataModel.getAttachmentsForWidget(t).slice(),name:a._id}},formName:function(i,t){return t.formname=i+"_"+t._id+"formattachements",t.formname},cleanData:function(t,a){var e=this.formName(t,a);i.Cmdbuild.dataModel.cleanForm(e)}};i.Cmdbuild.widgets.OpenAttachment=t,i.Cmdbuild.widgets.OpenAttachment.flush=function(t,a,e,d,l,n){var r=i.Cmdbuild.widgets.OpenAttachment.formName(d,{_id:e}),o=i.Cmdbuild.dataModel.getAttachmentsForWidget(r);if(o.length<=0)return void l.apply(n,[]);var s=o.splice(0,1)[0];i.Cmdbuild.dataModel.setAttachmentsForWidget(t.form,o),i.Cmdbuild.utilities.proxy.postInstanceAttachment(t.type,t.id,s.formdata,function(r){i.Cmdbuild.widgets.OpenAttachment.flush(t,a,e,d,l,n)},this)}}(jQuery);
//# sourceMappingURL=widgets.min.js.map